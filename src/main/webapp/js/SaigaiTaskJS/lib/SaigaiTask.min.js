// generated by SaigaiTaskJS/build/build.bat
/* Copyright (c) 2013 National Research Institute for Earth Science and
 * Disaster Prevention (NIED).
 * This code is licensed under the GPL version 3 license, available at the root
 * application directory.
 */
 if(typeof dojo=="undefined"){dojo={};}
if(typeof dojo.fromJson=="undefined"){dojo.fromJson=JSON.parse;}
if(typeof dojo.toJson=="undefined"){dojo.toJson=JSON.stringify;}
if(typeof dojo.trim=="undefined"){dojo.trim=$.trim;}
if(typeof dojo.clone=="undefined"){dojo.clone=function(target){return $.extend({},target);};}
if(typeof dojo.isIE=="undefined"){var detectIE=function(){var ua=window.navigator.userAgent;var msie=ua.indexOf('MSIE ');if(msie>0){return parseInt(ua.substring(msie+5,ua.indexOf('.',msie)),10);}
var trident=ua.indexOf('Trident/');if(trident>0){var rv=ua.indexOf('rv:');return parseInt(ua.substring(rv+3,ua.indexOf('.',rv)),10);}
var edge=ua.indexOf('Edge/');if(edge>0){return parseInt(ua.substring(edge+5,ua.indexOf('.',edge)),10);}
return 0;}
dojo.isIE=detectIE();}
if(typeof dojo.isChrome=="undefined"){var getChromeVersion=function(){var raw=navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./);return raw?parseInt(raw[2],10):0;}
dojo.isChrome=getChromeVersion();}
if(typeof dojo.create=="undefined"){dojo.create=function(tag,attrs,refNode,pos){var e=$("<"+tag+">");if(typeof attrs!="undefined"){if(typeof attrs.style!="undefined"){e.attr("style",attrs.style);}
if(typeof attrs.innerHTML!="undefined"){e.html(attrs.innerHTML);}
if(typeof attrs.className!="undefined"){e.addClass(attrs.className);}}
return e.get(0);}}
if(typeof dojo.keys=="undefined"){dojo.keys={};dojo.keys.LEFT_ARROW=37
dojo.keys.UP_ARROW=38
dojo.keys.RIGHT_ARROW=39
dojo.keys.DOWN_ARROW=40
dojo.keys.DELETE=46}
SaigaiTask.Map=function(div,options){SaigaiTask.Map.util.CommonUtil.loadLibrary(options.contextPath);this.init(div,options);}
SaigaiTask.Map.version=Number("$Revision: 6238 $".split(" ")[1]);SaigaiTask.Map.copy=function(dest,src){if(src==null)return;if(dest==null)return;for(var property in src){dest[property]=src[property];}};SaigaiTask.Map.extend=function(dest,src){if(src==null)return;if(dest==null)return;for(var property in src){if(typeof dest[property]=="undefined"||dest[property]==null){dest[property]=src[property];}}};SaigaiTask.Map.extendZoomWorld=function(panZoom){var zoomWorldListener=function(evt,map){var zoomWorld=map.zoomWorld;if(typeof zoomWorld=="function"){zoomWorld();OpenLayers.Event.stop(evt);return false;}};if(panZoom.CLASS_NAME=="OpenLayers.Control.PanZoomBar"){panZoom.zoomWorldIcon=true;panZoom._onButtonClick=panZoom.onButtonClick;panZoom.onButtonClick=function(evt){var buttonElement=evt.buttonElement;var map=evt.object;switch(buttonElement.action){case"zoomworld":return zoomWorldListener(evt,map);default:this._onButtonClick(evt);}};}
if(panZoom.CLASS_NAME=="OpenLayers.Control.Zoom"){var createImgButton=function(id,img,xy,sz,position){var imgLocation=OpenLayers.Util.getImageLocation(img);var btn=OpenLayers.Util.createAlphaImageDiv(panZoom.id+"_"+id,xy,sz,imgLocation,"relative");btn.style.cursor="pointer";btn.style.margin="0px auto";return btn;};var id="zoomworld",img="zoom-world-mini.png",xy={x:0,y:2},sz={w:18,h:18};var btn=createImgButton(id,img,xy,sz,"relative");var tooltip=lang.__("Move to the initial display position.");img=btn.getElementsByTagName("img")[0];img.title=tooltip;btn.onclick=function(evt){var map=panZoom.map;return zoomWorldListener(evt,map);}
var link=document.createElement("a");link.appendChild(btn);var div=panZoom.zoomInLink.parentElement;var position=null;switch(position){case"head":div.insertBefore(link,panZoom.zoomInLink);break;case"tail":div.appendChild(link);break;default:div.insertBefore(link,panZoom.zoomOutLink);break;}}};SaigaiTask.Map.param=function(obj){var prefix=null;var params=[];var add=function(key,value){value=value==null?"":value;params[params.length]=encodeURIComponent(key)+"="+encodeURIComponent(value);};var buildParams=function(prefix,obj){if(jQuery.isArray(obj)){jQuery.each(obj,function(idx,value){buildParams(prefix+"["+idx+"]",value);});}
else if(jQuery.type(obj)==="object"){var name=null;for(name in obj){buildParams(prefix+"."+name,obj[name]);}}
else{add(prefix,obj);}};for(prefix in obj){buildParams(prefix,obj[prefix]);}
return params.join("&").replace(/%20/g,"+");};SaigaiTask.Map.prototype={options:null,events:null,EventType:{beforeloadecommap:"beforeloadecommap",loadendecommap:"loadendecommap",alllayerloadend:"alllayerloadend",beforeshowcontentsearchview:"beforeshowcontentsearchview",beforeshowcontentpopup:"beforeshowcontentpopup",beforeaddlegend:"beforeaddlegend",afterredrawlegendpanel:"afterredrawlegendpanel",afterdraw:"afterdraw",successcontentssubmit:"successcontentssubmit",successcontentsdelete:"successcontentsdelete",beforemapclick:"beforemapclick",clicksearch:"clicksearch"},usejQuery:null,contextPath:null,api:null,saigaitaskServer:null,epsg:4326,div:null,map:null,controls:null,popupManager:null,mapId:null,filter:null,searchFilter:null,components:{mainpanel:null,contentsFormWindow:null},showLegend:false,excludesLayerIdsFromLegendWindow:[],clickHandler:null,clickBuffer:10,ecommaps:null,pandx:100,pandy:50,icon:null,geocoder:null,time:null,resize:function(){var me=this;me.map.updateSize();},init:function(div,initOptions){var me=this;var options=new SaigaiTask.Map.model.InitOptions();SaigaiTask.Map.copy(options,initOptions);me.options=options;me.filter={};for(var filterLayerId in options.filterFeatureMap){me.filter[filterLayerId]=[];var filterFeatureIds=options.filterFeatureMap[filterLayerId];for(var filterFeatureIdsKey in filterFeatureIds){var filterFeatureId=parseInt(filterFeatureIds[filterFeatureIdsKey]);me.filter[filterLayerId].push(filterFeatureId);}}
SaigaiTask.Map.copy(me.searchFilter,me.filter);(function(id){var iframe=parent.document.getElementById(id);if(iframe){try{console=parent.window.console;console.log(lang.__("Changed console to the parent of iframe"));}catch(e){}}})("TB_iframeContent");me.events=new OpenLayers.Events(me);for(var eventtypeIdx in me.EventType){var type=me.EventType[eventtypeIdx];me.events.extensions[type]=true;}
me.ecommaps=new Array();me.div=div;if(options){if(options.api!=null){this.api=options.api;this.api.stmap=this;}
if(options.icon!=null){this.icon=options.icon;}
var contextPath=options.contextPath;if(contextPath){me.contextPath=contextPath;me.saigaitaskServer=contextPath+"/map";if(this.api==null){this.api=new SaigaiTask.Map.SaigaiTaskAPI(contextPath);}
if(this.icon==null){this.icon=new SaigaiTask.Map.Icon(contextPath+"/js/SaigaiTaskJS/css");}}
if(typeof options.showLegend!='undefined'){me.showLegend=options.showLegend;}
me.epsg=options.epsg;if(options.geocoder!=null){me.geocoder=options.geocoder;}}
me.baseLayer=new Object();me.usejQuery=(typeof jQuery!='undefined');if(!me.usejQuery){console.warn('jQuery was not found.');}
var mapOptions={tileManager:null,controls:[],transitionEffect:null,zoomMethod:null};if(me.epsg!=900913||me.epsg==3857){if(options){if(options.scales){mapOptions.scales=options.scales;}else{mapOptions.maxResolution=0.703125;mapOptions.numZoomLevels=22;}}}
me.map=new OpenLayers.Map(div,mapOptions);me.setEpsg(me.epsg);me.controls=new Object();me.addControl(new OpenLayers.Control.Navigation({zoomWheelEnabled:true,handleRightClicks:true,zoomBoxKeyMask:OpenLayers.Handler.MOD_ALT}),me.getNavigationControlKey());me.controls.navigation.dragPan.handler.stopDown=false;var panZoom=new OpenLayers.Control.PanZoom();SaigaiTask.Map.extendZoomWorld(panZoom);me.addControl(panZoom,"panZoom");if(options&&options.coordinateDecimal){me.addControl(new OpenLayers.Control.MousePosition({displayProjection:new OpenLayers.Projection("EPSG:4326")}),'mouseposition');}
else{me.addControl(new SaigaiTask.Map.control.MousePosition60({displayProjection:new OpenLayers.Projection("EPSG:4326")}),'mouseposition');}
me.addControl(new OpenLayers.Control.ScaleBar(),"scaleBar");var centerCursorControl=new OpenLayers.Control.CenterCursor();me.addControl(centerCursorControl);centerCursorControl.moveCenter();me.map.addControl(new OpenLayers.Control.Attribution());var pdfControl=new SaigaiTask.Map.control.PdfControl(this);me.addControl(pdfControl,"pdfControl");var syncControl=new SaigaiTask.Map.control.SyncControl(this);me.addControl(syncControl,"syncControl");var selectFeatureControl=new SaigaiTask.Map.control.SelectFeatureControl(this);me.addControl(selectFeatureControl,"selectFeatureControl");var mgrsControl=new SaigaiTask.Map.control.MgrsControl(this);me.addControl(mgrsControl,"mgrsControl");var rakugakiControl=new SaigaiTask.Map.control.RakugakiControl(this);me.addControl(rakugakiControl,"rakugakiControl");var kmlSelectControl=new OpenLayers.Control.SelectFeature([],{clickout:true,toggle:false,multiple:false,hover:false});me.addControl(kmlSelectControl,"kmlSelectControl");if(me.initDraw)me.initDraw();me.clickHandler=new OpenLayers.Handler.Click(me,{click:me.onMapClick},{single:true,pixelTolerance:5});me.clickHandler.activate();OpenLayers.ProxyHost=this.api.url.wfsProxyURL;me.components.contextmenu=new SaigaiTask.Map.view.ContextMenu(me,options.showMenuOptions);if(me.showLegend){new SaigaiTask.Map.view.MainPanel(me);}
else{$("#"+me.div).width("100%").height("100%");}
me.map.events.on({"preaddlayer":function(option){var layer=option.layer;layer.loading=false;layer.events.on({"loadstart":function(){layer.loading=true;},"loadend":function(){layer.loading=false;var allloadend=true;for(var idx in me.map.layers){var l=me.map.layers[idx];if(l.loading){allloadend=false;break;}}
if(allloadend){me.events.triggerEvent("alllayerloadend");}}});}});},setEpsg:function(epsg,scales){var me=this;var mapOptions;if(epsg==900913){mapOptions={maxResolution:156543.0339,numZoomLevels:22,maxExtent:new OpenLayers.Bounds(-20037508.34,-20037508.34,20037508.34,20037508.34),units:'m',projection:new OpenLayers.Projection("EPSG:900913"),displayProjection:new OpenLayers.Projection("EPSG:4326")};}
else if(epsg==3857){mapOptions={maxResolution:156543.0339,numZoomLevels:22,maxExtent:new OpenLayers.Bounds(-20037508.34,-20037508.34,20037508.34,20037508.34),units:'m',projection:new OpenLayers.Projection("EPSG:3857"),displayProjection:new OpenLayers.Projection("EPSG:4326")};}else{mapOptions={maxExtent:new OpenLayers.Bounds(-180,-90,180,90),projection:"EPSG:4326"};if(!!scales){mapOptions.scales=scales;}else{mapOptions.maxResolution=0.703125;mapOptions.numZoomLevels=22;}}
me.map.setOptions(mapOptions);me.epsg=epsg;me.events.triggerEvent("epsgchanged");},getMouseLonLat:function(){var me=this;var lonlat=me.map.getLonLatFromPixel(me.controls['mouseposition'].lastXy);return lonlat;},reload:function(){var me=this;var map=me.map;var layers=map.layers;for(var layersIdx in layers){var layer=layers[layersIdx];if(layer.isBaseLayer)continue;layer.redraw(true);}},loadEcommap:function(mapId,layerIds,onlyLayerIds){var me=this;me.events.triggerEvent(me.EventType.beforeloadecommap);var lids=null;var olids=null;if(layerIds!=null){lids=layerIds.split(",");for(var i=0;i<lids.length;i=i+1)
me.excludesLayerIdsFromLegendWindow.push(lids[i]);}
if(onlyLayerIds!=null&&onlyLayerIds!="null")
olids=onlyLayerIds.split(",");this.mapId=mapId;me.api.getEcommapInfo(mapId,function(ecommap){if(ecommap!=null){ecommap.stmap=me;ecommap=new SaigaiTask.Map.EcommapInfo(ecommap);me.registEcommapInfo(ecommap,lids,olids);}});},registEcommapInfo:function(ecommap,lids,olids){var me=this;me.ecommaps.push(ecommap);var ecommapIdx=me.ecommaps.length-1;ecommap.ecommapIdx=ecommapIdx;me.setEpsg(ecommap.epsg,ecommap.scales);try{if(!!ecommap.layoutInfo&&!!ecommap.layoutInfo.restrictedExtent){var restrictedExtentArr=ecommap.layoutInfo.restrictedExtent
if(restrictedExtentArr.length==4){var restrictedExtent=new OpenLayers.Bounds(restrictedExtentArr[0],restrictedExtentArr[1],restrictedExtentArr[2],restrictedExtentArr[3]);var degProj=new OpenLayers.Projection("EPSG:4326");var maxExtent=new OpenLayers.Bounds(-20037508.34,-20037508.34,20037508.34,20037508.34).transform(new OpenLayers.Projection("EPSG:900913"),degProj);if(restrictedExtent.top>maxExtent.top)restrictedExtent.top=maxExtent.top;if(restrictedExtent.left<maxExtent.left)restrictedExtent.left=maxExtent.left;if(restrictedExtent.right>maxExtent.right)restrictedExtent.right=maxExtent.right;if(restrictedExtent.bottom<maxExtent.bottom)restrictedExtent.bottom=maxExtent.bottom;me.map.setOptions({restrictedExtent:restrictedExtent.clone().transform(degProj,new OpenLayers.Projection("EPSG:"+ecommap.epsg))});}}}catch(e){console.error(lang.__("Failed to set display limitation range."),e);}
var baseLayers=ecommap.getBaseLayerInfos();me.addBaseLayers(baseLayers);var arcgisLayerInfos=ecommap.getArcGISLayerInfos();me.addArcGISLayer(arcgisLayerInfos);var overlayLayerInfos=ecommap.getOverlayLayerInfos();me.addOverlayLayer(overlayLayerInfos);var externalMapLayerInfos=ecommap.getExternalMapLayerInfos();me.addExternalMapLayer(externalMapLayerInfos,true);var referenceLayerInfos=ecommap.getReferenceLayerInfos();me.addReferenceLayer(referenceLayerInfos,true);var kmlLayerInfos=ecommap.getLayerInfosByTypes([SaigaiTask.Map.Layer.Type.KML]);me.addLayers(kmlLayerInfos);ecommap.contentsLayers=ecommap.getLayerInfosByTypes([SaigaiTask.Map.Layer.Type.LOCAL]);var contentsLayers=ecommap.contentsLayers;for(var key in contentsLayers){var contentsLayer=contentsLayers[key];if(olids!=null){contentsLayer.visibility=false;for(var i=0;i<olids.length;i=i+1){if(olids[i]==contentsLayer.layerId)
contentsLayer.visibility=true;}}
else{if(lids!=null){for(var i=0;i<lids.length;i=i+1){if(lids[i]==contentsLayer.layerId)
contentsLayer.visibility=true;}}}
contentsLayer.searchable=contentsLayer.visibility;}
me.addContentsLayers(ecommap);me.map.zoomWorld=function(){ecommap.moveToHome();};me.initHome();var callback=function(){var popup=null;popup=SaigaiTask.Map.util.CommonUtil.getParameter("popup");if(popup==null)popup=me.options.popupid;if(popup!=null){var popups=popup.split(",");for(var idx in popups){var layer=popups[idx].split(".")[0];var fid=popups[idx].split(".")[1];me.options.pinned=true;me.options.center=true;me.getContent(layer,fid,null,null,me.options);var layerInfo=me.getLayerInfo(layer);if(!!layerInfo){layerInfo.visibility=true;layerInfo.searchable=true;var layer=layerInfo.getLayer();layer.refreshParams();}}}
var legendcollapsed=null;legendcollapsed=SaigaiTask.Map.util.CommonUtil.getParameter("legendCollapsed");if(legendcollapsed=="true"){me.options.collapsed=true;}
me.events.triggerEvent(me.EventType.loadendecommap,{ecommap:ecommap});};var sessionLayout=me.controls["sessionLayout"];if(!!sessionLayout)sessionLayout.loadLayout(callback,(olids==null));else callback();me.components.mainpanel.redrawLegendPanel();},initSaveLayout:function(){var sessionLayout=this.controls["sessionLayout"];sessionLayout.activate();sessionLayout.loadLayout();},initHome:function(){var me=this;var olmap=me.map;olmap.zoomWorld();var center=me.getCenter();var zoom=me.map.getZoom();var homeLocation={center:center,zoom:zoom};me.isHome=function(){var center=me.getCenter();var zoom=me.map.getZoom();if(homeLocation.center.equals(center)==false)return false;if(homeLocation.zoom!=zoom)return false;return true;};var map=this;var popup=SaigaiTask.Map.util.CommonUtil.getParameter("popup");if(popup==null){var initCenter=SaigaiTask.PageURL.getInitCenter();if(initCenter!=null){map.setCenter(initCenter);}
var initZoom=SaigaiTask.PageURL.getInitZoom();if(isFinite(initZoom)&&0<initZoom){map.map.zoomTo(initZoom);}}},onMapClick:function(evt){var me=this;me.events.triggerEvent(me.EventType.beforemapclick);if(me.popupManager!=null){me.popupManager.closeAll();}
if(!!document.activeElement&&!!document.activeElement.blur)document.activeElement.blur();var lb=this.map.getLonLatFromPixel(new OpenLayers.Pixel(evt.xy.x-this.clickBuffer,evt.xy.y+this.clickBuffer));var rt=this.map.getLonLatFromPixel(new OpenLayers.Pixel(evt.xy.x+this.clickBuffer,evt.xy.y-this.clickBuffer));if(this.map.displayProjection){lb.transform(this.map.getProjectionObject(),this.map.displayProjection);rt.transform(this.map.getProjectionObject(),this.map.displayProjection);}
var bbox=[lb.lon,lb.lat,rt.lon,rt.lat];this.clickSearch(new OpenLayers.LonLat((lb.lon+rt.lon)/2,(lb.lat+rt.lat)/2),bbox,false,{evt:evt});},clickSearch:function(center,bbox,pinned,option){var me=this;if(me.popupManager!=null){me.popupManager.closeAll();}
var layerIds=me.getSearchableLayerIds();if(layerIds.length==0){var refcontentsPopup=new SaigaiTask.Map.view.RefContentsPopup(me);refcontentsPopup.getReferenceFeatureInfo(center,bbox);return;}
var rule="";for(var idx in layerIds){var layerId=layerIds[idx];var contentsLayerInfo=me.getLayerInfo(layerId);if(typeof contentsLayerInfo.params.rule=="string"&&0<contentsLayerInfo.params.rule.length){rule+=(0<rule.length?",":"")+contentsLayerInfo.params.rule;}}
var cid=null;var ecommaps=me.ecommaps;for(var ecommapsKey in ecommaps){var ecommap=ecommaps[ecommapsKey];var mapInfo=ecommap.mapInfo;if(mapInfo.mapId==me.mapId){cid=mapInfo.communityId;break;}}
var limit=10;var filter=me.searchFilter;var filterLength=SaigaiTask.Map.util.CommonUtil.length(filter);limit+=filterLength*5;var mapDiv=$("#"+me.div);mapDiv.css("cursor","wait");me.searchContentsByBbox(bbox,{cid:cid,layerIds:layerIds,limit:limit,async:true,rule:rule,success:function(result){if(0<filterLength){var featureInfos=result[1];var filteredResult=[];for(var featureInfosKey in featureInfos){var featureInfo=featureInfos[featureInfosKey];var layerId=featureInfo[0];var featureId=featureInfo[1];var isFilter=false;var filterFeatureIds=filter[layerId];if(typeof filterFeatureIds!="undefined"){isFilter=jQuery.inArray(featureId,filterFeatureIds)==-1;}
if(isFilter==false){filteredResult.push(featureInfo);}}
result[1]=filteredResult;}
result[1]=result[1].slice(0,10);if(!option)option={};option.executePopup=true;var args={layerIds:layerIds,center:center,bbox:bbox,option:option,result:result,executePopup:true}
me.events.triggerEvent(me.EventType.clicksearch,args);if(args.executePopup){if(result[1].length==1){me.getContent(result[1][0][0],result[1][0][1],center,bbox,{pinned:pinned});}else if(result[1].length>1){var listPopup=new SaigaiTask.Map.view.ListPopup(me);listPopup.show(center,bbox,result,pinned);}else{var refcontentsPopup=new SaigaiTask.Map.view.RefContentsPopup(me);refcontentsPopup.getReferenceFeatureInfo(center,bbox);}};mapDiv.css("cursor","default");},error:function(){mapDiv.css("cursor","default");}});},searchContentsByBbox:function(bbox,options){var me=this;var defaultOptions={cid:null,mapId:me.mapId,layerIds:me.getVisibleLayerIds(),limit:0,async:false,rule:""};var op={};Ext.applyIf(op,options);Ext.applyIf(op,defaultOptions);console.log("op");console.log(op);return me.api.searchContentsByBbox(bbox,op.cid,op.mapId,op.layerIds,op.rule,op.limit,op.async,op.success);},searchShelter:function(options){var me=this;var result=null;var url=me.contextPath+me.url.searchShelterURL;options._csrf=SaigaiTask.ajaxcsrfToken;Ext.Ajax.request({url:url,method:"GET",params:options,async:false,success:function(response){result=JSON.parse(response.responseText);}});return result;},moveAddress:function(address){var me=this;var defer=$.Deferred();me.geocode(address).done(function(results,status){var result=results[0];var point=result.geometry.location;var lonlat=new OpenLayers.LonLat(point.lng(),point.lat());lonlat=lonlat.transform(new OpenLayers.Projection("EPSG:4326"),me.map.getProjectionObject());if(!!me.map.restrictedExtent){if(me.map.restrictedExtent.containsLonLat(lonlat)==false){alert(lang.__("Failed to move due to out of range."));defer.reject(result);return;}}
me.map.setCenter(lonlat,15);defer.resolve(result);});return defer.promise();},geocode:function(opt){var me=this;if(me.geocoder!=null){if(me.geocoder.toUpperCase()=="GOOGLE"){return me.geocodeGoogle(opt);}}
alert(lang.__("No geocoder to be available."));var defer=$.Deferred();defer.reject();return defer.promise();},geocodeGoogle:function(opt){var isV3=false;try{isV3=google.maps.version.indexOf("3.")==0;}catch(e){alert(lang.__("Google Map JavaScript API v3 has not been loaded."));}
var defer=$.Deferred();geocoder=new google.maps.Geocoder();var option={};switch(typeof opt){case"string":option.address=opt;break;case"object":if(!!opt.CLASS_NAME){switch(opt.CLASS_NAME){case"OpenLayers.Geometry.Point":var point=opt;var lat=point.y;var lng=point.x;option.latLng=new google.maps.LatLng(lat,lng);break;case"OpenLayers.LonLat":var lonlat=opt;var lat=lonlat.lat;var lng=lonlat.lon;option.latLng=new google.maps.LatLng(lat,lng);break;}}
break;}
geocoder.geocode(option,function(results,status){if(status==google.maps.GeocoderStatus.OK){defer.resolve(results,status);}
else{defer.reject(results,status);}});return defer.promise();},getFormattedAddress:function(result,formatOption){var addr=result.formatted_address;addr=addr.replace(/^日本, /,'');addr=addr.replace(/^〒\d\d\d-\d\d\d\d /,'');var pref=null;var addressComponentsIdx=result.address_components.length-1;for(;0<=addressComponentsIdx;addressComponentsIdx--){var component=result.address_components[addressComponentsIdx];if(component.types[0]=="administrative_area_level_1"){pref=component.long_name;}}
if(pref!=null){var replacedAddr=addr.replace(pref,"");if(replacedAddr.length!=0){addr=replacedAddr;}}
return addr;},getContent:function(layer,fid,center,bbox,options){if(typeof layer=="undefined"||layer==null||layer==""){console.warn(lang.__("Layer ID has not been specified."));return;}
if(isNaN(parseFloat(fid))||isFinite(fid)==false){console.warn(lang.__("Feature ID is not specified in numeric."));return;}
var me=this;me.api.getContent(me.mapId,layer,fid,center,bbox,function(data){if(data==null){return;}
else if(typeof data=="error"){console.warn("error!",args);}
else{var contentsPopup=new SaigaiTask.Map.view.ContentsPopup(me);contentsPopup.show(layer,fid,data,center,bbox,options);}});},createImg:function(url,title,maxw,maxh){var me=this;var extImg={xtype:'image',src:me.saigaitaskServer+'/images/loading.gif',style:{width:'32px',height:'32px'}};var extImgObj=Ext.create('Ext.Img',extImg);var img=new Image();img.onload=function(){if(!extImgObj.getEl()){setTimeout(img.onload,100);return;}
imgResized=true;var w=img.width;var h=img.height;if(typeof img.naturalWidth!='undefined'){w=img.naturalWidth;h=img.naturalHeight;}
var rate=Math.min(maxw/w,maxh/h);if(rate<1){w=Math.round(w*rate);h=Math.round(h*rate);}
if(w!=extImgObj.getWidth())extImgObj.setWidth(w);if(h!=extImgObj.getHeight())extImgObj.setHeight(h);if(extImgObj.src!=url){extImgObj.setSrc(url);}
if(typeof title!="undefined"&&title!=null){extImgObj.getEl().set({title:title});}
extImgObj.getEl().dom.onclick=function(){var img=this;FalUtil.showImageWindow(img.src);};};img.src=url;window.extImgObj=extImgObj;return extImgObj;},addContentsWFSLayer:function(cid,mid,layerId,fids,options){var defaultOptions={styleMap:null};var op={};Ext.applyIf(op,options);Ext.applyIf(op,defaultOptions);var me=this;var layerInfo=me.getLayerInfo(layerId);var ecommap=me.ecommaps[0];var url=ecommap.ecommapURL+"/wfs?";if(ecommap.wfsURL!=null)url=ecommap.wfsURL;url+="cid="+cid;var featureType=layerId;var featureNS="";if(!fids)fids=[];var filter=null;if(fids!=null){new OpenLayers.Filter.FeatureId({fids:fids});}
if(layerInfo.timeSeriesType==SaigaiTask.Map.Layer.TimeSeriesType.HISTORY){var time=SaigaiTask.PageURL.getTime();if(!time)time=new Date();var iso8601Time=new Date(time).toISOString();if(SaigaiTask.PageURL.CONFIG_SHIFT_TIMEZONE_OFFSET){iso8601Time=new Date(time-time.getTimezoneOffset()*60*1000).toISOString();}
filter=new OpenLayers.Filter.Logical({type:OpenLayers.Filter.Logical.AND,filters:[new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.LESS_THAN_OR_EQUAL_TO,property:"time_from",value:iso8601Time}),new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.GREATER_THAN_OR_EQUAL_TO,property:"time_to",value:iso8601Time})]});}
var styleMap=op.styleMap;if(styleMap==null){var sldXML=this.getSLD(mid,layerId);var sldFormat=new OpenLayers.Format.SLD();var sld=sldFormat.read(sldXML);for(var l in sld.namedLayers){var styles=sld.namedLayers[l].userStyles;styleMap=styles[0];}}
return this.addWFSLayer(url,featureType,featureNS,filter,styleMap);},addWFSLayer:function(url,featureType,featureNS,filter,styleMap){var protocol=new OpenLayers.Protocol.WFS({url:url,featureType:featureType,featureNS:featureNS,srsName:"EPSG:"+this.epsg,srsNameInQuery:"EPSG:"+this.epsg,outputFormat:"json",readFormat:new OpenLayers.Format.GeoJSON()});var response=protocol.read({maxFeatures:100,callback:function(response){console.log("test wfs response");console.log(response);console.log(response.error);if(-1<response.priv.responseText.indexOf("<servlet-exception>")){console.error(lang.__("Failed to get WFS.")+url+"\n"+response.priv.responseText);}}})
var wfs=new OpenLayers.Layer.Vector("WFS",{strategies:[new OpenLayers.Strategy.BBOX()],protocol:protocol,filter:filter,styleMap:styleMap});this.map.addLayer(wfs);return wfs;},addContentsLayers:function(ecommap){return this.addContentsLayer(ecommap);},addContentsLayer:function(ecommap){var contentsLayerInfo=ecommap.contentsLayerInfo;if(contentsLayerInfo==null){return null;}
var hasFilterLayer=false;for(var idx=ecommap.contentsLayerInfos.length-1;0<=idx;idx--){var layerInfo=ecommap.contentsLayerInfos[idx];if(layerInfo.filterkey!=null){hasFilterLayer=true;break;}}
if(hasFilterLayer){for(var idx=ecommap.contentsLayerInfos.length-1;0<=idx;idx--){var layerInfo=ecommap.contentsLayerInfos[idx];var contentsLayerInfo=ecommap.createContentsLayerInfo();contentsLayerInfo.appendChildLayerInfo(layerInfo);var isFilterLayer=layerInfo.filterkey!=null;if(isFilterLayer){contentsLayerInfo.params.filterlayer=layerInfo.layerId;contentsLayerInfo.params.filterkey=layerInfo.filterkey;contentsLayerInfo.params.grayout=layerInfo.grayout;if(layerInfo.hasSpatialLayer()){layerInfo.createSpatialLayer();}}
var contentsLayer=new SaigaiTask.Map.Layer.WMSLayer(contentsLayerInfo);this.map.addLayer(contentsLayer);console.log("contensLayer.params");console.log(contentsLayer.params);var reload=ecommap.mapInfo.reload;if(0<reload){var timerId=setInterval(function(){contentsLayer.redraw(true);},reload*1000);ecommap.mapInfo.reloadkTimerId=timerId;}}
return;}
var contentsLayer=new SaigaiTask.Map.Layer.WMSLayer(contentsLayerInfo);this.map.addLayer(contentsLayer);console.log("contensLayer.params");console.log(contentsLayer.params);var reload=ecommap.mapInfo.reload;if(0<reload){var timerId=setInterval(function(){contentsLayer.redraw(true);},reload*1000);ecommap.mapInfo.reloadkTimerId=timerId;}
return contentsLayer;},getContentsWmsURLInfo:function(ecommapIdx){console.log("getContentsWmsURL");var ecommap=this.ecommaps[ecommapIdx];var mapInfo=ecommap.mapInfo;var contentsLayers=ecommap.contentsLayers;var layerAuthKeys=ecommap.layerAuthKeyMap;var mapCid=mapInfo.communityId;var mapId=mapInfo.mapId;var layers="",keys="";var layerArray=[],keyArray=[];var visible=true;var layerId=null,layerAuthKey=null;for(var key in contentsLayers){console.log("contentsLayers["+key+"]");var contentsLayer=contentsLayers[key];layerId=contentsLayer.layerId;layerAuthKey=layerAuthKeys[layerId];console.log("visible: "+visible);console.log("layerId: "+layerId);console.log("layerAuthKey: "+layerAuthKey);if(layerId!=null&&layerAuthKey!=null&&contentsLayer.visibility==true){if(jQuery.inArray(layerId,layerArray)==-1){layerArray.push(layerId);keyArray.push(layerAuthKey);}}}
if(0<layerArray.length){layers=layerArray.join(",");keys=keyArray.join(",");}
if(layers.length==0){layers=layerId;keys=layerAuthKey;visible=false;}
var server=this.saigaitaskServer;var wmsBaseURL=server+this.url.wmsAuthURL;var featureId="";if(this.filter){var first=true;var filterLayerId=new Array();for(var layerId in this.filter){if(!layerId)continue;var featureIdList=this.filter[layerId];if(featureIdList){for(var idx in featureIdList){var fid=featureIdList[idx];if(first)first=false;else featureId+=",";featureId+=layerId+"."+fid;filterLayerId.push(layerId);}}}
if(0<filterLayerId.length){layers=filterLayerId.join(',');keys=new Array();for(var idx in filterLayerId){keys.push(layerAuthKeys[filterLayerId[idx]]);}
keys=keys.join(',');}}
var wmsURL=wmsBaseURL+"?cid="+mapCid+"&mid="+mapId+"&featureId="+featureId+"&";var ret={wmsURL:wmsURL,layers:layers,visibility:visible};console.log("ret");console.log(ret);return ret;},getSLD:function(mid,layerId){return this.api.getSld(mid,layerId);},getLayerMap:function(){var me=this;var layers=me.getAllLayers();var map={};for(var idx in layers){var layer=layers[idx];map[layer.layerId]=layer;}
return map;},getAllLayers:function(){var me=this;var ecommap=me.ecommaps[0];return ecommap.baseLayers.concat(ecommap.contentsLayers).concat(ecommap.overlayLayers).concat(ecommap.referenceLayers);},redrawLayer:function(obj){var me=this;if(typeof obj=="object"){if(!!obj.CLASS_NAME){if(obj.CLASS_NAME=="SaigaiTask.Map.Layer.WMSLayer"){var layer=obj;if(layer!=null&&typeof layer.refreshParams=="function"){var visibility=layer.getVisibility();success|=layer.refreshParams({nocache:true});layer.setVisibility(visibility);}
return success;}
if(obj.CLASS_NAME=="SaigaiTask.Map.Layer.LayerInfo"){var success=false;var layerInfo=obj;var layers=[]
var layer=layerInfo.getLayer();if(layer!=null){me.redrawContentsLayer(layer);layer=layerInfo.spatialLayer;if(layer!=null){me.redrawContentsLayer(layer);}}}}}
return false;},redrawContentsLayer:function(obj){var me=this;if($.isNumeric(obj)){var ecommapIdx=obj;var ecommap=me.ecommaps[ecommapIdx];var contentsLayerInfo=ecommap.contentsLayerInfo;if(contentsLayerInfo!=null){var layer=contentsLayerInfo.getLayer();var reloaded=me.redrawContentsLayer(contentsLayerInfo);if(!reloaded){for(var idx in contentsLayerInfo.children){var child=contentsLayerInfo.children[idx];me.redrawContentsLayer(child);}}}}
else if(typeof obj=="object"){return me.redrawLayer(obj);}
return false;},addBaseLayers:function(baseLayers){for(var key in baseLayers)
this.addBaseLayer(baseLayers[key]);},addBaseLayer:function(layerInfo){if(!layerInfo)return;layerInfo=new SaigaiTask.Map.Layer.LayerInfo(layerInfo);layer=SaigaiTask.Map.Layer.newLayerFromLayerInfo(layerInfo);if(layer instanceof SaigaiTask.Map.Layer.GoogleLayer){if(typeof google=="undefined"){alert(lang.__("Set geocoder setting to Google's when to user Google Map."));return;}}
this.map.addLayer(layer);if(layerInfo.visibility){this.map.setBaseLayer(layer);}
this.baseLayer[layerInfo.layerId]=layer;},getVisibleLayerIds:function(){var me=this;var layerIds=[];var ecommaps=me.ecommaps;for(var ecommapsKey in ecommaps){var ecommap=ecommaps[ecommapsKey];var contentsLayers=ecommap.contentsLayers;if(contentsLayers){for(var contentsLayersKey in contentsLayers){var contentsLayer=contentsLayers[contentsLayersKey];var layerId=contentsLayer.layerId;var visible=contentsLayer.visibility;if(visible){layerIds.push(layerId);}}}}
return layerIds;},getSearchableLayerIds:function(){var me=this;var layerIds=[];var ecommaps=me.ecommaps;for(var ecommapsKey in ecommaps){var ecommap=ecommaps[ecommapsKey];var contentsLayers=ecommap.contentsLayers;if(contentsLayers){for(var contentsLayersKey in contentsLayers){var contentsLayer=contentsLayers[contentsLayersKey];var layerId=contentsLayer.layerId;if(contentsLayer.alwaysNotSearch==false&&contentsLayer.searchable){layerIds.push(layerId);}}}}
return layerIds;},getLayerInfo:function(layerId){var layerInfo=null;var ecommaps=this.ecommaps;for(var ecommapsKey in ecommaps){var ecommap=ecommaps[ecommapsKey];var contentsLayers=ecommap.contentsLayers;for(var contentsLayersKey in contentsLayers){var contentsLayer=contentsLayers[contentsLayersKey];if(contentsLayer.layerId==layerId){layerInfo=contentsLayer;return layerInfo;}}}
return null;},addLayers:function(layerInfos){var me=this;for(var key in layerInfos){var info=layerInfos[key];me.addLayer(info);}},addLayer:function(obj){var me=this;switch(obj.CLASS_NAME){case"SaigaiTask.Map.Layer.LayerInfo":var layer=SaigaiTask.Map.Layer.newLayerFromLayerInfo(obj);if(layer.CLASS_NAME!="SaigaiTask.Map.Layer.KMLLayer"&&layer.CLASS_NAME!="SaigaiTask.Map.Layer.Group"){me.map.addLayer(layer);}
break;default:if(obj instanceof OpenLayers.Layer){me.map.addLayer(obj);}
break;}},addReferenceLayer:function(referenceLayerInfos,split){var me=this;if(!!!split){this.addLayers(referenceLayerInfos);}
else{var layerInfos=referenceLayerInfos;for(var key in layerInfos){var info=layerInfos[key];var childLayerInfos=info.children;for(var key2 in childLayerInfos){var childLayerInfo=childLayerInfos[key2];childLayerInfo.wmsURL=info.wmsURL;me.addLayer(childLayerInfo);}}}},addOverlayLayer:function(_overlayLayerInfos){var overlayLayerInfos=[].concat(_overlayLayerInfos).reverse();for(var key in overlayLayerInfos){var info=overlayLayerInfos[key];var layer=null;if(info.type==SaigaiTask.Map.Layer.Type.OVERLAY_XYZ)
layer=new SaigaiTask.Map.Layer.XYZLayer(info);else
layer=new SaigaiTask.Map.Layer.WMSLayer(info);this.map.addLayer(layer);}},addArcGISLayer:function(arcgisLayerInfos){var me=this;var layers=[];for(var key in arcgisLayerInfos){var info=arcgisLayerInfos[key];var layer=SaigaiTask.Map.Layer.newLayerFromLayerInfo(info);layers.push(layer);}
layers.reverse();me.map.addLayers(layers);},addExternalMapLayer:function(externalMapLayerInfos,split){var me=this;var layers=[];for(var key in externalMapLayerInfos){var info=externalMapLayerInfos[key];if(!!!split||info.type==SaigaiTask.Map.Layer.Type.EXTERNAL_MAP_XYZ){var layer=SaigaiTask.Map.Layer.newLayerFromLayerInfo(info);layers.push(layer);}
else{var childLayerInfos=info.children;for(var key2 in childLayerInfos){var childLayerInfo=childLayerInfos[key2];childLayerInfo.wmsURL=info.wmsURL;var layer=SaigaiTask.Map.Layer.newLayerFromLayerInfo(childLayerInfo);layers.push(layer);}}}
layers.reverse();me.map.addLayers(layers);},replaceHref:function(str){return str.replace(/(https?\:\/\/[^\s|<]+)/ig,'<a href="#" onclick="openWin(\'$1\'); return false;">$1</a>');},getLayerScale:function(layerId){var layerInfo=this.getLayerInfo(layerId);if(layerInfo)return layerInfo.scale;return 10000;},getLayerScaleZoom:function(layerId){var layerScale=this.getLayerScale(layerId);if(layerScale==0)return this.contentsZoomLevel;return this.map.getZoomForResolution(OpenLayers.Util.getResolutionFromScale(layerScale,this.map.baseLayer.units),true);},getFilterFeatureIdsByForm:function(formId){var responseText=SaigaiTask.Map.util.jQueryUtil.submitForm('#'+formId);var json=eval("("+responseText+")");this.filter=json;console.log(json);for(var idx=0;idx<this.ecommaps.length;idx++){this.redrawContentsLayer(idx);}},initDrawToolbar:function(toolbarOptions){var me=this;return new SaigaiTask.Map.view.DrawToolbar(me,toolbarOptions);},readFeatureGeometryValue:function(selector){var wkt=jQuery(selector).val();var features=null;if(typeof wkt!="undefined"){var wktFormat=new OpenLayers.Format.WKT();features=wktFormat.read(wkt);}
return features;},writeFeatureGeometoryValue:function(feature){if(!feature)return;var me=this;var wkt=me.getWKT(feature);var featureId=feature.fid;switch(feature.geometry.CLASS_NAME){case"OpenLayers.Geometry.Point":case"OpenLayers.Geometry.LineString":case"OpenLayers.Geometry.Polygon":default:if(me.usejQuery){var c="."+featureId;var jqueryObj=jQuery(c);jqueryObj.val(wkt);}
break;}},getWKT:function(feature){if(!feature)return;feature=feature.clone();var geometry=feature.geometry;var wkt=null;switch(geometry.CLASS_NAME){case"OpenLayers.Geometry.Point":case"OpenLayers.Geometry.LineString":case"OpenLayers.Geometry.Polygon":default:feature.geometry.transform(new OpenLayers.Projection("EPSG:"+this.epsg),new OpenLayers.Projection("EPSG:4326"));var wktFormat=new OpenLayers.Format.WKT();wkt=wktFormat.write(feature);break;}
return wkt;},bindMapEvent:function(){if(!this.usejQuery)return;var m=this;jQuery(document).ready(function(){var mClass=m.div;var zoomInClass="."+mClass+"ZoomIn";console.log("zoomInClass: "+zoomInClass);var zoomInElems=jQuery(zoomInClass);zoomInElems.each(function(){jQuery(this).click(function(){m.zoomIn();});});var zoomOutClass="."+mClass+"ZoomOut";console.log("zoomOutClass: "+zoomOutClass);var zoomOutElems=jQuery(zoomOutClass);zoomOutElems.each(function(){jQuery(this).click(function(){m.zoomOut();});});var navigationClass="."+mClass+"Navigation";console.log("navigationClass: "+navigationClass);navigationElems=jQuery(navigationClass);navigationElems.each(function(){jQuery(this).click(function(){m.setNavigationControlActivation(true);});});var moveClass="."+mClass+"Move";console.log("moveClass: "+moveClass);moveElems=jQuery(moveClass);moveElems.each(function(){jQuery(this).click(function(){m.setDragPanControlActivation(true);});});});},addControl:function(control,key){if(typeof key!='undefined'){this.controls[key]=control;}
return this.map.addControl(control);},setControlActivation:function(control,activation){if(activation)return control.activate();else return control.deactivate();},getNavigationControlKey:function(){return"navigation";},deactivateMouseControl:function(){this.setNavigationControlActivation(false);this.setDragPanControlActivation(false);this.clickHandler.deactivate();var kmlSelectControl=this.controls.kmlSelectControl;if(kmlSelectControl.active){kmlSelectControl.deactivate();}
if(this.usejQuery){jQuery("#"+this.div).css("cursor","default");}},setNavigationControlActivation:function(activation){var key=this.getNavigationControlKey();var control=this.controls[key];if(!control)return;if(typeof activation=="undefined"){activation=!control.active;}
if(activation){this.deactivateMouseControl();this.clickHandler.activate();var kmlSelectControl=this.controls.kmlSelectControl;if(kmlSelectControl.active){kmlSelectControl.deactivate();}
kmlSelectControl.activate();}
return this.setControlActivation(control,activation);},setDragPanControlActivation:function(activation){var key=this.getNavigationControlKey();var control=this.controls[key];if(!control)return;if(typeof activation=="undefined"){activation=!control.active;}
if(activation){this.deactivateMouseControl();this.clickHandler.deactivate();if(this.usejQuery){jQuery("#"+this.div).css("cursor","move");}}
return this.setControlActivation(control,activation);},getCenter:function(){var center=this.map.getCenter();if(center==null)return null;return center.transform(this.map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326"));},setCenter:function(lonlat,zoomLevel){lonlat=lonlat.transform(new OpenLayers.Projection("EPSG:4326"),this.map.getProjectionObject());if(SaigaiTask.Map.util.CommonUtil.getParameter("popup")!=null||this.options.popupid!=null){zoomLevel=15;return this.map.setCenter(lonlat,zoomLevel);}else{return this.map.setCenter(lonlat,zoomLevel);}},pan:function(dx,dy,options){return this.map.pan(dx,dy,options);},panLeft:function(){return this.pan(-this.pandx,0);},panTop:function(){return this.pan(0,-this.pandy);},panRight:function(){return this.pan(this.pandx,0);},panBottom:function(){return this.pan(0,this.pandy);},panTR:function(){return this.pan(this.pandx,-this.pandy);},panTL:function(){return this.pan(-this.pandx,-this.pandy);},panBR:function(){return this.pan(this.pandx,this.pandy);},panBL:function(){return this.pan(-this.pandx,this.pandy);},zoomIn:function(){return this.map.zoomIn();},zoomOut:function(){return this.map.zoomOut();},zoomTo:function(zoom){return this.map.zoomTo(zoom);},zoomToExtent:function(bounds,closest){bounds=bounds.clone().transform(new OpenLayers.Projection("EPSG:4326"),this.map.getProjectionObject());if(this.map.baseLayer){return this.map.zoomToExtent(bounds,closest);}
return null;},getLayer:function(idx){var layers=this.map.layers;var layer=layers[idx];return layer;},setLayerVisibility:function(idx,visibility){var layer=this.getLayer(idx);layer.setVisibility(visibility);},getLayerVisibility:function(idx){var layer=this.getLayer(idx);return layer.getVisibility();},toggleLayerVisibility:function(idx){var visibility=!this.getLayerVisibility(idx);this.setLayerVisibility(idx,visibility);},toFront:function(layer){var me=this;var layers=me.map.layers,layersIdx=null,l,newZIndex=0;for(layersIdx in layers){l=layers[layersIdx];if(l.id==layer.id){newZIndex=Math.max(Number(l.getZIndex()),newZIndex);}
else{newZIndex=Math.max(Number(l.getZIndex())+1,newZIndex);}}
layer.setZIndex(newZIndex);},setBaseLayerById:function(layerId){if(layerId){var layer=this.baseLayer[layerId];return this.setBaseLayer(layer);}},setBaseLayer:function(layer){if(layer){var ecommap=this.ecommaps[0];var baseLayerInfos=ecommap.getBaseLayerInfos();for(var idx in baseLayerInfos){var baseLayerInfo=baseLayerInfos[idx];baseLayerInfo.visibility=(layer.layerInfo.layerId==baseLayerInfo.layerId);}
return this.map.setBaseLayer(layer);}},findContentsLayerInfo:function(ecommapIdx,layerId){var ecommap=this.ecommaps[ecommapIdx];var contentsLayers=ecommap.contentsLayers;for(var key in contentsLayers){var layer=contentsLayers[key];if(layer.layerId==layerId)return layer;}
return null;},setLayerSearchable:function(layerId,searchable){var me=this;var layerInfo=me.getLayerInfo(layerId);if(layerInfo!=null){layerInfo.searchable=searchable;}},toMapResolution:function(reso){if(this.epsg==4326)return reso;return reso*OpenLayers.INCHES_PER_UNIT.dd/OpenLayers.INCHES_PER_UNIT[this.map.units];},focus:function()
{this.map.div.tabIndex=0;this.map.div.focus();},isFocus:function()
{return document.activeElement==this.map.div;}};SaigaiTask.Map.Layer={newLayerFromLayerInfo:function(layerInfo){var layer=null;if(layerInfo){var type=layerInfo.type;for(var key in SaigaiTask.Map.Layer){if(typeof SaigaiTask.Map.Layer[key]=="function"&&typeof SaigaiTask.Map.Layer[key].type!="undefined"){var types=SaigaiTask.Map.Layer[key].type;if($.isArray(SaigaiTask.Map.Layer[key].type)==false)types=[SaigaiTask.Map.Layer[key].type];for(var typesIdx in types){if(type==types[typesIdx]){layer=new SaigaiTask.Map.Layer[key](layerInfo);break;}}}}
if(layer==null){layer=new SaigaiTask.Map.Layer.WMSLayer(layerInfo);}}
return layer;}};SaigaiTask.Map.Layer.Type={GROUP:0,LOCAL:1,LOCAL_GROUP:10,REFERENCE:51,REFERENCE_WMS:59,BASE_WMS:1100,TILED:1150,TILECACHE:1152,OSM:1153,GOOGLE:1155,WEBTIS:1160,BASE_XYZ:1170,BASE_XYZ:1170,KML:130,OVERLAY_WMS:100,OVERLAY_WMS_SINGLE:101,OVERLAY_TILED:150,OVERLAY_TILECACHE:151,OVERLAY_OSM:152,OVERLAY_XYZ:170,EXTERNAL_MAP_WMS:900,EXTERNAL_MAP_WMS_LAYERS:901,EXTERNAL_MAP_XYZ:910,EXTERNAL_MAP_ARCGIS_LAYERS:903,getBaseLayerTypes:function(){return[SaigaiTask.Map.Layer.Type.BASE_WMS,SaigaiTask.Map.Layer.Type.TILED,SaigaiTask.Map.Layer.Type.TILECACHE,SaigaiTask.Map.Layer.Type.OSM,SaigaiTask.Map.Layer.Type.GOOGLE,SaigaiTask.Map.Layer.Type.WEBTIS,SaigaiTask.Map.Layer.Type.BASE_XYZ];},isBaseLayerType:function(type){return jQuery.inArray(type,SaigaiTask.Map.Layer.Type.getBaseLayerTypes())!=-1;},getOverlayLayerTypes:function(){return[SaigaiTask.Map.Layer.Type.OVERLAY_WMS,SaigaiTask.Map.Layer.Type.OVERLAY_WMS_SINGLE,SaigaiTask.Map.Layer.Type.OVERLAY_TILED,SaigaiTask.Map.Layer.Type.OVERLAY_TILECACHE,SaigaiTask.Map.Layer.Type.OVERLAY_OSM,SaigaiTask.Map.Layer.Type.OVERLAY_XYZ];},isOverlayLayerType:function(type){return jQuery.inArray(type,SaigaiTask.Map.Layer.Type.getOverlayLayerTypes())!=-1;},getExternalmapLayerTypes:function(){return[SaigaiTask.Map.Layer.Type.EXTERNAL_MAP_WMS,SaigaiTask.Map.Layer.Type.EXTERNAL_MAP_WMS_LAYERS,SaigaiTask.Map.Layer.Type.EXTERNAL_MAP_XYZ,SaigaiTask.Map.Layer.Type.EXTERNAL_MAP_ARCGIS_LAYERS];},isExternalmapLayerType:function(type){return jQuery.inArray(type,SaigaiTask.Map.Layer.Type.getExternalmapLayerTypes())!=-1;},getArcGISLayerTypes:function(){return[SaigaiTask.Map.Layer.Type.EXTERNAL_MAP_ARCGIS_LAYERS];},isArcGISLayerType:function(type){return jQuery.inArray(type,SaigaiTask.Map.Layer.Type.getArcGISLayerTypes())!=-1;}};OpenLayers.Layer.XYZZoom=OpenLayers.Class(OpenLayers.Layer.Grid,{isBaseLayer:true,sphericalMercator:false,zoomOffset:0,serverResolutions:null,maxZoomLevel:22,orgTileSize:null,initialize:function(name,url,options){if(options&&options.sphericalMercator||this.sphericalMercator){options=OpenLayers.Util.extend({projection:"EPSG:900913",numZoomLevels:22},options);}
if(options){if(options.maxZoomLevel>0)this.maxZoomLevel=options.maxZoomLevel;delete options.maxZoomLevel;}
OpenLayers.Layer.Grid.prototype.initialize.apply(this,[name||this.name,url||this.url,{},options]);},clone:function(obj){if(obj==null){obj=new OpenLayers.Layer.XYZ(this.name,this.url,this.getOptions());}
obj=OpenLayers.Layer.Grid.prototype.clone.apply(this,[obj]);return obj;},getURL:function(bounds){var xyz=this.getXYZ(bounds);var url=this.url;if(OpenLayers.Util.isArray(url)){var s=''+xyz.x+xyz.y+xyz.z;url=this.selectUrl(s,url);}
return OpenLayers.String.format(url,xyz);},getXYZ:function(bounds){bounds=this.adjustBounds(bounds);var res=this.getServerResolution();var x=Math.round((bounds.left-this.maxExtent.left)/(res*this.tileSize.w));var y=Math.round((this.maxExtent.top-bounds.top)/(res*this.tileSize.h));var z;if(this.map.getZoom()>this.maxZoomLevel){z=this.maxZoomLevel;if(this.zoomOffset)z+=this.zoomOffset;}else{z=this.getServerZoom();}
if(this.wrapDateLine){var limit=Math.pow(2,z);x=((x%limit)+limit)%limit;}
return{'x':x,'y':y,'z':z};},setMap:function(map){OpenLayers.Layer.Grid.prototype.setMap.apply(this,arguments);if(!this.tileOrigin){this.tileOrigin=new OpenLayers.LonLat(this.maxExtent.left,this.maxExtent.bottom);}},moveTo:function(bounds,zoomChanged,dragging){if(zoomChanged){var dz=this.map.getZoom()-this.maxZoomLevel;if(dz>0){var rate=Math.pow(2,dz);this.tileSize=new OpenLayers.Size(this.orgTileSize.w*rate,this.orgTileSize.h*rate);}else{this.tileSize=this.orgTileSize;}}
return OpenLayers.Layer.Grid.prototype.moveTo.apply(this,arguments);},setTileSize:function(size){OpenLayers.Layer.Grid.prototype.setTileSize.apply(this,[size]);this.orgTileSize=this.tileSize;},CLASS_NAME:"OpenLayers.Layer.XYZZoom"});OpenLayers.Layer.GSITile=OpenLayers.Class(OpenLayers.Layer.XYZZoom,{gsiInfos:{STD:{url:"http://cyberjapandata.gsi.go.jp/xyz/std/${z}/${x}/${y}.png",maxZoomLevel:18},ORT:{url:"http://cyberjapandata.gsi.go.jp/xyz/ort/${z}/${x}/${y}.jpg",maxZoomLevel:18},GAZO1:{url:"http://cyberjapandata.gsi.go.jp/xyz/gazo1/${z}/${x}/${y}.jpg",maxZoomLevel:17},GAZO2:{url:"http://cyberjapandata.gsi.go.jp/xyz/gazo2/${z}/${x}/${y}.jpg",maxZoomLevel:17},GAZO3:{url:"http://cyberjapandata.gsi.go.jp/xyz/gazo3/${z}/${x}/${y}.jpg",maxZoomLevel:17},GAZO4:{url:"http://cyberjapandata.gsi.go.jp/xyz/gazo4/${z}/${x}/${y}.jpg",maxZoomLevel:17},TOHO1:{url:"http://cyberjapandata.gsi.go.jp/xyz/toho1/${z}/${x}/${y}.jpg",maxZoomLevel:17},TOHO2:{url:"http://cyberjapandata.gsi.go.jp/xyz/toho2/${z}/${x}/${y}.jpg",maxZoomLevel:18},TOHO3:{url:"http://cyberjapandata.gsi.go.jp/xyz/toho3/${z}/${x}/${y}.jpg",maxZoomLevel:18},TOHO4:{url:"http://cyberjapandata.gsi.go.jp/xyz/toho4/${z}/${x}/${y}.jpg",maxZoomLevel:18},PALE:{url:"http://cyberjapandata.gsi.go.jp/xyz/pale/${z}/${x}/${y}.png",maxZoomLevel:18},BLANK:{url:"http://cyberjapandata.gsi.go.jp/xyz/blank/${z}/${x}/${y}.png",maxZoomLevel:14}},BLANK_MAP_URL:"http://cyberjapandata.gsi.go.jp/xyz/blank/${z}/${x}/${y}.png",type:"STD",GSI_ATTRIBUTION:((("<a href=\"https://maps.gsi.go.jp/development/ichiran.html\" target=\"_blank\">国土地理院</a>"))),initialize:function(name,type,options)
{this.type=type;var gsiInfo=this.gsiInfos[type];if(!options)options={};options.projection="EPSG:900913";this.url=gsiInfo.url;this.maxZoomLevel=gsiInfo.maxZoomLevel;this.attribution=this.GSI_ATTRIBUTION;OpenLayers.Layer.Grid.prototype.initialize.apply(this,[name||this.name,this.url,{},options]);},clone:function(obj){if(obj==null){obj=new OpenLayers.Layer.GSITile(this.name,this.url,this.getOptions());}
obj=OpenLayers.Layer.XYZZoom.prototype.clone.apply(this,[obj]);return obj;},getURL:function(bounds){var xyz=this.getXYZ(bounds);var url=this.url;if(window.location.protocol=="https:"){url=url.replace("http:","https:")}
if(this.type=="PALE"){if(xyz.z<12){url=this.gsiInfos.STD.url;}}else if(this.type!="STD"&&this.type!="ORT"){if(xyz.z<10||(this.type!="GAZO1"&&xyz.z<15)){url=this.BLANK_MAP_URL;}}
if(OpenLayers.Util.isArray(url)){var s=''+xyz.x+xyz.y+xyz.z;url=this.selectUrl(s,url);}
return OpenLayers.String.format(url,xyz);},moveTo:function(bounds,zoomChanged,dragging){if(zoomChanged){var z=this.map.getZoom();var update=this.attribution==this.GSI_ATTRIBUTION;if(this.type=="STD"&&5<=z&&z<=8){this.attribution="The bathymetric contours are derived from those contained within the GEBCO Digital Atlas,"
+"published by the BODC on behalf of IOC and IHO (2003) (http://www.gebco.net)<br/>"
+((("海上保安庁許可第２２２５１０号（水路業務法第２５条に基づく類似刊行物）<br/>")))
+this.GSI_ATTRIBUTION;}else if(this.type=="ORT"&&5<=z&&z<=12){this.attribution=((("データソース：Landsat8画像(GSI,TSIC,GEO Grid/AIST), 海底地形(GEBCO)<br/>")))
+this.GSI_ATTRIBUTION;}else{this.attribution=this.GSI_ATTRIBUTION;}
if(update){var controls=this.map.controls;for(var i=0;i<controls.length;i++){if(controls[i].updateAttribution)controls[i].updateAttribution();}}}
return OpenLayers.Layer.XYZZoom.prototype.moveTo.apply(this,arguments);},CLASS_NAME:"OpenLayers.Layer.GSITile"});SaigaiTask.Map.Layer.WebtisLayer=new OpenLayers.Class(OpenLayers.Layer.GSITile,{layerInfo:null,initialize:function(layerInfo){this.layerInfo=layerInfo;OpenLayers.Layer.GSITile.prototype.initialize.apply(this,[layerInfo.name,layerInfo.featuretypeId]);}});SaigaiTask.Map.Layer.WebtisLayer.type=SaigaiTask.Map.Layer.Type.WEBTIS;SaigaiTask.Map.API=OpenLayers.Class({contextPath:null,stmap:null,initialize:function(contextPath){var me=this;me.contextPath=contextPath;for(var subApiName in SaigaiTask.Map.API){var subApi=SaigaiTask.Map.API[subApiName];if(typeof subApi=="function"){var subApiVarName=subApiName.toLowerCase()
me[subApiVarName]=new subApi(me);}}},errorMsg:function(jqXHR){return"\n\n[HTTP status code "+jqXHR.status+"]";},showError:function(jqXHR){alert(lang.__("Failed to get data.<!--2-->")+this.errorMsg(jqXHR));},getEcommapInfo:function(mapId,success){var me=this;var url=me.url.ecommapInfoURL;jQuery.ajax(url,{async:true,dataType:"json",data:{mapId:mapId},success:function(data,textStatus,jqXHR){if(jQuery.isFunction(success)){success(data);}},error:function(jqXHR,status,errorThrown){if(jqXHR.status!=0){alert(lang.__("Failed to get initialization map data. (mapId=")+mapId+")"+me.errorMsg(jqXHR));}
console.error(errorThrown);}});},getContent:function(mid,layer,fid,center,bbox,success){try{var me=this;var layerInfo=me.stmap.getLayerInfo(layer);if(!layerInfo)return;var url=this.url.contentsGetURL;url+="?"+"layer="+layer+"&fid="+fid;if(mid!=null){url+="&mid="+mid;}
var time=layerInfo.getTime();if(time==null)time=SaigaiTask.PageURL.getTime();if(!!time){var iso8601Time=time.toISOString();if(SaigaiTask.PageURL.CONFIG_SHIFT_TIMEZONE_OFFSET){iso8601Time=new Date(time-time.getTimezoneOffset()*60*1000).toISOString();}
if(!!time)url+="&time="+iso8601Time;}
jQuery.ajax(url,{async:true,dataType:"json",cache:false,success:function(data,textStatus,jqXHR){if(jQuery.isFunction(success)){success(data);}},error:function(jqXHR,status,errorThrown){var errorMsg="\n\n[HTTP status code "+jqXHR.status+"]";alert(lang.__("Failed to get data.<!--2-->")+errorMsg);console.error(errorThrown);}});}catch(e){console.error(e);}},deleteContent:function(layer,fid,success){try{var url=this.url.contentsDeleteURL;jQuery.ajax(url,{async:true,data:{layer:layer,fid:fid},cache:false,success:function(data,textStatus,jqXHR){if(jQuery.isFunction(success)){success(data);}},error:function(jqXHR,status,errorThrown){var errorMsg="\n\n[HTTP status code "+jqXHR.status+"]";alert(lang.__("Failed to delete data.")+errorMsg);console.error(errorThrown);}});}catch(e){console.error(e);}},searchContentsByBbox:function(bbox,cid,mid,layerIds,rule,limit,async,success){var me=this;var url=me.url.contentsBboxURL+"?";url+="bbox="+(bbox.join(","));url+="&cid="+cid;url+="&mid="+mid;url+="&layers="+layerIds.join(',');url+="&rule="+rule;url+="&limit="+limit;url+="&noname=true";var me=this;var layertimes="";for(var idx in layerIds){var layerId=layerIds[idx];var layerInfo=me.stmap.getLayerInfo(layerId);if(layerInfo.time!=null){if(layertimes.length!=0)layertimes+=",";var time=layerInfo.getTime();var iso8601Time=time.toISOString();if(SaigaiTask.PageURL.CONFIG_SHIFT_TIMEZONE_OFFSET){iso8601Time=new Date(time-time.getTimezoneOffset()*60*1000).toISOString();}
layertimes+=layerId+","+iso8601Time;}}
if(0<layertimes.length){url+="&layertimes="+layertimes;}
var time=SaigaiTask.PageURL.getTime();if(!!time){var iso8601Time=time.toISOString();if(SaigaiTask.PageURL.CONFIG_SHIFT_TIMEZONE_OFFSET){iso8601Time=new Date(time-time.getTimezoneOffset()*60*1000).toISOString();}
if(!!time)url+="&time="+iso8601Time;}
var result=null;jQuery.ajax(url,{async:async,dataType:"json",success:function(data,textStatus,jqXHR){var result=data;if(jQuery.isFunction(success)){success(result);}},error:function(jqXHR,status,errorThrown){var errorMsg="\n\n[HTTP status code "+jqXHR.status+"]";alert(lang.__("Failed to get data.<!--2-->")+errorMsg);console.error(errorThrown);}});if(async==false){return result;}},searchContents:function(){},getContentsSearchRangeWKT:function(params){var me=this;var wkt=null;var url=me.url.contentsSearchRangeWKTURL;jQuery.ajax(url,{dataType:"json",data:params,async:false,success:function(data){wkt=data.items.wkt;}});return wkt;},getAttrInfos:function(layerId){var url=this.url.attrInfoURL;var json=null;jQuery.ajax({url:url,type:"GET",async:false,cache:false,dataType:"json",data:{layer:layerId},success:function(data){json=data;}});return json;},getLayerLastUpdateTime:function(layerInfo){var url=this.url.layerLastUpdateTimeURL;var time=layerInfo.getTimeParam();var json=null;jQuery.ajax({url:url,type:"GET",async:false,cache:false,dataType:"json",data:{layer:layerInfo.layerId,attrIds:layerInfo.updatecolumn,time:time},success:function(data){json=data;}});return json;},getSld:function(mid,layerId){var url=this.url.sldURL;url+="?mid="+mid+"&layer="+layerId;var result=null;jQuery.ajax(url,{dataType:"text",async:false,success:function(data){result=data;}});return result;},createPdf:function(params,success){var url=SaigaiTask.contextPath+"/PdfServlet";var defaultParams={prev_row:0,prev_col:0,printmap:1,printlegend:1,maptitle:"",titlealign:0,titlefontauto:1,description:"",descalign:2,descfontauto:1,pagesize:"a4",rotate:1,rows:1,cols:1,mapmt:5,mapmb:5,mapml:5,mapmr:5,iconrate:1.0,linerate:1.0,scalealign:4,legendcolauto:1,legendrate:0.8,legendpos:3,legendcontents:10,legendref:10,legendbase:10,legendmapmt:3,legendmapmb:3,legendmapmr:3,legendmapml:3,legendmt:10,legendmb:10,legendml:10,legendmr:10,listmt:10,listmb:10,listml:10,listmr:10,listcolauto:1,listfile:1,listlayers:["c11","c13"],header_l:null,header_l_text:"",header_c:null,header_c_text:"",header_r:null,header_r_text:"",fpage:1,fmappage:1,memoVisible:true,index_enabled:0,index_h:2,index_cols:6,index_v:1,index_rows:6,time:null,layertimes:null,rule:null,contentslayers:"",reflayers:"",kmllayers:"",overlaylayers:"",baselayer:""};var data={};Ext.applyIf(data,params);Ext.applyIf(data,defaultParams);$.ajax({url:url,type:"post",data:data,success:function(data,textStatus,jqXHR){if(jQuery.isFunction(success)){success(data);}}});},updateMetadata:function(layerId){var url=this.url.metadataUpdateURL;url+="?layer="+layerId;jQuery.ajax(url,{dataType:"text",async:true,success:function(result){console.log("updateMetadata: "+result)}});},intersection:function(wkt,layerId){var url=this.url.intersectionURL;var result=null;jQuery.ajax(url,{type:"post",dataType:"json",async:false,data:{wkt:wkt,layer:layerId},success:function(data){result=data;},error:function(data){throw lang.__("An error occurred in cropping.");}});return result;},mgrs2lonlat:function(mgrs){var url=this.url.mgrs2lonlatURL;var result=null;jQuery.ajax(url,{type:"get",dataType:"json",async:false,data:{mgrs:mgrs},success:function(data){result=data;},error:function(data){throw lang.__("An error occurred during the conversion MGRS code into coordinates.");}});return result;},landmarkValid:function(){var url=this.url.landmarkValidURL;var defer=jQuery.Deferred();jQuery.ajax(url,{type:"post",dataType:"json",async:true,success:defer.resolve,error:defer.reject});return defer.promise();},landmarkRegist:function(landmark,lon,lat){var url=this.url.landmarkRegistURL;var defer=jQuery.Deferred();jQuery.ajax(url,{type:"post",dataType:"json",async:true,data:{landmarkData:JSON.stringify([{landmark:landmark,lon:lon,lat:lat}])},success:defer.resolve,error:defer.reject});return defer.promise();},landmarkSearch:function(landmark){var url=this.url.landmarkSearchURL;var defer=jQuery.Deferred();jQuery.ajax(url,{type:"post",dataType:"json",async:false,data:{landmarkData:JSON.stringify([{landmark:landmark}])},success:defer.resolve,error:defer.reject});return defer.promise();}});SaigaiTask.Map.API.Rakugaki=OpenLayers.Class({api:null,initialize:function(api){var me=this;me.api=api;},save:function(kml){var me=this;var url=me.api.contextPath+"/page/map/rakugaki/save/";var result=null;jQuery.ajax(url,{type:"post",dataType:"json",async:false,data:{kml:kml},success:function(data){result=data;},error:function(data){throw lang.__("Unable to save memo KML.");}});return result;},download:function(option){var me=this;var defaultOption={url:me.api.contextPath+"/page/map/rakugaki/download/",type:"get",dataType:"xml",async:false,success:function(data){result=data;},error:function(data){throw lang.__("Unable to download memo KML.");}}
Ext.applyIf(option,defaultOption);var result=null;jQuery.ajax(option);return result;},lock:function(){var me=this;var defer=jQuery.Deferred();jQuery.ajax({url:me.api.contextPath+"/page/map/rakugaki/lock",type:"get",dataType:"json",async:true,cache:false,success:defer.resolve,error:defer.reject});return defer.promise();},unlock:function(){var me=this;var defer=jQuery.Deferred();jQuery.ajax({url:me.api.contextPath+"/page/map/rakugaki/unlock",type:"get",dataType:"json",async:true,cache:false,success:defer.resolve,error:defer.reject});return defer.promise();}});SaigaiTask.Map.SaigaiTaskAPI=OpenLayers.Class(SaigaiTask.Map.API,{contextPath:null,url:{ecommapInfoURL:"/map/ecommap/info",contentsGetURL:"/map/ecommap/contents/get",contentsCreateURL:"/map/contents/create/",contentsUpdateURL:"/map/ecommap/contents/update",contentsDeleteURL:"/map/ecommap/contents/delete",contentsBboxURL:"/map/ecommap/contents/bbox",contentsSearchURL:"/map/ecommap/contents/search",contentsSearchRangeWKTURL:"/map/ecommap/contents/search/range/wkt",attrInfoURL:"/map/ecommap/attrInfo",sldURL:"/map/ecommap/sld",wfsProxyURL:"/map/ecommap/wfsProxy?&url=",layoutURL:"/map/layout/",pointInfoURL:"/map/pointinfo/"},initialize:function(contextPath){var me=this;me.contextPath=contextPath;var url=me.url;me.url={};for(var idx in url){me.url[idx]=contextPath+url[idx];}},loadLayout:function(data,success){var url=this.url.layoutURL;jQuery.ajax(url,{dataType:"json",data:data,cache:false,async:false,success:function(layout){if(jQuery.isFunction(success)){success(layout);}},error:function(data){}});},saveLayout:function(data){var url=this.url.layoutURL;return jQuery.ajax(url,{dataType:"json",cache:false,data:SaigaiTask.Map.param(data),success:function(data){},error:function(data){}});}});SaigaiTask.Map.SaigaiTask2API=OpenLayers.Class(SaigaiTask.Map.API,{contextPath:null,url:{contentsGetURL:"/page/map/ecommap/contents/get",contentsCreateURL:"/page/map/ecommap/contents/create",contentsUpdateURL:"/page/map/ecommap/contents/update",contentsDeleteURL:"/page/map/ecommap/contents/delete",contentsBboxURL:"/page/map/ecommap/contents/bbox",contentsSearchRangeWKTURL:"/page/map/ecommap/contents/search/range/wkt",attrInfoURL:"/page/map/ecommap/attrInfo",layerLastUpdateTimeURL:"/page/map/ecommap/updatetime",sldURL:"/page/map/ecommap/sld",wfsProxyURL:"/page/map/ecommap/wfsProxy?session_token="+SaigaiTask.csrfToken+"&_csrf="+$("meta[name='_csrf']").attr("content")+"&url=",metadataUpdateURL:"/page/map/updatemetadata",intersectionURL:"/page/map/intersection",pointInfoURL:"/page/map/pointinfo/",mgrs2lonlatURL:"/page/map/mgrs2lonlat",rakugakiSaveURL:"/map/rakugaki/save/",landmarkValidURL:"/page/map/landmark/valid/",landmarkRegistURL:"/page/map/landmark/regist/",landmarkSearchURL:"/page/map/landmark/search/"},initialize:function(contextPath){var me=this;me.contextPath=contextPath;var url=me.url;me.url={};for(var idx in url){me.url[idx]=contextPath+url[idx];}
SaigaiTask.Map.API.prototype.initialize.apply(this,[contextPath]);}});SaigaiTask.Map.Layer.TimeSeriesType={NONE:0,INSTANT:10,PERIOD:11,HISTORY:20};SaigaiTask.PageURL.CONFIG_SHIFT_TIMEZONE_OFFSET=false;OpenLayers.Control.SelectDragFeature=OpenLayers.Class(OpenLayers.Control.SelectFeature,{dragCallbacks:{},featureCallbacks:{},keyboardCallbacks:{},mouseFeature:null,directTouch:false,initialize:function(layers,options){var me=this;OpenLayers.Control.prototype.initialize.apply(this,[options]);if(this.scope===null){this.scope=this;}
this.initLayer(layers);this.handlers={drag:new OpenLayers.Handler.Drag(this,OpenLayers.Util.extend({down:function(pixel){me.downFeature(pixel);},move:function(pixel){me.moveFeature(pixel);},up:function(pixel){if(me.directTouch){me.upFeature(pixel);me.outFeature();me.handlers.drag.deactivate();}
else{return me.upFeature(pixel);}},out:function(pixel){me.cancel(pixel);},done:function(pixel){me.doneDragging(pixel);}},this.dragCallbacks),{documentDrag:this.documentDrag}),feature:new OpenLayers.Handler.Feature(this,this.layer,OpenLayers.Util.extend({dblclick:this.dblclickFeature,clickout:function(){if(me.isTouchDevice()){me.handlers.drag.deactivate();}
me.clickoutFeature();},over:this.overFeature,out:this.outFeature},this.featureCallbacks),{geometryTypes:this.geometryTypes}),keyboard:new OpenLayers.Handler.Keyboard(this,{keydown:this.keydown})};if(this.box){this.handlers.box=new OpenLayers.Handler.Box(this,{done:this.selectBox},{boxDivClassName:"olHandlerBoxSelectFeature"});}
if(!me.isTouchDevice()){me.handlers.feature.touchstart=null;}
else{me.handlers.feature.callbacks.click=function(feature){me.directTouch=false;if(me.isTouchDevice()){if(me.handlers.drag.active==false){me.directTouch=true;var evt=me.handlers.feature.evt;me.handlers.drag.evt=evt;me.overFeature(feature);var evt=me.handlers.feature.evt;me.handlers.drag.dragstart(evt)}}
return false;};}
var drag=this.handlers.drag;drag._activate=drag.activate;drag.activate=function(){console.log("[drag] activate");return drag._activate();};drag._deactivate=drag.deactivate;drag.deactivate=function(){console.log("[drag] deactivate");return drag._deactivate();};},activate:function(){if(!this.active){if(this.layers){this.map.addLayer(this.layer);}
this.handlers.feature.activate();this.handlers.keyboard.activate();if(this.box){this.handlers.box.activate();}}
return OpenLayers.Control.prototype.activate.apply(this,arguments);},deactivate:function(){if(this.active){this.handlers.feature.deactivate();this.handlers.keyboard.deactivate();this.handlers.drag.deactivate();if(this.box)this.handlers.box.deactivate();this.mouseFeature=null;if(this.layers){this.map.removeLayer(this.layer);}}
return OpenLayers.Control.prototype.deactivate.apply(this,arguments);},isTouchDevice:function(){return'ontouchstart'in document.documentElement;},overFeature:function(feature){if(!this.handlers.drag.dragging){this.handlers.drag.activate();this.over=true;this.mouseFeature=feature;OpenLayers.Element.addClass(this.map.viewPortDiv,this.displayClass+"Over");}else{if(this.box)this.handlers.box.deactivate();if(this.mouseFeature&&feature&&this.mouseFeature.id==feature.id){this.over=true;}else{this.over=false;}}
if(this.hover&&feature){if(this.highlightOnly){this.highlight(feature);}else if(OpenLayers.Util.indexOf(feature.layer.selectedFeatures,feature)==-1){this.select(feature);}}},outFeature:function(feature){if(!this.handlers.drag.dragging){this.over=false;this.mouseFeature=null;if(!this.directTouch)this.handlers.drag.deactivate();OpenLayers.Element.removeClass(this.map.viewPortDiv,this.displayClass+"Over");}else{if(this.mouseFeature&&this.mouseFeature.id==feature.id){this.over=false;}}
if(this.box)this.handlers.box.activate();if(this.hover){if(this.highlightOnly){if(feature._lastHighlighter==this.id){if(feature._prevHighlighter&&feature._prevHighlighter!=this.id){delete feature._lastHighlighter;var control=this.map.getControl(feature._prevHighlighter);if(control){control.highlight(feature);}}else{this.unhighlight(feature);}}}else{this.unselect(feature);}}},outFeatureByKey:function()
{this.mouseFeature=null;},onDblClick:function(){},dblclickFeature:function(feature){this.onDblClick(feature);},onKeyDown:function(){},keydown:function(evt)
{this.onKeyDown(evt);},downFeature:function(pixel){this.lastPixel=pixel;if(!!this.mouseFeature){var evtFeature=this.layer.getFeatureFromEvent(this.handlers.drag.evt);if(this.mouseFeature!=evtFeature){this.mouseFeature=evtFeature;}
if(!this.mouseFeature){this.handlers.feature.layer.selectedFeatures=[];}}
if(!this.mouseFeature){this.mouseFeature=this.layer.getFeatureFromEvent(this.handlers.drag.evt);if(!this.mouseFeature){this.outFeature();return;}
this.mouseFeature.layer=this.layer;this.overFeature(this.mouseFeature);}
var selected=OpenLayers.Util.indexOf(this.mouseFeature.layer.selectedFeatures,this.mouseFeature)!=-1;if(selected){if(this.handlers.drag.evt[this.toggleKey]){this.unselect(this.mouseFeature);}}else{if(this.handlers.drag.evt[this.toggleKey]){this.select(this.mouseFeature);}else{this.clickFeature(this.mouseFeature);}}
this.onStart(this.mouseFeature,pixel,this.handlers.drag.evt[this.toggleKey]);},moveFeature:function(pixel){var me=this;var res=this.map.getResolution();for(var i=this.layer.selectedFeatures.length-1;i>=0;i--){feature=this.layer.selectedFeatures[i];if(feature.geometry){feature.geometry.move(res*(pixel.x-this.lastPixel.x),res*(this.lastPixel.y-pixel.y));}
this.layer.drawFeature(feature);}
this.lastPixel=pixel;this.onDrag(pixel);},upFeature:function(pixel){if(!this.over){if(!this.isTouchDevice())this.handlers.drag.deactivate();}},doneDragging:function(pixel){this.onComplete(pixel);},cancel:function(){if(!this.isTouchDevice())this.handlers.drag.deactivate();this.over=false;},setMap:function(map){this.handlers.feature.setMap(map);this.handlers.drag.setMap(map);this.handlers.keyboard.setMap(map);if(this.box)this.handlers.box.setMap(map);OpenLayers.Control.prototype.setMap.apply(this,arguments);},CLASS_NAME:"OpenLayers.Control.SelectDragFeature"});SaigaiTask.Map.view={};SaigaiTask.Map.view.Popup=new OpenLayers.Class({popup:null,panel:null,initialize:function(){},createPopupId:function(){return'extpopup-'+Ext.id();},showExtPopup:function(options){var me=this;var map=options.map;var stmap=map;var olmap=options.olmap;var center=options.center;var items=options.items;var toolbarData=options.toolbarData;var panelWidth=options.panelWidth;var title=options.title;var pinned=(options.pinned==true);console.log('options');console.log(options);var popupLonLat=center.clone();var size=options.size;if(!size)size=new OpenLayers.Size(300,200);var popupId=this.createPopupId();popupLonLat=popupLonLat.transform(new OpenLayers.Projection("EPSG:4326"),olmap.getProjectionObject());var popup=me.popup=new OpenLayers.Popup.FramedCloud("popup",popupLonLat,size,"<div id='"+popupId+"'></div>");popup.panMapIfOutOfView=true;olmap.addPopup(popup,false);popup.hide();popup.setSize(size);popup.events.un({mouseup:popup.onmouseup});popup.onmouseup=function(evt){if(this.mousedown){this.mousedown=false;}};popup.events.on({mouseup:popup.onmouseup});var popupManager=map.popupManager;if(popupManager==null){popupManager=new SaigaiTask.Map.control.PopupManager(map);}
popupManager.add(popup);if(pinned){popupManager.pin(popup);}
var openLink=function(url,TB_iframe){if(url){var urlObj=SaigaiTask.parseURL(url);if(typeof urlObj.searchObject.time!="undefined"){var time=urlObj.searchObject.time;if(time==""){var time=SaigaiTask.PageURL.getTime();if(!!time){var iso8601Time=time.toISOString();if(SaigaiTask.PageURL.CONFIG_SHIFT_TIMEZONE_OFFSET){iso8601Time=new Date(time-time.getTimezoneOffset()*60*1000).toISOString();}
time=iso8601Time;urlObj.searchObject.time=iso8601Time;url=urlObj.toURL();}}}
if(typeof TB_iframe!="undefined"){if(TB_iframe){if(url.indexOf('?')>0)
url=url+"&TB_iframe=false&width=950&height=700";else
url=url+"?TB_iframe=true&width=950&height=700";}
tb_show("",url);}
else{window.open(url);}}};var toolbar=null;if(toolbarData){toolbar=new Array();var buttonDataArray=new Array();if(jQuery.isArray(toolbarData.buttons)){buttonDataArray=buttonDataArray.concat(toolbarData.buttons);};for(var buttonDataArrayKey in buttonDataArray){var buttonData=buttonDataArray[buttonDataArrayKey];var opened=false;var button=(function(buttonData){var button=null;switch(buttonData.type){case"link":var handler=function(){openLink(buttonData.url,buttonData.TB_iframe);};button=Ext.create("Ext.Button",{text:buttonData.text,iconCls:'file-icon',enableToggle:false,handler:handler});if(buttonData.open){handler();opened=true;}
break;case"search":break;default:button=Ext.create("Ext.Button",buttonData);break;}
return button;})(buttonData);if(opened)return;toolbar.push(button);}
if(SaigaiTask.Map.view.Popup.searchButton){var button=Ext.create("Ext.Button",{text:lang.__("Search"),iconCls:'search-icon',enableToggle:false,handler:function(){if(stmap.popupManager!=null){stmap.popupManager.closeAll();}
var contentsSearchView=new SaigaiTask.Map.view.ContentsSearch(map);contentsSearchView.show({searchForm:options});}});toolbar.push(button);}}
Ext.onReady(function(){popup.show();popup.panIntoView();var margin=50;var mapMaxWidth=olmap.getSize().w-margin;var mapMaxHeight=olmap.getSize().h-margin-80;var maxWidth=mapMaxWidth;var maxHeight=mapMaxHeight;me.panel=Ext.create("Ext.panel.Panel",{renderTo:popupId,width:panelWidth,autoScroll:true,maxWidth:maxWidth,maxHeight:maxHeight<600?maxHeight:600,collapsible:true,title:(typeof title!="undefined"&&title!=null)?title:"",header:true,tools:[{type:'pin',hidden:pinned,handler:function(event,toolEl,owner,tool){popupManager.pin(popup);tool.hide();owner.child('tool[type=unpin]').show();}},{type:'unpin',hidden:!pinned,handler:function(event,toolEl,owner,tool){popupManager.unpin(popup);tool.hide();owner.child('tool[type=pin]').show();}},{type:'close',handler:function(event,toolEl,owner,tool){popupManager.close(popup);}}],tbar:toolbar,layout:{type:'vbox',align:'stretch'},items:items,listeners:{resize:function(self,width,height,oldWidth,oldHeight,eOpts){var margin=25;var size=new OpenLayers.Size(width+margin,height+margin);popup.setSize(size);SaigaiTask.Map.util.jQueryUtil.visibility('#'+popup.id,true);}}});if(!options.div==false){me.panel.update($("<div>").append(options.div).html());}});return popup;}});SaigaiTask.Map.view.Popup.searchButton=true;SaigaiTask.Map.view.KMLPopup=new OpenLayers.Class(SaigaiTask.Map.view.Popup,{stmap:null,initialize:function(stmap){this.stmap=stmap;},show:function(feature,layerInfo){var me=this;var stmap=me.stmap;if(stmap.popupManager!=null){stmap.popupManager.closeAll();}
try{var lonlat=feature.geometry.getBounds().getCenterLonLat().clone();if(me.stmap.epsg!=4326)lonlat.transform(me.stmap.map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326"));var popupDiv=document.createElement('div');var div,span;div=document.createElement('div');div.className="popup_attr";if(feature.attributes.description){div.innerHTML=(feature.attributes.name?"<h3>"+SaigaiTask.Map.util.CommonUtil.escapeXml(feature.attributes.name)+"</h3>":"")
+feature.attributes.description.replace(/<\s*a\s+/ig,'<a target="_blank" ').replace(/onclick\s*=\s*"[^"]*"/ig,'');}else if(feature.attributes.name){div.innerHTML="<h3>"+SaigaiTask.Map.util.CommonUtil.escapeXml(feature.attributes.name)+"</h3>";}
try{var tbody=null;var td;for(var key in feature.attributes){if(key!="name"&&key!="description"&&key!="styleUrl"){if(feature.attributes[key].value){if(!tbody)tbody=document.createElement('tbody');var attrTr=document.createElement('tr');td=document.createElement('td');attrTr.appendChild(td);td.innerHTML=key;td=document.createElement('td');td.innerHTML=feature.attributes[key].value;attrTr.appendChild(td);tbody.appendChild(attrTr);}}}
if(tbody){table=document.createElement('table');table.cellSpacing=0;table.cellPadding=0;table.appendChild(tbody);div.appendChild(table);}}catch(e){}
popupDiv.appendChild(div);var panel=Ext.create('Ext.panel.Panel',{width:200,contentEl:popupDiv});var option={map:me.stmap,olmap:me.stmap.map,center:lonlat,items:[panel],title:layerInfo.name,pinned:false};me.showExtPopup(option);}catch(e){console.error(e);}},CLASS_NAME:"SaigaiTask.Map.view.KMLPopup"});SaigaiTask.Map.control={};SaigaiTask.Map.control.PdfControl=new OpenLayers.Class(OpenLayers.Control,{stmap:null,printWindow:null,printPreviewWindow:null,initialize:function(stmap){var me=this;me.stmap=stmap;me.printWindow=new SaigaiTask.Map.view.PrintWindow(me);if(location.href.indexOf("http://localhost")==0){me.printWindow=new SaigaiTask.Map.view.PrintPreviewWindow(me);}},show:function(){var me=this;me.printWindow.win.show();},buildPdfParams:function(params,layerInfo){var me=this;var time=SaigaiTask.PageURL.getTime();if(!time)time=new Date();var iso8601Time=new Date(time).toISOString();if(SaigaiTask.PageURL.CONFIG_SHIFT_TIMEZONE_OFFSET){iso8601Time=new Date(time-time.getTimezoneOffset()*60*1000).toISOString();}
switch(layerInfo.type){case SaigaiTask.Map.Layer.Type.LOCAL:var contentsLayerInfo=layerInfo;if(contentsLayerInfo.visibility==true){if(0<params.contentslayers.length)params.contentslayers=","+params.contentslayers;params.contentslayers=contentsLayerInfo.layerId+params.contentslayers;if(contentsLayerInfo.filterkey!=null){params.filterkey=contentsLayerInfo.filterkey;params.filterLayerId=contentsLayerInfo.layerId;}
params.time=iso8601Time;if(typeof contentsLayerInfo.params.rule=="string"&&0<contentsLayerInfo.params.rule.length){params.rule+=(0<params.rule.length?",":"")+contentsLayerInfo.params.rule;}}
break;case SaigaiTask.Map.Layer.Type.KML:var kmlLayerInfo=layerInfo;if(kmlLayerInfo.visibility==true){if(0<params.kmllayers.length)params.kmllayers+=",";params.kmllayers+=kmlLayerInfo.layerId+":1";}
break;case SaigaiTask.Map.Layer.Type.REFERENCE_WMS:var reflayers=params.reflayers.length==0?[]:JSON.parse(params.reflayers);var referenceLayerInfo=layerInfo;if(referenceLayerInfo.visibility==true){var reflayer=[referenceLayerInfo.layerId,1,""];reflayers.push(reflayer);params.layertimes+=(0<params.layertimes.length?",":"")+referenceLayerInfo.layerId+","+iso8601Time;}
if(0<reflayers.length)params.reflayers=JSON.stringify(reflayers);break;case SaigaiTask.Map.Layer.Type.REFERENCE:var reflayers=params.reflayers.length==0?[]:JSON.parse(params.reflayers);var child=layerInfo;if(child.visibility==true){var success=false;var reflayer=null;for(var idx in reflayers){reflayer=reflayers[idx];if(reflayer[0]==child.parentLayerId){var layers=reflayer[2];var opacity=reflayer[1];if(child.opacity!=opacity){if(0<layers.length)continue;reflayer[1]=child.opacity;}
if(0<layers.length)layers+=",";layers+=child.layerId;reflayer[2]=layers;success=true;break;}}
if(!success&&reflayer[0]==child.parentLayerId){var cloneReflayer=[].concat(reflayer);var cloneLayerId=cloneReflayer[0];var cloneNum=1;if(cloneLayerId.indexOf("#")!=-1){var cloneLayerIdArray=cloneLayerId.split("#");cloneLayerId=cloneLayerIdArray[0];cloneNum=parseInt(cloneLayerIdArray[1])+1;}
cloneReflayer[0]=cloneLayerId+"#"+cloneNum;cloneReflayer[1]=child.opacity;cloneReflayer[2]=child.layerId;reflayers.push(cloneReflayer);success=true;}
if(success){if(0<reflayers.length)params.reflayers=JSON.stringify(reflayers);params.layertimes+=(0<params.layertimes.length?",":"")+child.layerId+","+iso8601Time;}
else{console.log(lang.__("Unable to print {0}. Parent layer info not exist.",child.layerId));}}
break;default:if(SaigaiTask.Map.Layer.Type.isOverlayLayerType(layerInfo.type)){var overlayLayerInfo=layerInfo;if(overlayLayerInfo.visibility==true){if(0<params.overlaylayers.length)params.overlaylayers+=",";params.overlaylayers+=overlayLayerInfo.layerId+":1";params.layertimes+=(0<params.layertimes.length?",":"")+overlayLayerInfo.layerId+","+iso8601Time;}
break;}}
for(var idx=layerInfo.children.length-1;0<=idx;idx--){me.buildPdfParams(params,layerInfo.children[idx]);}},createPdfParams:function(){var me=this;var stmap=me.stmap;var ecommap=stmap.ecommaps[0];var mapInfo=ecommap.mapInfo;var params=me.printWindow.getValues();SaigaiTask.Map.copy(params,{cid:mapInfo.communityId,mid:mapInfo.mapId,epsg:stmap.map.getProjection().split(":")[1],});if(!params.bbox){params.bbox=map.map.getExtent().toString();}
params.memoVisible=false;params.contentslayers="";params.kmllayers="";params.reflayers="";params.overlaylayers="";params.layertimes="";params.rule="";var addLayertimes=function(layerId,iso8601Time){params.layertimes+=(0<params.layertimes.length?",":"")+layerId+","+iso8601Time;}
var layerInfoTree=ecommap.layerInfoTree;for(var idx=layerInfoTree.length-1;0<=idx;idx--){me.buildPdfParams(params,layerInfoTree[idx]);}
var time=SaigaiTask.PageURL.getTime();if(!time)time=new Date();var toISOString=function(time){var iso8601Time=new Date(time).toISOString();if(SaigaiTask.PageURL.CONFIG_SHIFT_TIMEZONE_OFFSET){iso8601Time=new Date(time-time.getTimezoneOffset()*60*1000).toISOString();}
return iso8601Time;}
var iso8601Time=toISOString(time);for(var layerId in ecommap.layerInfoStore){var layerInfo=ecommap.layerInfoStore[layerId];if(layerInfo.visibility){if(layerInfo.type==SaigaiTask.Map.Layer.Type.LOCAL){if(layerInfo.time!=null){addLayertimes(layerInfo.layerId,toISOString(new Date(layerInfo.time)));}}
else if(SaigaiTask.Map.Layer.Type.isOverlayLayerType(layerInfo.type)){var layertime=layerInfo.time!=null?toISOString(new Date(layerInfo.time)):iso8601Time;addLayertimes(layerInfo.layerId,layertime);}
else if(layerInfo.type==SaigaiTask.Map.Layer.Type.REFERENCE_WMS){var layertime=layerInfo.time!=null?toISOString(new Date(layerInfo.time)):iso8601Time;addLayertimes(layerInfo.layerId,layertime);}}}
{var printTime=new Date();printTime.setMilliseconds(0);printTime.setSeconds(0);var printTimeStr=SaigaiTask.Page.Timeslider.formatDate(printTime,{dateSplit:"/",datetimeSplit:" ",timeSplit:":"});printTimeStr+=" "+lang.__("Print");var time=SaigaiTask.PageURL.getTime();if(time!=null){time.setMilliseconds(0);var timeStr=SaigaiTask.Page.Timeslider.formatDate(time,{dateSplit:"/",datetimeSplit:" ",timeSplit:":"});timeStr+=" "+lang.__("As of");printTimeStr+=" "+timeStr;}
params.description=printTimeStr+"\n"+params.description;}
var getLayerInfoJSON=function(layerInfo){var wmsProxy="";var metadataId="";if(layerInfo.wmsproxy&&layerInfo.wmsproxy!=0&&layerInfo.wmsproxy!=null){wmsProxy=layerInfo.wmsproxy;}
if(layerInfo.metadataid&&layerInfo.metadataid!=""&&layerInfo.metadataid!=null){metadataId=layerInfo.metadataid;}
return JSON.stringify({layerId:layerInfo.layerId,name:layerInfo.name,type:layerInfo.type,opacity:layerInfo.opacity,wmsURL:layerInfo.wmsURL,wmsFormat:layerInfo.wmsFormat,featuretypeId:layerInfo.featuretypeId,wmsLegendURL:layerInfo.wmsLegendURL,wmsproxy:wmsProxy,metadataId:metadataId});}
var addLayerInfoParam=function(layerInfo){params["layerInfo."+layerInfo.layerId]=getLayerInfoJSON(layerInfo);};var exlayers=[];var externalLayerInfos=ecommap.getExternalMapLayerInfos();var printExternalLayerInfos=[];var cloneNumMap={};var cloneExternalLayerInfo=function(externalLayerInfo){var cloneLayerId=externalLayerInfo.layerId;var cloneNum=cloneNumMap.hasOwnProperty(cloneLayerId)?cloneNumMap[cloneLayerId]:1;cloneNumMap[cloneLayerId]=cloneNum+1;var printExternalLayerInfo=JSON.parse(getLayerInfoJSON(externalLayerInfo));printExternalLayerInfo.layerId=cloneLayerId+"#"+cloneNum;printExternalLayerInfo.children=[];printExternalLayerInfo.visibility=externalLayerInfo.visibility;printExternalLayerInfos.push(printExternalLayerInfo);return printExternalLayerInfo;}
for(var idx in externalLayerInfos){var externalLayerInfo=externalLayerInfos[idx];var printExternalLayerInfo=cloneExternalLayerInfo(externalLayerInfo);if(externalLayerInfo.visibility==true){for(var cidx in externalLayerInfo.children){var child=externalLayerInfo.children[cidx];if(child.visibility==true){if(child.opacity!=opacity){if(0<printExternalLayerInfo.children.length){printExternalLayerInfo=cloneExternalLayerInfo(externalLayerInfo);}
printExternalLayerInfo.opacity=child.opacity;}
printExternalLayerInfo.children.push(child);}}}}
for(var idx in printExternalLayerInfos){var externalLayerInfo=printExternalLayerInfos[idx];if(externalLayerInfo.visibility==true){var opacity=externalLayerInfo.opacity;var exlayer=[externalLayerInfo.layerId,opacity];addLayertimes(externalLayerInfo.layerId,iso8601Time);var layers=[];for(var cidx in externalLayerInfo.children){var child=externalLayerInfo.children[cidx];if(child.visibility==true){layers.push(child.layerId);addLayerInfoParam(child);addLayertimes(child.layerId,iso8601Time);}}
exlayer.push(layers.reverse().join(","));exlayers.push(exlayer);addLayerInfoParam(externalLayerInfo);}}
if(0<=Number(params.mgrs)){var mgrsLayerInfo=stmap.controls.mgrsControl.layerInfo;var exlayer=[mgrsLayerInfo.layerId,1];var childLayerId=mgrsLayerInfo.layerId+"_";exlayer.push(childLayerId);exlayers.push(exlayer);addLayerInfoParam(mgrsLayerInfo);var featuretypeIds=[];var childLayerName="UTM Grid";for(var p=0;p<=Math.min(5,Number(params.mgrs));p++){featuretypeIds.push("mgrs"+p);childLayerName=p==0?"100km":p==1?"10km":p==2?"1km":p==3?"100m":p==4?"10m":"1m";}
var paramLayerInfo=JSON.parse(params["layerInfo."+mgrsLayerInfo.layerId]);paramLayerInfo.featuretypeId=featuretypeIds.join(",");params["layerInfo."+mgrsLayerInfo.layerId]=JSON.stringify(paramLayerInfo);paramLayerInfo.name=childLayerName;params["layerInfo."+childLayerId]=JSON.stringify(paramLayerInfo);}
if(0<exlayers.length)params.exlayers=JSON.stringify(exlayers);if(0<params.printBaselayer){var baseLayerInfos=ecommap.getBaseLayerInfos();for(var idx in baseLayerInfos){var baseLayerInfo=baseLayerInfos[idx];if(baseLayerInfo.visibility==true){params.baselayer=baseLayerInfo.layerId+":1";addLayertimes(baseLayerInfo.layerId,iso8601Time);}}}
else{params.printlegend=0;params.noframe=1;params.fpage=0;params.fmappage=0;}
delete params.printBaselayer;return params;},print:function(){var me=this;var stmap=me.stmap;var params=me.createPdfParams();stmap.api.createPdf(params);setTimeout(function(){me.checkPdfDownload();},1000);},checkPdfDownload:function(){var me=this;var printWindow=me.printWindow;var progressbar=me.printWindow.progressbar;$.ajax(SaigaiTask.contextPath+"/PdfServlet",{dataType:"json",cache:false,success:function(data){if(data.name=="Error"){console.error(lang.__("An error occurred during the PDF creation process."));}else{console.debug("Creating pdf: "+data[0]+"/"+data[1]);var v=data[0]/data[1];try{if(data[0]==0&&data[1]==0)setTimeout(function(){me.checkPdfDownload();},1000);else{if(data[0]<data[1]){progressbar.updateProgress(v,lang.__('Creating PDF file..')+' '+Math.round(100*v)+lang.__("%"));setTimeout(function(){me.checkPdfDownload();},1000);}
else{printWindow.onsuccess();}}}catch(e){console.warn(e);}}}});},getPrintSize:function(pageType){var a0={width:841,height:1189};var b0={width:1030,height:1456};var pageSize=null;var type=pageType[0].toLowerCase();if(type=="a")pageSize=a0;else if(type=="b")pageSize=b0;var num=Number(pageType[1]);while(0<num){pageSize.width=pageSize.width/2;pageSize.height=pageSize.height/2;num--;}
return pageSize;}});SaigaiTask.Map.Layer.LayerInfo=new OpenLayers.Class({ecommap:null,layerId:null,name:null,wmsURL:null,format:"image/png",opacity:1.0,reload:null,type:null,addable:false,editable:false,snappable:false,expanded:true,visibility:true,searchable:false,alwaysNotSearch:false,params:null,parentLayerId:null,parent:null,children:null,layer:null,attrInfos:null,transitionEffect:null,filterkey:null,grayout:null,spatialLayer:null,spatialLayers:null,singleTile:false,intersectionlayerid:null,intersectionlayername:null,updatecolumn:null,isEarthquakeLayer:false,time:null,getTime:function(){var timeStr=this.time;return(!!timeStr?new Date(timeStr):null);},initialize:function(options){var me=this;me.children=[];me.params=[];OpenLayers.Util.extend(me,options);me.attrInfos=[];for(var idx in options.attrInfos){var attrInfo=new SaigaiTask.Map.Layer.AttrInfo(options.attrInfos[idx]);me.attrInfos.push(attrInfo);}
if(typeof options.searchable=="undefined"||options.searchable==null){this.searchable=this.visibility;}
else if(options.searchable==false){this.alwaysNotSearch=true;}
me.time=SaigaiTask.PageURL.getLayerTime(me.layerId);me.updateRuleParam();},getLayer:function(){if(this.layer!=null){return this.layer;}
if(this.parent!=null){return this.parent.getLayer();}
return null;},appendChildLayerInfo:function(childLayerInfo){this.children.push(childLayerInfo);childLayerInfo.parent=this;childLayerInfo.parentLayerId=this.layerId;},mergeParams:function(params){var layerInfo=this;for(var paramName in layerInfo.params){var param=layerInfo.params[paramName];if(typeof params[paramName]=="undefined"){params[paramName]=[];}
if(typeof params[paramName]=="string"){params[paramName]=param;}
if($.isArray(params[paramName])){params[paramName].push(param);}}
if(layerInfo.time!=null){if(layerInfo.type==SaigaiTask.Map.Layer.Type.LOCAL){if(typeof params.layertimes=="undefined")params.layertimes="";if(0<params.layertimes.length)params.layertimes+=",";params.layertimes+=layerInfo.layerId;params.layertimes+=",";var time=layerInfo.getTime();var iso8601Time=time.toISOString();if(SaigaiTask.PageURL.CONFIG_SHIFT_TIMEZONE_OFFSET){iso8601Time=new Date(time-time.getTimezoneOffset()*60*1000).toISOString();}
params.layertimes+=iso8601Time;}}},getAttrInfo:function(attrId){var me=this;for(var idx in me.attrInfos){var attrInfo=me.attrInfos[idx];if(attrId==attrInfo.attrId){return attrInfo;}}
return null;},isVisibleAttr:function(attrId){var attrInfo=this.getAttrInfo(attrId);if(attrInfo!=null){var STATUS_SEARCHHIDE=SaigaiTask.Map.Layer.AttrInfo.STATUS_SEARCHHIDE;return STATUS_SEARCHHIDE<attrInfo.status;}
return false;},isEditableAttr:function(attrId){var attrInfo=this.getAttrInfo(attrId);if(attrInfo!=null){var STATUS_DEFAULT=SaigaiTask.Map.Layer.AttrInfo.STATUS_DEFAULT;return STATUS_DEFAULT==attrInfo.status;}
return false;},evalAttrSort:function(attrId1,attrId2){var attr1=this.getAttrInfo(attrId1);var attr2=this.getAttrInfo(attrId2);if(attr1==null&&attr2==null)return 0;if(attr2==null||attr1.disporder<attr2.disporder)return-1;if(attr1==null||attr2.disporder<attr1.disporder)return 1;return 0;},getHiddenLayerIds:function(hiddenLayerIds){var layerInfo=this;if(layerInfo.visibility==false){if(layerInfo.layerId!=null){hiddenLayerIds.push(layerInfo.layerId);}}
if(layerInfo.children!=null){for(var idx in layerInfo.children){var child=layerInfo.children[idx];child.getHiddenLayerIds(hiddenLayerIds);}}
return hiddenLayerIds;},hasSpatialLayer:function(){var me=this;return me.spatialLayers!=null;},setGrayout:function(grayout){var me=this;var layer=me.getLayer();if(layer!=null){var layerInfo=layer.layerInfo;if(layerInfo!=null){layerInfo.params.grayout=grayout;layer.refreshParams({nocache:true});}}},createSpatialLayer:function(){var layerInfo=this;var ecommap=layerInfo.ecommap;var stmap=ecommap.stmap;var olmap=stmap.map;var spatialLayerInfo=ecommap.createContentsLayerInfo();spatialLayerInfo.singleTile=true;spatialLayerInfo.appendChildLayerInfo(layerInfo);spatialLayerInfo.params.filterlayer=layerInfo.layerId;spatialLayerInfo.params.filterkey=layerInfo.filterkey;spatialLayerInfo.params.spatiallayer=1;spatialLayerInfo.params.spatiallayers=JSON.stringify(layerInfo.spatialLayers);var time=SaigaiTask.PageURL.getTime();if(!!time){var iso8601Time=time.toISOString();if(SaigaiTask.PageURL.CONFIG_SHIFT_TIMEZONE_OFFSET){iso8601Time=new Date(time-time.getTimezoneOffset()*60*1000).toISOString();}
spatialLayerInfo.params.time=iso8601Time;}
spatialLayerInfo.params.spatiallayers=JSON.stringify(layerInfo.spatialLayers);var spatialLayer=new SaigaiTask.Map.Layer.WMSLayer(spatialLayerInfo);spatialLayer.setVisibility(false);olmap.addLayer(spatialLayer);layerInfo.spatialLayer=spatialLayer;},isSessionExternalMapLayer:function(){var layerInfo=this;return(layerInfo.type==SaigaiTask.Map.Layer.Type.EXTERNAL_MAP_WMS||layerInfo.type==SaigaiTask.Map.Layer.Type.EXTERNAL_MAP_WMS_LAYERS)&&(layerInfo.layerId.indexOf("extmap_session")==0)},isDeletableSessionExternalMapLayer:function(){var layerInfo=this;if(!layerInfo.isSessionExternalMapLayer())return false;if(layerInfo.type==SaigaiTask.Map.Layer.Type.EXTERNAL_MAP_WMS)return true;if(layerInfo.type==SaigaiTask.Map.Layer.Type.EXTERNAL_MAP_WMS_LAYERS){var children=layerInfo.parent.children;for(var idx in children){var child=children[idx];if(child==layerInfo)continue;if(child.metadataid==layerInfo.metadataid){return false;}}}
return true;},getTimeParam:function(){var me=this;if(me.time!=null)return me.time;return me.getLayer().params.time;},updateRuleParam:function(){var me=this;var layerInfo=me;if(!!me.legendrules&&2<me.legendrules.length){var visibleRules=[];var allHide=true;for(var legendrulesIdx in layerInfo.legendrules){var rule=layerInfo.legendrules[legendrulesIdx];if(rule.visibility){visibleRules.push(rule.ruleId);}
if(allHide&&rule.visibility)allHide=false;}
if(visibleRules.length==0||visibleRules.length==layerInfo.legendrules.length){me.params.rule=null;}
else{me.params.rule=me.layerId+":"+visibleRules.join(":");}
if(allHide){layerInfo.visibility=false;layerInfo.searchable=false;}}},CLASS_NAME:"SaigaiTask.Map.Layer.LayerInfo"});SaigaiTask.Map.model={};SaigaiTask.Map.model.InitOptions=function(){};SaigaiTask.Map.model.InitOptions.prototype={contextPath:null,api:null,icon:null,showLegend:false,showMenuOptions:null,epsg:4326};SaigaiTask.Map.model.ShowMenuOptions=function(){};SaigaiTask.Map.model.ShowMenuOptions.prototype={addContentsMenu:false,deleteLayerMenu:false,transparencyLayerMenu:false};SaigaiTask.Map.model.ShelterSearchOptions=function(){};SaigaiTask.Map.model.ShelterSearchOptions.prototype={layerId:null,featureId:null};SaigaiTask.Map.model.Ecommap=function(){};SaigaiTask.Map.model.Ecommap.prototype={baseLayers:null,contentsLayers:null,overlayLayers:null,referenceLayers:null};SaigaiTask.Map.model.Layer=function(){};SaigaiTask.Map.model.Layer.prototype={id:null,name:null,description:null,attributes:null};SaigaiTask.Map.model.Feature=function(){};SaigaiTask.Map.model.Feature.prototype={layerId:null,featureId:null,geometry:null,attributes:null,files:null,metadata:null,getFeatureId:function(){var fid=null;if(layerId&&featureId){fid=layerId+"."+featureId;}
return fid;},getAttributeNames:function(){var names=[];if(this.attributes){for(var idx in this.attributes){names.push(this.attributes[idx].name);}}
return names;},getAttributeValues:function(){var values=[];if(this.attributes){for(var idx in this.attributes){values.push(this.attributes[idx].value);}}
return values;}};SaigaiTask.Map.model.Geometry=function(){};SaigaiTask.Map.model.Geometry.prototype={wkt:null};SaigaiTask.Map.model.Attribute=function(){};SaigaiTask.Map.model.Attribute.prototype={id:null,name:null,value:null};SaigaiTask.Map.model.SearchParams=function(){};SaigaiTask.Map.model.SearchParams.prototype={buffer:0,features:["c127.3"],layerId:"c127",mapId:42,spatialType:1};SaigaiTask.Map.model.SearchResult=function(){};SaigaiTask.Map.model.SearchResult.prototype={success:false,counts:null,features:null,raw:null};SaigaiTask.Map.model.ResultCount=function(){};SaigaiTask.Map.model.ResultCount.prototype={total:0,limit:0,offset:0};SaigaiTask.Map.Layer.XYZLayer=new OpenLayers.Class(OpenLayers.Layer.XYZZoom,{layerInfo:null,initialize:function(layerInfo){this.layerInfo=layerInfo;var options={reprojection:true,isBaseLayer:layerInfo.type==SaigaiTask.Map.Layer.Type.BASE_XYZ,buffer:0,opacity:layerInfo.opacity,alpha:true,visibility:layerInfo.visibility,attribution:layerInfo.attribution};options.maxZoomLevel=layerInfo.maxZoomLevel;OpenLayers.Layer.XYZZoom.prototype.initialize.apply(this,[layerInfo.name,layerInfo.wmsURL,options]);layerInfo.layer=this;}});SaigaiTask.Map.Layer.XYZLayer.type=[SaigaiTask.Map.Layer.Type.BASE_XYZ,SaigaiTask.Map.Layer.Type.OVERLAY_XYZ,SaigaiTask.Map.Layer.Type.EXTERNAL_MAP_XYZ]
SaigaiTask.Map.Layer.TileCacheLayer=new OpenLayers.Class(OpenLayers.Layer.TileCache,{layerInfo:null,initialize:function(layerInfo){var me=this;me.layerInfo=layerInfo;var options={visibility:layerInfo.visibility,buffer:0,alpha:true,opacity:1.0,isBaseLayer:true};options.format=layerInfo.wmsFormat;OpenLayers.Layer.TileCache.prototype.initialize.apply(this,[layerInfo.name,layerInfo.wmsURL,layerInfo.featuretypeId,options]);}});SaigaiTask.Map.Layer.TileCacheLayer.type=SaigaiTask.Map.Layer.Type.TILECACHE;SaigaiTask.Map.control.SessionLayout=new OpenLayers.Class(OpenLayers.Control,{stmap:null,xhr:null,initialize:function(stmap,options){var me=this;me.stmap=stmap;var handler=function(evt){me.saveLayout();};stmap.events.on({"legenditemexpanded":handler,"legendcheckchange":handler});stmap.map.events.on({"zoomend":handler,"moveend":handler});OpenLayers.Control.prototype.initialize.apply(this,[options]);},loadLayout:function(callback,blayer){if(this.active){var sessionLayout=this;var me=this.stmap;var map=me.map;var data={mapDivId:me.div};me.api.loadLayout(data,function(layout){if(layout!=null){var zoom=layout.zoom;if(typeof zoom!="undefined"){map.zoomTo(zoom);}
if(typeof layout.center!="undefined"){var center=new OpenLayers.LonLat.fromString(layout.center);me.setCenter(center);}
if(typeof layout.layers!="undefined"&&blayer){var layerMap=me.getLayerMap();var idx=null;for(idx in layout.layers){var layerLayout=layout.layers[idx];var layerId=layerLayout.id;var layer=layerMap[layerId];if(layer!=null){layer.expanded=layerLayout.expanded;layer.visibility=layerLayout.visibility;layer.searchable=layerLayout.visibility;}}
me.redrawContentsLayer(0);}}
sessionLayout.events.triggerEvent("layoutloaded");if(typeof callback=="function")callback();});}
else{if(typeof callback=="function")callback();}},saveLayout:function(){if(this.active!=true)return;var me=this.stmap;var map=me.map;if(this.xhr!=null)this.xhr.abort();var allLayers=me.getAllLayers();var layers=[];for(var allLayersIdx in allLayers){var layer=allLayers[allLayersIdx];layers[layers.length]={id:layer.layerId,expanded:layer.expanded==true,visibility:layer.visibility};}
var data={mapDivId:me.div,"zoom":map.zoom,"center":map.getCenter().clone().transform(map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326")).toShortString(),"layers":layers};this.xhr=me.api.saveLayout(data);}});SaigaiTask.Map.view.PrintPreviewWindow=function(){this.initialize.apply(this,arguments);};SaigaiTask.Map.view.PrintPreviewWindow.prototype={stmap:null,pdfControl:null,contentsContainer:null,formPanel:null,values:null,previewMapImageContainer:null,pdfRangeLayer:null,progressbar:null,progressbarInitText:lang.__('Creating PDF file..'),exportButton:null,exportImageButton:null,downloadButton:null,win:null,topToolbar:null,initialize:function(pdfControl){var me=this;me.pdfControl=pdfControl;var stmap=me.stmap=pdfControl.stmap;me.values={printBaselayer:"1",cols:1,rows:1,printmap:1,printlegend:1};me.createWindow({easy:true});me.pdfRangeLayer=new SaigaiTask.Map.Layer.PdfRangeLayer(me);},createWindow:function(opt){var me=this;var stmap=me.stmap;var easy=opt.easy;var winWidth=0;var hbox={xtype:'container',layout:"hbox",style:{background:"white"},items:[]};var hboxContainerObj=Ext.create('Ext.container.Container',hbox);me.contentsContainer=hboxContainerObj;var previewContainer=null;{previewContainer={xtype:'container',cls:'first-container',border:1,margin:5,layout:'vbox',items:[{xtype:"label",html:lang.__("印刷プレビュー")+'<span style="font-size:.8em">'+lang.__("（登録情報のみ）")+'</span>'},{xtype:"label",html:'<span style="font-size:.8em">'+lang.__("表示ページ")+'&nbsp;'+lang.__("縦")+'&nbsp;'+lang.__("横")+'</span>'}]};{var imgContainerWidth=256;var extImgContainer={xtype:'container',width:imgContainerWidth,style:{'text-align':'center',cursor:'pointer'}};var extImgContainerObj=Ext.create('Ext.container.Container',extImgContainer);me.previewMapImageContainer=extImgContainerObj;winWidth+=extImgContainer.width;}
previewContainer.items.push(extImgContainerObj);hboxContainerObj.add(previewContainer);}
var formPanel=easy?me.createEasyFormPanel():me.createDetailFormPanel();me.formPanel=formPanel;hboxContainerObj.add(formPanel);winWidth+=formPanel.width;winWidth+=30;var progressbar=Ext.create('Ext.ProgressBar',{hidden:true,text:me.progressbarInitText});me.progressbar=progressbar;var exportButton=Ext.create("Ext.Button",{text:lang.__("マップのPDFを出力"),icon:stmap.icon.getURL("printIconURL"),disabled:!me.isExportable(),tooltip:!me.isExportable()?lang.__("出力内容を１つ以上選択してください。"):"",handler:function(){if(formPanel.form.isValid()){me.onexport();}
else{Ext.MessageBox.show({title:lang.__('PDF output error'),msg:lang.__('Setting is incorrect.\n Check input content.'),buttons:Ext.MessageBox.OK,animateTarget:exportButton.getEl(),icon:Ext.MessageBox.ERROR});}}});me.exportButton=exportButton;var exportImageButton=Ext.create("Ext.Button",{text:lang.__("地図画像を出力"),icon:stmap.icon.getURL("downloadMapIconURL"),handler:function(){if(formPanel.form.isValid()){me.onexport();}
else{Ext.MessageBox.show({title:lang.__('PDF output error'),msg:lang.__('Setting is incorrect.\n Check input content.'),buttons:Ext.MessageBox.OK,animateTarget:exportButton.getEl(),icon:Ext.MessageBox.ERROR});}}});me.exportImageButton=exportImageButton;var downloadButton=Ext.create("Ext.Button",{text:lang.__("Download"),icon:stmap.icon.getURL("downloadIconURL"),href:SaigaiTask.contextPath+"/PdfServlet?download",hidden:true});me.downloadButton=downloadButton;var win=Ext.create("Ext.Window",{cls:"printPreviewWindow",closeAction:"hide",title:lang.__("Print dialog"),width:winWidth,dockedItems:[{xtype:'toolbar',dock:'top',padding:"10 0 3 0",style:{background:"white",},items:[{xtype:"tbtext",text:lang.__("マップとして印刷可能なPDFファイルに出力します。"),style:{fontSize:"12px"}},{xtype:'tbfill'},{xtype:'button',icon:stmap.icon.getURL("rangeIconURL"),text:lang.__("範囲設定"),padding:0,style:{fontSize:"12px"},handler:function(){me.hideWithoutReset();me.pdfRangeLayer.showPdfRangeDialog();}},{xtype:'button',text:lang.__("保存"),padding:0,style:{fontSize:"12px"},handler:function(){alert("実装中");}},{xtype:'button',text:lang.__("読み込み"),padding:0,style:{fontSize:"12px"},handler:function(){me.hideWithoutReset();me.pdfRangeLayer.showRangeListDialog();}},{xtype:'button',icon:stmap.icon.getURL("reloadIconURL"),text:easy?lang.__("詳細設定"):lang.__("かんたん設定"),padding:0,style:{fontSize:"12px"},handler:function(){var values=me.getValues();me.win.destroy();me.createWindow({easy:!easy});me.formPanel.form.setValues(values);me.win.show();}}]}],items:[hboxContainerObj,progressbar],fbar:[downloadButton,exportButton,exportImageButton],listeners:{show:function(window,eOpts){var x=-win.getWidth()/2;var y=-win.getHeight()/2;win.alignTo("map","c",[x,y]);me.showPreview();me.showPrintRange();var mgrsField=formPanel.form.findField("mgrs");if(mgrsField.getValue()==null){var value=""+(stmap.controls.mgrsControl.layer.getVisibility()?stmap.controls.mgrsControl.layerInfo.params.precision:"-1");mgrsField.setValue(value);}
progressbar.setWidth(win.getWidth()-10);},hide:function(window,eOpts){me.onHideDialog();}}});me.win=win;me.topToolbar=win.getDockedItems("toolbar[dock='top']")[0];},resetOnHide:true,hideWithoutReset:function(){var me=this;me.resetOnHide=false;me.win.hide();me.resetOnHide=true;},createEasyFormPanel:function(){var me=this;var stmap=me.stmap;var formPanel=Ext.create('Ext.form.Panel',{frame:false,border:false,width:380,bodyPadding:5,fieldDefaults:{labelAlign:'left',anchor:'100%'},items:[{xtype:'container',cls:'first-container',border:1,layout:'fit',items:[{xtype:'textareafield',name:'maptitle',fieldLabel:lang.__('Map title'),labelAlign:"top",rows:2,value:"",allowBlank:true},{xtype:'hiddenfield',name:'description',value:""}]},{xtype:'container',cls:'first-container',border:1,layout:'hbox',items:[{flex:1,xtype:'combo',fieldLabel:lang.__("Paper size"),labelWidth:'80px',store:new Ext.data.SimpleStore({fields:['value','display'],data:[["a0","A0"],["a1","A1"],["a2","A2"],["a3","A3"],["a4","A4"],["a5","A5"],["b0","B0"],["b1","B1"],["b2","B2"],["b3","B3"],["b4","B4"],["b5","B5"]],autoLoad:false}),displayField:'display',valueField:'value',name:"pagesize",value:"a4",editable:false,validator:function(value){value=this.getRawValue();var baseLayerInfo=stmap.map.baseLayer.layerInfo;return true;}},{xtype:'splitter'},{flex:1,xtype:'radiogroup',fieldLabel:lang.__('Paper orientation'),labelWidth:'60px',columns:2,items:[{name:'rotate',inputValue:'1',boxLabel:lang.__('Horizontal'),checked:true},{name:'rotate',inputValue:'0',boxLabel:lang.__('Vertical')}],listeners:{change:function(radiogroup,newValue,oldValue,eOpts){me.onchangePaperField();}}}]},{xtype:'container',cls:'first-container',border:1,layout:'hbox',defaultMargins:{top:5,bottom:5,left:5,right:5},items:[{flex:1,xtype:'combo',fieldLabel:lang.__('分割印刷(縦x横)'),labelAlign:"top",store:new Ext.data.SimpleStore({fields:['value','display'],data:[["1,1","1 x 1"],["2,1","2 x 1"],["1,2","1 x 2"],["2,2","2 x 2"],["3,3","3 x 3"],["4,4","4 x 4"]],autoLoad:false}),displayField:'display',valueField:'value',name:"splitprint",value:"1,1",editable:false,listeners:{"change":function(field,newValue,oldValue,eOpts){var cr=newValue.split(',');me.values.rows=cr[0];me.values.cols=cr[1];me.onchangePaperField();}}},{flex:2,xtype:"displayfield",margin:5,value:lang.__("地図を複数ページに分割して印刷します。 拡大した地図が印刷できます。")}]},{xtype:'container',cls:'first-container',border:1,layout:'fit',items:[{xtype:'combo',fieldLabel:lang.__("UTM grid"),store:new Ext.data.SimpleStore({fields:['value','display'],data:[["-1",lang.__("Hide")],["0",lang.__("0 digit: 100km")],["1",lang.__("Single digit: 10km")],["2",lang.__("The second digit: 1km")],["3",lang.__("The third digit: 100m")],["4",lang.__("The forth digit: 10m")]],autoLoad:false}),displayField:'display',valueField:'value',name:"mgrs",editable:false}]},{xtype:'container',cls:'first-container',border:1,layout:'hbox',items:[{flex:1,xtype:'combo',fieldLabel:lang.__('凡例サイズ'),labelAlign:"top",store:new Ext.data.SimpleStore({fields:['value','display'],data:[["1.8",lang.__("特大")],["1.35",lang.__("大きい")],["1.0",lang.__("普通")],["0.8",lang.__("小さい")],["0.5",lang.__("特小")]],autoLoad:false}),displayField:'display',valueField:'value',name:"legendrate",value:"1.0",editable:false},{flex:2,xtype:'container',layout:'vbox',margin:"5 5 0 5",items:[{xtype:'checkbox',name:"legendpos",boxLabel:lang.__("凡例を別ページに表示"),margin:0,inputValue:"0"},{xtype:'checkbox',name:"legenddisplay",boxLabel:lang.__("全ての登録情報の凡例を表示する"),margin:0,inputValue:"0"}]}]},{xtype:'container',cls:'first-container',border:1,layout:'hbox',items:[{xtype:'checkbox',name:"index_enabled",fieldLabel:lang.__('外枠索引'),boxLabel:lang.__("表示する"),inputValue:"1"},{xtype:'checkbox',name:"printindex",boxLabel:lang.__("インデックス地図出力"),margin:"0 0 0 10",inputValue:"1"}]}]});return formPanel;},createDetailFormPanel:function(){var me=this;var stmap=me.stmap;var formPanel=Ext.create('Ext.form.Panel',{frame:false,border:false,width:460,bodyPadding:5,fieldDefaults:{labelAlign:'left',anchor:'100%'},items:[{xtype:'tabpanel',defaults:{padding:5},items:[{id:"print-tab",title:lang.__("印刷"),items:[{xtype:'container',cls:'first-container',border:1,layout:'hbox',items:[{xtype:'checkbox',name:"printmap",fieldLabel:lang.__('出力内容'),labelWidth:"60px",boxLabel:lang.__("マップ"),inputValue:"1",listeners:{change:function(field,newValue,oldValue,eOpts){var printPreviewWindow=me;var tabpanel=printPreviewWindow.formPanel.child("tabpanel");var maptabpanel=tabpanel.child("#map-tab");if(field.checked)maptabpanel.tab.show();else maptabpanel.tab.hide();me.updateExportButtonEnabled();}}},{xtype:'checkbox',name:"printlegend",boxLabel:lang.__("凡例"),margin:"0 0 0 10",inputValue:"1",listeners:{change:function(field,newValue,oldValue,eOpts){var printPreviewWindow=me;var tabpanel=printPreviewWindow.formPanel.child("tabpanel");var legendtabpanel=tabpanel.child("#legend-tab");if(field.checked)legendtabpanel.tab.show();else legendtabpanel.tab.hide();me.updateExportButtonEnabled();}}}]},{xtype:'container',cls:'first-container',border:1,layout:'fit',items:[{xtype:'container',layout:'fit',items:[{xtype:'textareafield',name:'maptitle',fieldLabel:lang.__('Map title'),labelAlign:"top",rows:2,value:"",allowBlank:true}]},{xtype:'container',layout:'fit',items:[{xtype:'textareafield',name:'description',fieldLabel:lang.__('Explanation, annotations'),labelAlign:"top",rows:3,value:""}]}]},{xtype:'container',cls:'first-container',border:1,items:[{xtype:'container',layout:'hbox',items:[{flex:1,xtype:'combo',fieldLabel:lang.__("Paper size"),labelWidth:'80px',store:new Ext.data.SimpleStore({fields:['value','display'],data:[["a0","A0"],["a1","A1"],["a2","A2"],["a3","A3"],["a4","A4"],["a5","A5"],["b0","B0"],["b1","B1"],["b2","B2"],["b3","B3"],["b4","B4"],["b5","B5"]],autoLoad:false}),displayField:'display',valueField:'value',name:"pagesize",value:"a4",editable:false,validator:function(value){value=this.getRawValue();var baseLayerInfo=stmap.map.baseLayer.layerInfo;return true;}},{xtype:'splitter'},{flex:1,xtype:'radiogroup',fieldLabel:lang.__('Paper orientation'),labelWidth:'60px',columns:2,items:[{name:'rotate',inputValue:'1',boxLabel:lang.__('Horizontal'),checked:true},{name:'rotate',inputValue:'0',boxLabel:lang.__('Vertical')}],listeners:{change:function(radiogroup,newValue,oldValue,eOpts){me.onchangePaperField();}}}]},{xtype:"container",layout:"hbox",items:[{xtype:'combo',fieldLabel:lang.__('マップ出力サイズ'),labelWidth:"110px",store:new Ext.data.SimpleStore({fields:['value','display'],data:[["0","A0"],["1","A1"],["2","A2"],["3","A3"],["4","A4"],["5","A5"]],autoLoad:false}),displayField:'display',valueField:'value',name:"mapsize_a",value:"4",width:150,editable:false},{xtype:'displayfield',value:lang.__("（")+lang.__("縦")},{xtype:'combo',store:new Ext.data.SimpleStore({fields:['value','display'],data:[["1","1"],["2","2"],["3","3"],["4","4"],["5","5"],["6","6"],["7","7"],["8","8"],["10","10"],["12","12"],["14","14"],["16","16"]],autoLoad:false}),displayField:'display',valueField:'value',name:"rows",value:"1",width:50,editable:false},{xtype:'displayfield',value:'x'+lang.__("横")},{xtype:'combo',store:new Ext.data.SimpleStore({fields:['value','display'],data:[["1","1"],["2","2"],["3","3"],["4","4"],["5","5"],["6","6"],["7","7"],["8","8"],["10","10"],["12","12"],["14","14"],["16","16"]],autoLoad:false}),displayField:'display',valueField:'value',name:"cols",value:"1",width:50,editable:false},{xtype:'displayfield',value:lang.__("ページ")+lang.__("）")}]}]}]},{id:"map-tab",title:lang.__("マップ"),hidden:me.values.printmap=="0",items:[{xtype:'container',cls:'first-container',border:1,layout:"hbox",items:[{xtype:'displayfield',fieldLabel:lang.__("ページ余白(mm)")},{xtype:'textfield',fieldLabel:lang.__("上"),labelWidth:"20px",width:60,name:"mapmt",value:"5"},{xtype:'textfield',fieldLabel:lang.__("下"),labelWidth:"20px",width:60,name:"mapmb",value:"5"},{xtype:'textfield',fieldLabel:lang.__("左"),labelWidth:"20px",width:60,name:"mapml",value:"5"},{xtype:'textfield',fieldLabel:lang.__("右"),labelWidth:"20px",width:60,name:"mapmr",value:"5"},{xtype:'splitter'},{xtype:'checkbox',boxLabel:lang.__("余白なし"),width:80,name:"noframe",inputValue:"1"}]},{xtype:'container',cls:'first-container',border:1,items:[{xtype:'container',layout:"hbox",items:[{xtype:'combo',fieldLabel:lang.__("タイトル配置"),labelWidth:"95px",width:180,store:new Ext.data.SimpleStore({fields:['value','display'],data:[["-1",lang.__("表示しない")],["0",lang.__("左寄せ")],["1",lang.__("中央")],["2",lang.__("右寄せ")]],autoLoad:false}),displayField:'display',valueField:'value',name:"titlealign",value:"0",editable:false},{xtype:'splitter'},{xtype:'textfield',fieldLabel:lang.__("文字サイズ"),labelWidth:"75px",width:100,name:"titlefontsize",value:"32"},{xtype:'displayfield',value:"pt"},{xtype:'splitter'},{xtype:'checkbox',boxLabel:lang.__("自動"),width:80,name:"titlefontauto",inputValue:"1"}]},{xtype:'container',layout:"hbox",items:[{xtype:'combo',fieldLabel:lang.__("説明・注釈配置"),labelWidth:"95px",width:180,store:new Ext.data.SimpleStore({fields:['value','display'],data:[["-1",lang.__("表示しない")],["1",lang.__("左上")],["3",lang.__("左下")],["2",lang.__("右上")],["4",lang.__("右下")]],autoLoad:false}),displayField:'display',valueField:'value',name:"descalign",value:"2",editable:false},{xtype:'splitter'},{xtype:'textfield',fieldLabel:lang.__("文字サイズ"),labelWidth:"75px",width:100,name:"descfontsize",value:"16"},{xtype:'displayfield',value:"pt"},{xtype:'splitter'},{xtype:'checkbox',boxLabel:lang.__("自動"),width:80,name:"descfontauto",inputValue:"1"}]}]},{xtype:'container',cls:'first-container',border:1,items:[{xtype:'container',layout:"hbox",items:[{xtype:'displayfield',fieldLabel:lang.__("登録情報の\n印刷サイズ"),labelWidth:"80px"},{xtype:'splitter',},{xtype:'container',defaults:{labelWidth:"95px",width:160},items:[{xtype:'combo',fieldLabel:lang.__("アイコン・文字"),store:new Ext.data.SimpleStore({fields:['value','display'],data:[["0.3",lang.__("特小")],["0.66",lang.__("小さい")],["1.0",lang.__("普通")],["1.5",lang.__("1.5倍")],["2.0",lang.__("2倍")],["3.0",lang.__("3倍")],["4.0",lang.__("4倍")],["6.0",lang.__("6倍")],["8.0",lang.__("8倍")],["10.0",lang.__("10倍")]],autoLoad:false}),displayField:'display',valueField:'value',name:"iconrate",value:"1.0",editable:false},{xtype:'combo',fieldLabel:lang.__("線の太さ"),store:new Ext.data.SimpleStore({fields:['value','display'],data:[["0.66",lang.__("細い")],["1.0",lang.__("普通")],["1.5",lang.__("1.5倍")],["2.0",lang.__("2倍")],["3.0",lang.__("3倍")],["4.0",lang.__("4倍")],["6.0",lang.__("6倍")],["8.0",lang.__("8倍")],["10.0",lang.__("10倍")]],autoLoad:false}),displayField:'display',valueField:'value',name:"linerate",value:"1.0",editable:false}]}]}]},{xtype:'container',cls:'first-container',border:1,items:[{xtype:'container',layout:"hbox",items:[{xtype:'combo',fieldLabel:lang.__("縮尺位置"),labelWidth:"60px",width:145,store:new Ext.data.SimpleStore({fields:['value','display'],data:[["-1",lang.__("表示しない")],["3",lang.__("左下")],["4",lang.__("右下")]],autoLoad:false}),displayField:'display',valueField:'value',name:"scalealign",value:"4",editable:false},{xtype:"splitter"},{xtype:'checkbox',fieldLabel:lang.__("複数ページ"),labelWidth:"80px",boxLabel:lang.__("全ページに表示"),name:"scalepages",inputValue:"1"}]}]},{xtype:'container',cls:'first-container',border:1,layout:'fit',items:[{xtype:'combo',fieldLabel:lang.__("UTM grid"),store:new Ext.data.SimpleStore({fields:['value','display'],data:[["-1",lang.__("Hide")],["0",lang.__("0 digit: 100km")],["1",lang.__("Single digit: 10km")],["2",lang.__("The second digit: 1km")],["3",lang.__("The third digit: 100m")],["4",lang.__("The forth digit: 10m")]],autoLoad:false}),displayField:'display',valueField:'value',name:"mgrs",editable:false}]}]},{id:"legend-tab",title:lang.__("凡例"),hidden:me.values.printlegend=="0",items:[{xtype:'container',cls:'first-container',border:1,items:[{xtype:'container',layout:"hbox",items:[{xtype:'checkbox',fieldLabel:lang.__("列の幅"),labelWidth:"50px",boxLabel:lang.__("自動"),name:"legendcolauto",inputValue:"1",checked:true},{xtype:"splitter"},{xtype:"displayfield",value:"1/"},{xtype:'combo',width:40,store:new Ext.data.SimpleStore({fields:['value','display'],data:[["2","2"],["3","3"],["4","4"],["5","5"],["6","6"],["7","7"],["8","8"],["9","9"],["10","10"]],autoLoad:false}),displayField:'display',valueField:'value',name:"legendcols",value:"2",editable:false}]}]},{xtype:'container',cls:'first-container',border:1,layout:'hbox',items:[{xtype:'displayfield',fieldLabel:lang.__('凡例サイズ'),labelWidth:"80px"},{xtype:'container',items:[{xtype:'combo',width:80,store:new Ext.data.SimpleStore({fields:['value','display'],data:[["1.8",lang.__("特大")],["1.35",lang.__("大きい")],["1.0",lang.__("普通")],["0.8",lang.__("小さい")],["0.5",lang.__("特小")]],autoLoad:false}),displayField:'display',valueField:'value',name:"legendrate",value:"1.0",editable:false},{xtype:'checkbox',name:"legenddisplay",boxLabel:lang.__("全ての登録情報の凡例を表示する"),margin:0,inputValue:0}]}]},{xtype:'container',cls:'first-container',border:1,items:[{xtype:'container',layout:'hbox',items:[{xtype:'combo',fieldLabel:lang.__('凡例表示位置'),labelWidth:"90px",width:200,store:new Ext.data.SimpleStore({fields:['value','display'],data:[["1",lang.__("マップ内 左上")],["3",lang.__("マップ内 左下")],["2",lang.__("マップ内 右上")],["4",lang.__("マップ内 右下")],["0",lang.__("別ページ")]],autoLoad:false}),displayField:'display',valueField:'value',name:"legendpos",value:"3",editable:false},{xtype:'splitter',},{xtype:'checkbox',name:"legendposchk",boxLabel:lang.__("個別に指定"),margin:0,inputValue:0}]},{xtype:'container',layout:"hbox",margin:"5 0 5 0",items:[{xtype:'displayfield',fieldLabel:lang.__("マップ内余白(mm)"),labelWidth:"120px"},{xtype:'textfield',fieldLabel:lang.__("上"),labelWidth:"20px",width:60,name:"legendmapmt",value:"3"},{xtype:'textfield',fieldLabel:lang.__("下"),labelWidth:"20px",width:60,name:"legendmapmb",value:"3"},{xtype:'textfield',fieldLabel:lang.__("左"),labelWidth:"20px",width:60,name:"legendmapml",value:"3"},{xtype:'textfield',fieldLabel:lang.__("右"),labelWidth:"20px",width:60,name:"legendmapmr",value:"3"}]},{xtype:'container',layout:"hbox",margin:"5 0 5 0",items:[{xtype:'displayfield',fieldLabel:lang.__("別ページ余白(mm)"),labelWidth:"120px"},{xtype:'textfield',fieldLabel:lang.__("上"),labelWidth:"20px",width:60,name:"legendmt",value:"10"},{xtype:'textfield',fieldLabel:lang.__("下"),labelWidth:"20px",width:60,name:"legendmb",value:"10"},{xtype:'textfield',fieldLabel:lang.__("左"),labelWidth:"20px",width:60,name:"legendml",value:"10"},{xtype:'textfield',fieldLabel:lang.__("右"),labelWidth:"20px",width:60,name:"legendmr",value:"10"},{xtype:'splitter'},{xtype:'checkbox',boxLabel:lang.__("余白なし"),width:80,name:"legendnoframe",inputValue:"1"}]}]}]},{id:"headerfooter-tab",title:lang.__("ヘッダフッタ"),items:[{xtype:'container',cls:'first-container',border:1,layout:'hbox',items:[{xtype:'radiogroup',fieldLabel:lang.__('ヘッダ<br>左'),labelWidth:'50px',columns:2,items:[{xtype:'container',layout:'hbox',items:[{xtype:'radio',name:'header_l',inputValue:null,fieldStyle:{"margin-top":"15px"},boxLabel:lang.__('なし'),checked:true},{xtype:'container',margin:"0 0 0 10",items:[{xtype:'radio',margin:0,name:'header_l',inputValue:"title",boxLabel:lang.__('タイトル')},{xtype:'container',layout:"hbox",padding:"0 0 3 0",items:[{xtype:'radio',margin:0,name:'header_l',inputValue:"text",boxLabel:lang.__('文字列')+"&nbsp;"},{xtype:'textfield',name:"header_l_text"}]}]}]}]}]},{xtype:'container',cls:'first-container',border:1,layout:'hbox',items:[{xtype:'radiogroup',fieldLabel:lang.__('ヘッダ<br>&nbsp;&nbsp;中央'),labelWidth:'50px',columns:2,items:[{xtype:'container',layout:'hbox',items:[{xtype:'radio',name:'header_c',inputValue:null,fieldStyle:{"margin-top":"15px"},boxLabel:lang.__('なし'),checked:true},{xtype:'container',margin:"0 0 0 10",items:[{xtype:'radio',margin:0,name:'header_c',inputValue:"title",boxLabel:lang.__('タイトル')},{xtype:'container',layout:"hbox",padding:"0 0 3 0",items:[{xtype:'radio',margin:0,name:'header_c',inputValue:"text",boxLabel:lang.__('文字列')+"&nbsp;"},{xtype:'textfield',name:"header_c_text"}]}]}]}]}]},{xtype:'container',cls:'first-container',border:1,layout:'hbox',items:[{xtype:'radiogroup',fieldLabel:lang.__('ヘッダ<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;右'),labelWidth:'50px',columns:2,items:[{xtype:'container',layout:'hbox',items:[{xtype:'radio',name:'header_r',inputValue:null,fieldStyle:{"margin-top":"15px"},boxLabel:lang.__('なし'),checked:true},{xtype:'container',margin:"0 0 0 10",items:[{xtype:'container',layout:"hbox",items:[{xtype:'radio',margin:0,name:'header_r',inputValue:"date",boxLabel:lang.__('印刷日・データ日')},{xtype:'displayfield',value:"&nbsp;&nbsp;&nbsp;"},{xtype:'radio',margin:0,name:'header_r',inputValue:"time",boxLabel:lang.__('印刷日時・データ日時')}]},{xtype:'container',layout:"hbox",padding:"0 0 3 0",items:[{xtype:'radio',margin:0,name:'header_r',inputValue:"text",boxLabel:lang.__('文字列')+"&nbsp;"},{xtype:'textfield',name:"header_r_text"}]}]}]}]}]},{xtype:'container',cls:'first-container',border:1,layout:'hbox',items:[{xtype:'checkbox',name:"fpage",fieldLabel:lang.__('フッタ'),labelWidth:"60px",boxLabel:lang.__("ページ番号"),inputValue:"1"},{xtype:'checkbox',name:"fmappage",boxLabel:lang.__("マップ分割番号"),margin:"0 0 0 10",inputValue:"1"}]}]},{id:"index-tab",title:lang.__("外枠索引"),items:[{xtype:'container',cls:'first-container',border:1,items:[{xtype:"fieldcontainer",fieldLabel:lang.__('外枠索引'),labelWidth:60,items:[{xtype:'checkbox',name:"index_enabled",boxLabel:lang.__("表示する"),inputValue:"1"},{xtype:"container",layout:"hbox",width:300,items:[{xtype:'combo',fieldLabel:lang.__('横'),labelWidth:20,width:150,store:new Ext.data.SimpleStore({fields:['value','display'],data:[["1",lang.__("数字 (1、2、3..)")],["2",lang.__("英字 (A、B、C..)")]],autoLoad:false}),displayField:'display',valueField:'value',name:"index_h",value:"2",editable:false},{xtype:"displayfield",value:"&nbsp;&nbsp;"},{xtype:'combo',width:40,store:new Ext.data.SimpleStore({fields:['value','display'],data:[["1","1"],["2","2"],["3","3"],["4","4"],["5","5"],["6","6"],["7","7"],["8","8"],["9","9"],["10","10"]],autoLoad:false}),displayField:'display',valueField:'value',name:"index_cols",value:"6",editable:false},{xtype:"displayfield",value:lang.__("分割")}]},{xtype:"container",layout:"hbox",width:300,items:[{xtype:'combo',fieldLabel:lang.__('縦'),labelWidth:20,width:150,store:new Ext.data.SimpleStore({fields:['value','display'],data:[["1",lang.__("数字 (1、2、3..)")],["2",lang.__("英字 (A、B、C..)")]],autoLoad:false}),displayField:'display',valueField:'value',name:"index_v",value:"1",editable:false},{xtype:"displayfield",value:"&nbsp;&nbsp;"},{xtype:'combo',width:40,store:new Ext.data.SimpleStore({fields:['value','display'],data:[["1","1"],["2","2"],["3","3"],["4","4"],["5","5"],["6","6"],["7","7"],["8","8"],["9","9"],["10","10"]],autoLoad:false}),displayField:'display',valueField:'value',name:"index_cols",value:"6",editable:false},{xtype:"displayfield",value:lang.__("分割")}]},{xtype:'textfield',name:"index_size",fieldLabel:lang.__('幅(mm)'),labelWidth:50,width:95,value:"5"}]}]},{xtype:'container',cls:'first-container',border:1,items:[{xtype:'checkbox',name:"printindex",fieldLabel:lang.__("インデックス地図"),boxLabel:lang.__("出力する(マップ出力時のみ)"),inputValue:"1"}]}]}]}]});return formPanel;},onHideDialog:function()
{var me=this;if(me.resetOnHide){this.pdfRangeLayer.onHideDialog();}},onchangePaperField:function(){var me=this;me.values.bbox=null;me.showPrintRange();me.showPreview();},showPrintRange:function(){var me=this;var bounds=null;var bbox=me.values.bbox;if(!!bbox&&(bbox=bbox.split(",")).length==4){bounds=new OpenLayers.Bounds(bbox[0],bbox[1],bbox[2],bbox[3]);}
me.pdfRangeLayer.showPrintRange(bounds);},showPreview:function(){var me=this;var stmap=me.stmap;var pdfControl=me.pdfControl;var params=pdfControl.createPdfParams();params.preview="1";stmap.api.createPdf(params,function(data){var info=data;me._showPreview(info);});},_showPreview:function(info)
{var me=this;var stmap=me.stmap;try{var pdfW=info.pageWidth;var pdfH=info.pageHeight;if(pdfW&&pdfH){if(info.map){var wmsUrl=null;var layerIds=stmap.getVisibleLayerIds();if(layerIds.length){wmsUrl=SaigaiTask.contextPath+"/page/map/wmsAuth/?SERVICE=WMS";var mapInfo=map.ecommaps[0].mapInfo;wmsUrl+="&mid="+mapInfo.mapId+"&cid="+mapInfo.communityId;wmsUrl+="&LAYERS="+stmap.getVisibleLayerIds().reverse().join(",");}
if(wmsUrl){var previewURL=wmsUrl+"&REQUEST=GetMap&FORMAT=image/png";previewURL+="&BBOX="+info.bbox.join(',');previewURL+="&WIDTH=256&HEIGHT=256";previewURL+="&SRS=EPSG:"+stmap.epsg+"&epsg="+stmap.epsg;previewURL+="&"+new Date().getTime();var previewMapImageContainer=me.previewMapImageContainer;var maxw=previewMapImageContainer.width;var maxh=maxw;var extImgObj=stmap.createImg(previewURL,lang.__("印刷プレビュー（登録情報のみ）"),maxw,maxh);previewMapImageContainer.removeAll();previewMapImageContainer.add(extImgObj);if(!!extImgObj)extImgObj.getEl().setStyle("border","1px solid lightgray");}}
if(info.index_h)div.appendChild(this._createPreviewDiv(lang._('Index'),"preview_index_h",info.index_h,pdfW,pdfH,pageX,pageY,pageW,pageH));if(info.index_v)div.appendChild(this._createPreviewDiv(lang._('Index'),"preview_index_v",info.index_v,pdfW,pdfH,pageX,pageY,pageW,pageH));div.appendChild(this._createPreviewDiv(lang._('Map Frame'),"preview_frame",info.frame,pdfW,pdfH,pageX,pageY,pageW,pageH));if(info.title)div.appendChild(this._createPreviewDiv(lang._('Map Title'),"preview_title",info.title,pdfW,pdfH,pageX,pageY,pageW,pageH));if(info.legend)div.appendChild(this._createPreviewDiv(lang._('Legend<!--2-->'),"preview_legend",info.legend,pdfW,pdfH,pageX,pageY,pageW,pageH));if(info.scale)div.appendChild(this._createPreviewDiv(lang._('Scale'),"preview_scale",info.scale,pdfW,pdfH,pageX,pageY,pageW,pageH));if(info.description)div.appendChild(this._createPreviewDiv(lang._('Explanation and Comment'),"preview_description",info.description,pdfW,pdfH,pageX,pageY,pageW,pageH));if(info.attribution)div.appendChild(this._createPreviewDiv(lang._('Author Info'),"preview_attribution",info.attribution,pdfW,pdfH,pageX,pageY,pageW,pageH));if(info.feature)div.appendChild(this._createPreviewDiv(lang._('Spot Description'),"preview_feature",info.feature,pdfW,pdfH,pageX,pageY,pageW,pageH));}
preview.set('content',div);}catch(e){console.error(e);}},getValues:function(){var me=this;var values=me.formPanel.getValues();{var fields=me.formPanel.form.getFields().items;for(var idx in fields){var field=fields[idx];if(field.xtype=="radiofield"){if(field.checked){var name=field.name;var val=field.inputValue;values[name]=val;}}
else if(field.xtype=="checkbox"){var name=field.name;var val=field.inputValue;if(field.checked){values[name]=val;}
else{values[name]=0;}}}}
Ext.apply(me.values,values);if(me.pdfRangeLayer!=null){me.values.bbox=me.pdfRangeLayer.getBBOX();}
return Ext.apply({},me.values);},isExportable:function(){var me=this;var values=me.getValues();return!(values.printmap==0&&values.printlegend==0);},updateExportButtonEnabled:function(){var me=this;if(me.isExportable()){me.exportButton.setTooltip("");me.exportButton.enable();}
else{me.exportButton.setTooltip(lang.__("出力内容を１つ以上選択してください。"));me.exportButton.disable();}},onexport:function(){var me=this;me.progressbar.show();me.downloadButton.hide();me.exportButton.hide();me.exportImageButton.hide();me.pdfControl.print();me.topToolbar.disable();me.contentsContainer.disable();},onsuccess:function(){var me=this;me.progressbar.reset(true);me.progressbar.text=me.progressbarInitText;me.progressbar.hide();me.downloadButton.show();me.topToolbar.enable();me.contentsContainer.enable();me.exportButton.show();me.exportImageButton.show();}};SaigaiTask.Map.util={};SaigaiTask.Map.util.jQueryUtil={getFormParams:function(selector){var form=$(selector);var params=new Array();var tags=new Array("input","select");for(var k in tags){var param=$.param(form.find(tags[k]));params=params.concat(param.split("&"));}
$.each(form.find("input[type='checkbox']"),function(){var cb=$(this);if(cb.is(":checked")==false){params.splice(jQuery.inArray($.param(cb),params),1);}});return params;},submitForm:function(selector,submitOption){var option={async:false,data:SaigaiTask.Map.util.jQueryUtil.getFormParams(selector).join("&")};SaigaiTask.Map.extend(option,submitOption);var form=$(selector);option.url=form.attr("action");option.type=form.attr("method");return $.ajax(option).responseText;},visibility:function(selector,visibility){var name='visibility';if(typeof visibility=='undefined')return $(selector).css(name);else return $(selector).css(name,(visibility?'visible':'hidden'));}};SaigaiTask.Map.view.DrawToolbar=function(){this.initialize.apply(this,arguments);};SaigaiTask.Map.view.DrawToolbar.prototype={map:null,tbar:null,tbarItems:null,drawLayer:null,options:null,initialize:function(map,toolbarOptions){var me=this;me.map=map;me.drawLayer=new SaigaiTask.Map.Layer.DrawLayer(map);me.tbarItems=me.initDrawToolbarItems(toolbarOptions);if(me.options.init){me.tbar=me.getSimpleToolbar();}
me.loadFeatureGeometry();},getSimpleToolbar:function(){var me=this;if(me.tbar==null){me.tb=Ext.create("Ext.toolbar.Toolbar",{items:me.tbarItems,renderTo:me.options.renderTo});}
return me.tb;},initDrawToolbarItems:function(toolbarOptions){var me=this;var map=me.map;var olmap=map.map;var options={};Ext.applyIf(options,toolbarOptions);var defaultOptions={init:true,renderTo:document.body,label:null,drawPoint:false,drawLine:false,drawPolygon:false,drawCircle:false,strokeColor:false,modifyFeature:true,dragFeature:true,removeFeature:true,maxDrawNum:1};Ext.applyIf(options,defaultOptions);me.options=options;var geomType=options.geomType;var buttons=me.buttons={drawPointButton:null,drawLineButton:null,drawPolygonButton:null,modifyFeatureButton:null,dragFeatureButton:null};var items=[];var maxDrawNum=options.maxDrawNum;var drawFeature=function(drawFeatureOptions){var options={};Ext.applyIf(options,drawFeatureOptions);var defaultOptions={button:null,map:null,drawKey:"point",maxDrawNum:1};Ext.applyIf(options,defaultOptions);var button=options.button;var map=options.map;var drawKey=options.drawKey;var maxDrawNum=options.maxDrawNum;var drawLayer=me.drawLayer;var drawControl=drawLayer.getDrawControl(drawKey);var layer=drawLayer.layer;var currentDrawNum=layer.features.length;if(currentDrawNum<maxDrawNum){var onFeatureAdded=null;onFeatureAdded=function(){if(maxDrawNum<=layer.features.length){drawLayer.deactivateDrawControl(drawKey);drawControl.events.unregister("featureadded",map,onFeatureAdded);map.toFront(layer);map.setNavigationControlActivation(true);map.events.triggerEvent(map.EventType.afterdraw,{drawKey:drawKey});if(button!=null){button.toggle(false);}}};drawControl.events.register("featureadded",map,onFeatureAdded);drawLayer.activateDrawControl(drawKey);map.toFront(layer);}};if(options.label){items.push(options.label);}
if(options.drawPoint){var drawPointButton=buttons.drawPointButton=Ext.create("Ext.button.Button",{text:lang.__("Point"),iconCls:"draw-point-icon",tooltip:lang.__("Draw a point."),toggleGroup:"draw-button",enableToggle:true,drawToolbarType:"drawPoint"});items.push(drawPointButton);drawPointButton.on("click",function(button,e,eOpts){var drawKey="point";var drawLayer=me.drawLayer;drawLayer.deactivateCurrentDrawControl();var drawControl=drawLayer.getDrawControl(drawKey);var layer=drawLayer.layer;var currentDrawNum=layer.features.length;if(maxDrawNum<=currentDrawNum){button.toggle(false);alert(lang.__("This feature can register {0} {1} or less.",drawPointButton.text,maxDrawNum));}
else if(button.pressed){drawFeature({button:button,map:map,drawKey:drawKey,drawNum:1,maxDrawNum:maxDrawNum});}
else{map.setNavigationControlActivation(true);}});me.bindButtonControlActivation(drawPointButton,"point");}
if(options.drawPolygon){var drawPolygonButton=buttons.drawPolygonButton=Ext.create("Ext.button.Button",{text:lang.__("Surface"),iconCls:"draw-polygon-icon",tooltip:lang.__("Draw surface."),toggleGroup:"draw-button",enableToggle:true,drawToolbarType:"drawPolygon"});items.push(drawPolygonButton);drawPolygonButton.on("click",function(button,e,eOpts){var drawKey="polygon";var drawLayer=me.drawLayer;drawLayer.deactivateCurrentDrawControl();var drawControl=drawLayer.getDrawControl(drawKey);var layer=drawLayer.layer;var currentDrawNum=layer.features.length;if(maxDrawNum<=currentDrawNum){button.toggle(false);alert(lang.__("This feature can register {0} {1} or less.",drawPolygonButton.text,maxDrawNum));}
else if(button.pressed){drawFeature({button:button,map:map,drawKey:drawKey,drawNum:1,maxDrawNum:maxDrawNum});}
else{map.setNavigationControlActivation(true);}
me.bindButtonControlActivation(drawPolygonButton,"polygon");});}
if(options.drawCircle){var drawCircleButton=buttons.drawCircleButton=Ext.create("Ext.button.Button",{text:lang.__("Circle"),iconCls:"draw-circle-icon",tooltip:lang.__("Draw a circle."),toggleGroup:"draw-button",enableToggle:true,drawToolbarType:"drawCircle"});items.push(drawCircleButton);drawCircleButton.on("click",function(button,e,eOpts){var drawKey="circle";var drawLayer=me.drawLayer;drawLayer.deactivateCurrentDrawControl();var drawControl=drawLayer.getDrawControl(drawKey);var layer=drawLayer.layer;var currentDrawNum=layer.features.length;if(maxDrawNum<=currentDrawNum){button.toggle(false);alert(lang.__("This feature can register {0} {1} or less.",drawCircleButton.text,maxDrawNum));}
else if(button.pressed){drawFeature({button:button,map:map,drawKey:drawKey,drawNum:1,maxDrawNum:maxDrawNum});}
else{map.setNavigationControlActivation(true);}
me.bindButtonControlActivation(drawCircleButton,"circle");});}
if(options.drawLine){var drawLineButton=buttons.drawLineButton=Ext.create("Ext.button.Button",{text:lang.__("Line"),iconCls:"draw-line-icon",tooltip:lang.__("Draw line."),toggleGroup:"draw-button",enableToggle:true,drawToolbarType:"drawLine"});items.push(drawLineButton);drawLineButton.on("click",function(button,e,eOpts){var drawKey="line";var drawLayer=me.drawLayer;drawLayer.deactivateCurrentDrawControl();var drawControl=drawLayer.getDrawControl(drawKey);var layer=drawLayer.layer;var currentDrawNum=layer.features.length;if(maxDrawNum<=currentDrawNum){button.toggle(false);alert(lang.__("This feature can register {0} {1} or less.",drawLineButton.text,maxDrawNum));}
else if(button.pressed){drawFeature({button:button,map:map,drawKey:drawKey,drawNum:1,maxDrawNum:maxDrawNum});}
else{map.setNavigationControlActivation(true);}});me.bindButtonControlActivation(drawLineButton,"line");}
if(options.drawFreeLine){var drawFreeLineButton=buttons.drawFreeLineButton=Ext.create("Ext.button.Button",{text:lang.__("Line by hand"),iconCls:"draw-freeline-icon",tooltip:lang.__("Draw line by hand"),toggleGroup:"draw-button",enableToggle:true,drawToolbarType:"drawFreeLine"});items.push(drawFreeLineButton);drawFreeLineButton.on("click",function(button,e,eOpts){var drawKey="freeline";var drawLayer=me.drawLayer;drawLayer.deactivateCurrentDrawControl();var drawControl=drawLayer.getDrawControl(drawKey);var layer=drawLayer.layer;var currentDrawNum=layer.features.length;if(maxDrawNum<=currentDrawNum){button.toggle(false);alert(lang.__("This feature can register {0} {1} or less.",drawFreeLineButton.text,maxDrawNum));}
else if(button.pressed){drawFeature({button:button,map:map,drawKey:drawKey,drawNum:1,maxDrawNum:maxDrawNum});}
else{map.setNavigationControlActivation(true);}});me.bindButtonControlActivation(drawFreeLineButton,"freeline");}
if(options.drawText){var drawTextButton=buttons.drawTextButton=Ext.create("Ext.button.Button",{text:lang.__("Text<!--1-->"),iconCls:"draw-text-icon",tooltip:lang.__("Draw text"),toggleGroup:"draw-button",enableToggle:true,drawToolbarType:"drawText"});items.push(drawTextButton);drawTextButton.on("click",function(button,e,eOpts){var drawKey="text";var drawLayer=me.drawLayer;drawLayer.deactivateCurrentDrawControl();var drawControl=drawLayer.getDrawControl(drawKey);var layer=drawLayer.layer;var currentDrawNum=layer.features.length;if(button.pressed){drawFeature({button:button,map:map,drawKey:drawKey,drawNum:1,maxDrawNum:maxDrawNum});}
else{map.setNavigationControlActivation(true);}});me.bindButtonControlActivation(drawTextButton,"text");}
items.push("-");if(options.strokeColor){var colorMenu=Ext.create("Ext.menu.ColorPicker",{handler:function(cm,color){me.drawLayer.layer.styleMap.styles['default'].defaultStyle.strokeColor="#"+color;me.drawLayer.userStyle.strokeColor="#"+color;me.drawLayer.layer.styleMap.styles['temporary'].defaultStyle.strokeColor="#"+color;buttonEl=buttons.strokeColorButton.getEl();buttonIconEl=buttonEl.select(".x-btn-icon");buttonIconEl.setStyle("background-color","#"+color);me.drawLayer.setSelectedFeatureStyle(function(f){f.style.strokeColor="#"+color;});}});var menu=Ext.create("Ext.menu.Menu",{style:{},items:[{menu:colorMenu}]});var strokeColorButton=buttons.strokeColorButton=Ext.create("Ext.button.Button",{text:lang.__("Line color"),iconCls:"draw-freeline-icon",tooltip:lang.__("Change line color."),menu:colorMenu,drawToolbarType:"strokeColor"});items.push(strokeColorButton);}
if(!!options.strokeWidth){var defaultStrokeWidth=me.drawLayer.layer.styleMap.styles.default.defaultStyle.strokeWidth;var data=[];var strokeWidthMenuItems=[];for(var strokeWidth=0;strokeWidth<=10;strokeWidth++){data.push({display:strokeWidth+"px",value:strokeWidth});var getStrokeWidthIconUrl=function(strokeWidth){return map.icon.baseURL+"/icons/stroke_width/line_width_"+strokeWidth+".png";}
var iconUrl=getStrokeWidthIconUrl(strokeWidth);var handler=(function(strokeWidth){return function(item,e){var menuItem=$(item.getEl().dom);menuItem.siblings().removeClass("selected-menu");menuItem.addClass("selected-menu");me.drawLayer.layer.styleMap.styles['default'].defaultStyle.strokeWidth=strokeWidth;me.drawLayer.userStyle.strokeWidth=strokeWidth;me.drawLayer.layer.styleMap.styles['temporary'].defaultStyle.strokeWidth=strokeWidth;var iconUrl=getStrokeWidthIconUrl(strokeWidth);buttonEl=buttons.strokeWidthButton.getEl();buttonIconEl=buttonEl.select(".x-btn-icon");buttonIconEl.setStyle("background-image","url('"+iconUrl+"')");me.drawLayer.setSelectedFeatureStyle(function(f){f.style.strokeWidth=strokeWidth;});}})(strokeWidth);strokeWidthMenuItems.push({text:strokeWidth+"px",icon:iconUrl,handler:handler,cls:strokeWidth==defaultStrokeWidth?"selected-menu":""});}
var icon=getStrokeWidthIconUrl(defaultStrokeWidth);var strokeWidthButton=buttons.strokeWidthButton=Ext.create("Ext.button.Button",{text:lang.__("Thickness of the line"),icon:icon,tooltip:lang.__("Change thickness of the line."),menu:strokeWidthMenuItems,drawToolbarType:"strokeWidth"});items.push(strokeWidthButton);}
if(options.fillColor){var colorMenu=Ext.create("Ext.menu.ColorPicker",{handler:function(cm,color){me.drawLayer.layer.styleMap.styles['default'].defaultStyle.fillColor="#"+color;me.drawLayer.userStyle.fillColor="#"+color;me.drawLayer.layer.styleMap.styles['temporary'].defaultStyle.fillColor="#"+color;buttonEl=buttons.fillColorButton.getEl();buttonIconEl=buttonEl.select(".x-btn-icon");buttonIconEl.setStyle("background-color","#"+color);me.drawLayer.setSelectedFeatureStyle(function(f){f.style.fillColor="#"+color;});}});var fieldContainer=Ext.create('Ext.form.FieldContainer',{hideLabel:true,layout:{type:"hbox",align:"stretch"},defaults:{flex:1},items:[{xtype:'displayfield',style:{"text-align":'left',},value:lang.__("0%(nontransparent)")},{xtype:'displayfield',style:{"text-align":'right',},value:'100%'}]});colorMenu.add(fieldContainer);var opacitySlider=Ext.create('Ext.slider.Single',{hideLabel:true,increment:10,minValue:0,maxValue:100,value:me.drawLayer.modifyStyleMap.styles['default'].defaultStyle.fillOpacity*100,tipText:function(sliderThumb){if(sliderThumb.value==0)return lang.__("Transparency")+lang.__("0%(nontransparent)");return lang.__("Transparency")+sliderThumb.value+"%";},listeners:{changecomplete:function(slider,newValue,thumb,eOpts){var opacity=Math.abs(100-thumb.value)/100;me.drawLayer.layer.styleMap.styles['default'].defaultStyle.fillOpacity=opacity;me.drawLayer.userStyle.fillOpacity=opacity;me.drawLayer.layer.styleMap.styles['temporary'].defaultStyle.fillOpacity=opacity;me.drawLayer.setSelectedFeatureStyle(function(f){f.style.fillOpacity=opacity;});}}});colorMenu.add(opacitySlider);var menu=Ext.create("Ext.menu.Menu",{style:{},items:[{menu:colorMenu}]});var fillColorButton=buttons.fillColorButton=Ext.create("Ext.button.Button",{text:lang.__("Fill color"),iconCls:"paintcan-icon",tooltip:lang.__("Change fill color."),menu:colorMenu,drawToolbarType:"fillColor"});items.push(fillColorButton);}
if(options.fontColor){var colorMenu=Ext.create("Ext.menu.ColorPicker",{handler:function(cm,color){me.drawLayer.layer.styleMap.styles['default'].defaultStyle.fontColor="#"+color;me.drawLayer.userStyle.fontColor="#"+color;me.drawLayer.layer.styleMap.styles['temporary'].defaultStyle.fontColor="#"+color;buttonEl=buttons.fontColorButton.getEl();buttonIconEl=buttonEl.select(".x-btn-icon");buttonIconEl.setStyle("background-color","#"+color);me.drawLayer.setSelectedFeatureStyle(function(f){f.style.fontColor="#"+color;});}});var menu=Ext.create("Ext.menu.Menu",{style:{},items:[{menu:colorMenu}]});var fontColorButton=buttons.fontColorButton=Ext.create("Ext.button.Button",{text:lang.__("Font color"),iconCls:"draw-text-icon",tooltip:lang.__("Change font color."),menu:colorMenu,drawToolbarType:"fontColor"});items.push(fontColorButton);}
if(!!options.fontSize){var defaultFontSize=me.drawLayer.layer.styleMap.styles.default.defaultStyle.fontSize;var data=[];var fontSizeMenuItems=[];var fontSizes=[10,12,14,18,22,28];for(var idx in fontSizes){fontSize=fontSizes[idx];data.push({display:fontSize+"px",value:fontSize});var getFontSizeIconUrl=function(fontSize){var pt=fontSize;switch(fontSize){case 10:pt=8;break;case 12:pt=10;break;case 14:pt=12;break;case 18:pt=14;break;case 22:pt=18;break;case 28:pt=21;break;}
return map.icon.baseURL+"/icons/font_size/font_size_"+pt+"pt.png";}
var iconUrl=getFontSizeIconUrl(fontSize);var handler=(function(fontSize){return function(item,e){var menuItem=$(item.getEl().dom);menuItem.siblings().removeClass("selected-menu");menuItem.addClass("selected-menu");me.drawLayer.layer.styleMap.styles['default'].defaultStyle.fontSize=fontSize;me.drawLayer.userStyle.fontSize=fontSize;me.drawLayer.layer.styleMap.styles['temporary'].defaultStyle.fontSize=fontSize;var iconUrl=getFontSizeIconUrl(fontSize);buttonEl=buttons.fontSizeButton.getEl();buttonIconEl=buttonEl.select(".x-btn-icon");buttonIconEl.setStyle("background-image","url('"+iconUrl+"')");me.drawLayer.setSelectedFeatureStyle(function(f){f.style.fontSize=fontSize;me.drawLayer.setLabelBackground(f);});}})(fontSize);fontSizeMenuItems.push({text:fontSize+"px",icon:iconUrl,handler:handler,cls:fontSize==defaultFontSize?"selected-menu":""});}
var icon=getFontSizeIconUrl(defaultFontSize);var fontSizeButton=buttons.fontSizeButton=Ext.create("Ext.button.Button",{text:lang.__("Font Size"),icon:icon,tooltip:lang.__("Change size of the font."),menu:fontSizeMenuItems,drawToolbarType:"fontSize"});items.push(fontSizeButton);}
items.push("-");if(options.modifyFeature){var modifyFeatureButton=buttons.modifyFeatureButton=Ext.create("Ext.button.Button",{text:lang.__("Edit"),iconCls:"modify-feature-icon",tooltip:lang.__("Edit vertex of the line and face."),toggleGroup:"draw-button",enableToggle:true,drawToolbarType:"modifyFeature"});items.push(modifyFeatureButton);modifyFeatureButton.on("click",function(button,e,eOpts){var drawLayer=me.drawLayer;drawLayer.deactivateCurrentDrawControl();var layer=drawLayer.layer;var currentDrawNum=layer.features.length;if(button.pressed&&0<currentDrawNum){drawLayer.setModifyFeatureControlActivation(true);map.toFront(layer);}
else{button.toggle(false);map.setNavigationControlActivation(true);}});me.bindButtonControlActivation(modifyFeatureButton,"modifyFeature");}
if(options.dragFeature){var drawLayer=me.drawLayer;var dragFeatureButton=buttons.dragFeatureButton=Ext.create("Ext.button.Button",{text:lang.__("Move"),iconCls:"drag-feature-icon",tooltip:lang.__("Move point, line, surface."),toggleGroup:"draw-button",pressed:drawLayer.getDragFeatureControlActivation(),enableToggle:true,drawToolbarType:"dragFeature"});items.push(dragFeatureButton);dragFeatureButton.on("click",function(button,e,eOpts){drawLayer.deactivateCurrentDrawControl();var layer=drawLayer.layer;var currentDrawNum=layer.features.length;if(button.pressed&&0<currentDrawNum){drawLayer.setDragFeatureControlActivation(true);map.toFront(layer);}
else{drawLayer.setDragFeatureControlActivation(false);map.setNavigationControlActivation(true);}});me.bindButtonControlActivation(dragFeatureButton,"dragFeature");}
if(options.selectDragFeature){var drawLayer=me.drawLayer;var selectDragFeatureButton=buttons.selectDragFeatureButton=Ext.create("Ext.button.Button",{text:lang.__("Select"),iconCls:"cursor-icon",tooltip:lang.__("Select feature by clicking.")+"<br/>"
+lang.__("To select more than one, press Ctrl key.")+"<br/>"
+lang.__("Delete selected features by DELETE key.")+"<br/>"
+lang.__("Move selected features by arrow keys.")+"<br/>"
+lang.__("Move feature by dragging.")+"<br/>"
+lang.__("Edit text by double-click."),toggleGroup:"draw-button",pressed:drawLayer.getSelectDragFeatureControlActivation(),enableToggle:true,drawToolbarType:"selectDragFeature"});items.push(selectDragFeatureButton);selectDragFeatureButton.on("click",function(button,e,eOpts){drawLayer.deactivateCurrentDrawControl();var layer=drawLayer.layer;var currentDrawNum=layer.features.length;if(button.pressed&&0<currentDrawNum){drawLayer.setSelectDragFeatureControlActivation(true);}
else{drawLayer.setSelectDragFeatureControlActivation(false);map.setNavigationControlActivation(true);}});me.bindButtonControlActivation(selectDragFeatureButton,"selectDragFeature");}
if(options.selectRangeFeature){var drawLayer=me.drawLayer;var selectRangeFeatureButton=buttons.selectRangeFeatureButton=Ext.create("Ext.button.Button",{text:lang.__("Range Select"),iconCls:"range-icon",tooltip:lang.__("Select feature by box."),toggleGroup:"draw-button",pressed:drawLayer.getBoxSelectDragFeatureControlActivation(),enableToggle:true,drawToolbarType:"selectRangeFeature"});items.push(selectRangeFeatureButton);selectRangeFeatureButton.on("click",function(button,e,eOpts){drawLayer.deactivateCurrentDrawControl();var layer=drawLayer.layer;var currentDrawNum=layer.features.length;if(button.pressed&&0<currentDrawNum){drawLayer.setBoxSelectDragFeatureControlActivation(true);}
else{drawLayer.setBoxSelectDragFeatureControlActivation(false);map.setNavigationControlActivation(true);}});me.bindButtonControlActivation(selectRangeFeatureButton,"selectDragFeatureBox");}
if(options.removeSelectedFeature){var removeSelectedFeatureButton=Ext.create("Ext.button.Button",{text:lang.__("Delete"),iconCls:"removeselected-feature-icon",tooltip:lang.__("Delete selected note."),drawToolbarType:"removeSelectedFeature"});items.push(removeSelectedFeatureButton);removeSelectedFeatureButton.on("click",function(button,e,eOpts){if(0<drawLayer.layer.selectedFeatures.length){Ext.MessageBox.confirm("",lang.__("Delete selected note?"),function(btn){if(btn=="yes"){me.drawLayer.removeSelectedFeature(true);}});}});}
if(options.removeFeature){var removeAllFeatureButton=Ext.create("Ext.button.Button",{text:lang.__("Delete all<!--2-->"),iconCls:"removeall-feature-icon",tooltip:lang.__("Delete all drawn objects."),drawToolbarType:"removeFeature"});items.push(removeAllFeatureButton);removeAllFeatureButton.on("click",function(button,e,eOpts){if(1<drawLayer.layer.features.length){Ext.MessageBox.confirm(lang.__("Confirmation of all Delete"),lang.__("Are you sure to delete all drawn objects?"),function(btn){if(btn=="yes"){me.drawLayer.layer.removeAllFeatures();}});}
else{me.drawLayer.layer.removeAllFeatures();}});}
if(options.intersectLayerId!=null){var intersectLayerId=options.intersectLayerId;var intersectButton=Ext.create("Ext.button.Button",{text:lang.__("Crop"),iconCls:"intersection-feature-icon",tooltip:lang.__("Crop and shape drawing."),drawToolbarType:"intersect"});items.push(intersectButton);intersectButton.on("click",function(button,e,eOpts){var feature=null;try{feature=me.getDrawFeature(geomType);}catch(e){alert(lang.__("Invalid graphic. Please correct that graphics do not cross."));}
var feature=me.getDrawFeature(geomType);if(feature==null){alert(lang.__("No shape drawn."));}
else{Ext.MessageBox.confirm(lang.__("Confirmation of cropping"),lang.__("Cropping by {0}.<br/>Are you sure ?",options.intersectLayerName),function(btn){if(btn=="yes"){try{feature=feature.clone();var geometry=feature.geometry;var wkt=null;feature.geometry.transform(olmap.getProjectionObject(),new OpenLayers.Projection("EPSG:4326"));var wktFormat=new OpenLayers.Format.WKT();wkt=wktFormat.write(feature);console.log("wkt");console.log(wkt);var result=map.api.intersection(wkt,intersectLayerId);console.log("result");console.log(result);if(result!=null&&typeof result.wkt=="string"){var drawLayer=me.drawLayer;var layer=drawLayer.layer;layer.removeAllFeatures();var features=wktFormat.read(result.wkt);if(typeof features=="undefined"){alert(lang.__("Shape empty."));}
else{var geometry=features.geometry;var resultGeomType=geometry.CLASS_NAME.split(".")[2].toUpperCase();if(geomType.indexOf(resultGeomType)==-1){var getGeomName=function(geomType){var type=geomType.toUpperCase();var name=type.indexOf("POINT")!=-1?lang.__("Point"):type.indexOf("LINESTRING")!=-1?lang.__("Line"):type.indexOf("POLYGON")!=-1?lang.__("Surface"):lang.__("Unknown");if(type.indexOf("MULTI")==0)name+=lang.__("(Multiple)");return name;};var message=lang.__("Shape type not the same.");message+="\n";message+=lang.__("Unable to draw {0} in {1}.",getGeomName(resultGeomType),getGeomName(geomType));alert(message);}
else{drawLayer.drawFeatureByGeometry(geometry);layer.redraw(true);}}}}catch(e){Ext.MessageBox.alert(lang.__("Failed to crop"),e);}}});}});}
items.push("-");if(!!options.undo){var undoButton=buttons.undoButton=Ext.create("Ext.button.Button",{text:lang.__("Restore"),icon:map.icon.getURL("undoIconURL"),tooltip:lang.__("Restore drawing."),drawToolbarType:"undo"});undoButton.on("click",function(button,e,eOpts){me.drawLayer.historyControl.undo();});items.push(undoButton);me.drawLayer.layer.events.on({"historychange":function(args){var historyControl=args.historyControl;enable=0<=historyControl.stackIndex;undoButton.setDisabled(!enable);console.log("undoButton: "+(enable?"enabled":"disabled")+" stackIndex:"+historyControl.stackIndex);}});}
if(!!options.redo){var redoButton=buttons.redoButton=Ext.create("Ext.button.Button",{text:lang.__("Redo"),icon:map.icon.getURL("redoIconURL"),tooltip:lang.__("Redo drawing."),drawToolbarType:"redo"});redoButton.on("click",function(button,e,eOpts){me.drawLayer.historyControl.redo();});items.push(redoButton);me.drawLayer.layer.events.on({"historychange":function(args){var historyControl=args.historyControl;enable=historyControl.stackIndex+1<historyControl.stack.length;redoButton.setDisabled(!enable);console.log("undoButton: "+(enable?"enabled":"disabled")+" stackIndex:"+historyControl.stackIndex);}});}
var splitItem=function(items){var maxRowNum=6;if(maxRowNum<=items.length){if(-1<items.indexOf("-")){}}}
return items;},getDrawFeature:function(geomType,option){var me=this;var drawLayer=me.drawLayer;var layer=drawLayer.layer;var features=layer.features;if(features.length==0)return null;copy=[];for(var featuresIdx in features){copy.push(features[featuresIdx].clone());}
features=copy;if(option&&option.pseudo){for(var featuresIdx in features){var feature=features[featuresIdx];var pseudoGeom=me.convertPseudoGeometry(geomType,feature.geometry);if(pseudoGeom!=null)feature.geometry=pseudoGeom;}}
return me.mergeFeatures(features,geomType);},convertPseudoGeometry:function(geomType,geometry){var me=this;var drawLayer=me.drawLayer;var layer=drawLayer.layer;var pseudoGeomType=(-1<geomType.indexOf("MULTI")?geomType.substring(geomType.indexOf("MULTI")+5):geomType);switch(pseudoGeomType){case"POINT":break;case"LINESTRING":break;case"POLYGON":var pseudoPointDiffMeter=0.01;var meterProj=new OpenLayers.Projection("EPSG:900913");if(geometry.CLASS_NAME=="OpenLayers.Geometry.Point"){var northPoint=null;var southPoint=null;{var p=geometry.clone();p.transform(layer.projection,meterProj);var northPoint=p.clone();northPoint.y=p.y+(pseudoPointDiffMeter/2);var southPoint=p.clone();southPoint.y=p.y-(pseudoPointDiffMeter/2);northPoint.transform(meterProj,layer.projection);southPoint.transform(meterProj,layer.projection);}
var ring=new OpenLayers.Geometry.LinearRing([southPoint,northPoint,northPoint,southPoint]);var polygon=new OpenLayers.Geometry.Polygon([ring]);return polygon;}
else if(geometry.CLASS_NAME=="OpenLayers.Geometry.LineString"){var points=[].concat(geometry.components).concat([].concat(geometry.components).reverse());var ring=new OpenLayers.Geometry.LinearRing(points);var polygon=new OpenLayers.Geometry.Polygon([ring]);return polygon;}
else if(geometry.CLASS_NAME=="OpenLayers.Geometry.Polygon"){var isPseudoPoint=function(polygon){if(polygon.components.length!=1)return false;var line=polygon.components[0];var southPoint=line.components[0].clone();var northPoint=line.components[1].clone();if(line.components.length!=4)return false;if(southPoint.equals(line.components[3])==false)return false;if(northPoint.equals(line.components[2])==false)return false;if(southPoint.x!=northPoint.x)return false;northPoint.transform(layer.projection,meterProj);southPoint.transform(layer.projection,meterProj);if(pseudoPointDiffMeter*2<(northPoint.y-southPoint.y))return false;return true;}
var isPseudoLineString=function(polygon){if(polygon.components.length!=1)return false;var line=polygon.components[0];if(line.components.length%2!=0)return false;var pointsNum=line.components.length/2;var line1=new OpenLayers.Geometry.LineString(line.components.slice(0,pointsNum));var line2=new OpenLayers.Geometry.LineString(line.components.slice(pointsNum).reverse());return line1.equals(line2);}
if(isPseudoPoint(geometry)){var line=geometry.components[0];var southPoint=line.components[0];var northPoint=line.components[1];point=southPoint.clone();point.y=(southPoint.y+northPoint.y)/2;return point;}
else if(isPseudoLineString(geometry)){var line=geometry.components[0];var pointsNum=line.components.length/2;var line1=new OpenLayers.Geometry.LineString(line.components.slice(0,pointsNum));return line1;}}
break;}
return null;},mergeFeatures:function(features,geomType){var feature;if(geomType.match(/^MULTI/)){switch(geomType){case"MULTIPOINT":feature=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.MultiPoint(features[0].geometry));break;case"MULTILINESTRING":feature=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.MultiLineString(features[0].geometry));break;case"MULTIPOLYGON":if(features[0].geometry.CLASS_NAME=="OpenLayers.Geometry.MultiPolygon"){feature=features[0];}
else{feature=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.MultiPolygon(features[0].geometry));}
break;}
if(geomType=="MULTIPOLYGON"){for(var i=1;i<features.length;i++){if(!features[i]._sketch){for(var j=0;j<i;j++){if(!features[j]._sketch&&features[i].geometry.intersects(features[j].geometry))throw"Invalid Geometry";}}}}
for(var i=1;i<features.length;i++){if(!features[i]._sketch)feature.geometry.addComponents(features[i].geometry);}
feature.fid=features[0].fid;feature.layer=features[0].layer;}else{feature=features[0];}
return feature;},loadFeatureGeometry:function(){console.log("loadFeatureGeometry");var me=this;var stmap=me.map;var drawLayer=me.drawLayer;var selector="."+drawLayer.getFeatureIDPrefix()+"0";var features=stmap.readFeatureGeometryValue(selector);if(features!=null){var geometry=features.geometry;geometry.transform(new OpenLayers.Projection("EPSG:4326"),new OpenLayers.Projection("EPSG:"+stmap.epsg));var gClass=geometry.CLASS_NAME;switch(gClass){case"OpenLayers.Geometry.Point":var lonlat=new OpenLayers.LonLat(geometry.x,geometry.y);drawLayer.moveSinglePoint(lonlat);break;case"OpenLayers.Geometry.LineString":case"OpenLayers.Geometry.MultiLineString":drawLayer.drawFeature("line",geometry);break;case"OpenLayers.Geometry.Polygon":case"OpenLayers.Geometry.MultiPolygon":drawLayer.drawFeature("polygon",geometry);break;default:console.warn(lang.__("Not support.({0})",gClass));break;}}},bindButtonControlActivation:function(button,drawKey){var me=this;var control=me.drawLayer.getDrawControl(drawKey);control.events.register("activate",null,function(){button.toggle(true);});control.events.register("deactivate",null,function(){button.toggle(false);});}};SaigaiTask.Map.VectorLayer=function(){this.initialize.apply(this,arguments);};SaigaiTask.Map.VectorLayer.prototype={map:null,mapId:null,layerId:null,layer:null,selectedFeatureIds:[],options:null,option:null,events:null,EventType:{beforeselected:"beforeselected"},initialize:function(map,options){var me=this;me.map=map;var olmap=map.map;me.options=options;me.mapId=options.mapId;var layerId=me.layerId=options.layerId;map.switchContentsLayer(layerId,false);map.setLayerSearchable(layerId,true);var layer=me.layer=new OpenLayers.Layer.Vector(me.layerId+" Vector Layer",{projection:olmap.displayProjection,preFeatureInsert:function(feature){feature.geometry.transform(new OpenLayers.Projection("EPSG:4326"),new OpenLayers.Projection("EPSG:"+map.epsg));}});olmap.addLayer(layer);var sldXML=options.sld;if(sldXML!=null){var sldFormat=new OpenLayers.Format.SLD();var sld=sldFormat.read(sldXML);for(var l in sld.namedLayers){var styles=sld.namedLayers[l].userStyles;me.layer.styleMap=styles[0];}}
var styleMap=options.styleMap;if(styleMap!=null){me.layer.styleMap=styleMap;}
var highlightFeature=me.highlightFeatureControl=new OpenLayers.Control.SelectFeature(layer,{hover:true,highlightOnly:true,renderIntent:"temporary",eventListeners:{featurehighlighted:function(e){},featureunhighlighted:function(e){}}});map.addControl(highlightFeature);var selectFeature=me.selectFeatureControl=new OpenLayers.Control.SelectFeature(layer,{clickout:false,toggle:true,multiple:true,toggleKey:"ctrlKey",multipleKey:"shiftKey",renderIntent:"select",eventListeners:{featurehighlighted:function(e){var feature=e.feature;var attributes=feature.attributes;me.select(attributes);},featureunhighlighted:function(e){var feature=e.feature;var attributes=feature.attributes;var id=attributes.id;me.remove(id);}}});map.addControl(selectFeature);me.events=new OpenLayers.Events(me);},load:function(json){var me=this;var map=me.map;var layer=me.layer;var layerId=me.layerId;var count=json.count;layer.removeAllFeatures();if(0<count){var records=json.records;var recordsIdx=null,record,wkt;var wktFormat=new OpenLayers.Format.WKT(),features=[],feature;var filter=[];for(recordsIdx in records){record=records[recordsIdx];wkt=record.wkt;if(wkt!=null){feature=wktFormat.read(wkt);feature.attributes=record;features.push(feature);filter.push(record.featureid);}}
layer.addFeatures(features);for(var selectedFeatureIdsIdx in me.selectedFeatureIds){var selectedFeatureId=me.selectedFeatureIds[selectedFeatureIdsIdx];var feature=me.getFeature(selectedFeatureId);if(feature!=null){me.selectFeatureControl.select(feature);}}
if(map.searchFilter==null)map.searchFilter={};map.searchFilter[layerId]=filter;map.toFront(layer);}},search:function(formSelector){var me=this;var form=$(formSelector);var option={};option.url=form.attr("action");option.type=form.attr("method");option.data=SaigaiTask.Map.util.jQueryUtil.getFormParams(formSelector).join("&");option.async=true;option.success=function(json){me.load(json);};me.option=option;$.ajax(option);},research:function(){var me=this;$.ajax(me.option);},select:function(attributes){var me=this;var cont=me.events.triggerEvent(me.EventType.beforeselected,{attributes:attributes});if(cont==false)return;var id=attributes.id;if(jQuery.inArray(id,me.selectedFeatureIds)==-1){me.selectedFeatureIds.push(id);}
var feature=me.getFeature(id);if(feature!=null){if(me.isSelected(feature)==false){me.selectFeatureControl.select(feature);}}},selectByGeometry:function(geometry){var me=this;if(geometry!=null){var features=me.layer.features;for(var featuresIdx in features){var feature=features[featuresIdx];var point=feature.geometry.getCentroid();if(point.intersects(geometry)){var attributes=feature.attributes;me.select(attributes);}}}},unselect:function(id){var me=this;var index=jQuery.inArray(id,me.selectedFeatureIds);if(index!=-1){me.selectedFeatureIds.splice(index,1);}
var feature=me.getFeature(id);if(feature!=null){me.selectFeatureControl.unselect(feature);}},remove:function(id){var me=this;var index=jQuery.inArray(id,me.selectedFeatureIds);if(index!=-1){me.selectedFeatureIds.splice(index,1);}},getFeature:function(id){var me=this;var features=me.layer.getFeaturesByAttribute("id",id);var feature=null;if(0<features.length){feature=features[0];}
return feature;},isSelected:function(feature){var me=this;var selectedFeatures=me.layer.selectedFeatures;return jQuery.inArray(feature,selectedFeatures)!=-1;}};SaigaiTask.Map.view.ContentsFileFormPanel=function(){this.initialize.apply(this,arguments);};SaigaiTask.Map.view.ContentsFileFormPanel.prototype={stmap:null,formPanel:null,imageView:null,store:null,mid:null,layerId:null,fid:null,initialize:function(stmap,content,options){var me=this;me.stmap=stmap;me.mid=options.mid;me.layerId=options.layerId;me.fid=options.fid;if(options.editable=='undefined')options.editable=true;var ecommapURL=me.stmap.ecommaps[0].ecommapURL;ImageModel=Ext.define('ImageModel',{extend:'Ext.data.Model',fields:[{name:'title'},{name:'url'},{name:'thumbnail'}]});var data=[];if(content!=null){var files=content.files;if(files&&0<files.length){var filesIdx=0;while(filesIdx<files.length){var server=stmap.ecommaps[0].ecommapURL+'/..';var fileURL=files[filesIdx];if(fileURL.indexOf('http')==-1)fileURL=server+fileURL;var fileTitle=files[filesIdx+1];var url=fileURL;var ext=FalUtil.getFileExt(url);var thumbnail=url;if(!ext.match(/jpg|gif|png|jpeg|file/)){thumbnail=ecommapURL+"/map/fileicons/"+ext+".png";}
data.push({title:fileTitle,url:fileURL,thumbnail:thumbnail})
filesIdx+=2;}}}
var store=me.store=Ext.create('Ext.data.Store',{model:'ImageModel',data:data});var imageView=me.imageView=Ext.create('Ext.view.View',{store:store,tpl:['<tpl for=".">','<div class="thumb-wrap" id="{title:stripTags}" style="'+(options.editable?"":"cursor:pointer;")+'">','<div class="thumb" style="height:49px; background-image: url(\'{thumbnail}\'); background-size:contain; background-repeat:no-repeat;background-position:center center;"></div>','<span class="x- editable">{shortName:htmlEncode}</span>','</div>','</tpl>','<div class="x-clear"></div>'],multiSelect:false,trackOver:true,overItemCls:'x-item-over',itemSelector:'div.thumb-wrap',emptyText:lang.__('The file is not registered.'),plugins:[Ext.create('Ext.ux.DataView.DragSelector',{}),Ext.create('Ext.ux.DataView.LabelEditor',{dataIndex:'title'})],prepareData:function(data){Ext.apply(data,{shortName:Ext.util.Format.ellipsis(data.title,15)});return data;},listeners:{selectionchange:function(dv,nodes){},itemclick:function(dv,record,item,index,e,eOpts){if(!options.editable){var url=record.data.url;var ext=FalUtil.getFileExt(url);if(ext.match(/jpg|gif|png|jpeg|file/)){FalUtil.showImageWindow(url);}else{FalUtil.downloadFile({url:url});}}}},fbar:[{xtype:"button",text:lang.__("Add<!--2-->")}]});var formPanel=me.formPanel=Ext.create("Ext.form.Panel",{cls:'images-view',autoScroll:true,frame:false,collapsible:true,header:false,tbar:!options.editable?null:{items:[{xtype:"button",text:lang.__("Add<!--2-->"),icon:stmap.icon.getURL("addIconURL"),handler:function(){me.showAddFileWindow();}},{xtype:"button",text:lang.__("Delete"),icon:stmap.icon.getURL("deleteIconURL"),handler:function(){var selection=imageView.getSelectionModel().getSelection();if(0<selection.length){store.remove(selection);}
else alert(lang.__("Click after select file that you want to delete."));}}]},items:imageView});},showAddFileWindow:function(){var me=contentsFileFormPanel=this;var stmap=me.stmap;var formPanel=Ext.create("Ext.form.Panel",{autoScroll:true,border:false,fieldDefaults:{labelWidth:100,anchor:'100%'},defaultType:'textfield',bodyPadding:5,items:[{xtype:"textfield",fieldLabel:lang.__("Title<!--2-->"),name:"title",allowBlank:false},{xtype:"textfield",fieldLabel:"URL",name:"url",vtype:'url',allowBlank:false}],appendData:function(){var formValues=formPanel.form.getValues();var title=formValues["title"];var url=formValues["url"];me.store.loadRawData([{title:title,url:url}],true);}});formPanel=Ext.create("Ext.form.Panel",{fileUpload:true,autoScroll:true,border:false,fieldDefaults:{labelWidth:100,anchor:'100%'},defaultType:'textfield',bodyPadding:5,items:[{xtype:"hidden",name:"mid",value:me.mid},{xtype:"hidden",name:"layer",value:me.layerId},{xtype:"textfield",fieldLabel:lang.__("Title<!--2-->"),name:"files[0].title"},{xtype:"filefield",name:"files[0].formFile",fieldLabel:lang.__("File"),msgTarget:"side",buttonText:lang.__("Choose file"),allowBlank:false}],upload:function(){var me=this;var ecommapURL=stmap.ecommaps[0].ecommapURL;var form=me.getForm();if(form.isValid()){form.submit({url:SaigaiTask.contextPath+"/page/map/ecommap/contents/uploadFile/",params:'&_csrf='+SaigaiTask.ajaxcsrfToken,waitMsg:lang.__("Uploading file.."),success:function(form,action){var fileList=action.result.fileList;if(0<fileList.length){for(var key in fileList){var values=fileList[key];if(values.length==2){var fileUrl=values[0];var fileTitle=values[1];var ext=FalUtil.getFileExt(fileUrl);var thumbnail=fileUrl;if(!ext.match(/jpg|gif|png|jpeg|file/)){thumbnail=ecommapURL+"/map/fileicons/"+ext+".png";}
contentsFileFormPanel.store.loadRawData([{title:fileTitle,url:fileUrl,thumbnail:thumbnail}],true);}}}
win.close();},failure:function(form,action){win.close();var msg=lang.__("Failed to upload file.");try{var result=Ext.decode(action.response.responseText);if(typeof result.msg!="undefined"){msg+="</br>"+result.msg;}}catch(e){}
var msgwin=Ext.Msg.show({title:lang.__("Error"),msg:msg,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR});}})}}});var win=null;win=me.window=Ext.create('Ext.window.Window',{title:lang.__('Attachment registration form'),width:500,maxWidth:document.body.clientWidth,maxHeight:document.body.clientHeight,collapsible:false,modal:true,layout:'fit',items:formPanel,buttons:[{text:'OK',handler:function(){formPanel.upload();}},{text:lang.__('Cancel'),handler:function(){win.close();}}]});win.show();},getFieldSetItems:function(){var me=this;var items=null;if(me.store.getCount()==0){items=[{xtype:"button",text:lang.__("Add<!--2-->"),handler:function(button,e){button.ownerCt.add(me.formPanel);button.ownerCt.remove(button);me.showAddFileWindow();}}];}
else{items=me.formPanel;}
return items;},getJSONArray:function(){var me=this;var array=[];var data=me.store.data;for(var key in data.items){var item=data.items[key];array.push([item.data.url,item.data.title]);}
return array;}};SaigaiTask.Map.Layer.GoogleLayer=new OpenLayers.Class(OpenLayers.Layer.Google,{layerInfo:null,initialize:function(layerInfo){this.layerInfo=layerInfo;var options={reprojection:true,isBaseLayer:true,buffer:0,opacity:layerInfo.opacity,alpha:true,visibility:true,attribution:layerInfo.attribution};if("SATELLITE"==layerInfo.featuretypeId){options.type=google.maps.MapTypeId.SATELLITE;}else if("HYBRID"==layerInfo.featuretypeId){options.type=google.maps.MapTypeId.HYBRID;}else if("PHYSICAL"==layerInfo.featuretypeId||"TERRAIN"==layerInfo.featuretypeId){options.type=google.maps.MapTypeId.TERRAIN;}
options.sphericalMercator=true;var name="Google_"+layerInfo.featuretypeId;OpenLayers.Layer.Google.prototype.initialize.apply(this,[name,options]);}});SaigaiTask.Map.Layer.GoogleLayer.type=SaigaiTask.Map.Layer.Type.GOOGLE;SaigaiTask.Map.EcommapInfo=new OpenLayers.Class({stmap:null,ecommapURL:null,wmsAuthURL:null,contentsLayerInfo:null,contentsLayerInfos:null,layerInfoStore:{},layerInfoTree:[],initialize:function(options){var me=this;OpenLayers.Util.extend(this,options);var ecommap=this;var layerInfos=[].concat(ecommap.contentsLayers,ecommap.groupContentsLayers,ecommap.kmlLayers,ecommap.referenceLayers,ecommap.overlayLayers,ecommap.externalMapLayers,ecommap.baseLayers);ecommap.layerInfoStore={};for(var key in layerInfos){var layerInfo=layerInfos[key];if(typeof layerInfo=="undefined")continue;layerInfo.ecommap=ecommap;layerInfo=new SaigaiTask.Map.Layer.LayerInfo(layerInfo);ecommap.layerInfoStore[layerInfo.layerId]=layerInfo;switch(layerInfo.type){case SaigaiTask.Map.Layer.Type.LOCAL:layerInfo.params.LAYERS=layerInfo.layerId;layerInfo.params.keys=layerInfo.authkey;break;case SaigaiTask.Map.Layer.Type.OVERLAY_WMS:case SaigaiTask.Map.Layer.Type.OVERLAY_WMS_SINGLE:case SaigaiTask.Map.Layer.Type.OVERLAY_TILED:case SaigaiTask.Map.Layer.Type.OVERLAY_TILECACHE:case SaigaiTask.Map.Layer.Type.OVERLAY_OSM:layerInfo.params.LAYERS=[layerInfo.featuretypeId];break;case SaigaiTask.Map.Layer.Type.REFERENCE_WMS:case SaigaiTask.Map.Layer.Type.EXTERNAL_MAP_WMS:layerInfo.params.LAYERS=[];break;case SaigaiTask.Map.Layer.Type.REFERENCE:case SaigaiTask.Map.Layer.Type.EXTERNAL_MAP_WMS_LAYERS:case SaigaiTask.Map.Layer.Type.EXTERNAL_MAP_ARCGIS_LAYERS:layerInfo.params.LAYERS=layerInfo.featuretypeId;break;}}
var contentsLayerInfo=me.createContentsLayerInfo();ecommap.layerInfoTree=[];ecommap.contentsLayerInfos=[];var mapLayerInfos=ecommap.mapInfo.MapLayerInfo;for(var mapLayerInfosIdx in mapLayerInfos){var mapLayerInfo=mapLayerInfos[mapLayerInfosIdx];var layerId=mapLayerInfo.layerId;var layerInfo=ecommap.layerInfoStore[layerId];if(typeof layerInfo=="undefined"){continue;}
layerInfo.opacity=mapLayerInfo.opacity;if(typeof layerInfo.expanded==null){layerInfo.expanded=!mapLayerInfo.closed;}
if(!!mapLayerInfo.reload)layerInfo.reload=mapLayerInfo.reload;var parent=null;if(layerInfo.parent!=null){parent=layerInfo.parent;if(typeof parent=="object"){parent=parent.layerId;}}
var append=false;if(parent!=null){var parentLayerInfo=ecommap.layerInfoStore[parent];if(typeof parentLayerInfo=="object"){parentLayerInfo.appendChildLayerInfo(layerInfo);append=true;}}
if(append==false){if(layerInfo.type==SaigaiTask.Map.Layer.Type.LOCAL||layerInfo.type==SaigaiTask.Map.Layer.Type.LOCAL_GROUP){contentsLayerInfo.appendChildLayerInfo(layerInfo);ecommap.contentsLayerInfos.push(layerInfo);}
else{ecommap.layerInfoTree.push(layerInfo);console.log("add layerInfoTree "+layerInfo.name);}}}
if(typeof ecommap.externalMapLayers!="undefined"){for(var i=0;i<ecommap.externalMapLayers.length;i++){layerInfo=ecommap.layerInfoStore[ecommap.externalMapLayers[i].layerId];var append=false;if(layerInfo.parent!=null){var parent=ecommap.layerInfoStore[layerInfo.parent];if(typeof parent=="object"){parent.appendChildLayerInfo(layerInfo);append=true;}}
if(append==false){ecommap.layerInfoTree.push(layerInfo);}}}
if(0<contentsLayerInfo.children.length){ecommap.layerInfoTree.unshift(contentsLayerInfo);me.contentsLayerInfo=contentsLayerInfo;}
var baselayerInfos=me.getBaseLayerInfos();if(0<baselayerInfos.length){var exist=false;for(var idx in baselayerInfos){var baselayerInfo=baselayerInfos[idx];if(baselayerInfo.visibility){exist=true;break;}}
if(exist==false){baselayerInfos[baselayerInfos.length-1].visibility=true;}}},createContentsLayerInfo:function(){return new SaigaiTask.Map.Layer.LayerInfo({name:lang.__("Registration info"),wmsURL:this.wmsAuthURL,visibility:true,_olSalt:Math.random(),tiled:true,tilesOrigin:"0,0",params:{cid:this.mapInfo.communityId,mid:this.mapInfo.mapId,FORMAT:"image/png",TRANSPARENT:true,LAYERS:[],keys:[]}});},isBaseLayerInfo:function(layerInfo){return SaigaiTask.Map.Layer.Type.isBaseLayerType(layerInfo.type);},getBaseLayerInfos:function(){var types=SaigaiTask.Map.Layer.Type.getBaseLayerTypes();return this.getLayerInfosByTypes(types);},getOverlayLayerInfos:function(){var types=SaigaiTask.Map.Layer.Type.getOverlayLayerTypes();return this.getLayerInfosByTypes(types);},getReferenceLayerTypes:function(){return[SaigaiTask.Map.Layer.Type.REFERENCE_WMS];},getReferenceLayerInfos:function(){var types=this.getReferenceLayerTypes();return this.getLayerInfosByTypes(types);},getExternalMapLayerTypes:function(){return[SaigaiTask.Map.Layer.Type.EXTERNAL_MAP_WMS,SaigaiTask.Map.Layer.Type.EXTERNAL_MAP_XYZ];},getExternalMapLayerInfos:function(){var types=this.getExternalMapLayerTypes();return this.getLayerInfosByTypes(types);},getArcGISLayerInfos:function(){var types=SaigaiTask.Map.Layer.Type.getArcGISLayerTypes();return this.getLayerInfosByTypes(types);},getLayerInfosByTypes:function(types){var layerInfos=[];var ecommap=this;var mapLayerInfos=ecommap.mapInfo.MapLayerInfo;var checked=[];for(var mapLayerInfosIdx in mapLayerInfos){var mapLayerInfo=mapLayerInfos[mapLayerInfosIdx];var layerId=mapLayerInfo.layerId;checked.push(layerId);var layerInfo=ecommap.layerInfoStore[layerId];if(typeof layerInfo=="undefined"){continue;}
if($.inArray(layerInfo.type,types)!=-1){layerInfos.push(layerInfo);}}
for(var layerId in ecommap.layerInfoStore){if($.inArray(layerId,checked)!=-1)continue;var layerInfo=ecommap.layerInfoStore[layerId];if($.inArray(layerInfo.type,types)!=-1){layerInfos.push(layerInfo);}}
return layerInfos;},getHiddenLayerIds:function(){var me=this;var tree=me.layerInfoTree;var hiddenLayerIds=[];for(var idx in tree){var layerInfo=tree[idx];layerInfo.getHiddenLayerIds(hiddenLayerIds);}
return hiddenLayerIds;},clone:function(stmap){var ecommap=this;var copyWithFunc=$.extend(true,{},ecommap);var options={};for(var name in copyWithFunc){var prop=copyWithFunc[name];if(typeof prop!="function"){options[name]=prop;}}
options.stmap=stmap;return new SaigaiTask.Map.EcommapInfo(options);},updateSpatialLayerCondition:function(conditionValue){var me=this;var layerId=conditionValue.layerId;var layerInfo=me.layerInfoStore[layerId];if(typeof layerInfo=="undefined"||layerInfo==null){alert(lang.__("Retrieval object layer is not displayed."));return;}
layerInfo.spatialLayers=conditionValue.spatiallayer;var spatialLayer=layerInfo.spatialLayer;if(typeof spatialLayer=="undefined"||spatialLayer==null){alert(lang.__("There is no search range layer."));return;}
var spatialLayerInfo=spatialLayer.layerInfo;spatialLayerInfo.params.spatiallayers=JSON.stringify(layerInfo.spatialLayers);spatialLayer._refreshParams({nocache:true});},moveToHome:function(){var me=this;var ecommap=me;var stmap=me.stmap;var layoutInfo=ecommap.layoutInfo;var initExtent=null;if(layoutInfo){var e=layoutInfo.mapExtent;if(e){initExtent=new OpenLayers.Bounds(e[0],e[1],e[2],e[3]);}}
if(initExtent==null)initExtent=new OpenLayers.Bounds(120.20,22.93,151.35,46.78);me.initExtent=initExtent;if(layoutInfo.mapResolution==0){stmap.zoomToExtent(initExtent);}
else{var initResolution=layoutInfo.mapResolution;var zoom=stmap.map.getZoomForResolution(stmap.toMapResolution(initResolution),stmap);stmap.setCenter(initExtent.getCenterLonLat(),zoom);}
var legendpanel=stmap.components.mainpanel.legend;for(var idx in me.contentsLayerInfos){var contentsLayerInfo=me.contentsLayerInfos[idx];var legendrules=contentsLayerInfo.legendrules;if(!!legendrules){for(var ruleIdx in legendrules){var rule=legendrules[ruleIdx];var node=rule.node;if(!!node){var nodeChecked=node.get("checked");var parentChecked=node.parentNode.get("checked");if(nodeChecked!=parentChecked){node.set("checked",parentChecked);legendpanel.tree.fireEvent("checkchange",node,parentChecked,{});}}}}}}});SaigaiTask.Map.Layer.WMSLayer=new OpenLayers.Class(OpenLayers.Layer.WMS,{layerInfo:null,params:null,initialize:function(layerInfo){var me=this;me.layerInfo=layerInfo;for(var childLayerInfoKey in layerInfo.children){var childLayerInfo=layerInfo.children[childLayerInfoKey];if(typeof childLayerInfo.visibility=="undefined"){childLayerInfo.visibility=true;}
childLayerInfo.parent=layerInfo;}
var name=layerInfo.name;var url=layerInfo.wmsURL;var params=this.params={TRANSPARENT:true};var options={visibility:layerInfo.visibility,alpha:true,opacity:layerInfo.opacity,isBaseLayer:SaigaiTask.Map.Layer.Type.isBaseLayerType(layerInfo.type),attribution:layerInfo.attribution,transitionEffect:layerInfo.transitionEffect,singleTile:layerInfo.singleTile};if(layerInfo.ecommap!=null){options.isBaseLayer=layerInfo.ecommap.isBaseLayerInfo(layerInfo);}
OpenLayers.Layer.WMS.prototype.initialize.apply(this,[name,url,params,options]);me.refreshParams();layerInfo.layer=this;},refreshParams:function(option){var me=this;me._refreshParams(option);me.events.triggerEvent("refreshParams");},_refreshParams:function(option){var defaultOption={nocache:false};if(typeof option=="undefined")option={};Ext.applyIf(option,defaultOption);delete this.params.layertimes;OpenLayers.Util.extend(this.params,this.getParams());if(option.nocache){this.params._olSalt=Math.random();}
console.log("params "+this.layerInfo.name);console.log(this.params);if(typeof this.params.LAYERS=="undefined"||this.params.LAYERS.length==0){this.setVisibility(false);}
else{this.setVisibility(this.layerInfo.visibility);}
var time=SaigaiTask.PageURL.getTime();if(!!time){var iso8601Time=time.toISOString();if(SaigaiTask.PageURL.CONFIG_SHIFT_TIMEZONE_OFFSET){iso8601Time=new Date(time-time.getTimezoneOffset()*60*1000).toISOString();}
this.params.time=iso8601Time;}
else{this.params.time=null;}
console.log("visibility");console.log(this.getVisibility());console.log("opacity");console.log(this.opacity);console.log(this);this.redraw(true);},getParams:function(){var params=$.extend(true,{},this.layerInfo.params);var getParamsRecursive=function(params,layerInfo){if(0<layerInfo.children.length){for(var key in layerInfo.children){var child=layerInfo.children[key];getParamsRecursive(params,child);}}
else{if(layerInfo.visibility){layerInfo.mergeParams(params);}}};if(0<this.layerInfo.children.length){getParamsRecursive(params,this.layerInfo);}
for(var key in params){var param=params[key];if($.isArray(param)){params[key]=param.reverse().join(",");}
else if(typeof param=="object"){params[key]=JSON.stringify(param);}}
return params;},buildLayersParam:function(){var me=this;var info=me.layerInfo;var layers=[];if(typeof info.featuretypeId!="undefined"){return info.featuretypeId;}
for(var childLayerInfoKey in info.childLayerInfos){var childLayerInfo=info.childLayerInfos[childLayerInfoKey];if(childLayerInfo.visibility==true){layers.push(childLayerInfo.featuretypeId);}}
return layers.join(",");},getURL:function(bounds){var me=this;var info=me.layerInfo;var url=OpenLayers.Layer.WMS.prototype.getURL.call(this,bounds);if(info.wmsproxy!=null){if(info.wmsproxy!=0&&url.indexOf("http")==0){var page_url=SaigaiTask.PageURL.getUrl();var metadataid="";if(info.children.length>0){metadataid=info.children[0].metadataid;}
url=page_url.substr(0,page_url.indexOf("/page/")+6)+"map/externalWmsAuth/?url="+encodeURIComponent(url)+"&externalmapdatainfoid="+info.wmsproxy+"&metadataid="+metadataid;}}
return url;},setLayersParamVisibility:function(featuretypeId,visibility){var me=this;var info=me.layerInfo;for(var childLayerInfoKey in info.childLayerInfos){var childLayerInfo=info.childLayerInfos[childLayerInfoKey];if(childLayerInfo.featuretypeId==featuretypeId){childLayerInfo.visibility=visibility;break;}}},CLASS_NAME:"SaigaiTask.Map.Layer.WMSLayer"});SaigaiTask.Map.Layer.ArcGIS93Rest=new OpenLayers.Class(OpenLayers.Layer.ArcGIS93Rest,{layerInfo:null,params:null,initialize:function(layerInfo){var me=this;me.layerInfo=layerInfo;for(var childLayerInfoKey in layerInfo.children){var childLayerInfo=layerInfo.children[childLayerInfoKey];if(typeof childLayerInfo.visibility=="undefined"){childLayerInfo.visibility=true;}
childLayerInfo.parent=layerInfo;}
var name=layerInfo.name;var url=layerInfo.wmsCapabilitiesURL;var times="";if(url!=null&&url.indexOf("time=")!=-1){var time_param1=url.substring(url.indexOf("time=")+5,url.length);var sep_int=time_param1.indexOf("&");times=sep_int==-1?time_param1:time_param1.substring(0,sep_int);url=url.replace("me.times","");}
var params=this.params={TRANSPARENT:true};if(layerInfo.featuretypeId!=null){params.layers=layerInfo.featuretypeId;}
var options={isBaseLayer:SaigaiTask.Map.Layer.Type.isBaseLayerType(layerInfo.type),time:times};if(layerInfo.ecommap!=null){options.isBaseLayer=layerInfo.ecommap.isBaseLayerInfo(layerInfo);}
OpenLayers.Layer.ArcGIS93Rest.prototype.initialize.apply(this,[name,url,params,options]);me.refreshParams();layerInfo.layer=this;},refreshParams:function(option){var me=this;me._refreshParams(option);me.events.triggerEvent("refreshParams");},_refreshParams:function(option){var defaultOption={nocache:false};if(typeof option=="undefined")option={};Ext.applyIf(option,defaultOption);OpenLayers.Util.extend(this.params,this.getParams());if(option.nocache){this.params._olSalt=Math.random();}
console.log("params "+this.layerInfo.name);console.log(this.params);this.setVisibility(this.layerInfo.visibility);console.log("visibility");console.log(this.getVisibility());console.log("opacity");console.log(this.opacity);console.log(this);this.redraw(true);},getParams:function(){var params=$.extend(true,{},this.layerInfo.params);var getParamsRecursive=function(params,layerInfo){if(0<layerInfo.children.length){for(var key in layerInfo.children){var child=layerInfo.children[key];getParamsRecursive(params,child);}}
else{if(layerInfo.visibility){layerInfo.mergeParams(params);}}};if(0<this.layerInfo.children.length){getParamsRecursive(params,this.layerInfo);}
for(var key in params){var param=params[key];if($.isArray(param)){params[key]=param.reverse().join(",");}
else if(typeof param=="object"){params[key]=JSON.stringify(param);}}
return params;},buildLayersParam:function(){var me=this;var info=me.layerInfo;var layers=[];if(typeof info.featuretypeId!="undefined"){return info.featuretypeId;}
for(var childLayerInfoKey in info.childLayerInfos){var childLayerInfo=info.childLayerInfos[childLayerInfoKey];if(childLayerInfo.visibility==true){layers.push(childLayerInfo.featuretypeId);}}
return layers.join(",");},setLayersParamVisibility:function(featuretypeId,visibility){var me=this;var info=me.layerInfo;for(var childLayerInfoKey in info.childLayerInfos){var childLayerInfo=info.childLayerInfos[childLayerInfoKey];if(childLayerInfo.featuretypeId==featuretypeId){childLayerInfo.visibility=visibility;break;}}}});SaigaiTask.Map.Layer.ArcGIS93Rest.type=SaigaiTask.Map.Layer.Type.EXTERNAL_MAP_ARCGIS_LAYERS;SaigaiTask.Map.Layer.DrawLayerSelectDrag=new OpenLayers.Class({POINT:10,LINESTRING:20,POLYGON:30,TEXT:40,PHOTO:60,GROUP:100,initialize:function(memoLayer){var me=this;var stmap=me.stmap;this.memoSelectLayer=new OpenLayers.Layer.Markers('memoSelect');this.stmap.map.addLayer(this.memoSelectLayer);this.selectIcon=new OpenLayers.Icon(stmap.icon.getURL("pointnodeIconURL"),new OpenLayers.Size(9,9),new OpenLayers.Pixel(-5,-5));this.memoLayer=memoLayer;this.eMap={map:this.stmap.map,getLabelSize:OpenLayers.Format.KMLStyleUtil.getLabelSize,isFocus:this.stmap.isFocus}
this.setFontSize(14);var modifyStyleMap=me.modifyStyleMap=new OpenLayers.StyleMap();modifyStyleMap.styles['default']=new OpenLayers.Style({fillColor:"#0000FF",fillOpacity:0.4,hoverFillColor:"#FFFFFF",hoverFillOpacity:0.8,strokeColor:"#0000FF",strokeOpacity:1,strokeWidth:2,graphicOpacity:1,graphicZIndex:0,fontColor:"#0000FF",fontWeight:"bold",fontSize:memoLayer.styleMap.styles.default.defaultStyle.fontSize,labelAlign:"lt",cursor:"pointer"});var selectDragFeature=me.controls.selectDragFeature;selectDragFeature.events.on({"deactivate":function(){me.clearFeatureSelection();}});stmap.map.events.on({"moveend":function(){if(selectDragFeature.active){$(".memo_text_div textarea").blur();}}})
me.layer.events.on({"historychange":function(option){if(option.operation=="undo"||option.operation=="redo"){me.clearFeatureSelection();if(me.activeDrawKey=="selectDragFeature"){me.getSelectDragFeatureControl().select(option.feature);me.resetFeatureSelection(me.memoLayer);}}}});},isSelected:function(feature)
{var sf=this.memoLayer.selectedFeatures;for(var i=sf.length-1;i>=0;i--){if(sf[i]==feature)return true;}
return false;},selectFeature:function(feature)
{this.memoLayer.selectedFeatures.push(feature);this._featureSelected(feature);},clearFeatureSelection:function()
{this.memoSelectLayer.clearMarkers();this.memoLayer.selectedFeatures=[];},resetFeatureSelection:function(layer)
{var selected=layer.selectedFeatures;if(selected){for(var i=selected.length-1;i>=0;i--){this._featureUnselected(selected[i]);this._featureSelected(selected[i]);}}},_featureSelected:function(feature,noControl)
{try{if(!!document.activeElement&&!!document.activeElement.blur)document.activeElement.blur();if(feature.geometry.CLASS_NAME=="OpenLayers.Geometry.Point"){var vartices=feature.geometry.getVertices();for(var i=0;i<vartices.length;i++){this._addSelectMarker(this.dragMarker,feature,new OpenLayers.LonLat(vartices[i].x,vartices[i].y),this.selectIcon.clone(),'move');}}else{var bounds=feature.geometry.getBounds();this._addSelectMarker(this.dragMarker,feature,new OpenLayers.LonLat(bounds.left,bounds.top),this.selectIcon.clone());this._addSelectMarker(this.dragMarker,feature,new OpenLayers.LonLat(bounds.right,bounds.top),this.selectIcon.clone());this._addSelectMarker(this.dragMarker,feature,new OpenLayers.LonLat(bounds.left,bounds.bottom),this.selectIcon.clone());this._addSelectMarker(this.dragMarker,feature,new OpenLayers.LonLat(bounds.right,bounds.bottom),this.selectIcon.clone());}
this.memoSelectLayer.setZIndex(726);}catch(e){console.error(e);}},_featureUnselected:function(feature,noControl)
{if(this.dragMarker)this.dragMarker.deactivate();var markers=this.memoSelectLayer.markers;for(var i=markers.length-1;i>=0;i--){if(markers[i].linkid==feature.id){this.memoSelectLayer.removeMarker(markers[i]);}}},_addSelectMarker:function(control,feature,lonlat,icon,cursor)
{icon.imageDiv.style.cursor=cursor;var marker=new OpenLayers.Marker(lonlat,icon);marker.linkid=feature.id;this.memoSelectLayer.addMarker(marker);var self=this;if(control){marker.events.register("mouseover",marker,function(){control.overFeature(this);});marker.events.register("mouseout",marker,function(){control.outFeature(this);});if(this.isText(feature))marker.events.register("dblclick",marker,function(){self._startTextEdit(feature,true);});}},_nodeDragStart:function(marker,layer)
{if(!marker)return;var feature=layer.getFeatureById(marker.linkid);try{this.resizeOrigin=null;var bounds=feature.geometry.getBounds();var isLeft=Math.abs(bounds.left-marker.lonlat.lon)>Math.abs(bounds.right-marker.lonlat.lon);var isBottom=Math.abs(bounds.bottom-marker.lonlat.lat)>Math.abs(bounds.top-marker.lonlat.lat);this.resizeOrigin=new OpenLayers.Geometry.Point(isLeft?bounds.left:bounds.right,isBottom?bounds.bottom:bounds.top);this.resizeOrigin.prevLon=marker.lonlat.lon;this.resizeOrigin.prevLat=marker.lonlat.lat;this.resizeOrigin.isPoint=feature.geometry.CLASS_NAME=="OpenLayers.Geometry.Point"||this.isText(feature);var markers=this.memoSelectLayer.markers;for(var i=markers.length-1;i>=0;i--){if(markers[i]!=marker){this.memoSelectLayer.removeMarker(markers[i]);}}
this.memoLayer.selectedFeatures=[feature];}catch(e){console.error(e);}},_nodeDrag:function(marker,layer)
{if(this.resizeOrigin){var lonlat=marker.lonlat;var feature=layer.getFeatureById(marker.linkid);if(this.resizeOrigin.isPoint){var geometry=feature.geometry;feature.geometry.move(lonlat.lon-geometry.x,lonlat.lat-geometry.y);layer.drawFeature(feature);}else{this.resizeFeature(feature,this.resizeOrigin,lonlat,layer);}}},_nodeDragComplete:function(marker,layer)
{try{if(this.resizeOrigin){this.resizeOrigin=null;var feature=layer.getFeatureById(marker.linkid);this._featureUnselected(feature);this._featureSelected(feature);this._featureModified(feature);}}catch(e){console.error(e);}},resizeFeature:function(feature,originGeometry,lonlat,layer)
{try{var geometry=feature.geometry;var dx0=originGeometry.prevLon-originGeometry.x;var dy0=originGeometry.prevLat-originGeometry.y;var dx1=lonlat.lon-originGeometry.x;var dy1=lonlat.lat-originGeometry.y;if(dx0==0||dy0==0||dx1==0||dy1==0)return;originGeometry.prevLon=lonlat.lon;originGeometry.prevLat=lonlat.lat;var scale=dy1/dy0;var ratio=(dx1/dx0)/scale;geometry.resize(scale,originGeometry,ratio);layer.drawFeature(feature);}catch(e){console.error(e);}},_onKeyDown:function(evt)
{var offset=4*this.memoLayer.getResolution();switch(evt.keyCode){case dojo.keys.LEFT_ARROW:this.moveSelectedFeature(-offset,0);break;case dojo.keys.DOWN_ARROW:this.moveSelectedFeature(0,-offset);break;case dojo.keys.RIGHT_ARROW:this.moveSelectedFeature(offset,0);break;case dojo.keys.UP_ARROW:this.moveSelectedFeature(0,offset);break;case dojo.keys.DELETE:this.removeSelectedFeature();break;}},moveSelectedFeature:function(xOffset,yOffset)
{var me=this;var selected=this.memoLayer.selectedFeatures;for(var i=selected.length-1;i>=0;i--){var feature=selected[i];var geometry=feature.geometry;if(geometry){var beforeFeature=me.cloneTextFeature(feature);geometry.move(xOffset,yOffset);this.memoLayer.drawFeature(feature);this._featureUnselected(feature);this._featureSelected(feature);var event={type:"featuremoved",feature:feature,afterFeature:me.cloneTextFeature(feature),beforeFeature:beforeFeature};me.layer.events.triggerEvent(event.type,event);}}},removeSelectedFeature:function(force)
{try{if(typeof force=="undefined")force=false;var features=this.memoLayer.selectedFeatures;if(features.length==0)return true;if(force==false&&!confirm(lang.__('Delete selected note?'))){return;}
this.clearFeatureSelection();this.memoLayer.removeFeatures(features);}catch(e){console.error(e);}},preExButton:null,changeEditControl:function(mode,style,exButton)
{var me=this;if(mode=="SELECT"){me.setSelectDragFeatureControlActivation(true);me.stmap.clickHandler.deactivate();setTimeout(function(){me.stmap.clickHandler.activate();},500);}},setStyleGraphic:function(style,externalGraphic,graphicWidth,graphicHeight,graphicXOffset,graphicYOffset,graphicOpacity)
{style.externalGraphic=externalGraphic;style.graphicWidth=graphicWidth;style.graphicHeight=graphicHeight;style.graphicXOffset=graphicXOffset;style.graphicYOffset=graphicYOffset;if(graphicOpacity)style.graphicOpacity=graphicOpacity;},getGeomName:function(feature)
{var geom=feature.geometry;if(!geom)return lang._('Nothing');if(geom.CLASS_NAME.match(/Point$/)){if(this.isText(feature))return lang._('Font');return lang._('Point<!--2-->');}
if(geom.CLASS_NAME.match(/LineString$/))return lang._('Line');if(geom.CLASS_NAME.match(/Polygon$/))return lang._('Polygon');},isText:function(feature)
{return feature.style.fontColor&&feature.style.label;},checkTextEdit:function(feature)
{if(this.isText(feature)){if(this.isSelected(feature))this._startTextEdit(feature,true);}},_textNoClose:false,_startTextEdit:function(feature,modified)
{var me=this;try{if(!modified)this.changeEditControl('SELECT');var self=this;var parentDiv=this.eMap.map.div.parentNode;var px=this.eMap.map.getViewPortPxFromLonLat(new OpenLayers.LonLat(feature.geometry.x,feature.geometry.y));var div=dojo.create("div",{className:"memo_text_div"});div.style.left=px.x+"px";div.style.top=px.y+"px";var textFixed=false;if(feature.attributes&&feature.attributes.description){try{var option=dojo.fromJson(feature.attributes.description);if(option.reso)textFixed=true;if(option.reso)console.log("reso: "+option.reso+", zoom:"+me.stmap.map.getZoomForResolution(option.reso));}catch(e){}}
var textarea=this.textarea=me.createExtTextArea({rows:1,cols:10,trim:true,value:modified?feature.attributes.name.replace(/\\n/g,"\n"):null,div:div});var textChk=document.createElement("input");textChk.type="checkbox";textChk.checked=textFixed;var label=dojo.create("label",{style:"background-color:white; cursor:pointer;"});var labelDiv=dojo.create("div");var span=dojo.create("span",{innerHTML:lang.__("Resize with map scale"),style:"padding:0 2px;"});label.appendChild(textChk);label.appendChild(span);labelDiv.appendChild(label);div.appendChild(labelDiv);span.onmouseover=function(){self._textNoClose=true;};textChk.onmouseover=span.onmouseover;span.onmouseout=function(){self._textNoClose=false;textarea.focus();};textChk.onmouseout=span.onmouseout;if(modified&&textFixed){var updateChk=document.createElement("input");updateChk.type="checkbox";updateChk.checked=false;var updateLabel=dojo.create("label",{style:"background-color:white; cursor:pointer;"});var updateLabelDiv=dojo.create("div");var updateSpan=dojo.create("span",{innerHTML:lang.__("Update scale"),style:"padding:0 2px;"});var s=document.createElement("span");s.innerHTML="(";updateLabel.appendChild(s);updateLabel.appendChild(updateSpan);updateLabel.appendChild(updateChk);var s=document.createElement("span");s.innerHTML=")";updateLabel.appendChild(s);labelDiv.appendChild(updateLabel);div.appendChild(updateLabelDiv);updateChk.onmouseover=span.onmouseover;updateChk.onmouseout=span.onmouseout;updateSpan.onmouseover=span.onmouseover;updateSpan.onmouseout=span.onmouseout;}
textarea.onblur=function(){if(self._textNoClose)return;self._endTextEdit(div,textarea,textChk,feature,modified,updateChk);};parentDiv.appendChild(div);textarea.focus();}catch(e){console.error(e);}},_endTextEdit:function(div,textarea,textChk,feature,modified,updateChk)
{var me=this;var beforeFeature=me.cloneTextFeature(feature);try{var parentDiv=this.eMap.map.div.parentNode;var label=textarea.value;var textFixed=textChk.checked;var textFixedUpdate=!!updateChk?(updateChk.checked||!textFixed):true;parentDiv.removeChild(div);if(!label||dojo.trim(label)==""){this.clearFeatureSelection();this.memoLayer.removeFeatures(feature);return;}
feature.attributes.name=label;if(modified){this.memoLayer.eraseFeatures([feature]);this._featureModified(feature);feature.attributes.name=feature.attributes.name.replace(/\n/g,"\\n");this.setLabelBackground(feature);feature.style.label=feature.attributes.name;this.memoLayer.drawFeature(feature);}
else{this._featureAdded(this.TEXT,feature);}
if(textFixedUpdate){this.setTextZoomOption(feature.attributes,false,!textFixed);}}catch(e){console.error(e);}
var afterFeature=me.cloneTextFeature(feature);if(me.isTextChanged(beforeFeature,afterFeature)){var event={type:"featuremoved",feature:feature,afterFeature:afterFeature,beforeFeature:beforeFeature};me.layer.events.triggerEvent(event.type,event);}
me.layer.redraw();},isTextChanged:function(feature1,feature2){var getTextFixed=function(feature){var textFixed=false;if(feature.attributes&&feature.attributes.description){try{var option=dojo.fromJson(feature.attributes.description);if(option.reso)textFixed=option.reso;}catch(e){}}
return textFixed;};var getTextLabel=function(feature){var label=null;if(feature.attributes&&feature.attributes.name){label=feature.attributes.name;}
return label;};if(getTextLabel(feature1)!=getTextLabel(feature2))return true;if(getTextFixed(feature1)!=getTextFixed(feature2))return true;return false;},cloneTextFeature:function(feature){var clone=null;if(!!feature){clone=feature.clone();clone.data={};for(var key in feature.data){clone.data[key]=feature.data[key];}
clone.style={};for(var key in feature.style){clone.style[key]=feature.style[key];}}
return clone;},createExtTextArea:function(option){var exTextarea=Ext.create("Ext.form.field.TextArea",{renderTo:option.div,value:option.value});var textarea=exTextarea.inputEl.dom;var basic=Ext.create('Ext.create','Ext.resizer.Resizer',{target:exTextarea.inputEl,width:200,height:100,minWidth:50,minHeight:20});return textarea;},setLabelBackground:function(feature)
{var fontSize=parseInt(feature.style.fontSize);if(!fontSize)try{feature.style.fontSize.replace(/px$/,"");}catch(e){};if(!fontSize)this.kmlFormat.FONTSIZE;var size=this.eMap.getLabelSize(feature.attributes.name.replace(/\\n/g,"<br/>"),fontSize,feature.style.fontWeight);this.setStyleGraphic(feature.style,null,size.w,size.h,0,0);},_featureAdded:function(type,feature)
{console.log(feature);feature.attributes.description="{created:"+new Date().getTime()+"}";if(type!=this.PHOTO){var defaultStyle=this.memoLayer.styleMap.styles['default'].defaultStyle;feature.style=dojo.clone(defaultStyle);}
feature.style.memo=true;switch(type){case this.POINT:var style=this.iconStyle;if(this.iconSize>0){var scale=this.iconSize/Math.max(style.graphicWidth,style.graphicHeight);style.graphicWidth*=scale;style.graphicHeight*=scale;style.graphicXOffset*=scale;style.graphicYOffset*=scale;}
this.setStyleGraphic(feature.style,style.externalGraphic,style.graphicWidth,style.graphicHeight,style.graphicXOffset,style.graphicYOffset);this._adjustIconScale(feature.style);this.memoLayer.drawFeature(feature);break;case this.PHOTO:this.memoLayer.drawFeature(feature);break;case this.TEXT:feature.attributes.name=feature.attributes.name.replace(/\n/g,"\\n");this.setLabelBackground(feature);feature.style.label=feature.attributes.name;feature.style.externalGraphic=null;this.memoLayer.drawFeature(feature);break;case this.LINESTRING:case this.POLYGON:this.setStyleGraphic(feature.style,null,null,null,null,null);break;}
this.addingFeature=feature;this.clearFeatureSelection();this.selectFeature(feature);if(this.dataGrid)this.showList();},_featureModified:function(feature)
{var json={};try{json=dojo.fromJson(feature.attributes.description);}catch(e){}
json.modified=new Date().getTime();feature.attributes.description=dojo.toJson(json);if(this.dataGrid)this.showList();},_selectedFeaturesModified:function()
{var selected=this.memoLayer.selectedFeatures;for(var i=selected.length-1;i>=0;i--){this._featureModified(selected[i],true);}
if(this.dataGrid)this.showList();},changeOrderToEnds:function(toTop)
{try{var f=this.memoLayer.features;var sf=this.memoLayer.selectedFeatures;var sfMap={};for(var i=sf.length-1;i>=0;i--){sfMap[sf[i].id]=true;}
if(toTop){f.sort(function(a,b){return(sfMap[a.id]?1:0)-(sfMap[b.id]?1:0);});}else{f.sort(function(b,a){return(sfMap[a.id]?1:0)-(sfMap[b.id]?1:0);});}
this.memoLayer.eraseFeatures(f);for(var i=0;i<f.length;i++){this.memoLayer.drawFeature(f[i]);}}catch(e){console.error(e);}},setShapeType:function(mode,iconClass)
{this.shapeType=mode;dijit.byId('memoSHAPE').iconNode.className="dijitReset dijitInline "+iconClass;this.changeEditControl(mode);},setIcon:function(iconURL,w,h,x,y)
{this.iconStyle={externalGraphic:iconURL,graphicWidth:w,graphicHeight:h,graphicXOffset:x,graphicYOffset:y};var features=this.memoLayer.selectedFeatures;for(var i in features){var feature=features[i];var style=feature.style;if(feature.geometry.CLASS_NAME.match(/Point$/)){if(!this.isText(feature)&&!this.isPhoto(feature)){var scale=1;if(style.externalGraphic){var size=Math.max(style.graphicWidth,style.graphicHeight);var scale=size/Math.max(w,h);}
style.externalGraphic=iconURL;style.graphicWidth=w*scale;style.graphicHeight=h*scale;style.graphicXOffset=x*scale;style.graphicYOffset=y*scale;this.memoLayer.drawFeature(features[i]);this._adjustIconScale(style);}}}},setIconSize:function(size)
{if(size>0){this.iconSize=size;var features=this.memoLayer.selectedFeatures;for(var i=0;i<features.length;i++){if(features[i].geometry.CLASS_NAME.match(/Point$/)){var style=features[i].style;if(style.externalGraphic){var scale=size/Math.max(style.graphicWidth,style.graphicHeight);console.log(scale);style.graphicWidth*=scale;style.graphicHeight*=scale;style.graphicXOffset*=scale;style.graphicYOffset*=scale;style.graphicScale*=scale;}else{style.pointRadius=size;}
this.memoLayer.drawFeature(features[i]);}}}},_adjustIconScale:function(style)
{var img=new Image();img.onload=function(){style.graphicScale=Math.max(style.graphicWidth)/this.width;};img.src=style.externalGraphic;if(img.width){style.graphicScale=Math.max(style.graphicWidth)/img.width;}},setSelectedFeatureStyle:function(changeStyleFunc){var me=this;var memoLayer=me.memoLayer;var features=memoLayer.selectedFeatures;for(var i=0;i<features.length;i++){var f=features[i];var beforeFeature=me.cloneTextFeature(f);changeStyleFunc(f);memoLayer.drawFeature(f);me.layer.events.triggerEvent("featuremodified",{type:"featuremodified",feature:f,afterFeature:me.cloneTextFeature(f),beforeFeature:beforeFeature});}},setFontColor:function(color)
{var defaultStyle=this.memoLayer.styleMap.styles['default'].defaultStyle;defaultStyle.fontColor=color;var features=this.memoLayer.selectedFeatures;for(var i=0;i<features.length;i++){var f=features[i];f.style.fontColor=color;this.memoLayer.drawFeature(f);}
dijit.byId('memoFontColor').iconNode.style.backgroundColor=color;},setDrawColor:function(color)
{var defaultStyle=this.memoLayer.styleMap.styles['default'].defaultStyle;defaultStyle.strokeColor=color;var features=this.memoLayer.selectedFeatures;for(var i=0;i<features.length;i++){var f=features[i];f.style.strokeColor=color;this.memoLayer.drawFeature(f);}
dijit.byId('memoDrawColor').iconNode.style.backgroundColor=color;},setLineWidth:function(width)
{var defaultStyle=this.memoLayer.styleMap.styles['default'].defaultStyle;defaultStyle.strokeWidth=width;var features=this.memoLayer.selectedFeatures;for(var i=0;i<features.length;i++){features[i].style.strokeWidth=width;this.memoLayer.drawFeature(features[i]);}},setFillColor:function(color)
{var defaultStyle=this.memoLayer.styleMap.styles['default'].defaultStyle;defaultStyle.fillColor=color;var features=this.memoLayer.selectedFeatures;for(var i=0;i<features.length;i++){var style=features[i].style;style.fillColor=color;this.memoLayer.drawFeature(features[i]);}},setFillOpacity:function(opacity)
{var defaultStyle=this.memoLayer.styleMap.styles['default'].defaultStyle;defaultStyle.fillOpacity=opacity;var features=this.memoLayer.selectedFeatures;for(var i=0;i<features.length;i++){features[i].style.fillOpacity=opacity;this.memoLayer.drawFeature(features[i]);}},setFontSize:function(size)
{var defaultStyle=this.memoLayer.styleMap.styles['default'].defaultStyle;defaultStyle.fontSize=size;var features=this.memoLayer.selectedFeatures;for(var i=0;i<features.length;i++){var f=features[i];if(f.attributes.name){if(f.attributes.description){this.setTextZoomOption(f.attributes,true);}
f.style.fontSize=size;this.setLabelBackground(f);this.memoLayer.drawFeature(f);}}},setTextZoomOption:function(attributes,update,remove)
{try{var option={};try{option=dojo.fromJson(attributes.description);}catch(e){}
if(update){if(option.reso)option.reso=this.memoLayer.getResolution();}else{if(remove){if(option.reso)delete option.reso;}else{option.reso=this.memoLayer.getResolution();}}
attributes.description=dojo.toJson(option);attributes.option=option;}catch(e){console.error(e);}},updateStyle:function(type,feature,form)
{this.changeEditControl(null);},CLASS_NAME:"SaigaiTask.Map.Layer.DrawLayerSelectDrag"});SaigaiTask.Map.Layer.DrawLayer=new OpenLayers.Class(SaigaiTask.Map.Layer.DrawLayerSelectDrag,{stmap:null,singlePointMoveClickHandler:null,layer:null,drawFeatures:null,activeDrawKey:null,featureIdSerial:0,controls:null,snapControl:null,userStyle:null,initialize:function(stmap){var me=this;me.stmap=stmap;me.snapControl=new SaigaiTask.Map.control.SnapControl(stmap);me.initDraw();me.userStyle={};me.snapControl.setLayer(me.layer);me.singlePointMoveClickHandler=new OpenLayers.Handler.Click(stmap,{click:function(evt){var lonlat=stmap.map.getLonLatFromPixel(new OpenLayers.Pixel(evt.xy.x,evt.xy.y));var ret=me.moveSinglePoint(lonlat);var feature=ret.feature;$("."+feature.fid).change();return ret;}},{single:true});me.singlePointMoveClickHandler.deactivate();me.historyControl=new SaigaiTask.Map.control.DrawLayerHistoryControl(me);stmap.controls.kmlSelectControl.deactivate();SaigaiTask.Map.Layer.DrawLayerSelectDrag.prototype.initialize.apply(this,[me.layer]);},getFeatureIDPrefix:function(){return this.stmap.div+"Feature";},createFeatureID:function(drawKey){var num=this.layer.features.length-1;return this.getFeatureIDPrefix()+num;},getFeatureIndexFromID:function(featureId){var prefix=this.getFeatureIDPrefix();var id=featureId.substring(prefix.length);return id;},initDraw:function(){var me=this;var stmap=me.stmap;var layer=me.layer=new OpenLayers.Layer.Vector("Draw Layer");layer.events.on({"featureadded":function(evt){var feature=evt.feature;var f=feature;f.fid=me.createFeatureID(me.activeDrawKey);if(!f.style){f.style=new Object();var style=me.layer.styleMap.styles['default'].defaultStyle;for(var key in style){f.style[key]=style[key];}}
f.style.cursor="pointer";if(!me.drawFeatures[me.activeDrawKey]){me.drawFeatures[me.activeDrawKey]=new Array();}
me.drawFeatures[me.activeDrawKey].push(f);me.writeFeatureGeometoryValue(feature);},"featureremoved":function(evt){var feature=evt.feature;$("."+feature.fid).val("");},"featuremodified":function(evt){var feature=evt.feature;me.writeFeatureGeometoryValue(feature);}});stmap.addLayer(layer);layer.styleMap=new OpenLayers.StyleMap();for(var key in layer.styleMap.styles){var obj=layer.styleMap.styles[key];if(obj instanceof OpenLayers.Style){layer.styleMap.styles[key]=obj.clone();}}
layer.styleMap.styles['default'].defaultStyle=me.getDrawControlStyle();var dragFeatureStatus=null;var drawControls={text:new OpenLayers.Control.DrawFeature(layer,OpenLayers.Handler.Point,{featureAdded:function(feature){me._startTextEdit(feature);}}),point:new OpenLayers.Control.DrawFeature(layer,OpenLayers.Handler.Point),line:new OpenLayers.Control.DrawFeature(layer,OpenLayers.Handler.Path),freeline:new OpenLayers.Control.DrawFeature(layer,OpenLayers.Handler.Path,{handlerOptions:{freehand:true}}),polygon:new OpenLayers.Control.DrawFeature(layer,OpenLayers.Handler.Polygon),circle:new OpenLayers.Control.DrawFeature(layer,OpenLayers.Handler.RegularPolygon,{handlerOptions:{sides:40},eventListeners:{"deactivate":function(){if(!!stmap.popupManager){stmap.popupManager.closeAll();}}},callbacks:{"move":function(geometry){if(map.map.units!="m"){geometry=geometry.clone().transform(map.map.getProjectionObject(),new OpenLayers.Projection("EPSG:900913"));}
var area=geometry.getArea();var radius=0.565352*Math.sqrt(area);if(!!stmap.popupManager){stmap.popupManager.closeAll();}
var centroid=geometry.getCentroid();var center=new OpenLayers.LonLat(centroid.x,centroid.y).transform(stmap.map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326"));popup=new SaigaiTask.Map.view.Popup();var radiusText=parseInt(radius)+"m";if(10000<radius)radiusText=(radius/1000).toFixed(2)+"km";popup.showExtPopup({map:stmap,olmap:stmap.map,center:center,size:new OpenLayers.Size(150,10),title:radiusText});}}}),box:new OpenLayers.Control.DrawFeature(layer,OpenLayers.Handler.RegularPolygon,{handlerOptions:{sides:4,irregular:true}}),dragFeature:new OpenLayers.Control.DragFeature(layer,{onStart:function(feature,pixel){dragFeatureStatus={beforeFeature:feature.clone()};},onComplete:function(feature,pixel){me.writeFeatureGeometoryValue(feature);if(!!dragFeatureStatus){var event={type:"featuremoved",feature:feature,afterFeature:feature.clone(),beforeFeature:dragFeatureStatus.beforeFeature};me.layer.events.triggerEvent(event.type,event);dragFeatureStatus=null;}}}),modifyFeature:new OpenLayers.Control.ModifyFeature(layer),selectFeature:new OpenLayers.Control.SelectFeature(layer),selectDragFeature:new OpenLayers.Control.SelectDragFeature(layer,{onSelect:function(feature){me._featureSelected(feature);},onUnselect:function(feature){me._featureUnselected(feature);},onDblClick:function(feature){me.checkTextEdit(feature);},onKeyDown:function(evt){if(document.activeElement.tagName!="TEXTAREA")me._onKeyDown(evt);},onStart:function(feature,pixel){var features=me.memoLayer.selectedFeatures;for(var idx in features){var feature=features[idx];delete feature.beforeFeature;var beforeFeature=me.cloneTextFeature(feature);feature.beforeFeature=beforeFeature;}
dragFeatureStatus={};},onDrag:function(pixel){me.memoSelectLayer.setVisibility(false);},onComplete:function(pixel){me.memoSelectLayer.setVisibility(true);me.resetFeatureSelection(layer);me._selectedFeaturesModified();if(!!dragFeatureStatus){var features=me.memoLayer.selectedFeatures;for(var idx in features){var feature=features[idx];beforeFeature=feature.beforeFeature;var event={type:"featuremoved",feature:feature,afterFeature:me.cloneTextFeature(feature),beforeFeature:beforeFeature};me.layer.events.triggerEvent(event.type,event);};dragFeatureStatus=null;}},clickout:true,toggle:false,multiple:false,hover:false,toggleKey:"ctrlKey",multipleKey:"shiftKey",box:false}),selectDragFeatureBox:new OpenLayers.Control.SelectDragFeature(layer,{onSelect:function(feature){me._featureSelected(feature);},onUnselect:function(feature){me._featureUnselected(feature);},onDblClick:function(feature){me.checkTextEdit(feature);},onKeyDown:function(evt){if(document.activeElement.tagName!="TEXTAREA")me._onKeyDown(evt);},onStart:function(feature,pixel){var features=me.memoLayer.selectedFeatures;for(var idx in features){var feature=features[idx];delete feature.beforeFeature;var beforeFeature=me.cloneTextFeature(feature);feature.beforeFeature=beforeFeature;}
dragFeatureStatus={};},onDrag:function(pixel){me.memoSelectLayer.setVisibility(false);},onComplete:function(pixel){me.memoSelectLayer.setVisibility(true);me.resetFeatureSelection(layer);me._selectedFeaturesModified();if(!!dragFeatureStatus){var features=me.memoLayer.selectedFeatures;for(var idx in features){var feature=features[idx];beforeFeature=feature.beforeFeature;var event={type:"featuremoved",feature:feature,afterFeature:me.cloneTextFeature(feature),beforeFeature:beforeFeature};me.layer.events.triggerEvent(event.type,event);};dragFeatureStatus=null;}},clickout:true,toggle:false,multiple:false,hover:false,toggleKey:"ctrlKey",multipleKey:"shiftKey",box:true})};me.controls={};for(var key in drawControls){var control=drawControls[key];me.addControl(control,key);}
var virtualStyle=drawControls.modifyFeature.virtualStyle;virtualStyle.strokeColor="#FF0000";virtualStyle.strokeWidth=2;virtualStyle.strokeDashstyle='dash';virtualStyle.externalGraphic=stmap.icon.getURL("verticeIconURL");virtualStyle.graphicWidth=9;virtualStyle.graphicHeight=9;virtualStyle.graphicOpacity=0.5;virtualStyle.graphicXOffset=-5;virtualStyle.graphicYOffset=-5;me.drawFeatures=new Object();for(var key in drawControls){me.drawFeatures[key]=new Array();}},getDrawControlDefaultStyle:function(key){var me=this;var stmap=me.stmap;console.log("getDrawControlDefaultStyle");var style={fillColor:"#FFFFFF",fillOpacity:0.4,strokeColor:"#000000",strokeOpacity:1,strokeWidth:2,strokeLinecap:"round",strokeDashstyle:"solid",fontSize:14,labelAlign:"lt",externalGraphic:stmap.icon.getURL("editingIconURL"),graphicWidth:19,graphicHeight:32,graphicXOffset:-9,graphicYOffset:-32,graphicOpacity:1};switch(key){case"point":case"line":case"polygon":case"box":break;case"modifyFeature":style.externalGraphic=stmap.icon.getURL("pointnodeIconURL");style.graphicWidth=9;style.graphicHeight=9;style.graphicXOffset=-5;style.graphicYOffset=-5;style.graphicOpacity=1;break;case"selectDragFeature":case"text":style={};Ext.apply(style,me.modifyStyleMap.styles.default.defaultStyle);break;}
return style;},getDrawControlStyle:function(key){var me=this;var stmap=me.stmap;var style=me.getDrawControlDefaultStyle(key);Ext.apply(style,me.userStyle);return style;},writeFeatureGeometoryValue:function(feature){if(!feature)return;var me=this;var stmap=me.stmap;var wkt=stmap.getWKT(feature);var featureId=feature.fid;switch(feature.geometry.CLASS_NAME){case"OpenLayers.Geometry.Point":case"OpenLayers.Geometry.LineString":case"OpenLayers.Geometry.Polygon":default:var c="."+featureId;var jqueryObj=jQuery(c);jqueryObj.val(wkt);break;}},moveSinglePoint:function(lonlat){var me=this;var drawKey='point';var idx=0;var feature=me.drawFeatures[drawKey][idx];me.layer.setVisibility(true);if(lonlat!=null){if(feature){feature.move(lonlat);}
else{var lon=lonlat.lon;var lat=lonlat.lat;me.drawPointFeature(lon,lat);feature=me.drawFeatures[drawKey][idx];}}
if(feature!=null){me.writeFeatureGeometoryValue(feature);}
var ret={feature:feature};return ret;},removeSinglePoint:function(){return me.removePointFeature(0);},drawCenterPoint:function(){var center=this.map.getCenter();return this.drawPointFeature(center.lon,center.lat);},drawPointFeature:function(lon,lat){var geometry=new OpenLayers.Geometry.Point(lon,lat);return this.drawFeature("point",geometry);},drawFeature:function(controlKey,geometry){if(!geometry||!controlKey)return;var drawControl=this.getDrawControl(controlKey);var savedActiveDrawKey=this.activeDrawKey;this.activeDrawKey=controlKey;var ret=drawControl.drawFeature(geometry);this.activeDrawKey=savedActiveDrawKey;return ret;},drawFeatureByGeometry:function(geometry){var me=this;if(geometry.CLASS_NAME.match(/^OpenLayers.Geometry.Multi/)!=null){for(var idx in geometry.components){me.drawFeatureByGeometry(geometry.components[idx]);}}
else{var controlKey=null;switch(geometry.CLASS_NAME){case"OpenLayers.Geometry.Point":controlKey="point";break;case"OpenLayers.Geometry.LineString":controlKey="line";break;case"OpenLayers.Geometry.Polygon":controlKey="polygon";break;}
geometry.transform(new OpenLayers.Projection("EPSG:4326"),me.stmap.map.getProjectionObject());me.drawFeature(controlKey,geometry);}},getDrawLayerFeatureByIndex:function(idx){return this.layer.features[idx];},removePointFeature:function(idx){return this.removeFeature("point",idx);},removeFeature:function(drawKey,idx){var feature=this.drawFeatures[drawKey][idx];this.layer.removeFeatures([feature]);this.drawFeatures[drawKey][idx]=null;},addControl:function(control,key){if(typeof key!='undefined'){this.controls[key]=control;}
return this.stmap.map.addControl(control);},setControlActivation:function(control,activation){var me=this;if(activation)return control.activate();else{if(control==me.getDrawControl(me.activeDrawKey)){me.activeDrawKey=null;}
return control.deactivate();}},getDrawControl:function(key){return this.controls[key];},getDrawActivation:function(key){var control=this.getDrawControl(key);return control.active;},setDrawActivation:function(key,activate){var control=this.getDrawControl(key);return this.setControlActivation(control,activate);},deactivateDrawControl:function(key){return this.setDrawActivation(key,false);},deactivateCurrentDrawControl:function(){var activeDrawKey=this.activeDrawKey;if(activeDrawKey){return this.deactivateDrawControl(activeDrawKey);}},activateDrawControl:function(key){if(key){console.log("activate "+key);this.setDrawActivation(key,true);this.activeDrawKey=key;var style=this.getDrawControlStyle(key);this.layer.styleMap.styles['default'].defaultStyle=style;return true;}
return false;},getDragFeatureControl:function(){var me=this;var key="dragFeature";var control=me.controls[key];if(!control)return null;return control;},getDragFeatureControlActivation:function(){var me=this;var control=me.getDragFeatureControl();if(!control)return false;return control.active;},setDragFeatureControlActivation:function(activation){var me=this;var stmap=me.stmap;var key="dragFeature";var control=me.getDragFeatureControl()
if(!control)return;if(typeof activation=="undefined"){activation=!control.active;}
if(activation){stmap.deactivateMouseControl();me.deactivateCurrentDrawControl();me.setDragFeatureControlActivation(false);me.setModifyFeatureControlActivation(false);stmap.setNavigationControlActivation(true);return me.activateDrawControl(key);}
return me.setControlActivation(control,activation);},getSelectDragFeatureControl:function(){var me=this;var key="selectDragFeature";var control=me.controls[key];if(!control)return null;return control;},getBoxSelectDragFeatureControl:function(){var me=this;var key="selectDragFeatureBox";var control=me.controls[key];if(!control)return null;return control;},getSelectDragFeatureControlActivation:function(){var me=this;var control=me.getSelectDragFeatureControl();if(!control)return false;return control.active;},getBoxSelectDragFeatureControlActivation:function(){var me=this;var control=me.getBoxSelectDragFeatureControl();if(!control)return false;return control.active;},setSelectDragFeatureControlActivation:function(activation){var me=this;var stmap=me.stmap;var key="selectDragFeature";var control=me.getSelectDragFeatureControl()
if(!control)return;if(typeof activation=="undefined"){activation=!control.active;}
if(activation){stmap.deactivateMouseControl();me.deactivateCurrentDrawControl();me.setDragFeatureControlActivation(false);me.setModifyFeatureControlActivation(false);stmap.setNavigationControlActivation(true);stmap.toFront(me.layer);return me.activateDrawControl(key);}
return me.setControlActivation(control,activation);},setBoxSelectDragFeatureControlActivation:function(activation){var me=this;var stmap=me.stmap;var key="selectDragFeatureBox";var control=me.getBoxSelectDragFeatureControl()
if(!control)return;if(typeof activation=="undefined"){activation=!control.active;}
if(activation){stmap.deactivateMouseControl();me.deactivateCurrentDrawControl();me.setDragFeatureControlActivation(false);me.setModifyFeatureControlActivation(false);stmap.setNavigationControlActivation(true);stmap.toFront(me.layer);return me.activateDrawControl(key);}
return me.setControlActivation(control,activation);},setModifyFeatureControlActivation:function(activation){var me=this;var stmap=me.stmap;var key="modifyFeature";var control=this.controls[key];if(!control)return;if(typeof activation=="undefined"){activation=!control.active;}
if(activation){stmap.deactivateMouseControl();me.deactivateCurrentDrawControl();me.setDragFeatureControlActivation(false);me.setModifyFeatureControlActivation(false);stmap.setNavigationControlActivation(true);control.mode=OpenLayers.Control.ModifyFeature.RESHAPE;var ret=me.activateDrawControl(key);if(0<me.layer.features.length){control.selectFeature(me.layer.features[0]);}
return ret;}
return me.setControlActivation(control,activation);},destroy:function(){var me=this;var stmap=me.stmap;var olmap=stmap.map;var drawLayer=me;drawLayer.deactivateCurrentDrawControl();drawLayer.setDragFeatureControlActivation(false);drawLayer.controls.selectFeature.deactivate();olmap.removeControl(drawLayer.controls.selectFeature);drawLayer.layer.setVisibility(false);drawLayer.layer.removeAllFeatures();drawLayer.singlePointMoveClickHandler.deactivate();olmap.removeLayer(drawLayer.layer);drawLayer.layer.destroy();me.snapControl.destroy();stmap.controls.kmlSelectControl.activate();}});SaigaiTask.Map.control.SpatialSearch=function(){};SaigaiTask.Map.control.SpatialSearch.prototype={getSearchResult:function(result){if(result){var searchResult=new SaigaiTask.Map.model.SearchResult();searchResult.raw=result;var _result=result;if(_result){searchResult.success=_result.success;var counts=_result.items[0];var resultCount=new SaigaiTask.Map.model.ResultCount();resultCount.total=counts[0];resultCount.limit=counts[1];resultCount.offset=counts[2];searchResult.counts=resultCount;searchResult.features=[];var features=_result.items[1];for(var featuresIdx in features){var feature=features[featuresIdx];var f=new SaigaiTask.Map.model.Feature();f.layerId=feature[0];f.featureId=feature[1];f.geometry=new SaigaiTask.Map.model.Geometry();var geometryResult=feature[2];f.geometry.wkt=geometryResult[0];f.attributes=[];var attributeResults=feature[3];for(var attributeResultsIdx=0;attributeResultsIdx<attributeResults.length/2;attributeResultsIdx++){var idx=attributeResultsIdx*2;var attr=new SaigaiTask.Map.model.Attribute();attr.id=attributeResultsIdx;attr.name=attributeResults[idx];attr.value=attributeResults[idx+1];f.attributes.push(attr);}
f.files=feature[4];f.metadata=feature[5];f.raw=feature;searchResult.features.push(f);}
return searchResult;}}
return null;}};OpenLayers.Control.DragMarker=OpenLayers.Class(OpenLayers.Control,{initialize:function(layer,options){OpenLayers.Control.prototype.initialize.apply(this,[options]);this.layer=layer;this.handlers={drag:new OpenLayers.Handler.Drag(this,OpenLayers.Util.extend({down:this.downFeature,move:this.moveFeature,up:this.upFeature,out:this.cancel},this.dragCallbacks),{documentDrag:this.documentDrag})};},destroy:function(){this.layer=null;OpenLayers.Control.prototype.destroy.apply(this,[]);},activate:function(){return(this.handlers.drag.activate()&&OpenLayers.Control.prototype.activate.apply(this,arguments));},deactivate:function(){this.handlers.drag.deactivate();this.feature=null;this.dragging=false;this.lastPixel=null;OpenLayers.Element.removeClass(this.map.viewPortDiv,this.displayClass+"Over");return OpenLayers.Control.prototype.deactivate.apply(this,arguments);},overFeature:function(feature){if(!this.handlers.drag.dragging){this.feature=feature;this.handlers.drag.activate();OpenLayers.Element.addClass(this.map.viewPortDiv,this.displayClass+"Over");}
this.over=true;},downFeature:function(pixel){if(this.over){this.lastPixel=pixel;this.onStart(this.feature,pixel);this.handlers.drag.activate();this.handlers.drag.dragging=true;}},moveFeature:function(pixel){if(this.feature){var px=this.feature.icon.px.add(pixel.x-this.lastPixel.x,pixel.y-this.lastPixel.y);this.feature.moveTo(px);this.lastPixel=pixel;this.onDrag(this.feature,pixel);}},upFeature:function(pixel){if(!this.over){this.handlers.drag.deactivate();}
this.onComplete(this.feature,pixel);},doneDragging:function(pixel){this.onComplete(this.feature,pixel);},outFeature:function(feature){this.over=false;if(!this.handlers.drag.dragging){this.handlers.drag.deactivate();OpenLayers.Element.removeClass(this.map.viewPortDiv,this.displayClass+"Over");this.feature=null;}},cancel:function(){this.onComplete(this.feature,this.lastPixel);this.handlers.drag.deactivate();this.over=false;this.feature=null;},setMap:function(map){this.handlers.drag.setMap(map);OpenLayers.Control.prototype.setMap.apply(this,arguments);},CLASS_NAME:"OpenLayers.Control.DragMarker"});SaigaiTask.Map.Icon=function(){this.initialize.apply(this,arguments);};SaigaiTask.Map.Icon.prototype={baseURL:null,icon:{addIconURL:"/icons/add.png",removeIconURL:"/icons/remove.png",deleteIconURL:"/icons/delete.png",editIconURL:"/icons/edit.png",mapEditIconURL:"/icons/map_edit.png",undoIconURL:"/icons/undo.png",redoIconURL:"/icons/redo.png",editingIconURL:"/icons/editing.png",selectingIconURL:"/icons/selecting.png",pointnodeIconURL:"/icons/pointnode.png",printIconURL:"/icons/print.png",downloadMapIconURL:"/icons/map_down.png",downloadIconURL:"/icons/download.png",rangeIconURL:"/icons/range.png",folderOpenIconURL:"/icons/folder_open.png",closeIconURL:"/icons/close.png",reloadIconURL:"/icons/reload.png",verticeIconURL:"/icons/vertice.png",submapIconURL:"/images/submap.png",syncIconURL:"/images/CircledSync.png",markerIconURL:"/icons/geosilk/marker.png",newwinIconURL:"/images/newwinicon.gif",mgrsIconURL:"/icons/mgrs.png",rulerIconURL:"/icons/geosilk/ruler_triangle.png",transparencyURL:"/icons/pen.png"},initialize:function(baseURL){var me=this;if(typeof baseURL!="undefined"){me.baseURL=baseURL;}},getURL:function(name){var me=this;return me.baseURL+me.icon[name];}};SaigaiTask.Map.util.GeoUtil={projection:{WGS84:new OpenLayers.Projection("EPSG:4326"),GOOGLE:new OpenLayers.Projection("EPSG:900913"),UTM_ZONE_52N:new OpenLayers.Projection("EPSG:32652"),UTM_ZONE_53N:new OpenLayers.Projection("EPSG:32653"),UTM_ZONE_54N:new OpenLayers.Projection("EPSG:32654"),UTM_ZONE_55N:new OpenLayers.Projection("EPSG:32655")},projectionBounds:{WGS84:null,GOOGLE:null,UTM_ZONE_52N:new OpenLayers.Bounds(126.0000,0.0000,132.0000,84.0000),UTM_ZONE_53N:new OpenLayers.Bounds(132.0000,0.0000,138.0000,84.0000),UTM_ZONE_54N:new OpenLayers.Bounds(138.0000,0.0000,144.0000,84.0000),UTM_ZONE_55N:new OpenLayers.Bounds(144.0000,0.0000,150.0000,84.0000)},transform:function(geometry,sourceProj,destProj){switch(geometry.CLASS_NAME){case"OpenLayers.Geometry.Curve":console.error('transform '+geometry.CLASS_NAME+' is not supported.');break;case"OpenLayers.Geometry.Point":case"OpenLayers.Geometry.Collection":case"OpenLayers.Geometry.LinearRing":geometry=geometry.transform(sourceProj,destProj);break;case"OpenLayers.Geometry.LineString":case"OpenLayers.Geometry.Polygon":case"OpenLayers.Geometry.MultiPoint":case"OpenLayers.Geometry.MultiLineString":case"OpenLayers.Geometry.MultiPolygon":var components=geometry.components;for(var componentsIdx in components){var component=components[componentsIdx];SaigaiTask.Map.util.GeoUtil.transform(component,sourceProj,destProj);}
break;}
return geometry;},transform2UTM:function(geometry,sourceProj){var startTime=new Date();if(typeof sourceProj=='undefined'){sourceProj=SaigaiTask.Map.util.GeoUtil.projection.WGS84;}
var zones=[{proj:SaigaiTask.Map.util.GeoUtil.projection.UTM_ZONE_52N,bounds:SaigaiTask.Map.util.GeoUtil.projectionBounds.UTM_ZONE_52N},{proj:SaigaiTask.Map.util.GeoUtil.projection.UTM_ZONE_53N,bounds:SaigaiTask.Map.util.GeoUtil.projectionBounds.UTM_ZONE_53N},{proj:SaigaiTask.Map.util.GeoUtil.projection.UTM_ZONE_54N,bounds:SaigaiTask.Map.util.GeoUtil.projectionBounds.UTM_ZONE_54N},{proj:SaigaiTask.Map.util.GeoUtil.projection.UTM_ZONE_55N,bounds:SaigaiTask.Map.util.GeoUtil.projectionBounds.UTM_ZONE_55N}];var destProj=null;var mindistance=null;var centroid=geometry.getCentroid();for(var zonesIdx in zones){var zone=zones[zonesIdx];var contain=zone.bounds.contains(centroid.x,centroid.y);if(contain){destProj=zone.proj;break;}
var distance=centroid.distanceTo(zone.bounds.toGeometry());if(mindistance==null||mindistance>distance){mindistance=distance;destProj=zone.proj;}}
SaigaiTask.Map.util.GeoUtil.transform(geometry,sourceProj,destProj);var endTime=new Date();console.log("transform2UTM: "+(endTime-startTime)/1000+lang.__("Second"));return destProj;},union:function(wkts){var wktFormat=new OpenLayers.Format.WKT();var parser=new jsts.io.OpenLayersParser();var unionGeom=null;var utmProj=null;for(var wktsIdx in wkts){var wkt=wkts[wktsIdx];var feature=wktFormat.read(wkt);utmProj=SaigaiTask.Map.util.GeoUtil.transform2UTM(feature.geometry);var jstsGeom=parser.read(feature.geometry);if(unionGeom==null)unionGeom=jstsGeom;else unionGeom=unionGeom.union(jstsGeom);}
if(unionGeom!=null){var olGeom=parser.write(unionGeom);var feature=new OpenLayers.Feature.Vector(olGeom);SaigaiTask.Map.util.GeoUtil.transform(feature.geometry,utmProj,SaigaiTask.Map.util.GeoUtil.projection.WGS84);return feature;}
return null;},buffer:function(wkts,buffer){var wktFormat=new OpenLayers.Format.WKT();var parser=new jsts.io.OpenLayersParser();var features=[];for(var wktsIdx in wkts){var wkt=wkts[wktsIdx];var feature=wktFormat.read(wkt);var utmProj=SaigaiTask.Map.util.GeoUtil.transform2UTM(feature.geometry);var jstsGeom=parser.read(feature.geometry);jstsGeom=jstsGeom.buffer(buffer);console.log("utmProj");console.log(utmProj);var olGeom=parser.write(jstsGeom);var bufferedFeature=new OpenLayers.Feature.Vector(olGeom);SaigaiTask.Map.util.GeoUtil.transform(bufferedFeature.geometry,utmProj,SaigaiTask.Map.util.GeoUtil.projection.WGS84);features.push(bufferedFeature);}
return features;}};SaigaiTask.Map.view.ContentsSearch=function(map){this.map=map;};SaigaiTask.Map.view.ContentsSearch.prototype={map:null,container:null,spatialSearchFrom:null,spatialSearchResult:null,rangeLayer:null,resultLayer:null,searchResult:null,get:function(options){var me=this;var searchFormOptions=options.searchForm;var spatialSearchForm=new SaigaiTask.Map.view.SpatialSearchForm();me.spatialSearchFrom=spatialSearchForm;var form=spatialSearchForm.get(searchFormOptions);var spatialSearchResult=new SaigaiTask.Map.view.SpatialSearchResult();me.spatialSearchResult=spatialSearchResult;var resultView=spatialSearchResult.grid;resultView.title=lang.__('Search result');resultView.collapsible=false;resultView.margin='5 0 0 0';resultView.autoSize=true;var store=spatialSearchResult.grid.store;var reloadRangeLayer=function(){var wkts=[];var values=spatialSearchForm.getValues();var wkt=me.map.api.getContentsSearchRangeWKT(values);if(typeof wkt!="undefined"&&wkt!=null){wkts.push(wkt);}
me.loadRangeLayer(wkts);};reloadRangeLayer();var searchForMap=function(){reloadRangeLayer();me.searchResult=null;var limit=0;var offset=0;form.submit({params:{mid:searchFormOptions.searchButtonInfo.mid,limit:limit,offset:offset},success:function(form,action){var result=action.result;var spatialSearch=new SaigaiTask.Map.control.SpatialSearch();var searchResult=spatialSearch.getSearchResult(result);me.loadResultLayer(searchResult);me.searchResult=searchResult;}});};var searchForGrid=function(limit,offset){resultView.setLoading(true);if(resultView.collapsed){resultView.toggleCollapse();}
store.pageSize=limit;form.submit({params:{mid:searchFormOptions.searchButtonInfo.mid,limit:limit,offset:offset},success:function(form,action){var result=action.result;var spatialSearch=new SaigaiTask.Map.control.SpatialSearch();var searchResult=spatialSearch.getSearchResult(result);spatialSearchResult.load(searchResult);resultView.setLoading(false);}});};form.on('search',function(){searchForMap();var limit=spatialSearchResult.limitCombo.value;var offset=0;searchForGrid(limit,offset);});var pagingTbar=spatialSearchResult.pagingTbar;pagingTbar.on('movefirst',function(){store.currentPage=1;var limit=spatialSearchResult.limitCombo.value;var offset=(store.currentPage-1)*store.pageSize;searchForGrid(limit,offset);});pagingTbar.on('movelast',function(){var total=pagingTbar.store.totalCount;var limit=pagingTbar.store.pageSize;store.currentPage=Math.ceil(total/limit);var offset=(store.currentPage-1)*store.pageSize;searchForGrid(limit,offset);});pagingTbar.on('movenext',function(){store.currentPage++;var limit=spatialSearchResult.limitCombo.value;var offset=(store.currentPage-1)*store.pageSize;searchForGrid(limit,offset);});pagingTbar.on('moveprevious',function(){store.currentPage--;var limit=spatialSearchResult.limitCombo.value;var offset=(store.currentPage-1)*store.pageSize;searchForGrid(limit,offset);});spatialSearchResult.grid.on('popup',function(layerId,featureId){if(me.map){me.map.getContent(layerId,featureId);}});form.region="north";resultView.region="center";var panel=Ext.create("Ext.container.Container",{width:500,height:500,autoScroll:true,layout:{type:'border'},items:[form,resultView]});this.container=panel;return panel;},show:function(options){var me=this;var map=me.map;var container=me.get(options);var fbar=null;fbar=map.events.triggerEvent(map.EventType.beforeshowcontentsearchview,{contentSearchView:me});var win=Ext.create("Ext.window.Window",{title:lang.__('Registration info Search'),collapsible:true,resizable:true,width:500,maxWidth:document.body.clientWidth,maxHeight:document.body.clientHeight,layout:'fit',items:[container],fbar:fbar,buttonAlign:"center"});win.on('destroy',function(){me.onDestroy();});window.win=win;win.show();win.alignTo(document,"bl",[0,-win.getHeight()-20]);},loadRangeLayer:function(wkts){var me=this;var olmap=me.map.map;if(!me.rangeLayer){me.rangeLayer=new OpenLayers.Layer.Vector(lang.__("Search range"));}
var rangeLayer=me.rangeLayer;if(olmap.getLayer(rangeLayer.id)){olmap.removeLayer(rangeLayer);}
features=[];var wktFormat=new OpenLayers.Format.WKT();for(var wktsIdx in wkts){var wkt=wkts[wktsIdx];var feature=wktFormat.read(wkt);feature.geometry.transform(new OpenLayers.Projection("EPSG:4326"),olmap.getProjectionObject());features.push(feature);}
rangeLayer.removeAllFeatures();rangeLayer.addFeatures(features);if(0<features.length){olmap.addLayer(rangeLayer);}},loadResultLayer:function(searchResult){var me=this;var map=me.map;var olmap=me.map.map;if(!me.resultLayer){me.resultLayer=new OpenLayers.Layer.Vector(lang.__("Search result"));}
var resultLayer=me.resultLayer;var style={fillColor:"white",fillOpacity:0.4,strokeColor:"#0099ee",strokeOpacity:1,strokeWidth:5,strokeLinecap:"round",strokeDashstyle:"solid",externalGraphic:map.icon.getURL("editingIconURL"),graphicWidth:19,graphicHeight:32,graphicXOffset:-9,graphicYOffset:-32,graphicOpacity:1};resultLayer.styleMap.styles['default'].defaultStyle=style;if(olmap.getLayer(resultLayer.id)){olmap.removeLayer(resultLayer);}
resultLayer.removeAllFeatures();var features=[];for(var searchResultFeaturesIdx in searchResult.features){var searchResultFeature=searchResult.features[searchResultFeaturesIdx];var geometry=OpenLayers.Geometry.fromWKT(searchResultFeature.geometry.wkt);var feature=new OpenLayers.Feature.Vector(geometry);features.push(feature);}
resultLayer.addFeatures(features);if(0<features.length){olmap.addLayer(resultLayer);}},onDestroy:function(){var me=this;var olmap=me.map.map;var rangeLayer=me.rangeLayer;if(rangeLayer){if(olmap.getLayer(rangeLayer.id)){olmap.removeLayer(rangeLayer);}}
var resultLayer=me.resultLayer;if(resultLayer){if(olmap.getLayer(resultLayer.id)){olmap.removeLayer(resultLayer);}}}};SaigaiTask.Map.Layer.AttrInfo=new OpenLayers.Class({attrId:null,dataExp:null,dataType:null,dataTypeId:null,dataTypeName:null,highlight:false,length:null,maxLength:null,name:null,nullable:null,status:null,updateInserted:false,updateModified:false,addAddressButton:false,buttonData:null,initialize:function(options){this.children=[];this.params=[];OpenLayers.Util.extend(this,options);this.searchable=this.visibility;}});SaigaiTask.Map.Layer.AttrInfo.STATUS_DEFAULT=0;SaigaiTask.Map.Layer.AttrInfo.STATUS_READONLY=1;SaigaiTask.Map.Layer.AttrInfo.STATUS_SEARCHHIDE=-1;SaigaiTask.Map.Layer.AttrInfo.STATUS_DELETED=-100;SaigaiTask.Map.view.LegendPanel=function(){this.initialize.apply(this,arguments);};SaigaiTask.Map.view.LegendPanel.prototype={map:null,tree:null,fbar:null,addMapBtn:null,initialize:function(map){var me=this;me.map=map;var store=Ext.create('Ext.data.TreeStore',{expanded:true});var tree=Ext.create('Ext.tree.Panel',{store:store,rootVisible:false,title:lang.__('Legend'),width:200,border:true,useArrows:true,scroll:false,draggable:true,collapsible:true,resizable:true,resizeHandles:"e",collapsed:me.map.options.collapsed,viewConfig:{style:{overflow:'auto'}},listeners:{afterrender:function(panel,eOps){obj=$(panel.getEl().dom);panel.getEl().setStyle('z-index','1010');obj.click(function(){return false;});obj.dblclick(function(){return false;});obj.children().get(2).style.overflow='auto';},viewready:function(panel,eOps){console.log("viewready");var barItems=[];var rootNode=store.getRootNode();rootNode.on("append",function(thisNode,node,index,eOpts){me.changeViewCheckbox2Radio(thisNode);});rootNode.on("insert",function(thisNode,node,refNode,eOpts){me.changeViewCheckbox2Radio(thisNode);});for(var ecommapsKey in map.ecommaps){var ecommap=map.ecommaps[ecommapsKey];var excludesLayerIds=map.excludesLayerIdsFromLegendWindow;for(var idx in excludesLayerIds){var excludesLayerId=excludesLayerIds[idx];var excludesLayerInfo=ecommap.layerInfoStore[excludesLayerId];if(typeof excludesLayerInfo!="undefined"){excludesLayerInfo.visibility=false;}}
for(var layerInfoTreeKey in ecommap.layerInfoTree){var layerInfo=ecommap.layerInfoTree[layerInfoTreeKey];var node=me.createTreeNode(rootNode,layerInfo);if(node!=null){rootNode.appendChild(node);me.changeViewCheckbox2Radio(node);var layer=layerInfo.layer;if(layer!=null&&typeof layer.refreshParams=="function"){layer.refreshParams();}}}
if(!!ecommap.cswURL&&!me.addMapBtn){me.addMapBtn={text:lang.__('Add map'),icon:map.icon.getURL("addIconURL"),handler:function(){outermap_select();}};barItems.push(me.addMapBtn);}}
var bar=null;if(0<barItems.length){me.addTbarItems(barItems);}},checkchange:function(node,checked,eOpts){var onCheckChange=function(node,checked,option){if(node!=null){var layerInfo=node.raw.layerInfo;if(typeof layerInfo!="undefined"){if(!!node.raw&&!!node.raw.isRuleNode){var ruleNodes=node.parentNode.childNodes;var checkedMap={};for(var ruleNodesIdx in ruleNodes){var ruleNode=ruleNodes[ruleNodesIdx];var ruleId=ruleNode.raw.rule.ruleId;checkedMap[ruleId]=ruleNode.data.checked;}
for(var legendrulesIdx in layerInfo.legendrules){var rule=layerInfo.legendrules[legendrulesIdx];rule.visibility=rule.searchable=checkedMap[rule.ruleId];}
layerInfo.updateRuleParam();}
else{layerInfo.visibility=checked;layerInfo.searchable=checked;}
var recursive=function(n){if(n.get("checked")!=null){if(layerInfo.radio!=null){if(checked){if(n.existOnBrother())return;else{var brothers=node.childNodes;for(var idx in brothers){var brother=brothers[idx];if(brother.get("checked")!=null){if(n!=brother)return;else break;}}}}
else return;}
n.set("checked",checked);me.changeViewCheckbox2Radio(n);onCheckChange(n,checked,option);}};if(!option==false){if(option.doChildren){var childIsRuleNode=false;for(var childNodesIdx in node.childNodes){var childNode=node.childNodes[childNodesIdx];if(!!childNode.raw)
childIsRuleNode=!!childNode.raw.isRuleNode;}
if(childIsRuleNode){if(!!layerInfo.params&&layerInfo.params.rule!=null){return;}}
node.eachChild(recursive);}
if(option.doParent){recursive(node.parentNode);}}
var isRadio=layerInfo.parent!=null&&layerInfo.parent.radio!=null;if(checked&&isRadio){var brothers=node.parentNode.childNodes;for(var idx in brothers){if(node!=brothers[idx]){var brother=brothers[idx];if(brother.get("checked")!=null){brother.set("checked",false);me.changeViewCheckbox2Radio(brother);onCheckChange(brother,false);}}}}}}};var isRadio=typeof node.raw.radio!="undefined"&&node.raw.radio!=null;if(isRadio){me.changeViewCheckbox2Radio(node);if(checked==false){node.set("checked",true);me.changeViewCheckbox2Radio(node);return;}}
onCheckChange(node,checked,{doChildren:true});if(checked==true){onCheckChange(node,checked,{doParent:true});}
var refreshLayerInfos=[node.raw.layerInfo];while(0<refreshLayerInfos.length){var layerInfo=refreshLayerInfos.pop();var layer=layerInfo.getLayer();if(!layer){for(var idx in layerInfo.children){refreshLayerInfos.push(layerInfo.children[idx]);}}
else{if(typeof layer.refreshParams=="function"){layer.refreshParams();}
else{layer.setVisibility(checked);}}}
map.events.triggerEvent("legendcheckchange");},afteritemexpand:function(node,index,item,eOpts){me.changeViewCheckbox2Radio(node);},itemexpand:function(node,eOpts){me.onChangeExpanded(node,eOpts);},itemcollapse:function(node,eOpts){me.onChangeExpanded(node,eOpts);},itemcontextmenu:function(view,record,htmlItem,index,e,eOpts){var layerInfo=record.raw.layerInfo;if(typeof layerInfo!="undefined"){var contextmenu=map.components.contextmenu;if(typeof contextmenu!="undefined"){e.stopEvent();var option={tree:tree,record:record,layerInfo:layerInfo,addContentsMenu:true,addContentsMenuLayerInfos:[layerInfo],deleteLayerMenu:layerInfo.isDeletableSessionExternalMapLayer(),transparencyLayerMenu:SaigaiTask.Map.Layer.Type.isOverlayLayerType(layerInfo.type)||[SaigaiTask.Map.Layer.Type.REFERENCE,SaigaiTask.Map.Layer.Type.REFERENCE_WMS,SaigaiTask.Map.Layer.Type.EXTERNAL_MAP_WMS,SaigaiTask.Map.Layer.Type.EXTERNAL_MAP_WMS_LAYERS,SaigaiTask.Map.Layer.Type.EXTERNAL_MAP_XYZ].includes(layerInfo.type)};contextmenu.showMenu(e.xy[0],e.xy[1],option);}}}}});me.tree=tree;map.events.triggerEvent("legendinitialize",{legend:me});},addTbarItems:function(items){var me=this;if(!!me.fbar){me.fbar.add(items);}
else{bar=me.fbar=Ext.create('Ext.toolbar.Toolbar',{items:items,dock:"bottom"});me.tree.addDocked(bar);}},onChangeExpanded:function(node,eOpts){var me=this;var map=me.map;me.changeViewCheckbox2Radio(node);var expanded=node.isExpanded();var layerInfo=node.raw.layerInfo;layerInfo.expanded=expanded;map.events.triggerEvent("legenditemexpanded");},createTreeNode:function(parentNode,layerInfo){var me=this;var map=me.map;var ecommap=layerInfo.ecommap;var excludesLayerIds=map.excludesLayerIdsFromLegendWindow;if($.inArray(layerInfo.layerId,excludesLayerIds)!=-1){return null;}
if(ecommap!=null){var excludesLayerTypes=SaigaiTask.Map.Layer.Type.getBaseLayerTypes();if($.inArray(layerInfo.type,excludesLayerTypes)!=-1){return null;}}
var nodeConfig={};nodeConfig.expanded=layerInfo.expanded;nodeConfig.text=layerInfo.name;if(!!layerInfo.loaderror)nodeConfig.text=lang.__("[Read error]")+nodeConfig.text;nodeConfig.layerInfo=layerInfo;if(0<layerInfo.children.length){nodeConfig.checked=layerInfo.visibility;nodeConfig.children=[];var node=parentNode.createNode(nodeConfig);node.raw=nodeConfig;if(ecommap!=null){var legendUrl=ecommap.ecommapURL+'/legend?WIDTH=44&HEIGHT=32&cid='+ecommap.mapInfo.communityId+'&mid='+ecommap.mapInfo.mapId+'&layer='+layerInfo.layerId+'&SCALE=1000';var img=new Image();img.onload=function(){node.insertChild(0,node.createNode({icon:legendUrl,leaf:true}));}
img.src=legendUrl;}
for(var childLayerInfosKey in layerInfo.children){var childLayerInfo=layerInfo.children[childLayerInfosKey];var childNode=this.createTreeNode(node,childLayerInfo);if(childNode!=null){node.appendChild(childNode);}}
return node;}
else{if(layerInfo.type!=SaigaiTask.Map.Layer.Type.LOCAL_GROUP){nodeConfig.iconCls='no-icon';nodeConfig.checked=layerInfo.visibility;if(layerInfo.parent!=null){if(layerInfo.parent.radio!=null){nodeConfig.radio=layerInfo.parent.radio;nodeConfig.id=layerInfo.layerId;}}
var node=parentNode.createNode(nodeConfig);node.raw=nodeConfig;if(nodeConfig.radio!=null){node.existOnBrother=function(){var existOnBrother=false;for(var idx in parentNode.childNodes){if(parentNode.childNodes[idx])
var brother=parentNode.childNodes[idx];if(brother.get("checked")==true){existOnBrother=true;break;}}
return existOnBrother;}
if(node.existOnBrother()){node.set("checked",false);layerInfo.visibility=false;layerInfo.searchable=false;var layer=layerInfo.getLayer();layer.refreshParams();}}
if(ecommap!=null){if(layerInfo.type==SaigaiTask.Map.Layer.Type.LOCAL&&!!layerInfo.legendrules&&2<=layerInfo.legendrules.length){var iconHeight=32;for(var legendrulesIdx in layerInfo.legendrules){var rule=layerInfo.legendrules[legendrulesIdx];var ruleNodeConfig={cls:"legendpanel-legendrule-node",text:rule.title,checked:rule.visibility,icon:ecommap.ecommapURL+'/legend?WIDTH=44&HEIGHT='+iconHeight+'&cid='+ecommap.mapInfo.communityId+'&mid='+ecommap.mapInfo.mapId+'&layer='+layerInfo.layerId+'&SCALE=1000&'+new Date().getTime()+"&rule="+layerInfo.layerId+":"+rule.ruleId,leaf:true};ruleNodeConfig.layerInfo=layerInfo;ruleNodeConfig.isRuleNode=true;ruleNodeConfig.rule=rule;var ruleNode=node.createNode(ruleNodeConfig);ruleNode.raw=ruleNodeConfig;rule.node=ruleNode;node.insertChild(legendrulesIdx,ruleNode);}}
else if(layerInfo.type==SaigaiTask.Map.Layer.Type.LOCAL||layerInfo.type==SaigaiTask.Map.Layer.Type.REFERENCE){node.insertChild(0,node.createNode({icon:ecommap.ecommapURL+'/legend?WIDTH=44&HEIGHT=32&cid='+ecommap.mapInfo.communityId+'&mid='+ecommap.mapInfo.mapId+'&layer='+layerInfo.layerId+'&SCALE=1000&'+new Date().getTime(),leaf:true}));}
else if(layerInfo.type==SaigaiTask.Map.Layer.Type.EXTERNAL_MAP_WMS_LAYERS){var url=layerInfo.wmsLegendURL;if(!url&&layerInfo.parent){url=layerInfo.parent.wmsLegendURL;if(0<url.length)url+='&REQUEST=GetLegendGraphic&VERSION=1.0.0&FORMAT=image/png&WIDTH=44&HEIGHT=32&layer='+layerInfo.featuretypeId+'&'+new Date().getTime();}
if(!!url&&0<url.length){if(layerInfo.wmsproxy!=null){if(layerInfo.wmsproxy!=0&&url.indexOf("http")==0){var page_url=SaigaiTask.PageURL.getUrl();url=page_url.substr(0,page_url.indexOf("/page/")+6)+"map/externalWmsAuth/?url="+encodeURIComponent(url)+"&externalmapdatainfoid="+layerInfo.wmsproxy+"&metadataid="+layerInfo.metadataid;}}
node.insertChild(0,node.createNode({icon:url,leaf:true}));}}
else if(layerInfo.type==SaigaiTask.Map.Layer.Type.EXTERNAL_MAP_ARCGIS_LAYERS){var url=layerInfo.wmsLegendURL;if(!url&&layerInfo.parent)
url=layerInfo.parent.wmsLegendURL;if(url){$.ajax({url:url+"&f=json",dataType:"json",data:this.param,type:"POST",contentType:"application/x-www-form-urlencoded; charset=UTF-8",success:function(data,dataType){var legendURL="";if('layers'in data){var j_layers=data.layers;for(var i=0;i<j_layers.length;i++){if("legend"in j_layers[i]){for(var j=0;j<j_layers[i].legend.length;j++){if("imageData"in j_layers[i].legend[j]){node.insertChild(0,node.createNode({icon:"data:image/png;base64,"+j_layers[i].legend[j].imageData,text:j_layers[i].legend[j].label,leaf:true}));}}}}}},error:function(XMLHttpRequest,textStatus,errorThrown){console.log("ArcGIS Legend ImageData error");}});}}
else{console.log("LegendPanel is Else");node.leaf=true;}}}
return node;}
return null;},changeViewCheckbox2Radio:function(node){var me=this;if(!!node.raw&&node.raw.radio!=null){view=me.tree.getView()
var elm=Ext.get(view.getNode(node));if(elm!=null){elm.select(".x-tree-checkbox").addCls("x-tree-radio");}}
if(node.childNodes!=null){for(var idx in node.childNodes){var child=node.childNodes[idx];me.changeViewCheckbox2Radio(child);}}}};SaigaiTask.Map.view.ListPopup=new OpenLayers.Class(SaigaiTask.Map.view.Popup,{stmap:null,initialize:function(stmap){this.stmap=stmap;},show:function(center,bbox,result,pinned){var me=this;var stmap=me.stmap;var count=result[0][0];var rows=result[1];var dataMapList=new Array();var layerInfoCache={};for(var idx=0;idx<rows.length;idx++){var layerId=rows[idx][0];var featureId=rows[idx][1];var geom=rows[idx][2];var firstAttr=rows[idx][3][0];var dataMap=new Array();var layerInfo=layerInfoCache[layerId];if(layerInfo==null){layerInfo=stmap.getLayerInfo(layerId);layerInfoCache[layerId]=layerInfo;}
dataMap[lang.__('Layer name')]=layerInfo.name;var firstAttrInfo=layerInfo.getAttrInfo(firstAttr[0]);dataMap[lang.__('Name')]=(firstAttrInfo!=null?firstAttrInfo.name+": "+firstAttr[2]:"name attr exists");dataMap[lang.__('Distance')]=geom[2];dataMap[lang.__('Layer ID')]=layerId;dataMap[lang.__('Feature ID')]=featureId;dataMapList.push(dataMap);}
var createDataSet=function(dataMapList){if(!dataMapList||dataMapList.length==0)return null;var fields=new Array();for(var key in dataMapList[0]){fields.push(key);}
var values=new Array();for(var idx=0;idx<dataMapList.length;idx++){var dataMap=dataMapList[idx];var value=new Array();for(var fieldsIdx in fields){var key=fields[fieldsIdx];var data=dataMap[key];value.push(data);}
values.push(value);}
return{fields:fields,values:values};};var dataset=createDataSet(dataMapList);console.log('dataset');console.log(dataset);var createDataStore=function(dataset){var fields=new Array();for(var idx=0;idx<dataset.fields.length;idx++){var name=dataset.fields[idx];var field={name:name};fields.push(field);}
var data=dataset.values;var store=Ext.create("Ext.data.ArrayStore",{fields:fields,data:data});return store;};var store=createDataStore(dataset);var createGridPanel=function(option){var columns=new Array();for(var idx=0;idx<dataset.fields.length;idx++){var name=dataset.fields[idx];var column={text:name,dataIndex:name,flex:1};if(name==lang.__('Distance')){column['renderer']=Ext.util.Format.numberRenderer('0m');column['flex']=null;column['fixed']=true;column['width']=60;}
if(name==lang.__('Feature ID')||name==lang.__('Layer ID')){column['hidden']=true;}
columns.push(column);}
console.log('columns');console.log(columns);var grid=Ext.create('Ext.grid.Panel',{store:option.store,stateful:true,collapsible:false,multiSelect:false,header:false,width:250,frame:false,stateId:'stateGrid',columns:columns,viewConfig:{stripeRows:true,enableTextSelection:true}});return grid;};var option={store:store};var grid=createGridPanel(option);var self=this;var onItemClick=function(view,record,item,index,e,eOpts){if(stmap.popupManager!=null){stmap.popupManager.close(me.popup);}
var layerId=record.data[lang.__('Layer ID')];var fid=record.data[lang.__('Feature ID')];stmap.getContent(layerId,fid,center,bbox,{fromList:true,pinned:me.popup.pinned});return false;};grid.addListener('itemclick',onItemClick);if(stmap.popupManager!=null){stmap.popupManager.closeAll();}
var items=[grid];me.showExtPopup({title:count+lang.__("Items"),map:stmap,olmap:stmap.map,center:center,panelWidth:grid.width,pinned:pinned,items:items});}});SaigaiTask.Map.view.ContentsFormWindow=function(){this.initialize.apply(this,arguments);};SaigaiTask.Map.view.ContentsFormWindow.prototype={stmap:null,window:null,contentsFormPanel:null,drawToolbar:null,measure:null,initialize:function(option){var me=this;var stmap=option.stmap;var layerInfo=option.layerInfo;var fid=typeof option.fid!="undefined"?option.fid:null;var feature=typeof option.feature!="undefined"?option.feature:null;var content=typeof option.content!="undefined"?option.content:null;var lonlat=option.lonlat;var drawGeometryOnly=!!option.drawGeometryOnly;if(stmap.components.contentsFormWindow!=null){stmap.components.contentsFormWindow.window.close();}
stmap.components.contentsFormWindow=me;var tbar=null;var dockedItems=[];var geomType=layerInfo.geomType;var isMulti=geomType.indexOf("MULTI")==0;var isPoint=geomType.match(/POINT$/)!=null;var isPolygon=geomType.match(/POLYGON$/)!=null;var isLinestring=geomType.match(/LINESTRING$/)!=null;var pseudo=isPolygon;var drawToolbar=me.drawToolbar=new SaigaiTask.Map.view.DrawToolbar(stmap,{init:false,geomType:geomType,renderTo:Ext.getBody(),drawPoint:isPoint||isPolygon,drawPolygon:isPolygon,drawCircle:isPolygon,drawLine:isLinestring||isPolygon,modifyFeature:isPoint==false,dragFeature:true,removeFeature:true,intersectLayerId:layerInfo.intersectionlayerid,intersectLayerName:layerInfo.intersectionlayername,maxDrawNum:(isMulti?Number.MAX_VALUE:1)});if(isPolygon){var split=function(tbarItems){var array=[];var items=[];for(var idx in tbarItems){var item=tbarItems[idx];if(item=="-"){if(0<items.length){array.push({xtype:"toolbar",dock:"top",items:items});}
items=[];}
else{items.push(item);}}
return array;}
var tbarItems=drawToolbar.tbarItems;dockedItems=dockedItems.concat(split(tbarItems));}
else{tbar=drawToolbar.getSimpleToolbar();}
var drawLayer=drawToolbar.drawLayer;drawLayer.layer.setVisibility(true);if(feature!=null){if(pseudo){var geometry=feature.geometry;var isMulti=geometry.CLASS_NAME.match(/^OpenLayers.Geometry.Multi/)!=null;var geoms=isMulti?geometry.components:[geometry];for(var idx in geoms){var geom=geoms[idx];orgGeom=drawToolbar.convertPseudoGeometry(geomType,geom);drawLayer.drawFeatureByGeometry(orgGeom!=null?orgGeom:geom);}}
else{drawLayer.drawFeatureByGeometry(feature.geometry);}}
else{if(isPoint){if(feature!=null){var point=feature.geometry.getCentroid().transform(new OpenLayers.Projection("EPSG:4326"),stmap.map.getProjectionObject());lonlat=new OpenLayers.LonLat(point.x,point.y);}
if(lonlat==null){lonlat=stmap.map.getCenter();}
var ret=drawLayer.moveSinglePoint(lonlat);drawLayer.setDragFeatureControlActivation(true);feature=ret.feature;}}
var layerId=layerInfo.layerId;var contentsFormPanel=me.contentsFormPanel=new SaigaiTask.Map.view.ContentsFormPanel(stmap,layerId,feature,fid,content);var formPanel=contentsFormPanel.formPanel;var layerName=contentsFormPanel.json.layerInfo.layerName;var win=null;win=me.window=Ext.create('Ext.window.Window',{title:layerName+' '+lang.__('Registration form'),width:300,maxWidth:document.body.clientWidth,maxHeight:document.body.clientHeight,collapsible:true,tbar:tbar,dockedItems:dockedItems,layout:'fit',items:drawGeometryOnly?null:formPanel,buttons:[{text:lang.__('Registration'),textAlign:"left",icon:stmap.icon.getURL("editIconURL"),handler:function(){var form=formPanel.form;if(form.isValid()){try{drawLayer.deactivateCurrentDrawControl();var feature=drawToolbar.getDrawFeature(geomType,{pseudo:pseudo});if(confirm(lang.__('Are you sure to register?<!--2-->'))){if(drawGeometryOnly){var wkt=stmap.getWKT(feature);if(fid==0||fid==null){parent.$('body').trigger('onsavegeom',[wkt]);}else{parent.$('body').trigger('oneditgeom',[wkt]);}}
else{var wkt=stmap.getWKT(feature);contentsFormPanel.submit({wkt:wkt==null?"":wkt});win.close();}}}catch(e){console.error(e);if(e=="Invalid Geometry"){alert(lang.__("You can not register this shape. \n shape might be overlapped"));}
else{alert(e);}}}
else{alert(lang.__("Input data not appropriate."));}}},{text:lang.__('Cancel'),handler:function(){win.close();}}],listeners:{destroy:function(){drawLayer.destroy();}}});formPanel.addListener("clickaddressbtn",function(args){var btn=args.addressBtn;var field=args.textField;var features=drawToolbar.drawLayer.layer.features;if(0<features.length){var feature=features[0];var center=feature.geometry.getCentroid();center=center.transform(stmap.map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326"));stmap.geocode(center).done(function(results){var result=results[0];var address=stmap.getFormattedAddress(result);field.setValue(address);});}});win.show();win.alignTo(document,"tr",[-win.getWidth(),0]);var measure=me.measure=new SaigaiTask.Map.view.Measure(stmap);measure.stopMeasure();}};SaigaiTask.Map.view.HeaderToolbar=function(){this.initialize.apply(this,arguments);};SaigaiTask.Map.view.HeaderToolbar.prototype={map:null,tbar:null,measure:null,baselayerCombo:null,initialize:function(map){var me=this;me.map=map;var headerTbarItems=[];var headerTbar=Ext.create("Ext.toolbar.Toolbar",{items:headerTbarItems});me.tbar=headerTbar;me.updateBaselayerCombo();map.events.register("loadendecommap",map,function(){me.updateBaselayerCombo();});},updateBaselayerCombo:function(){var me=this;var map=me.map;var baseLayers=[];for(var ecommapsIdx in map.ecommaps){var ecommap=map.ecommaps[ecommapsIdx];baseLayers=baseLayers.concat(ecommap.getBaseLayerInfos());}
var store=null;if(me.baselayerCombo==null){var store=Ext.create('Ext.data.Store',{fields:['layerId','name'],data:baseLayers});}
else{store=me.baselayerCombo.getStore();store.removeAll();store.add(baseLayers);}
var value=null;for(idx in baseLayers){var baseLayer=baseLayers[idx];if(baseLayer.visibility){value=baseLayer.layerId;break;}}
var baselayerCombo=null;if(me.baselayerCombo==null){baselayerCombo=me.baselayerCombo=Ext.create('Ext.form.ComboBox',{store:store,queryMode:'local',displayField:'name',valueField:'layerId',value:value,listeners:{change:function(combo,newValue,oldValue,eOpts){map.setBaseLayerById(newValue);}}});me.tbar.add(baselayerCombo);}
else{me.baselayerCombo.setValue(value);}
map.setBaseLayerById(value);me.baselayerCombo=baselayerCombo;me.tbar.add(baselayerCombo);}};SaigaiTask.Map.control.MousePosition60=OpenLayers.Class(OpenLayers.Control.MousePosition,{initialize:function(options){OpenLayers.Util.extend(options,{"displayClass":"olControlMousePosition"})
OpenLayers.Control.MousePosition.prototype.initialize.apply(this,[options]);},formatOutput:function(lonLat){var digits=parseInt(this.numDigits);var dx=lonLat.lon;var hx=parseInt(dx);var mx=parseInt((dx-hx)*60);var sx=((dx-hx)*60-mx)*60;var dy=lonLat.lat;var hy=parseInt(dy);var my=parseInt((dy-hy)*60);var sy=((dy-hy)*60-my)*60;var newHtml=this.prefix+
hx+"°"+mx+"'"+sx.toFixed(1)+
this.separator+
hy+"°"+my+"'"+sy.toFixed(1)+
this.suffix;return newHtml;},CLASS_NAME:"SaigaiTask.Map.control.MousePosition60"});SaigaiTask.Map.Layer.KMLLayer=new OpenLayers.Class(OpenLayers.Layer.Vector,{stmap:null,layerInfo:null,kmlFormat:null,kmlSelectControl:null,reloadSec:0,reloadTimerId:null,initialize:function(layerInfo){var me=this;me.layerInfo=layerInfo;var ecommapInfo=layerInfo.ecommap;var stmap=me.stmap=ecommapInfo.stmap;me.kmlSelectControl=stmap.controls["kmlSelectControl"];var options={visibility:layerInfo.visibility,attribution:layerInfo.attribution};var wgs84=new OpenLayers.Projection("EPSG:4326");var internalProjection=wgs84;if(!!stmap.epsg)internalProjection=new OpenLayers.Projection("EPSG:"+stmap.epsg);me.kmlFormat=new OpenLayers.Format.KMLStyle({extractStyles:true,internalProjection:internalProjection});OpenLayers.Layer.Vector.prototype.initialize.apply(this,[layerInfo.name,options]);var layerInfo=me.layerInfo;if(layerInfo.reload!=null){try{var reloadJson=JSON.parse(layerInfo.reload);if($.isNumeric(reloadJson.sec)){me.reloadSec=reloadJson.sec;}}catch(e){logger.warn(e);}}
if(me.visibility){me.loadKMLFeature({data:{reload:true}});}
me.events.on({"visibilitychanged":function(){if(me.getVisibility()){me.loadKMLFeature({data:{reload:true}});}},"featureselected":function(e){me.kmlPopup=new SaigaiTask.Map.view.KMLPopup(me.stmap);me.kmlPopup.show(e.feature,layerInfo);me.kmlSelectControl.unselectAll();}});layerInfo.layer=this;me.stmap.map.addLayer(me);if(layerInfo.searchable){var layers=[me].concat(me.kmlSelectControl.layers);me.kmlSelectControl.setLayer(layers)
if(!me.kmlSelectControl.active)me.kmlSelectControl.activate();}},loadKMLFeature:function(option){var me=this;var kmlLayer=me;var data={url:me.layerInfo.wfsURL};if(0<me.reloadSec){data.reloadSec=me.reloadSec;}
if(!!option){if(!!option.data){$.extend(data,option.data);}}
jQuery.ajax({url:SaigaiTask.contextPath+"/page/map/kml/",async:true,dataType:"text",data:data,cache:false}).done(function(data){if(data){var features=me.kmlFormat.read(data);kmlLayer.removeAllFeatures();kmlLayer.addFeatures(features);for(var i=0;i<features.length;i++){var feature=features[i];var style=feature.style;if(!!style){style.cursor="pointer";if(style.fontColor){style.label=feature.attributes.name;style.fontWeight="bold";style.labelAlign="lt";}}}
kmlLayer.redraw();}}).fail(function(xhr,textStatus,errorThrown){alert(lang.__("Failed to get {0}",me.name));}).complete(function(xhr,textStatus){if(me.reloadTimerId==null){if(me.reloadSec>0){me.reloadTimerId=setTimeout(function(){me.reloadTimerId=null;if(me.visibility)me.loadKMLFeature();},me.reloadSec*1000);}}});},openKMLPopup:function(feature,layerInfo){var me=this;var stmap=me.stmap;if(stmap.popupManager!=null){stmap.popupManager.closeAll();}
try{var self=this;var lonlat=feature.geometry.getBounds().getCenterLonLat().clone();if(me.stmap.epsg!=4326)lonlat.transform(me.stmap.map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326"));var popupDiv=document.createElement('div');var div,span;div=document.createElement('div');div.className="popup_attr";if(feature.attributes.description){div.innerHTML=(feature.attributes.name?"<h3>"+SaigaiTask.Map.util.CommonUtil.escapeXml(feature.attributes.name)+"</h3>":"")
+feature.attributes.description.replace(/<\s*a\s+/ig,'<a target="_blank" ').replace(/onclick\s*=\s*"[^"]*"/ig,'');}else if(feature.attributes.name){div.innerHTML="<h3>"+SaigaiTask.Map.util.CommonUtil.escapeXml(feature.attributes.name)+"</h3>";}
try{var tbody=null;var td;for(var key in feature.attributes){if(key!="name"&&key!="description"&&key!="styleUrl"){if(feature.attributes[key].value){if(!tbody)tbody=document.createElement('tbody');var attrTr=document.createElement('tr');td=document.createElement('td');attrTr.appendChild(td);td.innerHTML=key;td=document.createElement('td');td.innerHTML=feature.attributes[key].value;attrTr.appendChild(td);tbody.appendChild(attrTr);}}}
if(tbody){table=document.createElement('table');table.cellSpacing=0;table.cellPadding=0;table.appendChild(tbody);div.appendChild(table);}}catch(e){}
popupDiv.appendChild(div);var panel=Ext.create('Ext.panel.Panel',{width:200,contentEl:popupDiv});var option={map:me.stmap,olmap:me.stmap.map,center:lonlat,items:[panel],title:layerInfo.name,pinned:false};var popup=SaigaiTask.Map.view.Popup.showExtPopup(option);}catch(e){console.error(e);}},CLASS_NAME:"SaigaiTask.Map.Layer.KMLLayer"});SaigaiTask.Map.Layer.KMLLayer.type=SaigaiTask.Map.Layer.Type.KML;OpenLayers.Layer.Google.v3.setGMapVisibility=function(visible){var cache=OpenLayers.Layer.Google.cache[this.map.id];var map=this.map;if(cache){var type=this.type;var layers=map.layers;var layer;for(var i=layers.length-1;i>=0;--i){layer=layers[i];if(layer instanceof OpenLayers.Layer.Google&&layer.visibility===true&&layer.inRange===true){type=layer.type;visible=true;break;}}
var container=this.mapObject.getDiv();if(visible===true){if(container.parentNode!==map.div){if(!cache.rendered){var me=this;google.maps.event.addListenerOnce(this.mapObject,'tilesloaded',function(){cache.rendered=true;me.setGMapVisibility(me.getVisibility());me.moveTo(me.map.getCenter());cache.googleControl.appendChild(map.viewPortDiv);});}else{cache.googleControl.appendChild(map.viewPortDiv);}
map.div.appendChild(container);google.maps.event.trigger(this.mapObject,'resize');}
this.mapObject.setMapTypeId(type);}else if(cache.googleControl.hasChildNodes()){map.div.appendChild(map.viewPortDiv);map.div.removeChild(container);}}};SaigaiTask.Map.control.SyncControl=new OpenLayers.Class(OpenLayers.Control,{stmap:null,syncCenter:true,syncZoom:true,group:null,state:null,initialize:function(stmap){var me=this;me.stmap=stmap;me.group=[stmap];me.state={moving:false};var olmap=stmap.map;olmap.events.on({"move":function(){me.moveEnd();},"zoomend":function(){me.zoomEnd();}});OpenLayers.Control.prototype.initialize.apply(this,[]);},mergeGroup:function(syncControl){var me=this;var concatGroup=me.group.concat(syncControl.group);me.group=syncControl.group=concatGroup;syncControl.state=me.state;},removeGroup:function(syncControl){var me=this;me.group=jQuery.grep(me.group,function(value){return value!=syncControl.stmap;});},moveEnd:function(){var me=this;var state=me.state;if(me.active&&state.moving==false){state.moving=true;var group=me.group;for(var idx in group){var stmap=group[idx];if(me.stmap==stmap)continue;var center=me.stmap.getCenter();stmap.setCenter(center);}
state.moving=false;}},zoomEnd:function(){var me=this;var state=me.state;if(me.active&&state.moving==false){state.moving=true;var group=me.group;for(var idx in group){var stmap=group[idx];if(me.stmap==stmap)continue;var center=me.stmap.getCenter();var zoom=me.stmap.map.getZoom();stmap.setCenter(center,zoom);}
state.moving=false;}}});SaigaiTask.Map.Layer.PdfRangeLayer=new OpenLayers.Class(OpenLayers.Layer.Vector,{printPreviewWindow:null,pdfRangeLayer:null,printFeature:null,paperRate:{'a':0.7073171,'b':0.7074176},printRangeNodeLayer:null,printRangeNode:null,printRangeNodeMaker:[],dragNodeMarker:null,dragImageNodeMarker:null,dragEvent:"",resizeOrigin:null,initialize:function(printPreviewWindow){var me=this,self=this,layer=this;me.printPreviewWindow=printPreviewWindow;},initLayer:function(){var me=this,self=this,layer=this;var printPreviewWindow=me.printPreviewWindow;var stmap=printPreviewWindow.stmap;var map=stmap.map;if(!self.pdfRangeLayer){me.pdfRangeLayer=this;var name="PdfRangeLayer";OpenLayers.Layer.Vector.prototype.initialize.apply(this,[name]);me.displayInLayerSwitcher=false;map.addLayer(layer);layer.styleMap.styles['default']=new OpenLayers.Style({fillColor:"#FFFFFF",fillOpacity:0.25,strokeColor:"#FF0000",strokeOpacity:1,strokeWidth:1});}
if(!this.printRangeNodeLayer){this.printRangeNodeLayer=new OpenLayers.Layer.Markers('rangeNode');this.printRangeNode=new OpenLayers.Icon(stmap.icon.getURL("pointnodeIconURL"),new OpenLayers.Size(9,9),new OpenLayers.Pixel(-5,-5));map.addLayer(self.printRangeNodeLayer);}
self.dragNodeMarker=new OpenLayers.Control.DragMarker(this.printRangeNodeLayer,{onStart:function(marker){self.nodeDragStart(marker,self.pdfRangeLayer);},onDrag:function(marker){self.nodeDrag(marker,self.pdfRangeLayer);},onComplete:function(marker){self.nodeDragComplete(marker,self.pdfRangeLayer);if(marker)marker.events.triggerEvent("mouseout");}});map.addControl(this.dragNodeMarker);this.dragNodeMarker.activate();self.dragImageNodeMarker=new OpenLayers.Control.DragMarker(this.printRangeNodeLayer,{onStart:function(marker){self.nodeDragStart(marker,self.imageRangeLayer);},onDrag:function(marker){self.nodeDrag(marker,self.imageRangeLayer);},onComplete:function(marker){self.nodeDragComplete(marker,self.imageRangeLayer);if(marker)marker.events.triggerEvent("mouseout");}});map.addControl(this.dragImageNodeMarker);this.dragImageNodeMarker.activate();},onHideDialog:function()
{this.pdfRangeLayer.setVisibility(false);this.printRangeNodeLayer.setVisibility(false);if(this.printFeature)this.pdfRangeLayer.removeFeatures([this.printFeature]);if(this.printFeatureInner!=null){for(var i=0;i<this.printFeatureInner.length;i++){this.pdfRangeLayer.removeFeatures([this.printFeatureInner[i]]);}}
this.printFeature=null;this.dragNodeMarker.deactivate();this.dragImageNodeMarker.deactivate();if(this.printRangeNodeMaker.length){this.printRangeNodeLayer.clearMarkers();}
this.printRangeNodeMarker=[];},showPrintRange:function(bbox){var me=this;me.initLayer();var map=this.map;try{if(!bbox)bbox=map.getExtent();if(this.printFeature)this.pdfRangeLayer.removeFeatures([this.printFeature]);var points=this.getPageRange(bbox).toGeometry().components[0].components;points[0]=points[0].clone();this.printFeature=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.LineString(points),null,{strokeColor:"#FF0000",strokeOpacity:0.7,strokeWidth:4,cursor:'pointer'});this.addFeatures([this.printFeature]);this.moveToFrontLayer(this.pdfRangeLayer);this.pdfRangeLayer.setVisibility(true);}catch(e){console.error(e);}},setPrintRangeNode:function(feature)
{var bounds=feature.geometry.getBounds();this.printRangeNodeLayer.clearMarkers();var lonLat={};var tag={}
lonLat.lon=bounds.left+((bounds.right-bounds.left)/2);lonLat.lat=bounds.top;tag={math:'y',pos:'t'};this.addPrintRangeNode(((this.dragEvent=="pdf")?this.dragNodeMarker:this.dragImageNodeMarker),feature,new OpenLayers.LonLat(lonLat.lon,lonLat.lat),this.printRangeNode.clone(),'n-resize',tag);lonLat.lon=bounds.left+((bounds.right-bounds.left)/2);lonLat.lat=bounds.bottom;tag={math:'y',pos:'b'};this.addPrintRangeNode(((this.dragEvent=="pdf")?this.dragNodeMarker:this.dragImageNodeMarker),feature,new OpenLayers.LonLat(lonLat.lon,lonLat.lat),this.printRangeNode.clone(),'s-resize',tag);lonLat.lon=bounds.left;lonLat.lat=bounds.top+((bounds.bottom-bounds.top)/2);tag={math:'x',pos:'l'};this.addPrintRangeNode(((this.dragEvent=="pdf")?this.dragNodeMarker:this.dragImageNodeMarker),feature,new OpenLayers.LonLat(lonLat.lon,lonLat.lat),this.printRangeNode.clone(),'w-resize',tag);lonLat.lon=bounds.right;lonLat.lat=bounds.top+((bounds.bottom-bounds.top)/2);tag={math:'x',pos:'r'};this.addPrintRangeNode(((this.dragEvent=="pdf")?this.dragNodeMarker:this.dragImageNodeMarker),feature,new OpenLayers.LonLat(lonLat.lon,lonLat.lat),this.printRangeNode.clone(),'e-resize',tag);lonLat.lon=bounds.left;lonLat.lat=bounds.top;tag={math:'y',pos:'tl'};this.addPrintRangeNode(((this.dragEvent=="pdf")?this.dragNodeMarker:this.dragImageNodeMarker),feature,new OpenLayers.LonLat(lonLat.lon,lonLat.lat),this.printRangeNode.clone(),'nw-resize',tag);lonLat.lon=bounds.right;lonLat.lat=bounds.top;tag={math:'y',pos:'tr'};this.addPrintRangeNode(((this.dragEvent=="pdf")?this.dragNodeMarker:this.dragImageNodeMarker),feature,new OpenLayers.LonLat(lonLat.lon,lonLat.lat),this.printRangeNode.clone(),'ne-resize',tag);lonLat.lon=bounds.left;lonLat.lat=bounds.bottom;tag={math:'y',pos:'bl'};this.addPrintRangeNode(((this.dragEvent=="pdf")?this.dragNodeMarker:this.dragImageNodeMarker),feature,new OpenLayers.LonLat(lonLat.lon,lonLat.lat),this.printRangeNode.clone(),'sw-resize',tag);lonLat.lon=bounds.right;lonLat.lat=bounds.bottom;tag={math:'y',pos:'br'};this.addPrintRangeNode(((this.dragEvent=="pdf")?this.dragNodeMarker:this.dragImageNodeMarker),feature,new OpenLayers.LonLat(lonLat.lon,lonLat.lat),this.printRangeNode.clone(),'se-resize',tag);this.moveToFrontLayer(this.printRangeNodeLayer);},addPrintRangeNode:function(control,feature,lonlat,icon,cursor,tag)
{icon.imageDiv.style.cursor=cursor;var marker=new OpenLayers.Marker(lonlat,icon);marker.linkid=feature.id;marker.tag=tag;this.printRangeNodeLayer.addMarker(marker);this.printRangeNodeMaker[this.printRangeNodeMaker.length]=marker;var self=this;if(control){marker.events.register("mouseover",marker,function(){control.overFeature(this);});marker.events.register("mouseout",marker,function(){control.outFeature(this);});}
marker.events.triggerEvent("mouseover");marker.events.triggerEvent("mouseout");},nodeDragStart:function(marker,layer)
{if(!marker)return;var feature=layer.getFeatureById(marker.linkid);try{this.resizeOrigin=null;var bounds=feature.geometry.getBounds();var x=0;var y=0;if(marker.tag.pos.indexOf("t")!=-1){y=bounds.bottom;}
else if(marker.tag.pos.indexOf("b")!=-1){y=bounds.top;}
else{y=((bounds.bottom-bounds.top)/2)+bounds.top;}
if(marker.tag.pos.indexOf("r")!=-1){x=bounds.left;}
else if(marker.tag.pos.indexOf("l")!=-1){x=bounds.right;}
else{x=((bounds.right-bounds.left)/2)+bounds.left;}
this.resizeOrigin=new OpenLayers.Geometry.Point(x,y);this.resizeOrigin.prevLon=marker.lonlat.lon;this.resizeOrigin.prevLat=marker.lonlat.lat;var markers=this.printRangeNodeLayer.markers;for(var i=markers.length-1;i>=0;i--){if(markers[i]!=marker){this.printRangeNodeLayer.removeMarker(markers[i]);}}}
catch(e){console.error(e);}},nodeDrag:function(marker,layer)
{if(this.resizeOrigin){var lonlat=marker.lonlat;var feature=layer.getFeatureById(marker.linkid);this.resizeFeature(feature,this.resizeOrigin,lonlat,layer,marker.tag);}},nodeDragComplete:function(marker,layer)
{try{if(this.resizeOrigin){this.resizeOrigin=null;var feature=layer.getFeatureById(marker.linkid);this.setPrintRangeNode(((this.dragEvent=="pdf")?this.printFeature:this.imageRangeFeature));}}
catch(e){console.error(e);}},resizeFeature:function(feature,originGeometry,lonlat,layer,tag)
{try{var geometry=feature.geometry;var dx0=originGeometry.prevLon-originGeometry.x;var dy0=originGeometry.prevLat-originGeometry.y;var dx1=lonlat.lon-originGeometry.x;var dy1=lonlat.lat-originGeometry.y;originGeometry.prevLon=lonlat.lon;originGeometry.prevLat=lonlat.lat;var scale;if(tag.math=="y"){scale=dy1/dy0;}
else{scale=dx1/dx0;}
if(scale==0)return;var ratio=1;if(this.dragEvent!="pdf"){if(tag.pos.length==2){ratio=(dx1/dx0)/scale;}
else{if(tag.math=="y"){ratio=1/scale;}
else{var points=geometry.components;var bounds=feature.geometry.getBounds();var res=this.eMap.getResolution();points[0].y=bounds.bottom;points[1].y=bounds.top;points[2].y=bounds.top;points[3].y=bounds.bottom;points[4].y=bounds.bottom;if(tag.pos=="l"){bounds.left=lonlat.lon;points[0].x=bounds.left
points[1].x=bounds.left;points[2].x=bounds.right;points[3].x=bounds.right;points[4].x=bounds.left;}
else{bounds.right=lonlat.lon;points[0].x=bounds.left;points[1].x=bounds.left;points[2].x=bounds.right;points[3].x=bounds.right;points[4].x=bounds.left;}}}}
if(!(this.dragEvent!="pdf"&&(tag.pos=="l"||tag.pos=="r"))){geometry.resize(scale,originGeometry,ratio);}
layer.drawFeature(feature);}
catch(e){console.error(e);}},getPageRange:function(bbox)
{var me=this;var values=me.printPreviewWindow.getValues();var paperType=values.pagesize.substr(0,1);var cols=values.cols;var rows=values.rows;var yoko=values.rotate=="1";var pageWidth=this.paperRate[paperType];if(yoko)pageWidth=1/pageWidth;pageWidth=pageWidth*cols/rows;var w=bbox.getWidth();var h=bbox.getHeight();if(w/h<pageWidth){h=w/pageWidth;var ch=(bbox.top+bbox.bottom)/2;return new OpenLayers.Bounds(bbox.left,ch-h/2,bbox.right,ch+h/2);}else{w=h*pageWidth;var cw=(bbox.right+bbox.left)/2;return new OpenLayers.Bounds(cw-w/2,bbox.bottom,cw+w/2,bbox.top);}},showPdfRangeDialog:function()
{var self=this;var printPreviewWindow=this.printPreviewWindow;var map=printPreviewWindow.stmap.map;if(!this.pdfRangeDialog){var dialog=Ext.create('Ext.window.Window',{id:"pdfRangeDialog",title:lang.__('印刷範囲設定'),bodyStyle:{"padding":"5px","text-align":"center","background-Color":"white"},html:Ext.DomHelper.createHtml({tag:"div",children:[{tag:"div",html:'<span style="font-size:0.8em;white-space:nowrap;">'+
lang.__('赤い枠をドラッグすると出力範囲が移動し、<br>各ノードをドラッグすると出力範囲の変更が出来ます。')+'</span>'}]}),closeAction:"hide",buttonAlign:"center",buttons:[{text:lang.__('範囲設定終了'),handler:function(){dialog.hide();}}]});dialog.on("hide",function(){self._hidedPdfRangeDialog();});this.pdfRangeDialog=dialog;}
this.pdfRangeDialog.show();var x=-this.pdfRangeDialog.getWidth()/2;var y=-this.pdfRangeDialog.getHeight()/2;this.pdfRangeDialog.alignTo("map","c",[x,y]);this.dragEvent="pdf";this.moveControl=new OpenLayers.Control.DragFeature(this.pdfRangeLayer,{dragCallbacks:{down:function(e){self.moveFeatureStart(e);this.downFeature(e);},up:function(e){this.upFeature(e);self.moveFeatureEnd(e);}}});this.map.addControl(this.moveControl);this.moveControl.activate();this.setPrintRangeNode(this.printFeature);this.pdfRangeLayer.setVisibility(true);this.moveToFrontLayer(this.pdfRangeLayer);this.moveToFrontLayer(this.printRangeNodeLayer);this.pdfRangeLayer.setVisibility(true);this.printRangeNodeLayer.setVisibility(true);},moveFeatureStart:function(e){if(this.printRangeNodeMaker.length){this.printRangeNodeLayer.clearMarkers();}},moveFeatureEnd:function(e){this.setPrintRangeNode(this.printFeature);},moveImageFeatureStart:function(e){if(this.printRangeNodeMaker.length){this.printRangeNodeLayer.clearMarkers();}},moveImageFeatureEnd:function(e){this.setPrintRangeNode(this.imageRangeFeature);},_hidedPdfRangeDialog:function()
{var self=this;var printPreviewWindow=this.printPreviewWindow;var map=printPreviewWindow.stmap.map;printPreviewWindow.win.show();if(this.printRangeNodeMaker.length){this.printRangeNodeLayer.clearMarkers();}
this.moveControl.deactivate();printPreviewWindow.values.bbox=this.getBBOX();printPreviewWindow.showPreview();},getBBOX:function(){var bbox=null;if(!!this.printFeature){var bounds=this.printFeature.geometry.getBounds();var bbox=Math.min(bounds.left,bounds.right)+","+
Math.min(bounds.bottom,bounds.top)+","+
Math.max(bounds.left,bounds.right)+","+
Math.max(bounds.bottom,bounds.top);}
return bbox;},moveToFrontLayer:function(layer)
{var me=this,self=this;var printPreviewWindow=this.printPreviewWindow;var map=printPreviewWindow.stmap.map;map.setLayerIndex(layer,map.layers.length);map.resetLayersZIndex();},showRangeListDialog:function()
{var me=this,self=this,layer=this;var printPreviewWindow=me.printPreviewWindow;var stmap=printPreviewWindow.stmap;var map=stmap.map;if(!this.rangeListDialog){var types=Ext.data.Types;Ext.define('SaigaiTask.model.PdfRange',{extend:'Ext.data.Model',fields:[{name:'id',type:types.NUMBER},{name:'name',type:types.STRING},{name:'created',type:types.STRING},{name:'options',type:types.STRING},{name:'range',type:types.STRING},{name:'status',type:types.INT},{name:'user_id',type:types.NUMBER},{name:'user_name',type:types.STRING}]});var dialog=Ext.create('Ext.window.Window',{id:"rangeListDialog",title:lang.__("印刷設定読み込み"),width:420,height:300,layout:"fit",items:[{xtype:"grid",loadMask:true,emptyText:lang.__("保存された印刷設定はありません。"),store:{model:"SaigaiTask.model.PdfRange",autoLoad:true,proxy:{type:"ajax",url:SaigaiTask.contextPath+"/page/map/pdfRange/list",reader:{type:"json",root:"items"}}},overflowY:"auto",layout:"column",columns:[{text:lang.__("印刷設定名称"),dataIndex:"name",width:255},{text:lang.__("保存日時"),dataIndex:"created",width:150}]}],closeAction:"hide",buttonAlign:"left",buttons:[{icon:stmap.icon.getURL("folderOpenIconURL"),text:lang.__('印刷設定読み込み'),handler:function(){alert("実装中");dialog.hide();}},{xtype:"checkbox",boxLabel:lang.__('印刷範囲のみ')},{xtype:"tbfill"},{icon:stmap.icon.getURL("deleteIconURL"),text:lang.__('削除'),handler:function(){alert("実装中");}},{xtype:"tbfill"},{icon:stmap.icon.getURL("closeIconURL"),text:lang.__('閉じる'),handler:function(){alert("実装中");dialog.hide();}}],listeners:{hide:function(){printPreviewWindow.win.show();}}});this.rangeListDialog=dialog;this.rangeListDialog.show();var x=-dialog.getWidth()/2;var y=-dialog.getHeight()/2;this.rangeListDialog.alignTo("map","c",[x,y]);}else{this.rangeListDialog.show();this.onRangeListSelect();this.initRangeList();}
this.pdfDialog.domNode.style.display='none';},closeRangeListDialog:function()
{if(this.rangeListDialog)this.rangeListDialog.hide();this.pdfDialog.domNode.style.display='';},CLASS_NAME:"SaigaiTask.Map.Layer.PdfRangeLayer"});SaigaiTask.Map.view.SelectFeatureWindow=function(){this.initialize.apply(this,arguments);};SaigaiTask.Map.view.SelectFeatureWindow.prototype={stmap:null,window:null,grid:null,removeActionColumnItem:null,slimerButton:null,initialize:function(option){var me=this;var stmap=option.stmap;var featureData=option.featureData;var nameAttr=featureData.nameAttr;var fields=["nameAttr","layerId","featureId"];var store=Ext.create("Ext.data.ArrayStore",{fields:fields,data:[fields]});me.removeActionColumnItem={icon:stmap.icon.getURL("removeIconURL"),tooltip:lang.__("Cancel<!--4-->")};me.grid=Ext.create('Ext.grid.Panel',{store:store,stateful:true,collapsible:false,multiSelect:false,header:false,width:250,frame:false,stateId:'stateGrid',columns:[{text:lang.__("Name"),dataIndex:"nameAttr",flex:1},{xtype:"actioncolumn",width:30,items:[me.removeActionColumnItem],renderer:function(val,metadata,record){metadata.style='cursor: pointer;';return val;}}],viewConfig:{stripeRows:true,enableTextSelection:true}});store.removeAll();me.add(featureData);me.slimerButton=Ext.create("Ext.button.Button",{text:lang.__('Bulk change'),textAlign:"center"});me.window=Ext.create('Ext.window.Window',{title:lang.__('Hide select.<!--2-->'),width:300,maxWidth:document.body.clientWidth,maxHeight:document.body.clientHeight,collapsible:true,layout:'fit',items:me.grid,dockedItems:[{xtype:'toolbar',dock:'bottom',ui:'footer',layout:'fit',items:[me.slimerButton]}]});},add:function(featureData){var me=this;var grid=me.grid;var store=grid.getStore();store.add({"nameAttr":featureData.nameAttr[1]+":"+featureData.nameAttr[2],"layerId":featureData.layerId,"featureId":featureData.featureId});},remove:function(featureData){var me=this;var grid=me.grid;var store=grid.getStore();var index=store.findBy(function(record,id){var data=record.getData();if(data.layerId!=featureData.layerId)return false;if(data.featureId!=featureData.featureId)return false;return true;});if(index!=-1){store.removeAt(index);}},show:function(){var me=this;var win=me.window;win.show();win.alignTo(document,"tr",[-win.getWidth(),0]);}};SaigaiTask.Map.view.Measure=function(){this.initialize.apply(this,arguments);};SaigaiTask.Map.view.Measure.prototype={map:null,measure:null,DIST:null,AREA:null,CIRCLE:null,measureLayer:null,featureMode:"LINE",initdrawlayer:true,initialize:function(map){var me=this;me.map=map;distresult=0;arearesult=0;me.onEvent();},onEvent:function(){var me=this;if(typeof map.components.contentsFormWindow=="undefined"||map.components.contentsFormWindow==null||!(!!map.components.contentsFormWindow&&map.components.contentsFormWindow.drawToolbar.drawLayer.layer.visibility)){$(document).on('click','#measure_type_dist',function(){me.startMeasureDist();});$(document).on('click','#measure_type_area',function(){me.startMeasureArea();});$(document).on('click','#measure_type_people',function(){me.startMeasurePeople();});}
else{me.startMeasure();}},offEvent:function(){var me=this;$(document).off('click','#measure_type_dist');$(document).off('click','#measure_type_area');$(document).off('click','#measure_type_people');},startMeasureDist:function()
{var me=this;me.featureMode="DIST";me.initMeasureLayer();me.setPanelVisible('DIST');$("#measure_dist").attr('value',"0");$("#measure_dist_units").attr('value',"");me._startMeasure(false);},startMeasureArea:function()
{var me=this;if(me.featureMode!="PEOPLE"){me.initMeasureLayer();me._startMeasure(true);$("#measure_area").attr('value',"0");$("#measure_area_units").attr('value',"");}
me.featureMode="AREA";me.setPanelVisible('AREA');},startMeasurePeople:function()
{var me=this;if(me.featureMode!="AREA"){me.initMeasureLayer();me._startMeasure(true);$("#measure_people").attr('value',"0");$("#measure_house").attr('value',"0");}
me.featureMode="PEOPLE";me.setPanelVisible('PEOPLE');},startMeasure:function()
{$("#measure_dist_span").css('display',"");$("#measure_area_span").css('display',"");$("#measure_people_span").css('display',"")
$("#buttons").hide();this._startMeasure(true);},initMeasureLayer:function()
{if(this.measureLayer){this.measureLayer.removeAllFeatures(this.measureLayer.features);}else{this.measureLayer=new OpenLayers.Layer.Vector(lang.__("Measurement results"));}
this.map.map.addLayer(this.measureLayer);},stopMeasure:function()
{this._deactivateMeasure();if(this.measureLayer){this.map.map.removeLayer(this.measureLayer);this.measureLayer=null;distresult=0;arearesult=0;}
$('#measure').dialog('close');},setPanelVisible:function(type)
{var distDisplay=type=="DIST"?"block":"none";var areaDisplay=type=="AREA"?"block":"none";var peopleDisplay=type=="PEOPLE"?"block":"none";var controlDisplay=type?"block":"none";$("#measure_dist_span").css('display',distDisplay);$("#measure_area_span").css('display',areaDisplay);$("#measure_people_span").css('display',peopleDisplay);$("#measure_control_span").css('display',controlDisplay);},addCenterMeasure:function()
{var lonlat=this.map.map.getCenter();this._addMeasurePoint(lonlat.lon,lonlat.lat);},undoMeasurePoint:function()
{this._undoMeasurePoint();},_startMeasure:function(areadraw)
{var me=this;if(!me.DIST){var style=new OpenLayers.Style();style.addRules([new OpenLayers.Rule({symbolizer:{"Point":{pointRadius:4,graphicName:"square",fillColor:"#FFFFFF",fillOpacity:1,strokeWidth:1,strokeOpacity:1,strokeColor:"#333333"},"Line":{strokeWidth:3,strokeOpacity:1,strokeColor:"#FF0000",strokeDashstyle:"dash"},"Polygon":{strokeWidth:2,strokeOpacity:1,strokeColor:"#FF0000",fillColor:"#FFFFFF",fillOpacity:0.3}}})]);var measureOptions={handlerOptions:{style:"default",layerOptions:{styleMap:new OpenLayers.StyleMap({"default":style})},persist:true}};me.DIST=new OpenLayers.Control.Measure(OpenLayers.Handler.Path,measureOptions);me.DIST.geodesic=true;me.map.map.addControl(me.DIST);me.AREA=new OpenLayers.Control.Measure(OpenLayers.Handler.Polygon,measureOptions);me.AREA.geodesic=true;me.map.map.addControl(me.AREA);me.CIRCLE=new OpenLayers.Control.Measure(OpenLayers.Handler.RegularPolygon,{handlerOptions:{sides:40},eventListeners:{"deactivate":function(){if(!!stmap.popupManager){stmap.popupManager.closeAll();}}},callbacks:{"move":function(geometry){if(map.map.units!="m"){geometry=geometry.clone().transform(map.map.getProjectionObject(),new OpenLayers.Projection("EPSG:900913"));}
var area=geometry.getArea();var radius=0.565352*Math.sqrt(area);if(!!stmap.popupManager){stmap.popupManager.closeAll();}
var centroid=geometry.getCentroid();var center=new OpenLayers.LonLat(centroid.x,centroid.y).transform(stmap.map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326"));popup=new SaigaiTask.Map.view.Popup();var radiusText=parseInt(radius)+"m";if(10000<radius)radiusText=(radius/1000).toFixed(2)+"km";popup.showExtPopup({map:stmap,olmap:stmap.map,center:center,size:new OpenLayers.Size(150,10),title:radiusText});}}},measureOptions);me.CIRCLE.geodesic=true;me.map.map.addControl(me.CIRCLE);this.DIST.partialDelay=0;this.AREA.partialDelay=0;this.CIRCLE.partialDelay=0;}
var contentsFormWindow=map.components.contentsFormWindow;if(!!contentsFormWindow&&contentsFormWindow.drawToolbar.drawLayer.layer.visibility){var drawToolbar=contentsFormWindow.drawToolbar;var features=drawToolbar.drawLayer.drawFeatures;var linebtn,polygonbtn,circlebtn,modifybtn;for(i=0;i<drawToolbar.tbarItems.length;i++){if(drawToolbar.tbarItems[i].iconCls=="draw-line-icon")
linebtn=drawToolbar.tbarItems[i];if(drawToolbar.tbarItems[i].iconCls=="draw-polygon-icon")
polygonbtn=drawToolbar.tbarItems[i];if(drawToolbar.tbarItems[i].iconCls=="draw-circle-icon")
circlebtn=drawToolbar.tbarItems[i];}
var drawLayer=contentsFormWindow.drawToolbar.drawLayer;if(me.initdrawlayer){drawLayer.layer.events.on({"featureadded":function(evt){var distunit=$("#measure_dist_units").html()=='m';if(distunit){var dist=parseFloat($("#measure_dist").val());}else{var dist=parseFloat($("#measure_dist").val())*1000;}
var areaunit=$("#measure_area_units").html()=='m';if(areaunit){var area=parseFloat($("#measure_area").val());}else{var area=parseFloat($("#measure_area").val())*1000000;}
var peopleval=$("#measure_people").val();if(typeof peopleval=="undefined")var people=0;else{if(peopleval.indexOf(",")!=-1)var people=parseInt(peopleval.split(',').join('').trim());else var people=parseInt(peopleval);}
var houseval=$("#measure_house").val();if(typeof houseval=="undefined")var house=0;else{if(houseval.indexOf(",")!=-1)var house=parseInt(houseval.split(',').join('').trim());else var house=parseInt(houseval);}
if(linebtn.pressed){var line=Math.floor(me.DIST.getBestLength(features.line[features.line.length-1].geometry)[0]*1000)/1000.0;if(me.DIST.getBestLength(features.line[features.line.length-1].geometry)[1]=='km')
line*=1000;dist+=line;dist=dist.toPrecision(4);if(dist<1000){$("#measure_dist").attr('value',dist);$("#measure_dist_units").html('m');}else{$("#measure_dist").attr('value',dist/1000);$("#measure_dist_units").html('km');}}
else if(polygonbtn.pressed){var polygon=Math.floor(me.AREA.getBestArea(features.polygon[features.polygon.length-1].geometry)[0]*1000)/1000.0;if(me.AREA.getBestArea(features.polygon[features.polygon.length-1].geometry)[1]=='km')
polygon*=1000000;area=parseFloat(area);area+=polygon;var polygons=features.polygon[features.polygon.length-1].geometry.clone().transform(new OpenLayers.Projection("EPSG:"+map.epsg),new OpenLayers.Projection("EPSG:4326")).toString();var ajaxData=new GetDatas(SaigaiTask.contextPath+"/page/decisionsupport/JSON_WKTAreaPeople","wkts="+polygons,SaigaiTask.csrfToken);ajaxData.doAjax().done(function(data,statusText,jqXHR){if('people'in data){people+=data.people;}
if('house'in data){house+=data.house;}
$("#measure_people").attr('value',separateComma(people));$("#measure_house").attr('value',separateComma(house));}).fail(function(jqXHR,statusText,errorThrown){console.log("JSON_BBOXAreaPeople is error! StatusCode="+jqXHR.status);});}
else if(circlebtn.pressed){var circle=Math.floor(me.CIRCLE.getBestArea(features.circle[features.circle.length-1].geometry)[0]*1000)/1000.0;if(me.CIRCLE.getBestArea(features.circle[features.circle.length-1].geometry)[1]=='km')
circle*=1000000;area=parseFloat(area);area+=circle;var circles=features.circle[features.circle.length-1].geometry.clone().transform(new OpenLayers.Projection("EPSG:"+map.epsg),new OpenLayers.Projection("EPSG:4326")).toString();var ajaxData=new GetDatas(SaigaiTask.contextPath+"/page/decisionsupport/JSON_WKTAreaPeople","wkts="+circles,SaigaiTask.csrfToken);ajaxData.doAjax().done(function(data,statusText,jqXHR){if('people'in data){people+=data.people}
if('house'in data){house+=data.house;}
$("#measure_people").attr('value',separateComma(people));$("#measure_house").attr('value',separateComma(house));}).fail(function(jqXHR,statusText,errorThrown){console.log("JSON_BBOXAreaPeople is error! StatusCode="+jqXHR.status);});}
area=area.toPrecision(6);if(area<1000000){$("#measure_area").attr('value',area);$("#measure_area_units").html('m');}else{$("#measure_area").attr('value',area/1000000);$("#measure_area_units").html('km');}},"featureremoved":function(evt){dist=0;dist=dist.toPrecision(4);area=0;area=area.toPrecision(6);$("#measure_dist").attr('value',dist);$("#measure_area").attr('value',area);$("#measure_people").attr('value',"0");$("#measure_house").attr('value',"0");features.polygon=[];features.circle=[];features.line=[];},"featuremoved":function(evt){var people=0;var house=0;for(i=0;i<features.polygon.length;i++){var polygons=features.polygon[i].geometry.clone().transform(new OpenLayers.Projection("EPSG:"+map.epsg),new OpenLayers.Projection("EPSG:4326")).toString();var ajaxData=new GetDatas(SaigaiTask.contextPath+"/page/decisionsupport/JSON_WKTAreaPeople","wkts="+polygons,SaigaiTask.csrfToken);ajaxData.doAjax().done(function(data,statusText,jqXHR){if('people'in data){people+=data.people;}
if('house'in data){house+=data.house;}
$("#measure_people").attr('value',separateComma(people));$("#measure_house").attr('value',separateComma(house));}).fail(function(jqXHR,statusText,errorThrown){console.log("JSON_BBOXAreaPeople is error! StatusCode="+jqXHR.status);});}
for(i=0;i<features.circle.length;i++){var circles=features.circle[i].geometry.clone().transform(new OpenLayers.Projection("EPSG:"+map.epsg),new OpenLayers.Projection("EPSG:4326")).toString();var ajaxData=new GetDatas(SaigaiTask.contextPath+"/page/decisionsupport/JSON_WKTAreaPeople","wkts="+circles,SaigaiTask.csrfToken);ajaxData.doAjax().done(function(data,statusText,jqXHR){if('people'in data){people+=data.people;}
if('house'in data){house+=data.house;}
$("#measure_people").attr('value',separateComma(people));$("#measure_house").attr('value',separateComma(house));}).fail(function(jqXHR,statusText,errorThrown){console.log("JSON_BBOXAreaPeople is error! StatusCode="+jqXHR.status);});}},"featuremodified":function(evt){if(evt.feature.geometry.id.match("LineString")){dist=0;for(i=0;i<features.line.length;i++){var line=Math.floor(me.DIST.getBestLength(features.line[i].geometry)[0]*1000)/1000.0;if(me.DIST.getBestLength(features.line[i].geometry)[1]=='km')
line*=1000;dist=parseFloat(dist);dist+=line;dist=dist.toPrecision(4);if(dist<1000){$("#measure_dist").attr('value',dist);$("#measure_dist_units").html('m');}else{$("#measure_dist").attr('value',dist/1000);$("#measure_dist_units").html('km');}}}else if(evt.feature.geometry.id.match("Polygon")){area=0;for(i=0;i<features.polygon.length;i++){var polygon=Math.floor(me.AREA.getBestArea(features.polygon[i].geometry)[0]*1000)/1000.0;if(me.AREA.getBestArea(features.polygon[i].geometry)[1]=='km')
polygon*=1000000;area=parseFloat(area);area+=polygon;}
for(i=0;i<features.circle.length;i++){var circle=Math.floor(me.CIRCLE.getBestArea(features.circle[i].geometry)[0]*1000)/1000.0;if(me.CIRCLE.getBestArea(features.circle[i].geometry)[1]=='km')
circle*=1000000;area=parseFloat(area);area+=circle;}
area=area.toPrecision(6);if(area<1000000){$("#measure_area").attr('value',area);$("#measure_area_units").html('m');}else{$("#measure_area").attr('value',area/1000000);$("#measure_area_units").html('km');}
var people=0;var house=0;for(i=0;i<features.polygon.length;i++){var polygons=features.polygon[i].geometry.clone().transform(new OpenLayers.Projection("EPSG:"+map.epsg),new OpenLayers.Projection("EPSG:4326")).toString();var ajaxData=new GetDatas(SaigaiTask.contextPath+"/page/decisionsupport/JSON_WKTAreaPeople","wkts="+polygons,SaigaiTask.csrfToken);ajaxData.doAjax().done(function(data,statusText,jqXHR){if('people'in data){people+=data.people;}
if('house'in data){house+=data.house;}
$("#measure_people").attr('value',separateComma(people));$("#measure_house").attr('value',separateComma(house));}).fail(function(jqXHR,statusText,errorThrown){console.log("JSON_BBOXAreaPeople is error! StatusCode="+jqXHR.status);});}
for(i=0;i<features.circle.length;i++){var circles=features.circle[i].geometry.clone().transform(new OpenLayers.Projection("EPSG:"+map.epsg),new OpenLayers.Projection("EPSG:4326")).toString();var ajaxData=new GetDatas(SaigaiTask.contextPath+"/page/decisionsupport/JSON_WKTAreaPeople","wkts="+circles,SaigaiTask.csrfToken);ajaxData.doAjax().done(function(data,statusText,jqXHR){if('people'in data){people+=data.people;}
if('house'in data){house+=data.house;}
$("#measure_people").attr('value',separateComma(people));$("#measure_house").attr('value',separateComma(house));}).fail(function(jqXHR,statusText,errorThrown){console.log("JSON_BBOXAreaPeople is error! StatusCode="+jqXHR.status);});}}}});me.initdrawlayer=false;}}else{var control=areadraw?this.AREA:this.DIST;this._deactivateMeasure();var self=this;control.activate();control.events.on({"measurepartial":this.measureCallback,"measure":function(event){self.measureComplete(event);}});}},measureComplete:function(event)
{this.measureLayer.addFeatures([new OpenLayers.Feature.Vector(event.geometry)]);this._deactivateMeasure();var me=this;if(!event.geometry.toString().search('LINESTRING')){if($("#measure_dist_units").text()=='km'){if(event.units=='km'){distresult=Math.floor(event.measure*1000)/1000.0;}else{distresult=Math.floor(event.measure*1000)/1000.0*0.001;}
$("#measure_dist_units").html('km');}else{if(event.units=='km'){distresult=Math.floor(event.measure*1000)/1000.0*1000;}else{distresult=Math.floor(event.measure*1000)/1000.0;}
if(distresult<1000){$("#measure_dist_units").html('m');}else{distresult=distresult*0.001;$("#measure_dist_units").html('km');}}
distresult=distresult.toPrecision(4);$("#measure_dist").attr('value',distresult);}
if(!event.geometry.toString().search('POLYGON')){if(me.featureMode=="AREA"||me.featureMode=="PEOPLE"){var polygons=event.geometry.transform(new OpenLayers.Projection("EPSG:"+map.epsg),new OpenLayers.Projection("EPSG:4326")).toString();var ajaxData=new GetDatas(SaigaiTask.contextPath+"/page/decisionsupport/JSON_WKTAreaPeople","wkts="+polygons,SaigaiTask.csrfToken);ajaxData.doAjax().done(function(data,statusText,jqXHR){if('people'in data){$("#measure_people").attr('value',separateComma(data.people));}else{$("#measure_people").attr('value',"0");}
if('house'in data){$("#measure_house").attr('value',separateComma(data.house));}else{$("#measure_house").attr('value',"0");}}).fail(function(jqXHR,statusText,errorThrown){console.log("JSON_BBOXAreaPeople is error! StatusCode="+jqXHR.status);});}
if($("#measure_area_units").text()=='km'){if(event.units=='km'){arearesult=Math.floor(event.measure*1000000)/1000000.0;}else{arearesult=Math.floor(event.measure*1000000)/1000000.0*1.0e-6;}
$("#measure_area_units").html('km');}else{if(event.units=='km'){arearesult=Math.floor(event.measure*1000000)/1000000.0*1.0e+6;}else{arearesult=Math.floor(event.measure*1000000)/1000000.0;}
if(arearesult<1.0e+6){$("#measure_area_units").html('m');}else{arearesult=arearesult*1.0e-6;$("#measure_area_units").html('km');}}
arearesult=arearesult.toPrecision(6);$("#measure_area").attr('value',arearesult);}},_deactivateMeasure:function()
{var control=this.DIST;if(control){control.events.remove("measure");control.events.remove("measurepartial");control.deactivate();}
var control=this.AREA;if(control){control.events.remove("measure");control.events.remove("measurepartial");control.deactivate();}},showMenu:function(){var self=this;$('#measure').remove();$('#content_main').append('<div id="measure" style="display:none;">');if(map.components.contentsFormWindow==null||!(!!map.components.contentsFormWindow&&map.components.contentsFormWindow.drawToolbar.drawLayer.layer.visibility)){$('#measure').load(SaigaiTask.PageURL.baseurl+'measure/measure/',function(responseText,textStatus,jqXHR){if(!(!!map.components.contentsFormWindow&&map.components.contentsFormWindow.drawToolbar.drawLayer.layer.visibility)){self.onEvent();}});}else{$('#measure').load(SaigaiTask.PageURL.baseurl+'measure/measure/',function(responseText,textStatus,jqXHR){$("#buttons").attr("style","display:none")
$("#measure_dist_span").css('display',"block");$("#measure_area_span").css('display',"block");$("#measure_people_span").css('display',"block");dist=0;dist=dist.toPrecision(4);area=0;area=area.toPrecision(6);$("#measure_dist").attr('value',dist);$("#measure_area").attr('value',area);$("#measure_people").attr('value',"0");$("#measure_house").attr('value',"0");if(!this.DIST){var style=new OpenLayers.Style();style.addRules([new OpenLayers.Rule({symbolizer:{"Point":{pointRadius:4,graphicName:"square",fillColor:"#FFFFFF",fillOpacity:1,strokeWidth:1,strokeOpacity:1,strokeColor:"#333333"},"Line":{strokeWidth:3,strokeOpacity:1,strokeColor:"#FF0000",strokeDashstyle:"dash"},"Polygon":{strokeWidth:2,strokeOpacity:1,strokeColor:"#FF0000",fillColor:"#FFFFFF",fillOpacity:0.3}}})]);var measureOptions={handlerOptions:{style:"default",layerOptions:{styleMap:new OpenLayers.StyleMap({"default":style})},persist:true}};var me=this;me.DIST=new OpenLayers.Control.Measure(OpenLayers.Handler.Path,measureOptions);me.DIST.geodesic=true;map.map.addControl(me.DIST);me.AREA=new OpenLayers.Control.Measure(OpenLayers.Handler.Polygon,measureOptions);me.AREA.geodesic=true;map.map.addControl(me.AREA);me.CIRCLE=new OpenLayers.Control.Measure(OpenLayers.Handler.RegularPolygon,{handlerOptions:{sides:40},eventListeners:{"deactivate":function(){if(!!stmap.popupManager){stmap.popupManager.closeAll();}}},callbacks:{"move":function(geometry){if(map.map.units!="m"){geometry=geometry.clone().transform(map.map.getProjectionObject(),new OpenLayers.Projection("EPSG:900913"));}
var area=geometry.getArea();var radius=0.565352*Math.sqrt(area);if(!!stmap.popupManager){stmap.popupManager.closeAll();}
var centroid=geometry.getCentroid();var center=new OpenLayers.LonLat(centroid.x,centroid.y).transform(stmap.map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326"));popup=new SaigaiTask.Map.view.Popup();var radiusText=parseInt(radius)+"m";if(10000<radius)radiusText=(radius/1000).toFixed(2)+"km";popup.showExtPopup({map:stmap,olmap:stmap.map,center:center,size:new OpenLayers.Size(150,10),title:radiusText});}}});me.CIRCLE.geodesic=true;map.map.addControl(me.CIRCLE);}
var contentsFormWindow=map.components.contentsFormWindow;var drawToolbar=contentsFormWindow.drawToolbar;var features=drawToolbar.drawLayer.drawFeatures;var dist=0;var area=0;var people=0;var house=0;for(var i=0;i<features.line.length;i++){var line=Math.floor(me.DIST.getBestLength(features.line[i].geometry)[0]*1000)/1000.0;if(me.DIST.getBestLength(features.line[i].geometry)[1]=='km')
line*=1000;dist+=line;}
dist=dist.toPrecision(4);if(dist<1000){$("#measure_dist").attr('value',dist);$("#measure_dist_units").html('m');}else{$("#measure_dist").attr('value',dist/1000);$("#measure_dist_units").html('km');}
for(var i=0;i<features.polygon.length;i++){var polygon=Math.floor(me.AREA.getBestArea(features.polygon[i].geometry)[0]*1000000)/1000000.0;if(me.AREA.getBestArea(features.polygon[i].geometry)[1]=='km')
polygon*=1000000;area+=polygon;var polygons=features.polygon[i].geometry.clone().transform(new OpenLayers.Projection("EPSG:"+map.epsg),new OpenLayers.Projection("EPSG:4326")).toString();var ajaxData=new GetDatas(SaigaiTask.contextPath+"/page/decisionsupport/JSON_WKTAreaPeople","wkts="+polygons,SaigaiTask.csrfToken);ajaxData.doAjax().done(function(data,statusText,jqXHR){if('people'in data){people+=data.people}
if('house'in data){house+=data.house;}
$("#measure_people").attr('value',separateComma(people));$("#measure_house").attr('value',separateComma(house));}).fail(function(jqXHR,statusText,errorThrown){console.log("JSON_BBOXAreaPeople is error! StatusCode="+jqXHR.status);});}
for(var i=0;i<features.circle.length;i++){var circle=Math.floor(me.CIRCLE.getBestArea(features.circle[i].geometry)[0]*1000000)/1000000.0;if(me.CIRCLE.getBestArea(features.circle[i].geometry)[1]=='km')
circle*=1000000;area+=circle;var circles=features.circle[i].geometry.clone().transform(new OpenLayers.Projection("EPSG:"+map.epsg),new OpenLayers.Projection("EPSG:4326")).toString();var ajaxData=new GetDatas(SaigaiTask.contextPath+"/page/decisionsupport/JSON_WKTAreaPeople","wkts="+circles,SaigaiTask.csrfToken);ajaxData.doAjax().done(function(data,statusText,jqXHR){if('people'in data){people+=data.people}
if('house'in data){house+=data.house;}
$("#measure_people").attr('value',separateComma(people));$("#measure_house").attr('value',separateComma(house));}).fail(function(jqXHR,statusText,errorThrown){console.log("JSON_BBOXAreaPeople is error! StatusCode="+jqXHR.status);});}
area=area.toPrecision(6);if(area<1000000){$("#measure_area").attr('value',area);$("#measure_area_units").html('m');}else{$("#measure_area").attr('value',area/1000000);$("#measure_area_units").html('km');}
$("#measure_people").attr('value',separateComma(people));$("#measure_house").attr('value',separateComma(house));});}
$('#buttons').css('display','none');$('#measure').dialog({title:lang.__("Measure distance and area"),position:{my:"top",at:"top",of:window},buttons:[{text:lang.__("Close"),click:function(){self.stopMeasure();self.offEvent();$('#measure').dialog('destroy');$('#measure').remove();return false;}}],close:function(){self.stopMeasure();self.offEvent();$('#measure').dialog('destroy');$('#measure').remove();}});}}
function GetDatas(){this.initialize.apply(this,arguments);}
GetDatas.prototype={initialize:function(url,param,token){this.url=url;this.param=param;this.token=token;},doAjax:function(){var jqXHR=$.ajax({url:this.url,headers:{"X-CSRF-Token":this.token},dataType:"json",data:this.param,contentType:"application/x-www-form-urlencoded; charset=UTF-8"});return jqXHR.promise();}}
function separateComma(num){return String(num).replace(/(\d)(?=(\d\d\d)+(?!\d))/g,'$1,');}
SaigaiTask.Map.view.MainPanel=function(){this.initialize.apply(this,arguments);};SaigaiTask.Map.view.MainPanel.prototype={map:null,panel:null,legend:null,mapPanelContainer:null,mapPanel:null,headerToolbar:null,initialize:function(map){var me=this;me.map=map;map.components.mainpanel=me;var panelItems=[];var items=[];var mapPanel=me.mapPanel=new SaigaiTask.Map.view.MapPanel(map);var headerToolbar=me.headerToolbar=new SaigaiTask.Map.view.HeaderToolbar(map);mapPanel.panel.addDocked(headerToolbar.tbar);var geocodingToolbar=new SaigaiTask.Map.view.GeocodingToolbar(map);geocodingToolbar.tbar.dock="bottom";var submap=null;geocodingToolbar.tbar.add(["->",Ext.create("Ext.Button",{text:lang.__("2 window display "),tooltip:lang.__("It displays map window bisection."),icon:map.icon.getURL("submapIconURL"),align:"left",handler:function(){var mapSyncControl=map.controls["syncControl"];if(mapSyncControl.group.length<2){submap=me.createSubmap();}
else{me.removeSubmap(submap);}}})]);items.push(mapPanel.panel);var mapPanelContainer=me.mapPanelContainer=Ext.create("Ext.Panel",{region:"center",layout:{type:"hbox",align:"stretch"},defaults:{flex:1},items:items});mapPanelContainer.addDocked(geocodingToolbar.tbar);panelItems.push(mapPanelContainer);var legend=me.legend=new SaigaiTask.Map.view.LegendPanel(map);legend.tree.region="west";legend.tree.margin="0 0 0 0";legend.tree.draggable=false;panelItems.push(legend.tree);legend.collapsed=true;var mapContainerHeight=$(mapPanel.panelDivElem.dom).parent().height();var main=me.panel=Ext.create("Ext.panel.Panel",{layout:'border',height:mapContainerHeight,items:panelItems,renderTo:mapPanel.panelDivElem,listeners:{"beforeadd":function(container,component,index,eOpts){if(me.legend.tree.id==component.id){map.events.triggerEvent(map.EventType.beforeaddlegend,{legend:component});}
return true;}}});map.resize=function(){var size=me.getExpandSize(main.getEl().dom);main.setWidth(size.width);main.setHeight(size.height);};$(window).resize(map.resize);$(window).scroll(map.resize);map.resize();map.events.triggerEvent("initmainpanel",{mainpanel:me});},activateResizer:function(component){var me=this;var map=me.map;var activateRegions={"north":"south","east":"west","west":"east","south":"north"};var activateRegion=activateRegions[component.region];if(typeof activateRegion!="undefined"){var div=$(component.getEl().dom);var handles=$(".x-resizable-handle",div);handles.removeClass("x-resizable-handle").addClass("x-unresizable-handle");handles.filter(".x-resizable-handle-"+activateRegion).addClass("x-resizable-handle").removeClass("x-unresizable-handle");}},getExpandSize:function(target){var sLeft=jQuery(window).scrollLeft();var sTop=jQuery(window).scrollTop();var winWidth=$(window).width();var winHeight=$(window).height();var winRight=sLeft+winWidth;var winBottom=sTop+winHeight;var elem=jQuery(target);var elemLeft=elem.offset().left;var elemTop=elem.offset().top;var anchorX=winRight;var anchorY=winBottom;var margin=5;var width=anchorX-elemLeft-margin;var height=anchorY-elemTop-margin;return{width:width,height:height};},redrawLegendPanel:function(){var me=this;var oldLegend=me.legend.tree;me.legend=new SaigaiTask.Map.view.LegendPanel(me.map);var legend=me.legend.tree;legend.region=oldLegend.region;legend.margin=oldLegend.margin;legend.draggable=oldLegend.draggable;var panel=me.panel;panel.remove(oldLegend);panel.add(legend);panel.doLayout();me.map.events.triggerEvent("afterredrawlegendpanel");},createSubmap:function(){var me=this;var map=me.map;var mapSyncControl=map.controls["syncControl"];var mapPanelContainer=me.mapPanelContainer;var newDiv=new Ext.Element(document.createElement('div'));newDiv.appendTo(Ext.getBody());var submap=window.submap=new SaigaiTask.Map(newDiv.id,{contextPath:map.contextPath,api:map.api,icon:map.icon});submap.mapId=map.mapId;var ecommap=map.ecommaps[0].clone(submap);submap.registEcommapInfo(ecommap);submap.controls["panZoom"].destroy();var zoom=new OpenLayers.Control.Zoom();submap.addControl(zoom,"zoom");submap.addControl(new OpenLayers.Control.LayerSwitcher(),"layerSwitcher");var submapPanel=new SaigaiTask.Map.view.MapPanel(submap);submap.components.submapPanel=submapPanel;var headerToolbar=new SaigaiTask.Map.view.HeaderToolbar(submap);headerToolbar.tbar.add(["->",Ext.create("Ext.Button",{tooltip:lang.__("Scale synchronization"),enableToggle:true,pressed:true,icon:map.icon.getURL("syncIconURL"),handler:function(button){if(button.pressed){mapSyncControl.activate();submapSyncControl.activate();}
else{mapSyncControl.deactivate();submapSyncControl.deactivate();}}}),Ext.create("Ext.Button",{tooltip:lang.__("Close"),icon:map.icon.getURL("deleteIconURL"),handler:function(){me.removeSubmap(submap);}})]);submapPanel.panel.addDocked(headerToolbar.tbar);var submapSyncControl=submap.controls["syncControl"];mapSyncControl.mergeGroup(submapSyncControl);mapSyncControl.activate();submapSyncControl.activate();var syncLayerRefresh=function(src,dst){if(src==null)return;src.events.on({"refreshParams":function(){(function(layer){if(layer!=null){if(typeof layer._refreshParams=="function"){return layer._refreshParams({nocache:true});}}})(dst);}});};if(map.ecommaps[0].contentsLayerInfo!=null){var layer=map.ecommaps[0].contentsLayerInfo.getLayer();var sublayer=submap.ecommaps[0].contentsLayerInfo.getLayer();syncLayerRefresh(layer,sublayer);syncLayerRefresh(sublayer,layer);}
mapPanelContainer.add(submapPanel.panel);return submap;},removeSubmap:function(submap){var me=this;var mapPanelContainer=me.mapPanelContainer;var submapPanel=submap.components.submapPanel;mapPanelContainer.remove(submapPanel.panel);var mapSyncControl=me.map.controls["syncControl"];var submapSyncControl=submap.controls["syncControl"];mapSyncControl.removeGroup(submapSyncControl);}};SaigaiTask.Map.control.PopupManager=new OpenLayers.Class({stmap:null,popups:null,initialize:function(stmap,options){var me=this;me.stmap=stmap;stmap.popupManager=me;me.popups=[];},add:function(popup){var me=this;me.popups.push(popup);$(popup.groupDiv).children().click(function(){me.toFrontend(popup);});},pin:function(popup){popup.pinned=true;},unpin:function(popup){popup.pinned=false;},close:function(popup){var me=this;var olmap=me.stmap.map;var deleteIdx=$.inArray(popup,me.popups);if(-1<deleteIdx){for(var idx=deleteIdx+1;idx<me.popups.length;idx++){if(deleteIdx!=null){var target=me.popups[idx];me.setZIndex(target,me.getZIndex(target)-1);}}
me.popups.splice(deleteIdx,1);}
olmap.removePopup(popup);},closeAll:function(force){var me=this;var olmap=me.stmap.map;var closePinned=(force==true);var newPopups=[];while(0<me.popups.length){var popup=me.popups.shift();var close=true;if(force!=true){close=(popup.pinned!=true);}
if(close){me.close(popup);}
else{newPopups.push(popup);}}
me.popups=newPopups;},setZIndex:function(popup,zIndex){return $(popup.div).css("z-Index",zIndex);},getZIndex:function(popup){return Number($(popup.div).css("z-Index"));},toFrontend:function(popup){var me=this;var targetIdx=$.inArray(popup,me.popups);if(-1<targetIdx&&targetIdx<me.popups.length-1){for(var idx=targetIdx+1;idx<me.popups.length;idx++){var sequencePopup=me.popups[idx];me.setZIndex(sequencePopup,me.getZIndex(sequencePopup)-1);}
me.setZIndex(popup,me.getZIndex(sequencePopup)+1);me.popups.splice(targetIdx,1);me.popups.push(popup);}},toBackend:function(popup){var me=this;var targetIdx=$.inArray(popup,me.popups);if(targetIdx!=0){for(var idx=targetIdx-1;0<=idx;idx--){var sequencePopup=me.popups[idx];me.setZIndex(sequencePopup,me.getZIndex(sequencePopup)+1);}
me.setZIndex(popup,me.getZIndex(sequencePopup)-1);me.popups.splice(targetIdx,1);me.popups.unshift(popup);}}});SaigaiTask.Map.view.GeocodingToolbar=function(){this.initialize.apply(this,arguments);};SaigaiTask.Map.view.GeocodingToolbar.prototype={tbar:null,map:null,addressField:null,resultAddressField:null,resultAddressFieldTip:null,initialize:function(map){var me=this;me.map=map;var olmap=map.map;var footerTbarItems=[];var addressField=me.addressField=Ext.create("Ext.form.field.Text",{enableKeyEvents:true,listeners:{afterrender:function(field,event){var el=field.getEl();$(el.dom).keydown(function(event){if(event.keyCode==13){event.preventDefault();return false;}});},specialkey:function(field,e,eOpts){if(e.getKey()==e.ENTER){me.fireJumpAddressButton();}}}});var jumpAddressButton=Ext.create("Ext.button.Button",{text:lang.__('Move map'),tooltip:lang.__("Move to the location of entered address or of self defense force code"),margin:"0 5 0 5",listeners:{click:function(){me.fireJumpAddressButton();}}});footerTbarItems.push(addressField);footerTbarItems.push(jumpAddressButton);var resultAddressField=me.resultAddressField=Ext.create("Ext.form.Label",{text:lang.__("Due to display crumbled on IE, messages are displayed beforehand."),hidden:true});var rgeocodeButton=Ext.create("Ext.button.Button",{text:lang.__('Get address of center position'),tooltip:lang.__("The address of map center is displayed."),margin:"0 5 0 5",listeners:{click:function(){var center=olmap.getCenter();center=center.transform(olmap.getProjectionObject(),new OpenLayers.Projection("EPSG:4326"));me.map.geocode(center).done(function(results){var result=results[0];me.updateAddress(result);}).fail(function(results,status){alert(lang.__("Failed to get address.")+status);});}}});footerTbarItems.push("-");footerTbarItems.push(rgeocodeButton);footerTbarItems.push(resultAddressField);var footerTbar=Ext.create("Ext.toolbar.Toolbar",{dock:"bottom",items:footerTbarItems});me.tbar=footerTbar;},updateAddress:function(result){var me=this;var addr=null;if(result instanceof String){addr=result;}
if(result instanceof Object){addr=me.map.getFormattedAddress(result);}
me.updateResultAddress(addr);},updateResultAddress:function(addr){var me=this;me.resultAddressField.setText(addr);if(me.resultAddressField.isHidden()){me.resultAddressField.show();}
if(me.resultAddressFieldTip==null){me.resultAddressFieldTip=Ext.create('Ext.tip.ToolTip',{target:me.resultAddressField.getEl()});}
me.resultAddressFieldTip.update(addr);},fireJumpAddressButton:function(){var me=this;var map=me.map;var olmap=map.map;var addressField=me.addressField;var address=addressField.getValue();var isMGRSFormat=/^\d\d?[a-zA-Z][a-zA-Z][a-zA-Z](\d*)$/;var result=isMGRSFormat.exec(address.replace(/\s+/g,""));if(result==null){isMGRSFormat=/^(\d*)$/;result=isMGRSFormat.exec(address.replace(/\s+/g,""));if(result!=null){var left=map.ecommaps[0].initExtent.left;var bottom=map.ecommaps[0].initExtent.bottom;var right=map.ecommaps[0].initExtent.right;var top=map.ecommaps[0].initExtent.top;var initExtent=new OpenLayers.Bounds(left,bottom,right,top);var center=map.getCenter();var wkt="POINT("+center.lon+" "+center.lat+")";var url=SaigaiTask.contextPath+"/page/map/getGrid/";jQuery.ajax(url,{type:"get",dataType:"json",async:false,data:{wkt:wkt},success:function(data){result[0]=new Array();result[0].push(data.wkt.slice(0,data.wkt.indexOf(" "))+result[0]+result[1]);var UTMalphabets=new Array();for(var i='A'.charCodeAt(0);i<='Z'.charCodeAt(0);i++){if(String.fromCodePoint(i)!="I"&&String.fromCodePoint(i)!="O")
UTMalphabets.push(String.fromCodePoint(i));}
var alphabet1=result[0][0].substr(3,1);var alphabet2=result[0][0].substr(4,1);for(var i=0;i<UTMalphabets.length;i++){if(alphabet1==UTMalphabets[i]){result[0].push(result[0][0].replace(alphabet1,UTMalphabets[i-1]));result[0].push(result[0][0].replace(alphabet1,UTMalphabets[i+1]));}
if(alphabet2==UTMalphabets[i]){result[0].push(result[0][0].replace(alphabet2,UTMalphabets[i-1]));result[0].push(result[0][0].replace(alphabet2,UTMalphabets[i+1]));}}
for(var i=0;i<UTMalphabets.length;i++){if(alphabet1==UTMalphabets[i]){result[0].push(result[0][3].replace(alphabet1,UTMalphabets[i-1]));result[0].push(result[0][3].replace(alphabet1,UTMalphabets[i+1]));result[0].push(result[0][4].replace(alphabet1,UTMalphabets[i-1]));result[0].push(result[0][4].replace(alphabet1,UTMalphabets[i+1]));}}
var nearest=0;var no;for(i=0;i<result[0].length;i++){var mgrs=result[0][i];var json=map.api.mgrs2lonlat(mgrs);if(!!json.lon&&!!json.lat){function radians(deg){return deg*Math.PI/180;}
var lat1=json.lat;var lng1=json.lon;var lat2=center.lat;var lng2=center.lon;var distance=6378.14*Math.acos(Math.cos(radians(lat1))*Math.cos(radians(lat2))*Math.cos(radians(lng2)-radians(lng1))+
Math.sin(radians(lat1))*Math.sin(radians(lat2)));if(distance-nearest<0||i==0){nearest=distance;no=i;}
else{continue;}}}
result[0]=result[0][no];},error:function(data){throw lang.__("An error occurred during the conversion MGRS code into coordinates.");}});}}
if(result!=null){do{var numericalLocation=result[1];var maxDigits=5;if(maxDigits*2<numericalLocation.length){alert(lang.__("The number of digits is too large.\n maximum number of digits of MGRS code is {0}.",maxDigits));break;}
if(numericalLocation.length%2!=0){alert(lang.__("MGRS code is invalid. Please align the number of digits."));break;}
var mgrs=result[0];var json=map.api.mgrs2lonlat(mgrs);if(!!json.lon&&!!json.lat){var digits=json["mgrs_digits"];var zoom=map.map.getZoom();var mgrsControl=map.controls.mgrsControl;if(!!mgrsControl)zoom=mgrsControl.getZoomForPrecision(digits);map.setCenter(new OpenLayers.LonLat(json.lon,json.lat),zoom);me.updateResultAddress(lang.__("MGRS code: ")+json.mgrs);}}while(0);return;}
var defResult=map.api.landmarkSearch(address);var landmarkFlag=false;defResult.done(function(landmarkArr){if(landmarkArr.length>0){for(var cnt in landmarkArr){var landmark=landmarkArr[cnt].landmark;var lon=landmarkArr[cnt].lon;var lat=landmarkArr[cnt].lat;map.setCenter(new OpenLayers.LonLat(lon,lat),16);me.updateResultAddress(lang.__("Landmark:")+landmark);landmarkFlag=true;break;}}});if(landmarkFlag){return;}
map.moveAddress(address).done(function(result){me.updateAddress(result);});}};SaigaiTask.Map.control.MgrsControl=new OpenLayers.Class(OpenLayers.Control,{stmap:null,layerInfo:null,layer:null,autoPrecision:true,AUTO_PRECISION_GRID_NUM:0.6,initialize:function(stmap){var me=this;me.stmap=stmap;var layerInfo=me.layerInfo=new SaigaiTask.Map.Layer.LayerInfo({layerId:"mgrs",type:SaigaiTask.Map.Layer.Type.EXTERNAL_MAP_WMS,name:lang.__("UTM grid"),wmsURL:window.location.protocol+"//"+window.location.host+SaigaiTask.contextPath+"/page/map/mgrs/?",wmsFormat:"image/png",visibility:false,params:{precision:0}});layerInfo.children=[];for(var p=0;p<=5;p++){layerInfo.children.push(new SaigaiTask.Map.Layer.LayerInfo({layerId:layerInfo.layerId+"_"+p,featuretypeId:"mgrs"+p,mgrsPrecision:p,visibility:false,params:{LAYERS:"mgrs"+p}}));}
var layer=me.layer=new SaigaiTask.Map.Layer.WMSLayer(layerInfo);stmap.events.on({"loadendecommap":function(ecommap){if(!layer.map){stmap.addLayer(layer);layer.setVisibility(layerInfo.visibility);}},"legendinitialize":function(args){var legend=args.legend;var btn=Ext.create("Ext.Button",{text:lang.__('UTM grid'),tooltip:lang.__("UTM grid is shown or hided."),icon:stmap.icon.getURL("mgrsIconURL"),enableToggle:true,handler:function(){layerInfo.visibility=!layerInfo.visibility;if(layerInfo.visibility){if(me.autoPrecision){var autoPrecision=me.getPrecisionForZoom(stmap.map.getZoom());me.setPrecision(autoPrecision);}}
layer.refreshParams();}});legend.addTbarItems([btn]);}});stmap.map.events.on({"zoomend":function(){if(me.autoPrecision){var autoPrecision=me.getPrecisionForZoom(stmap.map.getZoom());var current=layerInfo.params.precision;if(current!=autoPrecision){me.setPrecision(autoPrecision);layer.refreshParams();}}}});},setPrecision:function(precision){var me=this;var layerInfo=me.layerInfo;layerInfo.params.precision=precision;for(var idx in layerInfo.children){var child=layerInfo.children[idx];child.visibility=child.mgrsPrecision<=precision;}},getZoomForPrecision:function(precision){var me=this;var stmap=me.stmap;var olmap=stmap.map;var zoom=olmap.getZoom();if($.isNumeric(precision)&&olmap.getUnits()=="m"){for(var zoom=olmap.getMinZoom();zoom<olmap.getNumZoomLevels();zoom++){if(!me.isViewportAvailable(zoom,precision)){if(0<zoom){zoom--;}
break;}}
if(olmap.getNumZoomLevels()<=zoom)zoom=olmap.getNumZoomLevels()-1;}
return zoom;},getPrecisionForZoom:function(zoom){var precision=0;var me=this;var stmap=me.stmap;var olmap=stmap.map;var precisions=[5,4,3,2,1,0];for(var idx in precisions){var p=precisions[idx];if(!me.isViewportAvailable(zoom,p)){if(0<idx){idx--;}
precision=precisions[idx];break;}}
return precision;},isViewportAvailable:function(zoom,precision){var me=this;var stmap=me.stmap;var olmap=stmap.map;var maxMeter=null;switch(precision){case 5:maxMeter=1;break;case 4:maxMeter=10;break;case 3:maxMeter=100;break;case 2:maxMeter=1000;break;case 1:maxMeter=10000;break;case 0:maxMeter=100000;break;}
if(maxMeter==null)return false;var pixel=Math.min($(olmap.getViewport()).width(),$(olmap.getViewport()).height())-30*2;var viewportMeter=olmap.getResolutionForZoom(zoom)*pixel;return maxMeter*me.AUTO_PRECISION_GRID_NUM<=viewportMeter;}});OpenLayers.Format.KMLStyle=OpenLayers.Class(OpenLayers.Format.KML,{FONTSIZE:14,ICONSIZE:48,defaultStyle:{pointRadius:5,strokeColor:"#ff0000",strokeWidth:2,fillColor:"#ff0000",fillOpacity:0.5},initialize:function(options){OpenLayers.Format.KML.prototype.initialize.apply(this,[options]);},write:function(features)
{this.internalProjection.readyToUse=true;this.externalProjection.readyToUse=true;if(!(features instanceof Array)){features=[features];}
var kml=this.createElementNS(this.kmlns,"kml");var folder=this.createFolderXML();for(var i=0,len=features.length;i<len;++i){folder.appendChild(this.createPlacemarkXML(features[i]));}
kml.appendChild(folder);return OpenLayers.Format.XML.prototype.write.apply(this,[kml]);},parseData:function(data,options){if(typeof data=="string"){xmldoc=OpenLayers.Format.XML.prototype.read.apply(this,[data]);}
if(xmldoc.normalize)xmldoc.normalize();if(!xmldoc.firstChild.tagName!="kml"){xmldoc=new DOMParser().parseFromString(data,'text/xml');}
var folderNode=xmldoc.firstChild.firstChild;while(folderNode&&folderNode.nodeType==Node.TEXT_NODE){folderNode=folderNode.nextSibling;}
this.foldersDesc=OpenLayers.Util.getXmlNodeValue(this.getElementsByTagNameNS(folderNode,"*","description")[0]);var types=["Link","NetworkLink","Style","StyleMap","Placemark"];for(var i=0,len=types.length;i<len;++i){var type=types[i];var nodes=this.getElementsByTagNameNS(xmldoc,"*",type);if(nodes.length==0){continue;}
switch(type.toLowerCase()){case"link":case"networklink":this.parseLinks(nodes,options);break;case"style":if(this.extractStyles){this.parseStyles(nodes,options);}
break;case"stylemap":if(this.extractStyles){this.parseStyleMaps(nodes,options);}
break;case"placemark":this.parseFeatures(nodes,options);break;}}
this.adjustImageSize(this.features);return this.features;},adjustImageSize:function(features)
{var imageFeatuers={};for(var i=0;i<features.length;i++){var style=features[i].style;var url=style.externalGraphic;if(url){if(url)
if(!imageFeatuers[url])imageFeatuers[url]=[];imageFeatuers[url].push(features[i]);}}
for(var url in imageFeatuers){this._adjustImageSize(url,imageFeatuers[url]);}},_adjustImageSize:function(url,features)
{var img=new Image();img.onload=function(){if(img.width<=1||img.height<=1)return;for(var i=0;i<features.length;i++){var style=features[i].style;if(style.graphicScale>0){var w=img.width*style.graphicScale;var h=img.height*style.graphicScale;if(style.graphicXOffset)style.graphicXOffset=Math.round(parseFloat(style.graphicXOffset)*w/style.graphicWidth);if(style.graphicYOffset)style.graphicYOffset=Math.round(parseFloat(style.graphicYOffset)*h/style.graphicHeight);style.graphicWidth=w;style.graphicHeight=h;}else{if(img.width>img.height){var h=style.graphicWidth*img.height/img.width;if(style.graphicYOffset)style.graphicYOffset=Math.round(parseFloat(style.graphicYOffset)*h/style.graphicHeight);style.graphicHeight=h;}else if(img.width<img.height){var w=style.graphicHeight*img.width/img.height;if(style.graphicXOffset)style.graphicXOffset=Math.round(parseFloat(style.graphicXOffset)*w/style.graphicWidth);style.graphicWidth=w;}}}
if(features[0].layer)features[0].layer.redraw();};img.src=url;img.onload();},getStyle:function(styleUrl,options){var styleBaseUrl=OpenLayers.Util.removeTail(styleUrl);var newOptions=OpenLayers.Util.extend({},options);newOptions.depth++;newOptions.styleBaseUrl=styleBaseUrl;if(!this.styles[styleUrl]&&!OpenLayers.String.startsWith(styleUrl,"#")&&newOptions.depth<=this.maxDepth&&!this.fetched[styleBaseUrl]){var data=this.fetchLink(styleBaseUrl);if(data){this.parseData(data,newOptions);}}
if(!this.styles[styleUrl])return this.defaultStyle;var style=OpenLayers.Util.extend({},this.styles[styleUrl]);return style;},parseStyle:function(node){var style={};var types=["LineStyle","PolyStyle","IconStyle","BalloonStyle","LabelStyle"];var type,nodeList,geometry,parser,styleTypeNode;for(var i=0,len=types.length;i<len;++i){type=types[i];styleTypeNode=this.getElementsByTagNameNS(node,"*",type)[0];if(!styleTypeNode){continue;}
switch(type.toLowerCase()){case"linestyle":var color=this.parseProperty(styleTypeNode,"*","color");if(color){var matches=(color.toString()).match(this.regExes.kmlColor);if(matches){var alpha=matches[1];style["strokeOpacity"]=parseInt(alpha,16)/255;style["strokeColor"]="#"+matches[4]+matches[3]+matches[2];}}
var width=this.parseProperty(styleTypeNode,"*","width");if(width<1)width=0;style["strokeWidth"]=width;case"polystyle":var color=this.parseProperty(styleTypeNode,"*","color");if(color){var matches=(color.toString()).match(this.regExes.kmlColor);if(matches){var alpha=matches[1];style["fillOpacity"]=parseInt(alpha,16)/255;style["fillColor"]="#"+matches[4]+matches[3]+matches[2];}}
var fill=this.parseProperty(styleTypeNode,"*","fill");if(fill=="0"){style["fillColor"]="none";}
break;case"iconstyle":var iconNode=this.getElementsByTagNameNS(styleTypeNode,"*","Icon")[0];if(iconNode){var href=this.parseProperty(iconNode,"*","href");if(href){href=href.replace(/%3F/i,"?");var scale=parseFloat(this.parseProperty(styleTypeNode,"*","scale")||1);if(scale<=0)scale=1;var width=this.ICONSIZE*scale;var height=this.ICONSIZE*scale;if(OpenLayers.String.startsWith(href,"http://maps.google.com/mapfiles/kml")){width=64;height=64;scale=scale/2;}else{var width=this.ICONSIZE*scale;var height=this.ICONSIZE*scale;style.graphicScale=scale;}
var matches=href.match(this.regExes.kmlIconPalette);if(matches){var palette=matches[1];var file_extension=matches[2];var x=this.parseProperty(iconNode,"*","x");var y=this.parseProperty(iconNode,"*","y");var posX=x?x/32:0;var posY=y?(7-y/32):7;var pos=posY*8+posX;href="http://maps.google.com/mapfiles/kml/pal"
+palette+"/icon"+pos+file_extension;}
style["graphicOpacity"]=1;style["externalGraphic"]=href;var hotSpotNode=this.getElementsByTagNameNS(styleTypeNode,"*","hotSpot")[0];if(hotSpotNode){var x=parseFloat(hotSpotNode.getAttribute("x"));var y=parseFloat(hotSpotNode.getAttribute("y"));var xUnits=hotSpotNode.getAttribute("xunits");if(xUnits=="pixels"){style["graphicXOffset"]=-x*scale;}
else if(xUnits=="insetPixels"){style["graphicXOffset"]=-width+(x*scale);}
else if(xUnits=="fraction"){style["graphicXOffset"]=-width*x;}
var yUnits=hotSpotNode.getAttribute("yunits");if(yUnits=="pixels"){style["graphicYOffset"]=-height+(y*scale);}
else if(yUnits=="insetPixels"){style["graphicYOffset"]=-(y*scale);}
else if(yUnits=="fraction"){style["graphicYOffset"]=-height*(1-y);}}
style["graphicWidth"]=width;style["graphicHeight"]=height;}}
break;case"balloonstyle":var balloonStyle=OpenLayers.Util.getXmlNodeValue(styleTypeNode);if(balloonStyle){style["balloonStyle"]=balloonStyle.replace(this.regExes.straightBracket,"${$1}");}
break;case"labelstyle":var color=this.parseProperty(styleTypeNode,"*","color");if(color){var matches=(color.toString()).match(this.regExes.kmlColor);if(matches){var opacity=parseInt(matches[1],16)/255;style.fontOpacity=opacity;if(opacity>0)style.fontColor="#"+matches[4]+matches[3]+matches[2];}}
var scale=parseFloat(this.parseProperty(styleTypeNode,"*","scale")||1);if(scale<=0)scale=1;style.fontSize=this.FONTSIZE*scale;OpenLayers.Format.KMLStyleUtil.parseTextMemo(this,node,style);break;default:}}
if(!style["strokeColor"]&&style["fillColor"]){style["strokeColor"]=style["fillColor"];}
var id=node.getAttribute("id");if(id&&style){style.id=id;}
return style;},createPlacemarkXML:function(feature)
{var placemarkName=this.createElementNS(this.kmlns,"name");var name=feature.attributes.name||"";placemarkName.appendChild(this.createTextNode(name));var placemarkDesc=this.createElementNS(this.kmlns,"description");var desc=feature.attributes.description||"";placemarkDesc.appendChild(this.createTextNode(desc));var placemarkNode=this.createElementNS(this.kmlns,"Placemark");if(feature.fid!=null){placemarkNode.setAttribute("id",feature.fid);}
placemarkNode.appendChild(placemarkName);placemarkNode.appendChild(placemarkDesc);if(feature.style){var styleNode=this.createStyleNode(feature.style);placemarkNode.appendChild(styleNode);}
var geometryNode=this.buildGeometryNode(feature.geometry);placemarkNode.appendChild(geometryNode);return placemarkNode;},createKmlColorNode:function(color,opacity)
{if(opacity===undefined||opacity===null){var alpha="ff";}else{var alpha=Math.round(parseFloat(opacity)*255).toString(16);if(alpha.length==1)alpha="0"+alpha;}
var value;if(!color||color.length<4){value=alpha+'000000';}else if(color.length<7){var r=color.slice(1,2);var g=color.slice(2,3);var b=color.slice(3,4);value=alpha+b+b+g+g+r+r;}else{var r=color.slice(1,3);var g=color.slice(3,5);var b=color.slice(5,7);value=alpha+b+g+r;}
var colorNode=this.createElementNS(this.kmlns,"color");colorNode.appendChild(this.createTextNode(value));return colorNode;},createStyleNode:function(style)
{if(true){var styleNode=this.createElementNS(this.kmlns,"Style");var id=OpenLayers.Util.createUniqueID("style_");styleNode.setAttribute("id",id);if(style.strokeColor||style.strokeOpacity){var lineNode=this.createElementNS(this.kmlns,"LineStyle");var colorNode=this.createKmlColorNode(style.strokeColor,style.strokeOpacity);lineNode.appendChild(colorNode);if(style.strokeWidth){var width=this.createElementNS(this.kmlns,"width");width.appendChild(this.createTextNode(style.strokeWidth));lineNode.appendChild(width);}
styleNode.appendChild(lineNode);}
if(style.fillColor||style.fillOpacity){var polyNode=this.createElementNS(this.kmlns,"PolyStyle");var colorNode=this.createKmlColorNode(style.fillColor,style.fillOpacity);polyNode.appendChild(colorNode);styleNode.appendChild(polyNode);}
if(polyNode&&style.strokeWidth=="0"){var outline=this.createElementNS(this.kmlns,"outline");outline.appendChild(this.createTextNode("0"));polyNode.appendChild(outline);styleNode.appendChild(polyNode);}
if(style.externalGraphic&&style.graphic!==false){var iconstyleNode=this.createElementNS(this.kmlns,"IconStyle");var iconNode=this.createElementNS(this.kmlns,"Icon");var href=this.createElementNS(this.kmlns,"href");var urlObj=OpenLayers.Util.createUrlObject(style.externalGraphic.replace("?","%3F"),{ignorePort80:true});url=urlObj.protocol+'//'+urlObj.host+urlObj.port+urlObj.pathname;href.appendChild(this.createTextNode(url));iconNode.appendChild(href);var scale=this.createElementNS(this.kmlns,"scale");scale.appendChild(this.createTextNode(style.graphicScale>0?style.graphicScale:1));iconstyleNode.appendChild(scale);iconstyleNode.appendChild(iconNode);if(style.graphicXOffset||style.graphicYOffset){var hotSpotNode=this.createElementNS(this.kmlns,"hotSpot");if(style.graphicXOffset){hotSpotNode.setAttribute("x",-style.graphicXOffset/style.graphicWidth);hotSpotNode.setAttribute("xunits","fraction");}
if(style.graphicYOffset){hotSpotNode.setAttribute("y",1+style.graphicYOffset/(style.graphicHeight));hotSpotNode.setAttribute("yunits","fraction");}
iconstyleNode.appendChild(hotSpotNode);}
styleNode.appendChild(iconstyleNode);}
if(style.fontColor!=undefined){var colorNode=this.createKmlColorNode(style.fontColor,style.fontOpacity);var labelStyle=this.createElementNS(this.kmlns,"LabelStyle");labelStyle.appendChild(colorNode);styleNode.appendChild(labelStyle);try{if(style.fontSize){var fontSize=parseFloat(style.fontSize);var fontScaleNode=this.createElementNS(this.kmlns,"scale");fontScaleNode.appendChild(this.createTextNode(fontSize/this.FONTSIZE));labelStyle.appendChild(fontScaleNode);}}catch(e){}}
return styleNode;}},CLASS_NAME:"OpenLayers.Format.KMLStyle"});SaigaiTask.Map.util.CommonUtil={length:function(obj){var count=0;if(obj!=null){for(var key in obj){if(key!=null){count++;}}}
return count;},loadLibrary:function(contextPath){var server=location.href.substring(0,location.href.indexOf(contextPath))+contextPath;var libs=[];if(typeof FalUtil=='undefined'){libs.push(server+'/assets2/js/falutil.js');}
if(typeof Ext=='undefined'){libs.push(server+"/extjs/ext-all.js");}
for(var idx in libs){var lib=libs[idx];var jsElement=document.createElement("script");jsElement.type="text/javascript";jsElement.src=lib;document.getElementsByTagName("head")[0].appendChild(jsElement);console.log('load javascript: '+lib);}},getXHR:function(){if(window.ActiveXObject){try{return new ActiveXObject("Msxml2.XMLHTTP");}catch(e){try{return new ActiveXObject("Microsoft.XMLHTTP");}catch(e2){return null;};};}else if(window.XMLHttpRequest){return new XMLHttpRequest();}else{return null;}},escapeXml:function(str)
{return str.replace(/&/gm,"&amp;").replace(/</gm,"&lt;").replace(/>/gm,"&gt;").replace(/"/gm,"&quot;");},getQueryString:function(){return window.location.search.substring(1);},getParameterMap:function(query){var map=new Array();var params=query.split("&");for(var idx in params){var param=params[idx];var pos=param.indexOf("=");if(0<pos){var key=param.substring(0,pos);var val=param.substring(pos+1);map[key]=val;}}
return map;},getParameter:function(name){var query=SaigaiTask.Map.util.CommonUtil.getQueryString();var paramMap=SaigaiTask.Map.util.CommonUtil.getParameterMap(query);return paramMap[name];}};OpenLayers.Control.CenterCursor=OpenLayers.Class(OpenLayers.Control,{element:null,elementMap:null,size:23,opacity:0.8,initialize:function()
{OpenLayers.Control.prototype.initialize.apply(this,arguments);},draw:function()
{OpenLayers.Control.prototype.draw.apply(this,arguments);var cursor=this.createCursor();this.div.appendChild(cursor);this.element=cursor;this.element.style.display='none';this.moveCenter();this.map.events.register("movestart",this,this.moveStart);this.map.events.register("resize",this,this.moveCenter);this.map.events.register("moveend",this,this.moveEnd);return this.div;},createCursor:function()
{var color='red';var bgColor='white';var cursor=document.createElement("div");cursor.className="CenterCursor";var s=cursor.style;s.width=s.height="2px";s.position="absolute";s.opacity=this.opacity;var half=Math.floor(this.size/2.0);cursor.appendChild(this.createLine(0,half-1,half-3,3,bgColor));cursor.appendChild(this.createLine(half+4,half-1,half-3,3,bgColor));cursor.appendChild(this.createLine(half-1,0,3,half-3,bgColor));cursor.appendChild(this.createLine(half-1,half+4,3,half-3,bgColor));cursor.appendChild(this.createLine(1,half,half-4,1,color));cursor.appendChild(this.createLine(half+4,half,half-4,1,color));cursor.appendChild(this.createLine(half,1,1,half-4,color));cursor.appendChild(this.createLine(half,half+4,1,half-4,color));return cursor;},createLine:function(left,top,w,h,color)
{var line=document.createElement("div");var s=line.style;s.position="absolute";s.overflow="hidden";s.top=top+"px";s.left=left+"px";s.width=w+"px";s.height=h+"px";s.backgroundColor=color;return line;},moveStart:function()
{this.element.style.display='';this.elementMap.style.display='none';},moveEnd:function()
{this.element.style.display='none';this.elementMap.style.display='';this.moveCenter();},moveCenter:function()
{var s=this.map.getSize();this.element.style.left=((s.w-this.size)/2)+"px";this.element.style.top=((s.h-this.size)/2)+"px";var div=this.map.layerContainerDiv;if(!this.elementMap){this.elementMap=this.createCursor();this.elementMap.style.zIndex=750;div.appendChild(this.elementMap);}else{this.elementMap.style.left=((s.w-this.size)/2-div.offsetLeft)+"px";this.elementMap.style.top=((s.h-this.size)/2-div.offsetTop)+"px";}},CLASS_NAME:"OpenLayers.Control.CenterCursor"});SaigaiTask.Map.Layer.OSMLayer=new OpenLayers.Class(OpenLayers.Layer.OSM,{layerInfo:null,initialize:function(layerInfo){var me=this;me.layerInfo=layerInfo;var url=layerInfo.wmsURL;if(!url.match(".*\\$\{z\}\/\\$\{x\}\/\\$\{y\}\.png$")){if(!url.match(".*/$"))url+="/";url+="${z}/${x}/${y}.png";}
var options={visibility:layerInfo.visibility,buffer:0,alpha:true,opacity:1.0,isBaseLayer:true};OpenLayers.Layer.OSM.prototype.initialize.apply(this,[layerInfo.name,url,options]);}});SaigaiTask.Map.Layer.OSMLayer.type=SaigaiTask.Map.Layer.Type.OSM;SaigaiTask.Map.view.ContextMenu=function(){this.initialize.apply(this,arguments);};SaigaiTask.Map.view.ContextMenu.prototype={stmap:null,lonlat:null,initialize:function(stmap,options){var me=this;me.stmap=stmap;document.getElementById(stmap.div).oncontextmenu=function(e){e=e?e:window.event;if(options!="object")options={};jQuery.extend(options,{addContentsMenu:false});var evt=new OpenLayers.Events(e,document.getElementById(stmap.div));var xy=evt.getMousePosition(e);me.lonlat=stmap.map.getLonLatFromPixel(new OpenLayers.Pixel(xy.x,xy.y));var x=e.pageX?e.pageX:e.clientX;var y=e.pageY?e.pageY:e.clientY;return me.showMenu(x,y,options);};me.stmap.events.on({"beforemapclick":function(){if(!!me.menu&&me.menu.isVisible()){me.menu.close();}}})},showMenu:function(x,y,showMenuOptions){if(typeof Ext=='undefined')return;var me=this;var stmap=me.stmap;var items=[];var lonlat=me.lonlat;var options=new SaigaiTask.Map.model.ShowMenuOptions();SaigaiTask.Map.copy(options,showMenuOptions);if(options.addContentsMenu){var addContentsMenuLayerInfos=[];if(typeof options.addContentsMenuLayerInfos!="undefined"){addContentsMenuLayerInfos=options.addContentsMenuLayerInfos;}
else{for(var ecommapsKey in stmap.ecommaps){var ecommap=stmap.ecommaps[ecommapsKey];var contentsLayers=ecommap.contentsLayers;for(var contentsLayersKey in contentsLayers){var contentsLayer=contentsLayers[contentsLayersKey];addContentsMenuLayerInfos.push(contentsLayer);}}}
items.push(me.createAddContentsMenuItem(lonlat,addContentsMenuLayerInfos));}
if(options.deleteLayerMenu){var layerInfo=options.layerInfo;var record=options.record;items.push(me.createDeletemenuItem(layerInfo,record));}
if(options.transparencyLayerMenu){var layerInfo=options.layerInfo;var record=options.record;items.push(me.createTransparencyMenuItem(layerInfo,record));}
if(lonlat!=null){items.push(me.createAddPlaceMenuItem(lonlat));}
if(0<items.length){var menu=me.menu=Ext.create('Ext.menu.Menu',{renderTo:Ext.getBody(),items:items});if(typeof x=='undefined')x=y=0;menu.setPosition(x,y);menu.show();return false;}
return true;},createAddContentsMenuItem:function(lonlat,layerInfos){var me=this;var stmap=me.stmap;var items=[];var createItems=function(layerInfo){if(layerInfo.type==SaigaiTask.Map.Layer.Type.LOCAL){if(layerInfo.addable==true){items.push({text:layerInfo.name,layerInfo:layerInfo,icon:layerInfo.ecommap.ecommapURL+'/legend?WIDTH=44&HEIGHT=32&cid='+layerInfo.ecommap.mapInfo.communityId+'&mid='+layerInfo.ownerMapId+'&layer='+layerInfo.layerId+'&SCALE=1000'});}}
else{for(var idx in layerInfo.children){var childLayerInfo=layerInfo.children[idx];createItems(childLayerInfo);}}};for(var idx in layerInfos){var layerInfo=layerInfos[idx];createItems(layerInfo);}
var menuItem={text:lang.__('Register'),icon:stmap.icon.getURL("addIconURL")};var onClick=function(layerInfo){new SaigaiTask.Map.view.ContentsFormWindow({stmap:stmap,layerInfo:layerInfo,lonlat:lonlat});};if(items.length==0){return null;}
else if(items.length==1){jQuery.extend(menuItem,{listeners:{click:function(menu,item,e,eOpts){var layerInfo=items[0].layerInfo;onClick(layerInfo);}}});}
else{jQuery.extend(menuItem,{hideOnClick:false,menu:{items:items,listeners:{click:function(menu,item,e,eOpts){var layerInfo=item.layerInfo;onClick(layerInfo);}}}});}
return menuItem;},createDeletemenuItem:function(layerInfo,record){var me=this;var stmap=me.stmap;var menuItem={text:lang.__('Delete'),icon:stmap.icon.getURL("deleteIconURL"),listeners:{click:function(menu,item,e,eOpts){var parentNode=record.parentNode;record.remove();{var layerInfos=[layerInfo];if(!!layerInfo.children&&layerInfo.children.length>0){layerInfos=layerInfos.concat(layerInfo.children);}
var records=[];for(var idx in layerInfos){var linfo=layerInfos[idx];var l=linfo.getLayer();if(l!=null){stmap.map.removeLayer(l);}}
if(!!parentNode&&parentNode.childNodes.length==0){parentNode.remove()}}
if(layerInfo.isSessionExternalMapLayer()){var records=[];var registDeleteRecordRecursive=function(records,layerInfo){if(layerInfo.metadataid!=null){records.push({menuinfoid:SaigaiTask.Page.menuInfo.id,metadataid:layerInfo.metadataid,updateTime:Ext.Date.format(new Date(),"Y-m-d\\TH:i:s"),state:"remove"});}
if(layerInfo.children!=null){for(var idx in layerInfo.children){var child=layerInfo.children[idx];registDeleteRecordRecursive(records,child);}}};registDeleteRecordRecursive(records,layerInfo);if(0<records.length){jQuery.ajax(SaigaiTask.contextPath+"/page/map/sessionMetadata",{async:true,type:"POST",dataType:"json",data:{records:JSON.stringify(records)},success:function(data,textStatus,jqXHR){},error:function(jqXHR,status,errorThrown){console.error(errorThrown);}});}}}}};return menuItem;},createAddPlaceMenuItem:function(lonlat){var me=this;var stmap=me.stmap;var menuItem={text:lang.__('About this place,'),icon:stmap.icon.getURL("markerIconURL")};var resultLandmark=stmap.api.landmarkValid();var landmarkValid=0;var dialogH=200;resultLandmark.done(function(message){if(message.valid!==undefined){if(message.valid==1){landmarkValid=1;dialogH=290;}}});var onClick=function(){var win=null;lonlat=lonlat.clone().transform(stmap.map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326"));Ext.Ajax.request({url:stmap.api.url.pointInfoURL,params:'lon='+lonlat["lon"]+'&lat='+lonlat["lat"]+'&_csrf='+SaigaiTask.ajaxcsrfToken,success:function(param){var result=JSON.parse(param.responseText);var formPanel;if(landmarkValid==1){formPanel=Ext.create('Ext.form.Panel',{xtype:'form',autoScroll:true,items:[{xtype:'fieldset',title:lang.__('About this place,'),margin:'5',defaults:{xtype:'displayfield',margin:'3',labelWidth:100,width:260},items:result},{xtype:'fieldset',title:lang.__('Register landmark'),margin:'5',items:[{xtype:'textfield',fieldLabel:lang.__('Landmark name'),name:'landmark',width:250},{xtype:'button',text:lang.__('Registration'),width:50,handler:function(){var landmarkVal=formPanel.getForm().findField('landmark').getValue();if(landmarkVal.length>0){var result=stmap.api.landmarkRegist(landmarkVal,lonlat["lon"],lonlat["lat"]);result.done(function(message){if(message.error===undefined){alert(lang.__('{0} registered.',message.landmark));}else{alert(message.error);}});result.fail(function(message){alert(lang.__("Failed to register landmark."));});win.close();}else{alert(lang.__("Enter the name of landmark to be registered"));}}}]}]});}else{formPanel=Ext.create('Ext.form.Panel',{xtype:'form',autoScroll:true,items:[{xtype:'fieldset',title:lang.__('About this place,'),margin:'5',defaults:{xtype:'displayfield',margin:'3',labelWidth:100,width:260},items:result}]});}
if(!!me.window)me.window.close();win=me.window=Ext.create('Ext.window.Window',{title:lang.__('About this place,'),width:300,height:dialogH,maxWidth:document.body.clientWidth,maxHeight:document.body.clientHeight,layout:'fit',items:formPanel,buttons:[{text:lang.__('Close'),handler:function(){win.close();}}]});win.show();},callback:function(){}});};jQuery.extend(menuItem,{listeners:{click:function(menu,item,e,eOpts){onClick();}}});return menuItem;},createTransparencyMenuItem:function(layerInfo,record){var me=this;var stmap=me.stmap;var menuItem={text:lang.__('Transmittance change'),icon:stmap.icon.getURL("transparencyURL"),listeners:{click:function(){var form=Ext.create('Ext.form.Panel',{xtype:'form',autoScroll:true,items:[{xtype:'combo',name:'transparency',fieldLabel:lang.__('Transmittance'),store:{fields:['name','value'],data:[{"name":lang.__("0%(nontransparent)"),"value":"1.0"},{"name":"10%","value":"0.9"},{"name":"20%","value":"0.8"},{"name":"30%","value":"0.7"},{"name":"40%","value":"0.6"},{"name":"50%","value":"0.5"},{"name":"60%","value":"0.4"},{"name":"70%","value":"0.3"},{"name":"80%","value":"0.2"},{"name":"90%","value":"0.1"}]},queryMode:'local',displayField:'name',valueField:'value',value:Math.round((1-layerInfo.opacity)*100)+'%'}],buttons:[{text:lang.__('Proceed'),handler:function(){var opacity=form.getValues().transparency;var layerInfos=[layerInfo];if(!!layerInfo.children&&layerInfo.children.length>0){layerInfos=layerInfos.concat(layerInfo.children);}
var records=[];for(var idx in layerInfos){var linfo=layerInfos[idx];linfo.opacity=opacity;var l=linfo.getLayer();if(l!=null&&l.opacity!=opacity)l.setOpacity(opacity);var record={state:"update",menuinfoid:SaigaiTask.Page.menuInfo.id,layeropacity:opacity};if(SaigaiTask.Map.Layer.Type.isExternalmapLayerType(linfo.type)){if(!linfo.metadataid)continue;record.metadataid=linfo.metadataid;record.sessionExternalMapLayer=linfo.layerId.indexOf("extmap_session")==0;}
else{record.layerId=linfo.layerId;}
records.push(record);}
jQuery.ajax(SaigaiTask.contextPath+"/page/map/sessionMetadata",{headers:{"X-CSRF-Token":'${cookie.JSESSIONID.value}'},async:false,type:"post",data:{records:JSON.stringify(records)},success:function(data,textStatus,jqXHR){},error:function(jqXHR,status,errorThrown){console.error(errorThrown);}});console.log(form.getValues().transparency);win.close();},},{text:lang.__('Close'),handler:function(){win.close();}}]});if(!!me.window)me.window.close();win=me.window=Ext.create('Ext.window.Window',{title:lang.__('Transmittance change'),width:300,height:100,maxWidth:document.body.clientWidth,maxHeight:document.body.clientHeight,layout:'fit',items:form});win.show();}}};return menuItem;}};SaigaiTask.Map.view.ContentsPopup=new OpenLayers.Class(SaigaiTask.Map.view.Popup,{stmap:null,layerInfo:null,initialize:function(stmap){this.stmap=stmap;},show:function(layerId,fid,result,center,bbox,options){var me=this;var stmap=me.stmap;var items=new Array();var pinned=false;if(typeof options!='undefined'){pinned=options.pinned;}
if((typeof center=='undefined'||center==null)&&result.geom[0]!=null){var wkt=result.geom[0];try{var wktFormat=new OpenLayers.Format.WKT();var feature=wktFormat.read(wkt);var centroid=feature.geometry.getCentroid();center=new OpenLayers.LonLat(centroid.x,centroid.y);stmap.setCenter(center.clone());}catch(e){alert(lang.__("Unable to get position info."));console.error(lang.__("Failed to get position info :")+layerId+"."+fid);console.error(e);return;}}
var layerInfo=me.layerInfo=stmap.getLayerInfo(layerId);var layer=layerInfo.getLayer();var title=null;if(layerInfo!=null)title=layerInfo.name;var layout="vbox";var hbox={xtype:'container',layout:layout,width:0,items:[]};var hboxContainerObj=Ext.create('Ext.container.Container',hbox);var files=result.files;if(files&&0<files.length){if(hboxContainerObj.layout.type=="hbox"){var imgContainerWidth=256;var extImgContainer={xtype:'container',width:imgContainerWidth,style:{'text-align':'center',cursor:'pointer'}};var extImgContainerObj=Ext.create('Ext.container.Container',extImgContainer);hboxContainerObj.add(extImgContainerObj);hbox.width+=extImgContainer.width;var maxw=imgContainerWidth;var maxh=maxw;var filesIdx=0;while(filesIdx<files.length){var server=stmap.ecommaps[0].ecommapURL+'/..';var fileURL=files[filesIdx];if(fileURL.indexOf('http')==-1)fileURL=server+fileURL;var fileTitle=files[filesIdx+1];var extImgObj=stmap.createImg(fileURL,fileTitle,maxw,maxh);extImgContainerObj.add(extImgObj);filesIdx+=2;}}}
var attrs=result.attrs;var editable=false;if(typeof layerInfo.editable!="undefined"){editable=layerInfo.editable;}
var editablePopup=false;if(editable&&editablePopup){var contentsFormPanel=new SaigaiTask.Map.view.ContentsFormPanel(stmap,layerId,null,fid,content);var width=250;contentsFormPanel.formPanel.setWidth(width);hboxContainerObj.add(contentsFormPanel.formPanel);hbox.width+=width;}
else{var grid=me.createAttrGrid(attrs,layerInfo);hboxContainerObj.add(grid);hbox.width+=grid.width;}
var files=result.files;if(files&&0<files.length){if(hboxContainerObj.layout.type=="vbox"){var contentsFileFormPanel=me.contentsFileFormPanel=new SaigaiTask.Map.view.ContentsFileFormPanel(stmap,result,{mid:stmap.mapId,layerId:layerId,fid:fid,editable:false});var imagesViewPanel=contentsFileFormPanel.formPanel;imagesViewPanel.setWidth(250);hboxContainerObj.add(imagesViewPanel);}}
items.push(hboxContainerObj);if(typeof options!='undefined'&&options['fromList']){var button=Ext.create("Ext.Button",{text:lang.__("Return to list<!--2-->"),scale:'small',handler:function(){if(stmap.popupManager!=null){stmap.popupManager.close(me.popup);}
stmap.clickSearch(center,bbox,me.popup.pinned);return false;}});items.push(button);}
var map=stmap.map;if(stmap.popupManager!=null){stmap.popupManager.closeAll();}
var externalData=result.external;var toolbarData={buttons:[]};if(externalData){toolbarData=externalData.toolbar;}
else{for(var idx=0;idx<attrs.length;idx++){var attr=attrs[idx];var attrId=attr.attrId;var value=attr.attrValue;var attrInfo=layerInfo.getAttrInfo(attrId);if(attrInfo==null||attrInfo.buttonData==null)continue;var buttonData={url:value};SaigaiTask.Map.extend(buttonData,attrInfo.buttonData);toolbarData.buttons.push(buttonData);}}
if(editable){if(typeof toolbarData.buttons=="undefined"){toolbarData.buttons=[];}
var deleteButton={text:lang.__("Delete"),icon:stmap.icon.getURL("deleteIconURL"),handler:function(){if(!!SaigaiTask.PageURL.getTime()){alert(lang.__("Can't delete during time set."));return;}
if(confirm(lang.__("Are you sure to delete?"))){stmap.api.deleteContent(layerId,fid,function(){if(stmap.popupManager!=null){stmap.popupManager.close(me.popup);}
if(layer!=null){layer.refreshParams({nocache:true});}
stmap.events.triggerEvent(stmap.EventType.successcontentsdelete,{contentsPopup:me,layerInfo:layerInfo});});}}};if(editablePopup){toolbarData.buttons.push({text:lang.__("Save"),icon:stmap.icon.getURL("editIconURL"),handler:function(){contentsFormPanel.submit();}});toolbarData.buttons.push(deleteButton);}
else{toolbarData.buttons.push({text:lang.__("Edit"),icon:stmap.icon.getURL("editIconURL"),handler:function(){if(stmap.popupManager!=null){if(!!SaigaiTask.PageURL.getTime()){alert(lang.__("Can't edit during time set."));return;}
var wkt=result.geom[0];var wktFormat=new OpenLayers.Format.WKT();var feature=wktFormat.read(wkt);stmap.popupManager.close(me.popup);new SaigaiTask.Map.view.ContentsFormWindow({stmap:stmap,layerInfo:layerInfo,fid:fid,lonlat:center,feature:feature,content:result});}}});toolbarData.buttons.push(deleteButton);}}
var option={map:stmap,olmap:map,center:center,items:items,toolbarData:toolbarData,panelWidth:hbox.width,layerId:layerId,featureId:fid,title:title,pinned:pinned,metadataId:layerInfo.metadataid,searchButtonInfo:{url:stmap.api.url.contentsSearchURL,mid:stmap.mapId,contentsLayers:stmap.ecommaps[0].contentsLayers,featureInfo:result}};stmap.events.triggerEvent(stmap.EventType.beforeshowcontentpopup,{options:option});me.showExtPopup(option);me.popup.popupParam=layerId+"."+fid;},createDeleteButton:function(){},createAttrGrid:function(attrs,layerInfo){var grid=null;if(attrs){var data=(function(attrs){var data=new Array();for(var idx=0;idx<attrs.length;idx++){var attr=attrs[idx];var attrId=attr.attrId;var attrInfo=!!layerInfo?layerInfo.getAttrInfo(attrId):null;var name=attr.attrName;if(attrInfo!=null){name=attrInfo.name;}
var value=attr.attrValue;var jsonDataExps=null;try{jsonDataExps=jQuery.parseJSON(attrInfo.dataExp)}catch(e){}
if(jsonDataExps!=null){for(var jsonDataExpsIdx in jsonDataExps){var jsonDataExp=jsonDataExps[jsonDataExpsIdx];if(typeof jsonDataExp[attr.attrValue]!="undefined"){value=jsonDataExp[attr.attrValue];break;}}}
if(!!layerInfo&&!layerInfo.isVisibleAttr(attrId))continue;data.push({attrId:attrId,name:name,value:value});}
return data;})(attrs);if(!!layerInfo){for(var idx in layerInfo.attrInfos){var attrInfo=layerInfo.attrInfos[idx];var attrId=attrInfo.attrId;if(layerInfo.isVisibleAttr(attrId)){var exist=false;for(var idx2 in data){var attr=data[idx2];if(attr.attrId==attrId){exist=true;break;}}
if(!exist){data.push({attrId:attrId,name:attrInfo.name,value:null});}}}}
if(!!layerInfo){data.sort(function(attr1,attr2){return layerInfo.evalAttrSort(attr1.attrId,attr2.attrId);});}
Ext.define('ContentsAttrModel',{extend:'Ext.data.Model',fields:[{name:'attrId',type:'text'},{name:'name',type:'text'},{name:'value',type:'text'}]});var store=Ext.create("Ext.data.Store",{model:'ContentsAttrModel',data:data});grid=Ext.create("Ext.grid.Panel",{store:store,width:250,cls:"attrgridpanel",columns:[{text:lang.__('Attribute ID'),dataIndex:'attrId',flex:1,sortable:false,hidden:true},{text:lang.__('Attribute'),dataIndex:'name',flex:1,sortable:false},{text:lang.__('Value'),dataIndex:'value',flex:2,sortable:false}],viewConfig:{getRowClass:function(record,rowIndex,rowParams,store){var classes=[];var attrId=record.data.attrId;var attrInfo=!!layerInfo?layerInfo.getAttrInfo(attrId):null;if(attrInfo!=null&&attrInfo.highlight==true){return"highlight";}
return null;}}});}
return grid;}});OpenLayers.Control.ScaleBar=OpenLayers.Class(OpenLayers.Control,{element:null,scale:1,displaySystem:'metric',minWidth:100,maxWidth:200,divisions:2,subdivisions:2,showMinorMeasures:false,abbreviateLabel:true,singleLine:false,align:'left',div:null,scaleText:"scale 1/",thousandsSeparator:"",measurementProperties:{english:{units:['mile','feet','inche'],abbr:['mi','ft','in'],inches:[63360,12,1]},metric:{units:['kilometer','meter','centimeter'],abbr:['km','m','cm'],inches:[39370.07874,39.370079,0.393701]}},limitedStyle:false,customStyles:null,defaultStyles:{},appliedStyles:null,initialize:function(options){OpenLayers.Control.prototype.initialize.apply(this,[options]);if(!document.styleSheets){this.limitedStyle=true;}
if(this.limitedStyle){this.appliedStyles=OpenLayers.Util.extend({},this.defaultStyles);OpenLayers.Util.extend(this.appliedStyles,this.customStyles);}
this.element=document.createElement('div');this.element.style.position='relative';this.element.className=this.displayClass+'Wrapper';this.labelContainer=document.createElement('div');this.labelContainer.className=this.displayClass+'Units';this.labelContainer.style.position='absolute';this.graphicsContainer=document.createElement('div');this.graphicsContainer.style.position='absolute';this.graphicsContainer.className=this.displayClass+'Graphics';this.numbersContainer=document.createElement('div');this.numbersContainer.style.position='absolute';this.numbersContainer.className=this.displayClass+'Numbers';this.element.appendChild(this.graphicsContainer);this.element.appendChild(this.labelContainer);this.element.appendChild(this.numbersContainer);},destroy:function(){this.map.events.unregister('moveend',this,this.onMoveend);this.div.innerHTML="";OpenLayers.Control.prototype.destroy.apply(this);},draw:function(){OpenLayers.Control.prototype.draw.apply(this,arguments);this.dxMarkerMajor=(this.styleValue('MarkerMajor','borderLeftWidth')+
this.styleValue('MarkerMajor','width')+
this.styleValue('MarkerMajor','borderRightWidth'))/2;this.dxMarkerMinor=(this.styleValue('MarkerMinor','borderLeftWidth')+
this.styleValue('MarkerMinor','width')+
this.styleValue('MarkerMinor','borderRightWidth'))/2;this.dxBar=(this.styleValue('Bar','borderLeftWidth')+
this.styleValue('Bar','borderRightWidth'))/2;this.dxBarAlt=(this.styleValue('BarAlt','borderLeftWidth')+
this.styleValue('BarAlt','borderRightWidth'))/2;this.dxNumbersBox=this.styleValue('NumbersBox','width')/2;var classNames=['Bar','BarAlt','MarkerMajor','MarkerMinor'];if(this.singleLine){classNames.push('LabelBoxSingleLine');}else{classNames.push('NumbersBox','LabelBox');}
var vertDisp=0;for(var classIndex=0;classIndex<classNames.length;++classIndex){var cls=classNames[classIndex];vertDisp=Math.max(vertDisp,this.styleValue(cls,'top')+this.styleValue(cls,'height'));}
this.element.style.height=vertDisp+'px';this.xOffsetSingleLine=this.styleValue('LabelBoxSingleLine','width')+
this.styleValue('LabelBoxSingleLine','left');this.div.appendChild(this.element);this.map.events.register('moveend',this,this.onMoveend);this.update();return this.div;},onMoveend:function(){this.update();},update:function(scale){if(this.map.baseLayer==null||!this.map.getScale()){return;}
this.scale=(scale!=undefined)?scale:this.map.getScale();this.element.title=this.scaleText+OpenLayers.Number.format(this.scale);this.element.style.width=this.maxWidth+'px';var c=this.map.getCenter();if(this.map.displayProjection&&this.map.getProjectionObject().getCode()!="EPSG:4326"){c.transform(this.map.getProjectionObject(),this.map.displayProjection);}
var latRate=Math.cos(c.lat/180*Math.PI);var comp=this.getComp(latRate);this.setSubProps(comp);if(!this.subProps)return;this.subProps.pixels/=latRate;this.labelContainer.innerHTML="";this.graphicsContainer.innerHTML="";this.numbersContainer.innerHTML="";var numDiv=this.divisions*this.subdivisions;var alignmentOffset={left:0+(this.singleLine?0:this.dxNumbersBox),center:(this.maxWidth/2)-
(numDiv*this.subProps.pixels/2)-
(this.singleLine?this.xOffsetSingleLine/2:0),right:this.maxWidth-
(numDiv*this.subProps.pixels)-
(this.singleLine?this.xOffsetSingleLine:this.dxNumbersBox)};var xPos,measure,divNum,cls,left;for(var di=0;di<this.divisions;++di){xPos=di*this.subdivisions*this.subProps.pixels+
alignmentOffset[this.align];this.graphicsContainer.appendChild(this.createElement("MarkerMajor"," ",xPos-this.dxMarkerMajor));if(!this.singleLine){measure=(di==0)?0:OpenLayers.Number.format((di*this.subdivisions)*this.subProps.length,this.subProps.dec,this.thousandsSeparator);this.drawNumbersBox(measure,xPos);}
for(var si=0;si<this.subdivisions;++si){if((si%2)==0){cls="Bar";left=xPos-this.dxBar;}else{cls="BarAlt";left=xPos-this.dxBarAlt;}
this.graphicsContainer.appendChild(this.createElement(cls," ",left,this.subProps.pixels));if(si<this.subdivisions-1){divNum=(di*this.subdivisions)+si+1;xPos=divNum*this.subProps.pixels+
alignmentOffset[this.align];this.graphicsContainer.appendChild(this.createElement("MarkerMinor"," ",xPos-this.dxMarkerMinor));if(this.showMinorMeasures&&!this.singleLine){measure=divNum*this.subProps.length;this.drawNumbersBox(measure,xPos);}}}}
xPos=numDiv*this.subProps.pixels;xPos+=alignmentOffset[this.align];this.graphicsContainer.appendChild(this.createElement("MarkerMajor"," ",xPos-this.dxMarkerMajor));measure=OpenLayers.Number.format(numDiv*this.subProps.length,this.subProps.dec,this.thousandsSeparator)+" "+this.subProps.abbr;if(!this.singleLine){this.drawNumbersBox(measure,xPos);}},drawNumbersBox:function(measure,xPos){this.numbersContainer.appendChild(this.createElement("NumbersBoxBgUp",measure,xPos-this.dxNumbersBox-1));this.numbersContainer.appendChild(this.createElement("NumbersBoxBgUp",measure,xPos-this.dxNumbersBox+1));this.numbersContainer.appendChild(this.createElement("NumbersBoxBg",measure,xPos-this.dxNumbersBox-1));this.numbersContainer.appendChild(this.createElement("NumbersBoxBg",measure,xPos-this.dxNumbersBox+1));this.numbersContainer.appendChild(this.createElement("NumbersBox",measure,xPos-this.dxNumbersBox));},createElement:function(cls,text,left,width){var element=document.createElement("div");element.className=this.displayClass+cls;OpenLayers.Util.extend(element.style,{position:"absolute",textAlign:"center",overflow:"hidden",left:Math.floor(left)+"px"});element.appendChild(document.createTextNode(text));if(width){element.style.width=Math.round(width)+"px";}
return element;},getComp:function(rate){var system=this.measurementProperties[this.displaySystem];var numUnits=system.units.length;var comp=new Array(numUnits);var numDiv=this.divisions*this.subdivisions;for(var unitIndex=0;unitIndex<numUnits;++unitIndex){comp[unitIndex]={};var ppdu=OpenLayers.DOTS_PER_INCH*system.inches[unitIndex]/this.scale;var minSDDisplayLength=((this.minWidth*rate-this.dxNumbersBox)/ppdu)/numDiv;var maxSDDisplayLength=((this.maxWidth*rate-this.dxNumbersBox)/ppdu)/numDiv;for(var vi=0;vi<numDiv;++vi){var minNumber=minSDDisplayLength*(vi+1);var maxNumber=maxSDDisplayLength*(vi+1);var num=this.getHandsomeNumber(minNumber,maxNumber);var compNum={value:(num.value/(vi+1)),score:0,tie:0,dec:0,displayed:0};for(var vi2=0;vi2<numDiv;++vi2){var position=num.value*(vi2+1)/(vi+1);var num2=this.getHandsomeNumber(position,position);var major=((vi2+1)%this.subdivisions==0);var last=((vi2+1)==numDiv);if((this.singleLine&&last)||(!this.singleLine&&(major||this.showMinorMeasures))){compNum.score+=num2.score;compNum.tie+=num2.tie;compNum.dec=Math.max(compNum.dec,num2.dec);compNum.displayed+=1;}else{compNum.score+=num2.score/this.subdivisions;compNum.tie+=num2.tie/this.subdivisions;}}
compNum.score*=(unitIndex+1)*compNum.tie/compNum.displayed;comp[unitIndex][vi]=compNum;}}
return comp;},setSubProps:function(comp){var system=this.measurementProperties[this.displaySystem];var score=Number.POSITIVE_INFINITY;var tie=Number.POSITIVE_INFINITY;for(var unitIndex=0;unitIndex<comp.length;++unitIndex){var ppdu=OpenLayers.DOTS_PER_INCH*system.inches[unitIndex]/this.scale;for(var vi in comp[unitIndex]){var compNum=comp[unitIndex][vi];if(compNum.value>=0.33&&(compNum.value<330||unitIndex==0)){this.subProps={length:compNum.value,pixels:ppdu*compNum.value,units:system.units[unitIndex],abbr:system.abbr[unitIndex],dec:compNum.dec};score=compNum.score;tie=compNum.tie;break;}}}},styleValue:function(selector,key){var value=0;if(this.limitedStyle){value=this.appliedStyles[selector][key];}else{selector="."+this.displayClass+selector;rules:for(var i=document.styleSheets.length-1;i>=0;--i){var sheet=document.styleSheets[i];if(!sheet.disabled){var allRules;try{if(typeof(sheet.cssRules)=='undefined'){if(typeof(sheet.rules)=='undefined'){continue;}else{allRules=sheet.rules;}}else{allRules=sheet.cssRules;}}catch(err){continue;}
if(allRules&&allRules.length){for(var ruleIndex=0;ruleIndex<allRules.length;++ruleIndex){var rule=allRules[ruleIndex];if(rule.selectorText&&(rule.selectorText.toLowerCase()==selector.toLowerCase())){if(rule.style[key]!=''){value=parseInt(rule.style[key]);break rules;}}}}}}}
return value?value:0;},getHandsomeNumber:function(small,big,sigFigs){sigFigs=(sigFigs==null)?10:sigFigs;var num={value:small,score:Number.POSITIVE_INFINITY,tie:Number.POSITIVE_INFINITY,dec:3};var cmult,max,dec,tmult,multiplier,score,tie;for(var hexp=0;hexp<3;++hexp){cmult=Math.pow(2,(-1*hexp));max=Math.floor(Math.log(big/cmult)/Math.LN10);for(var texp=max;texp>(max-sigFigs+1);--texp){dec=Math.max(hexp-texp,0);tmult=cmult*Math.pow(10,texp);if((tmult*Math.floor(big/tmult))>=small){if(small%tmult==0){multiplier=small/tmult;}else{multiplier=Math.floor(small/tmult)+1;}
score=multiplier+(2*hexp);tie=(texp<0)?(Math.abs(texp)+1):texp;if((score<num.score)||((score==num.score)&&(tie<num.tie))){num.value=parseFloat((tmult*multiplier).toFixed(dec));num.score=score;num.tie=tie;num.dec=dec;}}}}
return num;},CLASS_NAME:"OpenLayers.Control.ScaleBar"});SaigaiTask.Map.control.DrawLayerHistoryControl=new OpenLayers.Class(OpenLayers.Control,{drawLayer:null,stack:null,stackIndex:null,ignoreSave:null,initialize:function(drawLayer){var me=this;me.drawLayer=drawLayer;me.clear();me.ignoreSave=true;var layer=drawLayer.layer;layer.events.on({"featureadded":function(evt){if(!me.ignoreSave){me.save({type:evt.type,operation:"add",feature:evt.feature});}},"featureremoved":function(evt){if(!me.ignoreSave){me.save({type:evt.type,operation:"remove",feature:evt.feature});}},"featuremodified":function(evt){if(!me.ignoreSave){me.save({type:evt.type,operation:"modify",feature:evt.feature,beforeFeature:evt.beforeFeature,afterFeature:evt.afterFeature});}},"featuremoved":function(evt){if(!me.ignoreSave){me.save({type:evt.type,operation:"modify",feature:evt.feature,beforeFeature:evt.beforeFeature,afterFeature:evt.afterFeature});}}});},startHistory:function(){this.ignoreSave=false;},stopHistory:function(){this.ignoreSave=true;},clear:function(){var me=this;me.stack=[];me.stackIndex=me.stack.length-1;console.debug("clear: -1");me.drawLayer.layer.events.triggerEvent("historychange",{historyControl:me,operation:"clear"});},save:function(info){var me=this;if(me.stackIndex!=me.stack.length-1){if(0<me.stackIndex)me.stack=me.stack.slice(0,me.stackIndex+1);else me.stack=[];}
me.stack.push(info);me.stackIndex=me.stack.length-1;console.debug("save: "+me.stackIndex);me.drawLayer.layer.events.triggerEvent("historychange",{historyControl:me,operation:"save"});},undo:function(){var me=this;if(0<=me.stackIndex){var undoIndex=me.stackIndex;var info=me.stack[undoIndex];var layer=me.drawLayer.layer;me.stopHistory();switch(info.operation){case"add":layer.removeFeatures([info.feature]);break;case"remove":layer.addFeatures([info.feature]);break;case"modify":layer.removeFeatures([info.feature]);info.feature.geometry=info.beforeFeature.geometry.clone();info.feature.style=$.extend({},info.beforeFeature.style);info.feature.attributes=$.extend({},info.beforeFeature.attributes);layer.addFeatures([info.feature]);break;}
me.startHistory();me.stackIndex--;console.debug("undo: "+me.stackIndex+"/"+(me.stack.length-1));me.drawLayer.layer.events.triggerEvent("historychange",{historyControl:me,operation:"undo",feature:info.feature});return true;}
return false;},redo:function(){var me=this;if(me.stackIndex<me.stack.length-1){var redoIndex=me.stackIndex+1;var info=me.stack[redoIndex];var layer=me.drawLayer.layer;me.stopHistory();switch(info.operation){case"add":layer.addFeatures([info.feature]);break;case"remove":layer.removeFeatures([info.feature]);break;case"modify":layer.removeFeatures([info.feature]);info.feature.geometry=info.afterFeature.geometry.clone();info.feature.style=$.extend({},info.afterFeature.style);info.feature.attributes=$.extend({},info.afterFeature.attributes);layer.addFeatures([info.feature]);break;}
me.startHistory();me.stackIndex++;console.debug("redo: "+me.stackIndex+"/"+(me.stack.length-1));me.drawLayer.layer.events.triggerEvent("historychange",{historyControl:me,operation:"redo",feature:info.feature});return true;}
return false;}});SaigaiTask.Map.view.SpatialSearchResult=function(){this.initialize.apply(this,arguments);};SaigaiTask.Map.view.SpatialSearchResult.prototype={grid:null,gridEvents:{popup:true},limitCombo:null,pagingTbar:null,pagingTbarEvents:{movefirst:true,movelast:true,movenext:true,moveprevious:true},initialize:function(){var store=Ext.create("Ext.data.Store",{fields:[],data:[]});var columns=[];var pagingTbar=null;pagingTbar=Ext.create('Ext.PagingToolbar',{store:store,displayInfo:true,displayMsg:lang.__('{0} - {1} / {2}items'),emptyMsg:lang.__("No match info."),moveFirst:function(){pagingTbar.fireEvent('movefirst');},moveLast:function(){pagingTbar.fireEvent('movelast');},moveNext:function(){pagingTbar.fireEvent('movenext');},movePrevious:function(){pagingTbar.fireEvent('moveprevious');}});pagingTbar.addEvents(this.pagingTbarEvents);var grid=null;grid=Ext.create("Ext.grid.Panel",{autoScroll:true,scroll:"vertical",scrollDelta:400,store:store,columns:columns,bbar:pagingTbar});grid.addEvents(this.gridEvents);var limitCombo=Ext.create("Ext.form.field.ComboBox",{name:'limit',width:80,allowBlank:false,store:new Ext.data.SimpleStore({data:[[10,lang.__('10 items')],[20,lang.__('20 items')],[30,lang.__('30 items')],[40,lang.__('40 items')],[50,lang.__('50 items')]],fields:['limit','text']}),value:20,valueField:'limit',displayField:'text',editable:false,listeners:{select:function(combo,records,eOps){var limit=combo.value;store.pageSize=limit;store.load();}}});var tbar=Ext.create("Ext.toolbar.Toolbar",{items:[{xtype:'label',text:lang.__('Item:<!--2-->'),margin:"0 5 0 5"},limitCombo]});grid.addDocked(tbar);this.grid=grid;this.limitCombo=limitCombo;this.pagingTbar=pagingTbar;return grid;},empty:function(){var me=this;var pagingTbar=me.pagingTbar;var store=pagingTbar.store;store.loadData([]);store.totalCount=0;store.currentPage=1;pagingTbar.onLoad();},load:function(searchResult){var me=this;var counts=searchResult.counts;var features=searchResult.features;if(counts.total==0||features.length==0){me.empty();return null;}
var attrNames=features[0].getAttributeNames();var fields=[];for(var attrNamesIdx in attrNames){fields.push(attrNamesIdx);}
var data=[];for(var featuresIdx in features){var feature=features[featuresIdx];var d=feature.getAttributeValues();d.feature=feature;data.push(d);}
var store=Ext.create("Ext.data.Store",{fields:fields,data:data,pageSize:counts.limit});store.totalCount=counts.total;store.currentPage=counts.offset/counts.limit+1;var columns=[];for(var attrNamesIdx in attrNames){var attrName=attrNames[attrNamesIdx];columns.push({text:attrName,dataIndex:attrNamesIdx,flex:1});}
var grid=this.grid;columns.push({xtype:'actioncolumn',width:25,items:[{getClass:function(v,meta,rec){return'map-icon pointer';},handler:function(grid,rowIndex,colIndex){var rec=grid.getStore().getAt(rowIndex);var feature=rec.raw.feature;me.doPopup(feature.layerId,feature.featureId);}}]});grid.reconfigure(store,columns);var pagingTbar=this.pagingTbar;pagingTbar.store=store;pagingTbar.onLoad();},show:function(searchResult){var grid=this.get(searchResult);if(grid){var win=Ext.create("Ext.window.Window",{title:lang.__('Search result'),layout:'fit',items:[grid]});win.show();}},doPopup:function(layerId,featureId){this.grid.fireEvent('popup',layerId,featureId);}};SaigaiTask.Map.Layer.Group=new OpenLayers.Class({layerInfo:null,initialize:function(layerInfo){var me=this;me.layerInfo=layerInfo;layerInfo.layer=null;}});SaigaiTask.Map.Layer.Group.type=SaigaiTask.Map.Layer.Type.GROUP;OpenLayers.Renderer.prototype.drawFeature=function(feature,style)
{try{if(style==null){style=feature.style;if(style==null)style={};}
if(feature.geometry){var res=this.getResolution();if(style.memo&&style.label){var point;var rate=1;try{feature.attributes.option=dojo.fromJson(feature.attributes.description);}catch(e){feature.attributes.option={};}
var option=feature.attributes.option;if(option.reso){rate=option.reso/res;}
var offsetX=0;var offsetY=0;if(option.anchor){}
var rendered=false;var padding=(parseInt(feature.style.strokeWidth)/2+2)*res*rate;point=feature.geometry.getCentroid();if(style.fillColor){var x=point.x;var y=point.y;var w=style.graphicWidth*res*rate+padding*2;var h=style.graphicHeight*res*rate;if(feature.bgRect){var points=feature.bgRect.components[0].components;points[0].x=x;points[0].y=y;points[1].x=x+w;points[1].y=y;points[2].x=x+w;points[2].y=y-h;points[3].x=x;points[3].y=y-h;points[4].x=x;points[4].y=y;}
else{feature.bgRect=new OpenLayers.Geometry.Polygon([new OpenLayers.Geometry.LinearRing([new OpenLayers.Geometry.Point(x,y),new OpenLayers.Geometry.Point(x+w,y),new OpenLayers.Geometry.Point(x+w,y-h),new OpenLayers.Geometry.Point(x,y-h),new OpenLayers.Geometry.Point(x,y)])]);}
rendered=this.drawGeometry(feature.bgRect,style,feature.id);}else{if(feature.bgRect){this.eraseGeometry(feature.bgRect);feature.bgRect=null;}}
if(rendered!==false){var labelBak=style.label;var lines=style.label.split("\\n");var orgFontSize=style.fontSize;style.fontSize=(parseFloat(style.fontSize)||14)*rate;style.label=lines[0];if(/Edge/.test(navigator.userAgent)||(dojo.isIE>=9&&document.documentMode>=9))point.move(0,-style.fontSize*res*1.08);else if(dojo.isChrome>=50)point.move(0,-style.fontSize*res*0.3);point.move(padding,0);this.drawText(feature.id,style,point);for(var i=1;i<lines.length;i++){style.label=lines[i];point.move(0,-style.fontSize*res*1.05);this.drawText(feature.id+"_"+i,style,point);}
style.label=labelBak;style.fontSize=orgFontSize;}else{this.removeText(feature.id);if(feature.bgRect){this.eraseGeometry(feature.bgRect);feature.bgRect=null;}
if(feature.style&&feature.style.label){var label=feature.style.label;var lineCount=1;var start=-1;while((start=label.indexOf("\\n",start+1))!=-1){lineCount++;}
for(var j=1;j<lineCount;j++){this.removeText(feature.id+"_"+j);}}}
return rendered;}else{var bounds=feature.geometry.getBounds();if(bounds){var worldBounds;if(this.map.baseLayer&&this.map.baseLayer.wrapDateLine){worldBounds=this.map.getMaxExtent();}
if(style.graphicWidth){bounds.left-=style.graphicWidth*res/2;bounds.right+=style.graphicWidth*res/2;}
if(style.graphicHeight){bounds.bottom-=style.graphicHeight*res/2;bounds.top+=style.graphicHeight*res/2;}
if(!bounds.intersectsBounds(this.extent,{worldBounds:worldBounds})){style={display:"none"};}else{this.calculateFeatureDx(bounds,worldBounds);}
var rendered=this.drawGeometry(feature.geometry,style,feature.id);if(style.display!="none"&&style.label&&rendered!==false){var location=feature.geometry.getCentroid();if(style.labelXOffset||style.labelYOffset){var xOffset=isNaN(style.labelXOffset)?0:style.labelXOffset;var yOffset=isNaN(style.labelYOffset)?0:style.labelYOffset;var res=this.getResolution();location.move(xOffset*res,yOffset*res);}
this.drawText(feature.id,style,location);}else{this.removeText(feature.id);}
return rendered;}}}}catch(e){console.error(e);}};OpenLayers.Renderer.SVG.prototype.drawFeature=OpenLayers.Renderer.prototype.drawFeature;OpenLayers.Renderer.VML.prototype.drawFeature=OpenLayers.Renderer.prototype.drawFeature;OpenLayers.Renderer.prototype.eraseFeatures=function(features)
{if(!(features instanceof Array)){features=[features];}
var len=features.length;for(var i=0;i<len;++i){var feature=features[i];this.eraseGeometry(feature.geometry);this.removeText(feature.id);if(feature.bgRect){this.eraseGeometry(feature.bgRect);feature.bgRect=null;}
if(feature.style&&feature.style.label){var label=feature.style.label;var lineCount=1;var start=-1;while((start=label.indexOf("\\n",start+1))!=-1){lineCount++;}
for(var j=1;j<lineCount;j++){this.removeText(feature.id+"_"+j);}}}};OpenLayers.Renderer.SVG.prototype.eraseFeatures=OpenLayers.Renderer.prototype.eraseFeatures;OpenLayers.Renderer.VML.prototype.eraseFeatures=OpenLayers.Renderer.prototype.eraseFeatures;SaigaiTask.Map.view.ContentsFormPanel=function(){this.initialize.apply(this,arguments);};SaigaiTask.Map.view.ContentsFormPanel.prototype={stmap:null,params:null,json:null,layerInfo:null,feature:null,formPanel:null,update:false,contentsFileFormPanel:null,initialize:function(stmap,layerId,feature,fid,content){var me=this;me.stmap=stmap;me.feature=feature;var json=me.json=stmap.api.getAttrInfos(layerId);var attrInfos=json.attrInfos;var attrValues={};if(content!=null){var attrs=content.attrs;for(var idx in attrs){var attr=attrs[idx];attrValues[attr.attrId]=attr.attrValue;}}
var items=[];var params=me.params={};var layerInfo=me.layerInfo=stmap.getLayerInfo(layerId);params.layer=layerInfo.layerId;var mid=layerInfo.ecommap.mapInfo.mapId;params.mid=mid;var update=false;if(typeof fid!="undefined"&&fid!=null){params.fid=fid;update=true;}
me.update=update;if(SaigaiTask.PageURL.params.drawGeometry!=true){if(attrInfos){var attrItems=[];var attrIds=params.attrIds=[];var attrInfoMap={};for(var key in attrInfos){var attrInfo=attrInfos[key];var attrId=attrInfo.attrId;attrInfoMap[attrId]=attrInfo;if(!attrId)continue;var layerAttrInfo=layerInfo.getAttrInfo(attrId);var visible=layerInfo.isVisibleAttr(attrId);var editable=layerInfo.isEditableAttr(attrId);var highlight=layerAttrInfo!=null?layerAttrInfo.highlight:false;if(update==false){editable=true;highlight=false;}
if(visible){if(typeof attrValues!="undefined"&&attrValues!=null){var attrValue=attrValues[attrId];if(typeof attrValue!="undefined"){attrInfo.value=attrValue;}}
if(layerAttrInfo!=null&&!!layerAttrInfo.name)attrInfo.name=layerAttrInfo.name;if(layerAttrInfo!=null&&!!layerAttrInfo.addAddressButton)attrInfo.addAddressButton=true;var item=me.createFormItem(attrInfo,editable,highlight);attrItems.push(item);if(editable){attrIds.push(attrId);}}}
attrItems.sort(function(attrItem1,attrItem2){var attrId1=attrItem1.name;var attrId2=attrItem2.name;return layerInfo.evalAttrSort(attrId1,attrId2);});if(0<attrItems.length){items.push({xtype:'fieldset',title:lang.__('Attribute'),layout:'anchor',defaults:{anchor:'100%'},collapsible:true,items:attrItems});}}
var contentsFileFormPanel=me.contentsFileFormPanel=new SaigaiTask.Map.view.ContentsFileFormPanel(stmap,content,{mid:mid,layerId:layerId,fid:fid,editable:true});items.push({xtype:'fieldset',title:lang.__('Attachment<!--2-->'),layout:'anchor',defaults:{anchor:'100%'},collapsible:true,items:contentsFileFormPanel.getFieldSetItems()});}
Ext.define('Fal.form.Panel',{extend:'Ext.form.Panel',markupRequired:false,initComponent:function(){this.on('beforeadd',function(me,field){var fields=[];if(field.xtype=='fieldset'){fields=field.items.items;}
else{fields.push(field);}
for(var key in fields){var f=fields[key];if(!f.allowBlank&&me.markupRequired){f.labelSeparator+='<span style="color: rgb(255, 0, 0); padding-left: 2px;">*</span>';}}});this.callParent(arguments);}});var formPanel=this.formPanel=Ext.create('Fal.form.Panel',{autoScroll:true,title:attrInfos.layerName,border:false,fieldDefaults:{labelWidth:100,anchor:'100%'},url:update?stmap.api.url.contentsUpdateURL:stmap.api.url.contentsCreateURL,markupRequired:true,defaultType:'textfield',bodyPadding:5,items:items});},createFormItem:function(attrInfo,editable,highlight){var me=this;var value=null;if(typeof attrInfo.value!="undefined"){value=attrInfo.value;}
var item={fieldLabel:attrInfo.name,name:attrInfo.attrId,value:value,allowBlank:attrInfo.nullable};if(typeof highlight=="undefined"){highlight=false;}
if(highlight){jQuery.extend(item,{border:2,style:{borderColor:'red',borderStyle:'solid'}});}
if(editable==false){item.xtype='displayfield';return item;}
switch(attrInfo.dataTypeId){case'text':var fieldClass=attrInfo.length<=20?"Ext.form.field.Text":"Ext.form.field.TextArea";item.xtype='fieldcontainer';item.combineErrors=true;item.msgTarget='side';item.layout={type:"hbox",align:"stretch"};item.defaults={hideLabel:true};item.items=[];var textField=Ext.create(fieldClass,{name:item.name,value:item.value,allowBlank:item.allowBlank,flex:1});item.items.push(textField);if(attrInfo.addAddressButton){var addressButton=Ext.create("Ext.button.Button",{xtype:"button",width:40,text:lang.__("Address"),handler:(function(textField){return function(){me.formPanel.fireEvent("clickaddressbtn",{addressBtn:this,textField:textField});};})(textField)});item.items.push(addressButton);}
break;case'integer':item.xtype='numberfield';item.allowDecimals=false;break;case'float':item.xtype='numberfield';break;case'date':item.xtype='datefield';item.format='Y/m/d';item.selectOnFocus=true;break;case'time':item.xtype='timefield';item.format=item.submitFormat='H:i:s';item.selectOnFocus=true;item.increment=10;break;case'datetime':item.xtype='fieldcontainer';item.combineErrors=true;item.msgTarget='side';item.layout='fit';item.defaults={flex:1,hideLabel:true};item.items=[];var dateValue=null;var timeValue=null;if(attrInfo.value!=null){var datetime=attrInfo.value.split(" ");for(var idx in datetime){var val=datetime[idx];if(val.match(/^\d{4}\/\d{2}\/\d{2}$/)){dateValue=val;}
if(val.match(/^\d{2}:\d{2}:\d{2}$/)){timeValue=val;}}}
var dateAttrInfo=Ext.clone(attrInfo);dateAttrInfo.dataTypeId="date";dateAttrInfo.value=dateValue;var dateItem=this.createFormItem(dateAttrInfo,editable,false);dateItem.border=0;item.items.push(dateItem);var timeAttrInfo=Ext.clone(attrInfo);timeAttrInfo.dataTypeId="time";timeAttrInfo.value=timeValue;var timeItem=this.createFormItem(timeAttrInfo,editable,false);timeItem.border=0;item.items.push(timeItem);break;case'select':item.xtype='combo';var data=[];var jsonDataExps=null;try{jsonDataExps=jQuery.parseJSON(attrInfo.dataExp)}catch(e){}
if(jsonDataExps!=null){for(var jsonDataExpsIdx in jsonDataExps){var jsonDataExp=jsonDataExps[jsonDataExpsIdx];for(var key in jsonDataExp){var val=jsonDataExp[key];data.push([key,val]);}}}
else{var dataExps=attrInfo.dataExp.split(',');for(var dataExpsKey in dataExps){var dataExp=dataExps[dataExpsKey];data.push([dataExp,dataExp]);}}
if(item.allowBlank){data.push(['','　']);}
else{if(typeof item.value=="undefined"||item.value==null||item.value==""){if(0<data.length){item.value=data[0][0];}}}
item.store=new Ext.data.SimpleStore({fields:['value','display'],data:data,autoLoad:false});item.displayField='display';item.valueField='value';item.editable=false;item.selectOnFocus=true;break;case'checkbox':if(item.value==true)item.value="○";item.xtype='checkbox';item.inputValue=attrInfo.dataExp;item.checked=item.value==item.inputValue;break;default:item.xtype='textfield';}
return item;},submit:function(optionParams){var me=this;var stmap=me.stmap;var params=me.params;var formPanel=me.formPanel;var form=formPanel.form;var layerInfo=me.layerInfo;var loadMask=new Ext.LoadMask(formPanel,{msg:lang.__("Now saving..<!--2-->")});loadMask.show();if(me.feature!=null){params.wkt=stmap.getWKT(me.feature);}
var formValues=form.getValues();for(var name in formValues){var formValue=formValues[name];if(Ext.isArray(formValue)){formValues[name]=formValue.join(" ");}
params[name]=formValues[name];}
params.fileList=JSON.stringify(me.contentsFileFormPanel.getJSONArray());var attrInfos=layerInfo.attrInfos;for(var idx in attrInfos){var attrInfo=attrInfos[idx];var attrId=attrInfo.attrId;if((me.update==false&&attrInfo.updateInserted)||(me.update&&attrInfo.updateModified)){var val=null;switch(attrInfo.dataTypeId){case'date':case'time':case'datetime':case'text':val=Ext.Date.format(new Date(),"Y/m/d H:i:s");break;case'integer':case'float':case'select':case'checkbox':default:}
if(val!=null){params[attrId]=val;params.attrIds.push(attrId);}}}
OpenLayers.Util.extend(params,optionParams);params._csrf=SaigaiTask.ajaxcsrfToken;Ext.Ajax.request({url:form.url,params:params,success:function(response,options){var result=JSON.parse(response.responseText);if(result.success){stmap.events.triggerEvent(stmap.EventType.successcontentssubmit,{contentsFormPanel:me});var layer=layerInfo.getLayer();if(layer!=null){if(typeof layer.refreshParams=="function"){return layer.refreshParams({nocache:true});}}
stmap.redrawContentsLayer(0);}
else{alert("ERROR:"+result.msg);}
if(SaigaiTask.PageURL.params.oninsertFeature.match("redirecturl:")){var oninsertFeature=SaigaiTask.PageURL.params.oninsertFeature
var url=oninsertFeature.slice(oninsertFeature.indexOf(":")+1);if(confirm(lang.__("Move to {0}",url))){location.href=url;}}else if(SaigaiTask.PageURL.params.oninsertFeature.match("close")){window.open('about:blank','_self').close()}},failure:function(){alert(lang.__("Registration not completed."));},callback:function(){loadMask.hide();}});}};OpenLayers.Format.KMLStyleUtil={parseTextMemo:function(kmlFormat,node,style){var self=this;var label=null;var list=node.parentNode.children;if(typeof list=="undefined")list=node.parentNode.childNodes;for(var idx in list){if(list[idx].nodeName=="name"){label=list[idx].textContent;break;}}
if(label!=null){style.label=label;style.memo=true;style.cursor="pointer";style.fontWeight="bold";style.labelAlign="lt";if(style.label){var fontSize=parseInt(style.fontSize);if(!fontSize)try{style.fontSize.replace(/px$/,"");}catch(e){};if(!fontSize)kmlFormat.FONTSIZE;var size=self.getLabelSize(style.label.replace(/\\n/g,"<br/>"),fontSize,style.fontWeight);style.graphicWidth=size.w;style.graphicHeight=size.h;}}},getLabelSize:function(label,fontSize,fontWeight)
{var size={w:100,h:fontSize};try{var span=document.createElement("span");span.style.position="absolute";span.style.lineHeight="105%";span.style.padding="0.15em";span.style.margin=0;span.style.fontSize=fontSize+"px";span.style.fontWeight=fontWeight;span.innerHTML=label;var dest=document.body;var elems=document.getElementsByClassName("olMap");if(0<elems.length)dest=elems[0];dest.appendChild(span);size.w=span.offsetWidth;size.h=span.offsetHeight;dest.removeChild(span);}catch(e){}
return size;}};SaigaiTask.Map.view.RakugakiWindow=function(){this.initialize.apply(this,arguments);};SaigaiTask.Map.view.RakugakiWindow.prototype={stmap:null,rakugakiControl:null,window:null,drawToolbar:null,initialize:function(option){var me=this;me.stmap=option.stmap;me.rakugakiControl=option.rakugakiControl;me.initDrawToolbar();},initDrawToolbar:function(){var me=this;var stmap=me.stmap;var headerToolbar=null;if(!!me.headerToolbar){headerToolbar=me.headerToolbar;}
else{headerToolbar=me.headerToolbar={};var headerTbar=Ext.create("Ext.toolbar.Toolbar",{docked:"top",align:"right"});headerToolbar.tbar=headerTbar;headerTbar.hide();var headerToolbar=me.headerToolbar;map.components.mainpanel.mapPanel.panel.addDocked(headerToolbar.tbar);}
var drawToolbar=me.drawToolbar=new SaigaiTask.Map.view.DrawToolbar(map,{init:false,drawFreeLine:true,drawText:true,strokeColor:true,strokeWidth:true,fillColor:true,fontColor:true,fontSize:true,modifyFeature:false,dragFeature:false,selectFeature:false,selectDragFeature:true,selectRangeFeature:true,removeSelectedFeature:true,removeFeature:true,undo:true,redo:true,maxDrawNum:Number.MAX_VALUE});drawToolbar.drawLayer.snapControl.snap.deactivate();},initEditWindow:function(){var me=this;var stmap=me.stmap;var drawToolbar=me.drawToolbar;var dockedItems=[];{var toolbarLayouts=[["drawFreeLine","strokeColor","strokeWidth"],["drawText","fontColor","fontSize","fillColor"],["selectDragFeature","selectRangeFeature","removeSelectedFeature","removeFeature","undo","redo"]];for(var toolbarLayoutsIdx in toolbarLayouts){var toolbarItems=[];var drawToolbarTypes=toolbarLayouts[toolbarLayoutsIdx];for(var key in drawToolbarTypes){var drawToolbarType=drawToolbarTypes[key];if(drawToolbarType=="-"){toolbarItems.push("-");continue;}
var tbarItems=drawToolbar.tbarItems;for(var idx in tbarItems){var item=tbarItems[idx];if(item=="-")continue;else{if(item.drawToolbarType==drawToolbarType){toolbarItems.push(item);break;}}}}
dockedItems.push({xtype:"toolbar",dock:"top",items:toolbarItems});}}
var win=null;win=me.window=Ext.create('Ext.window.Window',{title:lang.__("Memo")+lang.__("Edit"),width:420,maxWidth:document.body.clientWidth,maxHeight:document.body.clientHeight,collapsible:true,dockedItems:dockedItems,layout:'fit',closeAction:'hide',buttons:[{text:lang.__('Registration'),textAlign:"left",icon:stmap.icon.getURL("editIconURL"),handler:function(){me.rakugakiControl.save();}},{text:lang.__('Cancel'),handler:function(){win.close();}}],listeners:{hide:function(){me.rakugakiControl.cancel();}}});},showEditWindow:function(){var me=this;var stmap=me.stmap;var win=me.window;if(!win){me.initEditWindow();win=me.window;}
win.show();win.alignTo(document,"t",[-win.getWidth()/2,0]);me.drawToolbar.buttons.selectDragFeatureButton.toggle(true);me.drawToolbar.drawLayer.setSelectDragFeatureControlActivation(true);}}
SaigaiTask.Map.view.RefContentsPopup=new OpenLayers.Class(SaigaiTask.Map.view.ContentsPopup,{stmap:null,debug:false,gmlFormat:null,center:null,bbox:null,requests:null,listPopup:null,initialize:function(stmap){this.stmap=stmap;this.gmlFormat=new OpenLayers.Format.GML();},debugBbox:function(bbox){var me=this;var stmap=me.stmap;var olmap=stmap.map;if(me.debug){console.log("BBOX");var layer=new OpenLayers.Layer.Vector();var bboxGeom=new OpenLayers.Bounds(bbox[0],bbox[1],bbox[2],bbox[3]).toGeometry();bboxGeom=bboxGeom.transform(new OpenLayers.Projection("EPSG:4326"),olmap.getProjectionObject());layer.addFeatures([new OpenLayers.Feature.Vector(bboxGeom)])
stmap.map.addLayer(layer);layer.redraw();}},uniqueID:function(){var randam=Math.floor(Math.random()*1000)
var date=new Date();var time=date.getTime();return randam+time.toString();},getReferenceFeatureInfo:function(center,bbox,div,fromContents,pinned)
{var me=this;me.center=center;me.bbox=bbox;if(typeof pinned=="undefined"||pinned==null)pinned=false;try{var popupDiv=div;if(!div){popupDiv=document.createElement("div");popupDiv.className="popup_div";popupDiv.id="ref-popup-"+me.uniqueID();}
var requests=me.requests=[];var ecommap=me.stmap.ecommaps[0];var referenceLayerInfos=ecommap.getReferenceLayerInfos().concat(ecommap.getExternalMapLayerInfos());for(var idx in referenceLayerInfos){var referenceLayerInfo=referenceLayerInfos[idx];if(referenceLayerInfo.alwaysNotSearch==false&&referenceLayerInfo.searchable){requests.push({layerInfo:referenceLayerInfo,center:center,bbox:bbox,popupDiv:popupDiv,fromContents:fromContents,popupOption:{map:me.stmap,olmap:me.stmap.map,center:center,div:popupDiv,items:[],toolbarData:{buttons:[]},title:referenceLayerInfo.name,pinned:pinned}});}}
me.showReferenceListPopup(requests,pinned);for(var idx in requests){me.getReferenceFeatureInfoScope(requests[idx]);}}catch(e){console.error(e);}},showReferenceListPopup:function(requests,pinned){var me=this;var stmap=me.stmap;me.listPopup={};Ext.define('SaigaiTask.Map.view.RefContentsPopup.Result',{extend:'Ext.data.Model',fields:[{name:lang.__('Layer name'),type:'String'}]});var store=Ext.create("Ext.data.ArrayStore",{model:'SaigaiTask.Map.view.RefContentsPopup.Result'});store.addListener('add',function(view,record,item,index,e,eOpts){if(grid.store.getTotalCount()==0){if(me.popup==null){if(stmap.popupManager!=null){stmap.popupManager.closeAll();}
me.showExtPopup({title:lang.__("External map feature list"),map:me.stmap,olmap:me.stmap.map,center:requests[0].center,panelWidth:grid.width,pinned:pinned,items:[grid]});}}});var grid=me.listPopup.grid=Ext.create('Ext.grid.Panel',{store:store,stateful:true,collapsible:false,multiSelect:false,header:false,width:250,frame:false,stateId:'stateGrid',columns:[{text:lang.__("Layer name"),dataIndex:lang.__("Layer name"),flex:1}],viewConfig:{stripeRows:true,enableTextSelection:true}});grid.addListener('itemclick',function(view,record,item,index,e,eOpts){if(stmap.popupManager!=null){stmap.popupManager.closeAll();}
if(stmap.popupManager!=null){stmap.popupManager.close(me.popup);}
var request=record.raw.request;var button=Ext.create("Ext.Button",{text:lang.__("Return to list<!--2-->"),scale:'small',handler:function(){var pinned=me.popup.pinned;if(stmap.popupManager!=null){stmap.popupManager.close(me.popup);me.popup=null;}
me.getReferenceFeatureInfo(me.center,me.bbox,null,null,pinned);return false;}});request.popupOption.toolbarData.buttons.push(button);request.popupOption.pinned=me.popup.pinned;if(request.type=="gml"){me.showRefGmlFeaturePopup(request,record.raw.feature);}
else if(request.type=="html"){me.showRefHtmlPopup(request);}
else{alert("RefContentsPopup unknown request type: "+request.type);}});},getReferenceFeatureInfoScope:function(request)
{var me=this;var self=this;var stmap=self.stmap;var ecommap=stmap.ecommaps[0];var layerIds="";var featureIds="";var layerInfo=request.layerInfo;var metadataIds="";if(!layerInfo==false){var visibleLayerIds=[];var visibleFeatureIds=[];var visibleMetadataIds=[];for(var idx in layerInfo.children){var child=layerInfo.children[idx];if(child.visibility){visibleLayerIds.push(child.layerId);visibleFeatureIds.push(child.featuretypeId);visibleMetadataIds.push(child.metadataid);}}
layerIds=visibleLayerIds.join(",");featureIds=visibleFeatureIds.join(",");metadataIds=visibleMetadataIds.join(",");}
if(layerIds&&layerIds.length>0){var url=layerInfo.wmsFeatureURL!=null?layerInfo.wmsFeatureURL:layerInfo.wmsURL;url+=this.getWmsGetFeatureInfoURL(layerInfo.layerId,featureIds,request.bbox,4326,stmap.clickBuffer,stmap.clickBuffer,5);request.type="gml";request.xhr=jQuery.ajax({url:map.api.url.wfsProxyURL+encodeURIComponent(url)+"&metadataid="+metadataIds,type:"GET",async:true,cache:false,headers:{"X-CSRF-Token":SaigaiTask.csrfToken},dataType:"text",success:function(data){console.log(data);if(typeof data=="error"){console.warn("error!",args);}else{try{if(data.length>0){if(data.normalize)data.normalize();var features=request.response=[];try{features=request.response=self.gmlFormat.read(data);}catch(e){console.error(e);}
if(features.length==0||!features[0].fid){url=url.replace(/&INFO_FORMAT=.+?&/,"&INFO_FORMAT=text/html&");console.log(url);request.type="html";request.xhr=jQuery.ajax({url:map.api.url.wfsProxyURL+encodeURIComponent(url)+"&metadataid="+metadataIds,type:"GET",async:true,cache:false,dataType:"text",success:function(data){if(data){try{data=data.replace(/(<tr[^>]*?>)[^<]*<t[d|h]>[^<]*<\/t[d|h]>/g,"$1");layerIds=layerIds.split(',');for(var i=layerIds.length-1;i>=0;i--){var layerInfo=ecommap.layerInfoStore[layerIds[i]];console.log(layerIds[i]);console.log(layerInfo);if(layerInfo&&layerInfo.featuretypeId)
data=data.replace(">"+layerInfo.featuretypeId.split(":")[1]+"<",">"+SaigaiTask.Map.util.CommonUtil.escapeXml(layerInfo.name)+"<");}}catch(e){console.error(e);}
request.response=data;if(me.requests.length==1){self.showRefHtmlPopup(request);}
else{if(data=="<html></html>"){}
else{var raw={};var raw={request:request};raw[lang.__("Layer name")]=request.layerInfo.name;var result=SaigaiTask.Map.view.RefContentsPopup.Result.create(raw);result.raw=raw;me.listPopup.grid.store.add(result);}}}}});}else{if(me.requests.length==1&&features.length==1){self.showRefGmlPopup(request);}
else{for(var idx in features){var feature=features[idx];var raw={request:request,feature:feature};raw[lang.__("Layer name")]=request.layerInfo.name;try{if(feature.fid!=null){var fidElems=feature.fid.split(".");if(fidElems.length==2){var featureLayerId=fidElems[0];var featureLayerName=null;for(var idx in layerInfo.children){var child=layerInfo.children[idx];if(child.featuretypeId!=null){var childFeatureTypeId=child.featuretypeId;if(featureLayerId.indexOf(':')==-1&&childFeatureTypeId.indexOf(':')!=-1){var elems=child.featuretypeId.split(':');childFeatureTypeId=elems[elems.length-1];}
if(childFeatureTypeId==featureLayerId){raw[lang.__("Layer name")]+="/"+child.name;break;}}}}}}catch(e){}
var result=SaigaiTask.Map.view.RefContentsPopup.Result.create(raw);result.raw=raw;me.listPopup.grid.store.add(result);}}}}}catch(e){console.error(e);}}}});}},getWmsGetFeatureInfoURL:function(groupId,layers,bbox,epsg,x,y,count,format)
{var me=this;var stmap=me.stmap;var olmap=stmap.map;var lonLength=bbox[2]-bbox[0];var latLength=bbox[3]-bbox[1];var bufferedBbox=[bbox[0]-lonLength,bbox[1]-latLength,bbox[2]+lonLength,bbox[3]+latLength];me.debugBbox(bufferedBbox);var time=SaigaiTask.PageURL.getTime();if(!!time){var iso8601Time=time.toISOString();if(SaigaiTask.PageURL.CONFIG_SHIFT_TIMEZONE_OFFSET){iso8601Time=new Date(time-time.getTimezoneOffset()*60*1000).toISOString();}
time=iso8601Time;}
else{time=null;}
if(!format)format="application/vnd.ogc.gml";var url="WIDTH="+x*2+"&HEIGHT="+y*2+"&LAYERS="+layers
+"&STYLES=&SRS=epsg:"+epsg+"&SERVICE=WMS&VERSION=1.1.1&REQUEST=GetFeatureInfo&EXCEPTIONS=application%2Fvnd.ogc.se_xml&BBOX="
+(bufferedBbox.join(","))+"&X="+x+"&Y="+y+"&INFO_FORMAT="+format+"&QUERY_LAYERS="+layers+"&FEATURE_COUNT="+count+"&buffer=2";if(!!time)url+="&TIME="+time;return url;},showRefGmlPopup:function(request)
{var me=this;var features=request.response;try{if(features.length==0){features=null;return;}
if(features.length==1){me.showRefGmlFeaturePopup(request,features[0]);}
else{me.showRefGmlTablePopup(request,features);}
features=null;}catch(e){console.error(e);}},showRefGmlFeaturePopup:function(request,feature){var me=this;var layerInfo=request.layerInfo;var ecommapURL=me.stmap.ecommaps[0].ecommapURL;var featureType=feature.gml.featureType;var featureTypeName=featureType;for(var idx in layerInfo.children){var child=layerInfo.children[idx];if(featureType==child.featuretypeId){featureTypeName=child.name;break;}}
var title=null;title=featureTypeName+" ["+layerInfo.name+"]";var layout="vbox";var hbox={xtype:'container',layout:layout,width:0,items:[]};var hboxContainerObj=Ext.create('Ext.container.Container',hbox);var attrs=[];for(var attrId in feature.attributes){var attrValue=feature.attributes[attrId];var attr={attrId:attrId,attrName:attrId,attrValue:attrValue}
attrs.push(attr);}
var attrLayerInfo=null;if(feature.gml.featureNS=="http://map.ecom-plat.jp/map"){var ecommap=me.stmap.ecommaps[0];for(var idx in ecommap.contentsLayerInfos){var contentsLayerInfo=ecommap.contentsLayerInfos[idx];if(contentsLayerInfo.name==featureTypeName){layerInfo.attrInfos=[];for(var attrIdx in contentsLayerInfo.attrInfos){var attrInfo=new SaigaiTask.Map.Layer.AttrInfo(contentsLayerInfo.attrInfos[attrIdx]);attrInfo.attrId=attrInfo.name;layerInfo.attrInfos.push(attrInfo);}
attrLayerInfo=layerInfo;}}}
var grid=me.createAttrGrid(attrs,attrLayerInfo);hboxContainerObj.add(grid);hbox.width+=grid.width;if(feature.gml.featureNS=="http://map.ecom-plat.jp/map"){if(hboxContainerObj.layout.type=="vbox"){var contentsFileFormPanel=me.contentsFileFormPanel=new SaigaiTask.Map.view.ContentsFileFormPanel(me.stmap,null,{editable:false});for(var attrId in feature.attributes){var attr=feature.attributes[attrId];var match=attr.match(/^(https?:\/\/[^ ]+)$/i);if(match&&match.length>0){var fileTitle="";var fileURL=match[1];var url=fileURL;var ext=FalUtil.getFileExt(url);var thumbnail=url;if(!ext.match(/jpg|gif|png|jpeg|file/)){thumbnail=ecommapURL+"/map/fileicons/"+ext+".png";}
contentsFileFormPanel.store.add({title:fileTitle,url:fileURL,thumbnail:thumbnail});}}
var imagesViewPanel=contentsFileFormPanel.formPanel;imagesViewPanel.setWidth(250);hboxContainerObj.add(imagesViewPanel);}}
request.popupOption.items.push(hboxContainerObj);request.popupOption.panelWidth=hbox.width;delete request.popupOption.div;me.showExtPopup(request.popupOption);},showRefGmlTablePopup:function(request,features){var me=this;var headers={};var featureDiv;var preTypeName="";var table,tbody,tr,td;var resultDiv=document.createElement("div");resultDiv.className='popup_ref';var noattr=true;for(var i=0;i<features.length;i++){var feature=features[i];var typeName=feature.fid.replace(/\..+$/,"");var header;if(preTypeName!=typeName){header=[];preTypeName=typeName;}
var attrLength=0;for(var attrid in feature.attributes)attrLength++;if(header.length<attrLength){var idx=0;for(var attrid in feature.attributes){if(attrid!="style")header[idx++]=attrid;}
headers[typeName]=header;}}
preTypeName="";var layerName=null;for(var i=0;i<features.length;i++){var typeName=features[i].fid.replace(/\..+$/,"");var h=headers[typeName];if(!h)h=[];if(preTypeName!=typeName){layerName=typeName;var groupLayerInfo=request.layerInfo;if(!groupLayerInfo==false){for(var idx in groupLayerInfo.children){var layerInfo=groupLayerInfo.children[idx];if(layerInfo&&(layerInfo.featuretypeId.replace(/^.*?\:/,"")==typeName))layerName=layerInfo.name;}}
featureDiv=document.createElement("div")
featureDiv.className="featureTypeName";featureDiv.innerHTML=layerName+" "+lang.__("({0} items )",features.length);resultDiv.appendChild(featureDiv);preTypeName=typeName;table=document.createElement("table");table.className="featureInfo";tbody=document.createElement("tbody");tr=document.createElement("tr");noattr=true;for(var j=0;j<h.length;j++){td=document.createElement("th");td.innerHTML=h[j];td.style.minWidth=(Math.min(100,h[j].length*16))+"px";tr.appendChild(td);noattr=false;}
if(!noattr){tbody.appendChild(tr);}}
tr=this._createRefPopupTr(layerName,features[i],h,noattr);tbody.appendChild(tr);table.appendChild(tbody);resultDiv.appendChild(table);}
var options={minWidth:250,maxWidth:me.stmap.map.getSize().w*0.6,panIntoView:true,turned:true};var popupDiv=request.popupDiv;if(popupDiv){popupDiv.appendChild(resultDiv);if(document.getElementById(popupDiv.id)==null){me.showExtPopup(request.popupOption);}
else{var panelId=$("#"+popupDiv.id).parents(".x-panel")[0].id;var panel=Ext.getCmp(panelId);panel.update($("<div>").append(popupDiv).html());}}},_createRefPopupTr:function(layerName,feature,header,noattr)
{var tr=document.createElement("tr");var td;for(var j=0;j<header.length;j++){td=document.createElement("td");var attr=feature.attributes[header[j]];if(attr){var match=attr.match(/^(https?:\/\/[^ ]+)$/i);if(match&&match.length>0){if(match[1].match(/\.(png|jpg|jpeg|gif)$/i)){td.innerHTML='<a href="'+match[1]+'" target="?blank"><img src="'+match[1]+'" class="popup_attr_image"/></a>';}else{td.innerHTML=this.replaceHref(SaigaiTask.Map.util.CommonUtil.escapeXml(attr)).replace(/\n+/gm,"<br/>");}}else{td.innerHTML=attr;}
td.style.minWidth=(Math.min(100,attr.length*8))+"px";}
tr.appendChild(td);}
if(noattr){td=document.createElement("td");td.innerHTML=lang.__('No Attribute');tr.appendChild(td);}
return tr;},showRefHtmlPopup:function(request)
{var me=this;try{var html=request.response;var popupOption=request.popupOption;if(!html)return;if($.trim(html.substring(html.indexOf('<body>')+6,html.indexOf('</body>'))).length==0)return;var div=document.createElement('div');div.className="popup_ref";if(html){div.innerHTML=html.replace(/<\s*a\s+/ig,'<a target="_blank" ').replace(/onclick\s*=\s*"[^"]*"/ig,'');}
popupOption.div.appendChild(div);me.showExtPopup(popupOption);}catch(e){console.error(e);}}});SaigaiTask.Map.view.MapPanel=function(){this.initialize.apply(this,arguments);};SaigaiTask.Map.view.MapPanel.prototype={map:null,panel:null,panelDivElem:null,initialize:function(map){var me=this;me.map=map;var olmap=map.map;var mapDom=document.getElementById(map.div);var oldWidth=mapDom.clientWidth;var oldHeight=mapDom.clientHeight;mapDom.style.width='100%';mapDom.style.height='100%';var parent=mapDom.parentNode;var panelDivElem=new Ext.Element(document.createElement('div'));parent.appendChild(panelDivElem.dom);var mapPanel=Ext.create("Ext.panel.Panel",{renderTo:panelDivElem.dom,region:'center',layout:'hbox',contentEl:map.div});mapPanel.on('resize',function(){olmap.updateSize();});mapPanel.setWidth(oldWidth);mapPanel.setHeight(oldHeight);this.panel=mapPanel;this.panelDivElem=panelDivElem;var loadMask=new Ext.LoadMask(mapPanel,{msg:lang.__("Now loading..")});map.events.on({"beforeloadecommap":function(){loadMask.show();},"loadendecommap":function(){loadMask.hide();}});var resizeMask=new Ext.LoadMask(mapPanel,{useMsg:false});$(document).on("mousedown",".x-resizable-handle, .ui-layout-resizer",function(){resizeMask.show();});$("body").on("mouseup",function(){if(!resizeMask.disabled)
resizeMask.hide();});}};SaigaiTask.Map.view.PrintWindow=function(){this.initialize.apply(this,arguments);};SaigaiTask.Map.view.PrintWindow.prototype={stmap:null,pdfControl:null,formPanel:null,progressbar:null,progressbarInitText:lang.__('Creating PDF file..'),exportButton:null,downloadButton:null,win:null,initialize:function(pdfControl){var me=this;me.pdfControl=pdfControl;var stmap=me.stmap=pdfControl.stmap;var formPanel=Ext.create('Ext.form.Panel',{frame:false,border:false,width:340,bodyPadding:5,fieldDefaults:{labelAlign:'left',labelWidth:90,anchor:'100%'},items:[{xtype:'textfield',name:'maptitle',fieldLabel:lang.__('Map title'),value:"",allowBlank:true},{xtype:'textareafield',name:'description',fieldLabel:lang.__('Explanation, annotations'),value:""},{xtype:'combo',fieldLabel:lang.__("Paper size"),store:new Ext.data.SimpleStore({fields:['value','display'],data:[["a0","A0"],["a1","A1"],["a2","A2"],["a3","A3"],["a4","A4"],["a5","A5"],["b0","B0"],["b1","B1"],["b2","B2"],["b3","B3"],["b4","B4"],["b5","B5"]],autoLoad:false}),displayField:'display',valueField:'value',name:"pagesize",value:"a4",editable:false,validator:function(value){value=this.getRawValue();var baseLayerInfo=stmap.map.baseLayer.layerInfo;return true;}},{xtype:'checkboxgroup',fieldLabel:lang.__('Paper orientation'),cls:'x-check-group-alt',columns:2,items:[{xtype:'radiofield',name:'rotate',inputValue:'1',boxLabel:lang.__('Horizontal'),checked:true},{xtype:'radiofield',name:'rotate',inputValue:'0',boxLabel:lang.__('Vertical')}]},{xtype:'checkboxgroup',fieldLabel:lang.__('Base map'),cls:'x-check-group-alt',columns:2,items:[{xtype:'radiofield',name:'printBaselayer',inputValue:'1',boxLabel:lang.__('Existing'),checked:true},{xtype:'radiofield',name:'printBaselayer',inputValue:'0',boxLabel:lang.__('None<!--2-->')}]},{xtype:'combo',fieldLabel:lang.__("UTM grid"),store:new Ext.data.SimpleStore({fields:['value','display'],data:[["-1",lang.__("Hide")],["0",lang.__("0 digit: 100km")],["1",lang.__("Single digit: 10km")],["2",lang.__("The second digit: 1km")],["3",lang.__("The third digit: 100m")],["4",lang.__("The forth digit: 10m")]],autoLoad:false}),displayField:'display',valueField:'value',name:"mgrs",value:"-1",editable:false,}]});me.formPanel=formPanel;var progressbar=Ext.create('Ext.ProgressBar',{hidden:true,width:340,text:me.progressbarInitText});me.progressbar=progressbar;var exportButton=Ext.create("Ext.Button",{text:lang.__("PDF output"),icon:stmap.icon.getURL("printIconURL"),handler:function(){if(formPanel.form.isValid()){me.onexport();}
else{Ext.MessageBox.show({title:lang.__('PDF output error'),msg:lang.__('Setting is incorrect.\n Check input content.'),buttons:Ext.MessageBox.OK,animateTarget:exportButton.getEl(),icon:Ext.MessageBox.ERROR});}}});me.exportButton=exportButton;var downloadButton=Ext.create("Ext.Button",{text:lang.__("Download"),href:SaigaiTask.contextPath+"/PdfServlet?download",hidden:true});me.downloadButton=downloadButton;var win=Ext.create("Ext.Window",{closeAction:"hide",title:lang.__("Print dialog"),items:[formPanel,progressbar],fbar:[exportButton,downloadButton],listeners:{show:function(window,eOpts){var value=""+(stmap.controls.mgrsControl.layer.getVisibility()?stmap.controls.mgrsControl.layerInfo.params.precision:"-1");var mgrsField=formPanel.form.findField("mgrs");mgrsField.setValue(value);}}});me.win=win;},getValues:function(){var me=this;return me.formPanel.getValues();},onexport:function(){var me=this;me.progressbar.show();me.downloadButton.hide();me.exportButton.hide();me.pdfControl.print();me.formPanel.disable();},onsuccess:function(){var me=this;me.progressbar.reset(true);me.progressbar.text=me.progressbarInitText;me.progressbar.hide();me.downloadButton.show();me.formPanel.enable();me.formPanel.show();me.exportButton.show();}};SaigaiTask.Map.control.SnapControl=new OpenLayers.Class(OpenLayers.Control,{stmap:null,snap:null,wfsLayers:null,initialize:function(stmap){var me=this;me.stmap=stmap;if(stmap.ecommaps.length==0)return;var ecommap=stmap.ecommaps[0];var contentsLayerInfos=ecommap.contentsLayerInfos;var wfsLayers=[];var wfsLayer=null;var styleMap=new OpenLayers.StyleMap({fillOpacity:0,strokeOpacity:0});for(var idx in contentsLayerInfos){var layerInfo=contentsLayerInfos[idx];var mapInfo=ecommap.mapInfo;var isSnappableLayer=layerInfo.snappable;if(isSnappableLayer){wfsLayer=stmap.addContentsWFSLayer(mapInfo.communityId,mapInfo.mapId,layerInfo.layerId,null,{styleMap:styleMap});wfsLayers.push(wfsLayer);}}
me.wfsLayers=wfsLayers;var targets=[];for(var wfsLayersIdx in wfsLayers){wfsLayer=wfsLayers[wfsLayersIdx];targets.push({layer:wfsLayer,tolerance:10});}
snap=me.snap=new OpenLayers.Control.Snapping({layer:null,targets:targets});stmap.addControl(snap);snap.activate();},setLayer:function(layer){var me=this;var snap=me.snap;if(snap!=null){snap.setLayer(layer);}},destroy:function(){var me=this;var stmap=me.stmap;var olmap=stmap.map;var wfsLayers=me.wfsLayers;for(var idx in wfsLayers){var wfsLayer=wfsLayers[idx];olmap.removeLayer(wfsLayer);wfsLayer.destroy();}}});SaigaiTask.Map.control.RakugakiControl=new OpenLayers.Class(OpenLayers.Control,{stmap:null,mainpanel:null,kmlFormat:null,tbar:null,drawToolbar:null,rakugakiButton:null,buttons:null,rakugakiWindow:null,initialize:function(stmap){var me=this;me.stmap=stmap;var wgs84=new OpenLayers.Projection("EPSG:4326");var internalProjection=wgs84;if(!!stmap.epsg)internalProjection=new OpenLayers.Projection("EPSG:"+stmap.epsg);me.kmlFormat=new OpenLayers.Format.KMLStyle({extractStyles:true,internalProjection:internalProjection});me.rakugakiButton=Ext.create("Ext.Button",{text:lang.__("Memo"),icon:stmap.icon.getURL("mapEditIconURL"),tooltip:lang.__("Memo layer will be displayed or hided."),enableToggle:true,handler:function(button,evt){if(button.pressed){me.show();}
else{if(me.hasUnsaveEdit()){Ext.MessageBox.confirm(lang.__("Hide memo"),lang.__("There is editing memo.<br/>Are you sure to discard the changes?"),function(btn,text){if(btn=='yes'){me.hide();}
else{button.toggle(true);return;}});}
else{me.hide();}}}});me.buttons={};var buttonHandler=function(type){me.reload(function(){me.startEdit(type);});};me.buttons.edit=Ext.create("Ext.Button",{text:lang.__("Edit"),icon:stmap.icon.getURL("editIconURL"),tooltip:lang.__("Edit memo"),enableToggle:true});var types=["register","edit"];for(var idx in types){var type=types[idx];(function(type){var button=me.buttons[type];if(!!button){button.on("click",function(button,status){if(button.pressed){buttonHandler(type);}
else{if(me.hasUnsaveEdit()){Ext.MessageBox.confirm(lang.__("Cancel memo {0}",button.text),lang.__("There is editing memo.<br/>Are you sure to discard the changes?"),function(btn,text){if(btn=='yes'){me.cancelEdit();}
else{button.toggle(true);return;}});}
else{me.stopEdit();}}});}})(type);}
me.tbar=Ext.create("Ext.toolbar.Toolbar",{hidden:true,items:[me.buttons.register,me.buttons.edit]});stmap.events.on({"epsgchanged":function(args){var internalProjection=wgs84;if(!!stmap.epsg)internalProjection=new OpenLayers.Projection("EPSG:"+stmap.epsg);me.kmlFormat.internalProjection=internalProjection;},"initmainpanel":function(args){me.mainpanel=args.mainpanel;me.mainpanel.headerToolbar.tbar.add("->",me.rakugakiButton,me.tbar);}});},show:function(){var me=this;me.tbar.show();if(me.drawToolbar==null){me.rakugakiWindow=new SaigaiTask.Map.view.RakugakiWindow({stmap:me.stmap,rakugakiControl:me});me.drawToolbar=me.rakugakiWindow.drawToolbar;}
me.drawToolbar.drawLayer.layer.setVisibility(true);me.reload();},hide:function(){var me=this;if(me.hasUnsaveEdit()){me.cancelEdit();}
else{me.stopEdit();}
me.drawToolbar.drawLayer.layer.setVisibility(false);me.tbar.hide();},startEdit:function(type){console.debug("startEdit: "+type);var me=this;var stmap=me.stmap;var onlockfail=function(msg){alert(msg);me.buttons[type].toggle();}
stmap.api.rakugaki.lock().fail(function(){onlockfail(lang.__("Failed to edit lock."));}).done(function(result){var lock=false;if(!!result)lock=!!result.lock;if(lock==false){var lockInfo=result.lockInfo;var username="";if(!!lockInfo.groupInfo&&!!lockInfo.groupInfo.name)username="("+lockInfo.groupInfo.name+")";if(!!lockInfo.unitInfo&&!!lockInfo.unitInfo.name)username="("+lockInfo.unitInfo.name+")";onlockfail(lang.__("User {0} is editing.",username));return;}
me.lockTimer=setInterval(function(){stmap.api.rakugaki.lock();},10*1000)
for(var btnType in me.buttons){var btn=me.buttons[btnType];switch(btnType){case"save":case"cancel":btn.show();break;default:if(type!=btnType){btn.setDisabled(true);}
break;}}
var drawToolbar=me.drawToolbar;if(drawToolbar!=null){me.rakugakiWindow.showEditWindow();drawToolbar.drawLayer.historyControl.clear();drawToolbar.drawLayer.historyControl.startHistory();}});},stopEdit:function(){var me=this;var stmap=me.stmap;clearInterval(me.lockTimer);stmap.api.rakugaki.unlock();for(var btnType in me.buttons){var btn=me.buttons[btnType];switch(btnType){case"save":case"cancel":btn.hide();break;default:btn.show();btn.setDisabled(false);btn.toggle(false);break;}}
var drawToolbar=me.drawToolbar;if(drawToolbar!=null){drawToolbar.drawLayer.historyControl.clear();drawToolbar.drawLayer.historyControl.stopHistory();if(me.rakugakiWindow.window!=null){me.rakugakiWindow.window.close();}
drawToolbar.drawLayer.deactivateCurrentDrawControl();stmap.setNavigationControlActivation(true);}},hasUnsaveEdit:function(){try{return 0<this.drawToolbar.drawLayer.historyControl.stack.length;}catch(e){return false;}},cancelEdit:function(){var me=this;me.stopEdit();me.reload();},saveEdit:function(callback){var me=this;var stmap=me.stmap;var kml=me.getEditKML();stmap.api.rakugaki.save(kml);me.stopEdit();if(typeof callback=="function"){callback();}},save:function(){var me=this;var stmap=me.stmap;if(!me.hasUnsaveEdit()){Ext.MessageBox.alert(lang.__("Save memo"),lang.__("Nothing is changed."));}
else{Ext.MessageBox.confirm(lang.__("Save memo"),lang.__("Are you sure to save memo?"),function(btn,text){if(btn=='yes'){me.saveEdit(function(){Ext.MessageBox.alert(lang.__("Save memo"),lang.__("Saved."));});}});}},cancel:function(){var me=this;var stmap=me.stmap;if(me.hasUnsaveEdit()){Ext.MessageBox.confirm(lang.__("Cancel memo"),lang.__("There is memo that has not been saved.<br/>It will discard the changes and cancel editing memo. <br/> Are you sure?"),function(btn,text){if(btn=='yes'){me.cancelEdit();}});}
else{me.cancelEdit();}},getEditKML:function(){var me=this;var drawToolbar=me.drawToolbar;var features=drawToolbar.drawLayer.layer.features;var kml=me.kmlFormat.write(features);return kml;},reload:function(callback){var me=this;var stmap=me.stmap;var drawToolbar=me.drawToolbar;stmap.api.rakugaki.download({async:true,success:function(kml){drawToolbar.drawLayer.layer.removeAllFeatures();if(kml!=null){var kmlString=new XMLSerializer().serializeToString(kml);var features=me.kmlFormat.read(kmlString);drawToolbar.drawLayer.layer.addFeatures(features);}
if(typeof callback=="function"){callback();}},error:function(){ExtmMessageBox.alert(lang.__("Reload memo"),lang.__("Unable to get memo from server."));}});}});SaigaiTask.Map.view.SpatialSearchForm=function(){};SaigaiTask.Map.view.SpatialSearchForm.prototype={defaultOptions:{limit:0,offset:0,searchButtonInfo:{featureInfo:null}},options:null,form:null,get:function(options){var me=this;me.options=options;Ext.applyIf(options,me.defaultOptions);var featureInfo=options.searchButtonInfo.featureInfo;var targetsConfig={fields:['id','name'],data:[]};var defaultTargetValue=null;for(var contentsLayersIdx in options.searchButtonInfo.contentsLayers){var contentsLayerInfo=options.searchButtonInfo.contentsLayers[contentsLayersIdx];targetsConfig.data.push({id:contentsLayerInfo.layerId,name:contentsLayerInfo.name});if(defaultTargetValue==null){defaultTargetValue=contentsLayerInfo.layerId;}}
var targets=Ext.create('Ext.data.Store',targetsConfig);var methods=Ext.create('Ext.data.Store',{fields:['id','name'],data:[{"id":1,"name":lang.__("Include")},{"id":2,"name":lang.__("Not include")},{"id":3,"name":lang.__("Fully include")},{"id":4,"name":lang.__("Not included completely")},{"id":5,"name":lang.__("Overlap")},{"id":6,"name":lang.__("Not overlap")}]});var form=null;form=Ext.create("Ext.form.Panel",{bodyPadding:5,url:options.searchButtonInfo.url,buttonAlign:'center',fieldDefaults:{labelAlign:'left',labelWidth:100,anchor:'100%'},items:[{xtype:'fieldcontainer',fieldLabel:lang.__('Retrieval object'),labelWidth:60,layout:'hbox',items:[{xtype:"combo",editable:false,store:targets,queryMode:'local',name:'layer',displayField:'name',valueField:'id',value:defaultTargetValue,flex:1},{xtype:'button',text:lang.__('Search'),margin:'0 0 0 10',padding:'2 10 2 10',iconCls:'search-icon',handler:function(){form.doSearch();}}]},{xtype:'fieldset',title:lang.__('Search condition'),margin:0,collapsible:true,margin:0,padding:'0 10 0 10',defaults:{labelWidth:120},items:[{xtype:"displayfield",fieldLabel:lang.__("Search range"),value:featureInfo.attrs[0].attrValue},{xtype:"textfield",hidden:true,name:"features",value:options.layerId+"."+options.featureId},{xtype:"numberfield",name:"buffer",fieldLabel:lang.__("Search range buffer (m)"),value:0},{xtype:"combo",fieldLabel:lang.__("Search method"),editable:false,store:methods,queryMode:'local',name:"spatialType",displayField:'name',valueField:'id',value:1}]}],doSearch:function(){form.fireEvent('search');}});form.addEvents('search','aftersearch');me.form=form;return form;},show:function(options){var form=this.get(options);form.on('search',function(){form.submit({params:{mid:options.searchButtonInfo.mid},success:function(form,action){var result=action.result;var spatialSearch=new SaigaiTask.Map.control.SpatialSearch();var searchResult=spatialSearch.getSearchResult(result);var spatialSearchResult=new SaigaiTask.Map.view.SpatialSearchResult();spatialSearchResult.show(searchResult);}});});var win=Ext.create("Ext.window.Window",{extend:"Ext.window.Window",title:lang.__("Registration info Search"),width:500,layout:"fit",items:[form]});win.show();},getValues:function(){var me=this;var options=me.options;var values=me.form.getValues();values.mid=options.searchButtonInfo.mid;values.limit=options.limit;values.offset=options.offset;return values;}};SaigaiTask.Map.control.SelectFeatureControl=new OpenLayers.Class(OpenLayers.Control,{stmap:null,layer:null,layerInfo:null,selectedFeatureDatas:null,window:null,slimer:null,initialize:function(stmap,options){var me=this;me.stmap=stmap;me.selectedFeatureDatas=[];var handler=function(evt){me.saveLayout();};stmap.events.on({"clicksearch":function(args,evt){me.onClickSearch(args);}});me.layer=new OpenLayers.Layer.Vector("Selected Feature Layer",{style:{strokeColor:"#FFFF00",strokeWidth:2,fillColor:"white",fillOpacity:0.5,externalGraphic:stmap.icon.getURL("selectingIconURL"),graphicWidth:19,graphicHeight:32,graphicXOffset:-9,graphicYOffset:-32,graphicOpacity:1}});stmap.addLayer(me.layer);OpenLayers.Control.prototype.initialize.apply(this,[options]);},onClickSearch:function(args){var me=this;var stmap=me.stmap;var layerIds=args.layerIds;var center=args.center;var bbox=args.bbox;var option=args.option;var evt=!!option?option.evt:null;var result=args.result;if(result[0][0]==0)return;if(layerIds.length==1){var ecommap=stmap.ecommaps[0];var layerInfo=ecommap.layerInfoStore[layerIds[0]];if(layerInfo!=null&&layerInfo.type==SaigaiTask.Map.Layer.Type.LOCAL){if(!!evt&&evt.shiftKey){if(me.layerInfo==null)me.layerInfo=layerInfo;args.executePopup=false;var layer=result[1][0][0];var fid=result[1][0][1];var nameAttr=result[1][0][3][0];var nameAttrId=nameAttr[0];nameAttrInfo=me.layerInfo.getAttrInfo(nameAttrId);if(!!nameAttrInfo&&!!nameAttrInfo.name)nameAttr[1]=nameAttrInfo.name;var selected=me.isSelected(layer,fid);if(selected){var selectedFeatureData=me.get(layer,fid);me.deselect(selectedFeatureData);}
else{stmap.api.getContent(stmap.mapId,layer,fid,center,bbox,function(data){if(data==null){return;}
else if(typeof data=="error"){console.warn("error!",args);}
else{var selected=me.isSelected(layer,fid);if(selected){me.deselect(layer,fid);}
else{var featureData=new SaigaiTask.Map.control.SelectFeatureControl.FeatureData(data);featureData.nameAttr=nameAttr;me.select(featureData);}}});}}}}},select:function(featureData){var me=this;var stmap=me.stmap;me.selectedFeatureDatas.push(featureData);if(me.window==null){me.window=new SaigaiTask.Map.view.SelectFeatureWindow({stmap:stmap,featureData:featureData});me.window.window.on("destroy",function(){me.clear();});me.window.grid.on("select",function(grid,record,index,eOpts){var data=record.getData();var layerId=data.layerId;var featureId=Number(data.featureId);var featureData=me.get(layerId,featureId);var centroid=featureData.feature.geometry.getCentroid();var center=new OpenLayers.LonLat(centroid.x,centroid.y);center.transform(stmap.map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326"));stmap.getContent(layerId,featureId,center);});me.window.removeActionColumnItem.handler=function(grid,rowIndex,colIndex){var record=grid.getStore().getAt(rowIndex)
var data=record.getData();var selectedFeatureData=me.get(data.layerId,data.featureId);if(selectedFeatureData!=null){me.deselect(selectedFeatureData);}};me.window.slimerButton.setHandler(function(){me.onClickSlimerButton();});var layerInfo=stmap.getLayerInfo(featureData.layerId);var layer=layerInfo.getLayer();layer.events.on({"refreshParams":function(){me.layer.display(layerInfo.visibility);if(layerInfo.visibility){me.window.window.show();}
else{me.window.window.hide();}}});me.window.show();}
else{me.window.add(featureData);}
try{var wkt=featureData.geom[0];var wktFormat=new OpenLayers.Format.WKT();var feature=wktFormat.read(wkt);feature.geometry.transform(new OpenLayers.Projection("EPSG:4326"),stmap.map.getProjectionObject());featureData.feature=feature;me.layer.addFeatures([feature]);me.layer.refresh();stmap.toFront(me.layer);}catch(e){alert(lang.__("Unable to get position info."));console.error(lang.__("Failed to get position info :")+layerId+"."+fid);console.error(e);return;}},onClickSlimerButton:function(){var me=this;var stmap=me.stmap;if(!me.selectedFeatureDatas||me.selectedFeatureDatas.length==0){alert(lang.__("Please select one or more."));}
else{var columns=[];for(var idx in me.layerInfo.attrInfos){var attrInfo=me.layerInfo.attrInfos[idx];var editable=attrInfo.status==0;if(editable){columns.push({name:attrInfo.name,field:attrInfo.attrId,dataType:attrInfo.dataTypeId,editable:editable,nullable:attrInfo.nullable});}}
var targetIds=[];var values={};for(var idx in me.selectedFeatureDatas){var selectedFeatureData=me.selectedFeatureDatas[idx];var attrs=selectedFeatureData.attrs;targetIds.push(selectedFeatureData.featureId);for(var attrsIdx in attrs){var attr=attrs[attrsIdx];if(idx==0){values[attr.attrId]=attr.attrValue;}
else{if(values[attr.attrId]!=attr.attrValue){values[attr.attrId]=null;}}}}
var slimer=me.slimer;if(!slimer){var key="gid";var slimers=SaigaiTask.Edit.slimers;for(var slimersIdx in slimers){var _slimer=slimers[slimersIdx]
if(me.layerInfo.layerId==_slimer.table){slimer=me.slimer=_slimer;slimer.dialog.bind("slimersuccess",function(evt){stmap.reload();slimer.targetIds=null;});break;}}}
if(!slimer){alert(lang.__("Bulk changes dialog is not found."));}
else{slimer.targetIds=targetIds;slimer.setValues(values);slimer.dialog.dialog({title:lang.__("Bulk change"),minWidth:400,maxHeight:500,modal:true});}}},deselect:function(selectedFeatureData){var me=this;var index=jQuery.inArray(selectedFeatureData,me.selectedFeatureDatas);me.selectedFeatureDatas.splice(index,1);me.window.remove(selectedFeatureData);var feature=selectedFeatureData.feature;if(feature!=null){me.layer.removeFeatures([feature]);me.layer.refresh();}},clear:function(){var me=this;while(0<me.selectedFeatureDatas.length){var selectedFeatureData=me.selectedFeatureDatas[0];me.deselect(selectedFeatureData);}
me.layerInfo=null;me.window=null;},indexOf:function(layer,fid){var me=this;for(var idx in me.selectedFeatureDatas){var selectedFeatureData=me.selectedFeatureDatas[idx];if(selectedFeatureData.layerId==layer&&selectedFeatureData.featureId==fid){return idx;}}
return-1;},get:function(layer,fid){var me=this;var index=me.indexOf(layer,fid);return index!=-1?me.selectedFeatureDatas[index]:null;},isSelected:function(layer,fid){return this.indexOf(layer,fid)!=-1?true:false;}});SaigaiTask.Map.control.SelectFeatureControl.FeatureData=new OpenLayers.Class({layerId:null,featureId:null,attrs:null,geom:null,files:null,meta:null,feature:null,raw:null,initialize:function(data){var me=this;OpenLayers.Util.extend(me,data);}});